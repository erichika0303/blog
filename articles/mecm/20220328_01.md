---
title: クラウド管理ゲートウェイ (CMG) の設計ポイントについて
date: 2022-03-28
tags:
  - MECM
---

みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Configuration Manager (CM) にて提供されるクラウド管理ゲートウェイ (CMG) の設計ポイントについてご案内します。  
なお、下記は MECM CB 2111 および仮想マシンスケールセット (VMSS) の CMG のご利用を前提としておりますのでご留意くださいませ。

# クラウド管理ゲートウェイ (CMG) とは

CMG とは以下の機能を提供する Azure 上で提供されるクラウド サービスです。

- リバースプロキシ機能
  - インターネット上の端末からの通信をイントラネット上の CM の管理ポイントやソフトウェア更新ポイントに中継する機能。イントラネット上の配布ポイントには中継しませんのでご注意ください。
- クラウド上の配布ポイント機能
  - イントラネット、インターネットのどちらの端末に対してもアプリケーションやパッケージを提供するための配布ポイント機能を提供する機能。

下記URLでもドキュメントをご提供しておりますのでご参照くださいませ。

クラウド管理ゲートウェイの概要  
https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/overview

## CMG のユースケース

CMG を使われるユースケースとしては以下のようなものがございます。

1. リモートワーク向けに貸し出した企業端末をMECMを使ってインターネット経由で管理したい。これを VPN を使わずに実現したい。
2. リモートワーク向けに貸し出した企業端末の更新プログラム適用を実施する際、WSUSと同様レベルで管理したい。その際に、VPN 経由でイントラネットの配布ポイントからコンテンツをダウンロードさせるのでは無く、MicrosoftのWindows UpdateやOffice CDNからダウンロードさせることにより、限られた社内インターネット帯域の逼迫を回避したい。
3. 社内にある端末だが、事業拠点とデータセンター間の帯域より、インターネット回線の方が早い、もしくは空いているのでそちらを使いたい。

## CMG のリバースプロキシ機能

CMG をリバースプロキシとして利用する場合、以下の要素をご理解くださいますようお願い致します。

- インターネット端末のみが CMG をリバースプロキシとして利用する
- CMG を利用するためクライアント認証が発生する
- サイトサーバー間の通信暗号化が必要

### MECM におけるインターネット端末の判定

上記でもご案内の通り、インターネット端末として判定されない場合、クライアントはイントラネット用の管理ポイントに対して通信を試みる形となります。  
MECM において、端末がインターネット経由で接続しているのか、イントラネット経由で接続しているのかの判定条件は以下の図のとおりです。オンプレミスADに参加している、リモートワーク向け端末がVPNを介して、オンプレミスADのドメインコントローラーやイントラネットの管理ポイントに接続できてしまうと、たとえ利用している回線がインターネット回線でもイントラネット端末として判定されてしまいます。こちらを回避するためにはレジストリを使って「常にインターネット」の設定をする必要がございますのでご理解くださいますようお願い致します。

![](./20220328_01/20220328_01_01.png)

### CMG におけるクライアント認証

CMG は不特定多数の端末からアクセスがあるため、クライアント認証を行い、成功した端末の通信のみをイントラネットの CM サーバーに中継する仕組みを持ちます。認証の仕組みとしては以下の3つがございます。

1. Azure AD 認証
2. PKI 証明書認証
3. サイト トークン認証

CMG の認証は 1 -> 2 -> 3 の流れでフォールバックしていきます。　　

#### Azure AD 認証

Windows 10 / 11 端末のみが利用できる Azure AD を使った認証です。Azure AD connect を使ってオンプレミスの AD の情報を Azure AD に同期したり、直接端末を Azure AD に参加させて、その際の シングルサインオン情報を使って認証を行います。 インターネット上の Windows 8.1 や Windows Server 端末は本認証は利用できませんので、他の認証形式と併用する形となります。

なお、CMG では 他のクライアント認証方式を使う場合、Azure AD connectを使った AD - Azure AD 間同期は不要です。ただし、多くの場合、CMG 利用と共同管理の利用は同時に検討されることが多いので、その場合は Hybrid Azure AD 構成が結局必要になります。

#### PKI 証明書認証

企業内のクライアント証明書配布基盤により配布されたクライアント証明書により認証を行う形式です。例えば、Active Directory 証明書サービスとグループポリシーを使って配布する、といった方法があるでしょう。よくありがちなトラブルとして、証明書失効リスト (CRL) の公開元がインターネット公開されていないために CRL チェックが出来ずに認証失敗と言ったものがあります。CRL をインターネット公開していない場合は、CMG のクライアント認証設定で CRL チェックを外すと解決します。

#### サイト トークン認証

Azure AD 認証や PKI 証明書認証基盤が利用出来ない環境における認証手段となります。サイト トークン認証は以下の二つの場合に利用されますが、それぞれ利用するトークンが異なります。

- インターネット端末の CM サーバーへの登録: 一括登録トークン
  - インターネット端末が CM サーバーと初めて通信を行う際、サーバー登録用の認証が必要となります。Azure ADや証明書の代替として、登録の際に利用されるトークンが一括登録トークンです。一括登録トークンは階層内の最上位サイトサーバー (中央管理サイトサーバーもしくはプライマリサイトサーバー) にある  BulkRegistrationTokenTool.exe ツールを使用して発行します。このトークンは既定では 3 日間、最大 7 日間有効であり、期間内にインターネット端末にて ccmsetup のオプションでこのトークンを指定すると、インターネット越しでの端末登録が成功します。  

    一括登録トークン  
    https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/deploy/deploy-clients-cmg-token#bulk-registration-token

- CM サーバーとの通信: 自己証明 (SelfProve) トークン
  - 一度でも CM サーバーとの通信に成功したことのあるデバイスに自動的に割り当てられるトークンです。本トークンは 90 日間有効で、インターネット経由でも、イントラネット経由でも CM サーバーに通信が行われると月に 1 回、自動で更新される仕組みとなっています。90 日間、1度も CM サーバーに接続出来ないで居ると、本トークンは無効化されます。トークンが無効化された端末はイントラネット経由で CM サーバーに接続して再度、本トークンを取得する必要があります。
  なお、本トークンの発行は無効化できません。


### クライアント認証方式の選択方針

環境に依りますが、大凡以下の方針で選択されるのが良いかと存じます。各認証方式を組み合わせることも可能です。

1. Windows 10 / 11 端末しか管理しない -> Azure AD 認証
2. Windows 8.1 端末や Windows Server もインターネット越しに管理したい -> PKI 証明書認証
3. 認証基盤の都合上、Azure AD 認証が利用出来ない -> PKI 証明書認証
4. Azure AD 認証や PKI 証明書認証が利用出来ない -> サイトトークン認証
5. 端末のキッティング/再キッティングは必ず企業ネットワークで行われ、かつリモートワークを行う期間は数日なので3ヶ月以内に企業ネットワークに接続する機会がある -> サイトトークン認証


### サイトサーバー間の通信暗号化

最新の CM ではサイトサーバー間通信で平文通信 (http) が非推奨となっているため、問題無いかと存じますが、CMG を利用する際、各サイトサーバー間の通信は SSL を使った暗号化通信が必須となっております。選択方式としては、以下の 2 方式がございます。

- 拡張 HTTP
- HTTPS

また、CMG リバースプロキシシナリオにおいて関係するサイトシステムは以下の通りです。

- CMG
- クラウド管理ゲートウェイ接続ポイント (CMG-CP)
  - CMG に対してHTTPS通信を行い、その通信を維持することでクライアント -> CMG -> CMG-CP -> 管理ポイントもしくはソフトウェア更新ポイントへの通信を中継するサイトシステムの役割です。
- 管理ポイント

#### 拡張 HTTP

CM が独自に発行・管理する自己署名証明書を使って、秘匿性の高い、サイトシステム間の通信を暗号化する方式です。本証明書は有効期限が自動更新されるため、証明書管理の負担が下がるメリットがあります。

#### HTTPS

企業内のPKI 証明書基盤が発行する証明書を使って全てのサイトシステム間の通信を暗号化する方式です。サイト システム間同士がお互いのサーバー証明書・クライアント証明書を認証する必要があるため、多くの証明書が必要となります。これらの証明書には有効期限があるため、期限が切れた証明書は更新する必要があります。

#### 認証方式、通信形式に伴う必要な PKI 証明書の一覧

拡張HTTP、HTTPS 方式それぞれに伴う各ポイントに必要な PKI 証明書は以下の図の通りです。

![](./20220328_01/20220328_01_02.png)

## CMG のクラウド上の配布ポイント機能

CMG を Azure 上の配布ポイントとして提供する機能です。本機能はリバースプロキシ機能とは異なり、イントラネット端末、インターネット端末両方で利用可能です。イントラネット端末が CMG を配布ポイントとして利用する場合は境界グループへの CMG の紐付けが必要です。インターネット端末はイントラネット端末と異なり、境界グループの影響無しにダウンロード元を決定します。コンテンツ別の、ダウンロード元については以下の図を参考ください。なお、注意点として M365 アプリケーションの更新プログラムを CMG からは配布できません。  

![](./20220328_01/20220328_01_04.png)  

上記図で示している、イントラネット端末に対して、Windows Update や Office CDN をダウンロード元のリストに追加する「展開設定」とは以下のオプションを指します。  

[CM コンソール] - [ソフトウェア ライブラリ] - [概要] - [ソフトウェア更新プログラム] - [すべてのソフトウェア更新プログラム] - [展開] - [プロパティ] - [ダウンロードの設定]タブ

![](./20220328_01/20220328_01_05.png)  

また、イントラネット端末に対して、イントラネットの配布ポイントよりも、Windows Update や Office CDN, CMG からのダウンロードを優先させるためには以下のオプションを有効化します。  

[CM コンソール] - [管理] - [概要] - [階層の構成] - [境界グループ] - 対象の境界グループを選択 - [プロパティ] - [オプション]タブ - [オンプレミスのソースよりクラウド ベースのソースを優先します]  

![](./20220328_01/20220328_01_06.png)  

### CMG 利用による VPN 帯域使用料削減の条件

多くのお客様において、VPN 帯域の利用料削減を目的に CMG 導入をご検討されることが多くございます。この際の条件としては、URL 指定による VPN スプリットトンネリング機能が必要になって参ります。お客様によっては、IP アドレス指定による VPN スプリットトンネリング機能しかご利用できない場合がございますが、Windows Update や Office CDN, および CMG は URL 指定によるサービスを前提としております。URL 指定の VPN スプリットトンネリング機能のご利用をお勧め致します。

## CMG のインターネットアクセス要件

以下ドキュメントにまとまっております。

CMG のデータ フロー
https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/data-flow

主な通信経路は以下の図の通りです。  
![](./20220328_01/20220328_01_03.png)

なお、CMDB 内の AzureEnvironments テーブルの中身はそれぞれご確認くださいますようお願い致します。ご参考までに、弊社環境における MECM CB 2111 の場合、他との重複を除きますと、AzurePublicCloud rekoの値は以下の通りです。

```
https://management.core.windows.net/
https://login.microsoftonline.com/
https://gallery.azure.com/
https://vault.azure.net/
core.windows.net
database.windows.net
trafficmanager.net
vault.azure.net
servicebus.azure.com
cloudapp.net
https://graph.microsoft.com/
https://gateway.configmgr.manage.microsoft.com/
https://cmmicrosvc.manage.microsoft.com/
https://portal.manage.microsoft.com/
https://enrollment.manage.microsoft.com/
https://login.windows.net/
cloudapp.azure.com
```

## CMG のセキュリティ

CMG は PaaS レベルで提供されるクラウドサービスです。そのため、責任共有モデルも PaaS のものに準じます。

クラウドにおける共同責任
https://docs.microsoft.com/ja-jp/azure/security/fundamentals/shared-responsibility

CMG で考慮すべき(設定可能な)セキュリティについては以下にまとまっておりますのでこちらをご参照ください。

クラウド管理ゲートウェイのセキュリティとプライバシー
https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/security-and-privacy-for-cloud-management-gateway

## CMG のサイジング設計について

CMG のサイジングについては下記ガイドをご参照ください。

CMG のパフォーマンスとスケール
https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/perf-scale

上記 URL の注意点としましては、表記される数値はあくまで同時クライアント接続数であることです。1 台のクライアントから CMG に対して複数の接続がある場合もありますので、クライアント台数とは完全には一致しませんので、余裕を持って設計されることをお勧め致します。

なお、弊社サポートでは恐れながらサイジングに関するお問い合わせについてはお受けできませんのでご理解くださいますようお願い致します。

## CMG のコスト見積について

CMG のコスト見積については下記を参照ください。多くの場合、仮想マシンより Azure からクライアントに対するアウトバウンドネットワークの費用が支配的です。

https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/cost
