<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Microsoft Endpoint Manager Support Blog</title>
  
  <subtitle>日本マイクロソフト Microsoft Endpoint Manager サポート チームのブログです。</subtitle>
  <link href="https://jpmem.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpmem.github.io/blog/"/>
  <updated>2022-05-30T03:28:54.900Z</updated>
  <id>https://jpmem.github.io/blog/</id>
  
  <author>
    <name>Microsoft Endpoint Manager Support Japan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>WSUS コンソールが全く開かなくなってしまった！ WsusPool の停止とは</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-05-23_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-05-23_01/</id>
    <published>2022-05-22T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.900Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。 WSUS サポート チームです。<br>今回は、 WSUS コンソールが全く開かず、以下のような接続エラーがでてしまっているときにご一読いただきたい WsusPoolの停止 についてご紹介します。<br><img src="/blog/wsus/2022-05-23_01/2022-05-23_01_1.png">   </p><h1 id="WSUS-コンソールが全く開かなくなってしまった！"><a href="#WSUS-コンソールが全く開かなくなってしまった！" class="headerlink" title="WSUS コンソールが全く開かなくなってしまった！"></a>WSUS コンソールが全く開かなくなってしまった！</h1><p>WSUS は、 IIS の WsusPool を介してデータベースへアクセスする仕組みになっています。<br>WsusPool は、IIS のアプリケーション プールであり、IIS のワーカープロセス (w3wp.exe) として動作しますので、以下のように IIS マネージャーから WsusPool の動作状況を確認できます。<br><img src="/blog/wsus/2022-05-23_01/2022-05-23_01_2.png"> </p><p>その為、 Windows Internal Database や SQL Server などデータベース サービスが動作しているにも関わらず、 WSUS コンソールが全く開かず上記のような接続エラーとなってしまう場合には、WsusPool が停止しデータベースへアクセスできない状態となっている可能性が考えられるのです。  </p><h1 id="WsusPool-の停止とは"><a href="#WsusPool-の停止とは" class="headerlink" title="WsusPool の停止とは"></a>WsusPool の停止とは</h1><p>なぜ WsusPool が停止していると考えられるでしょうか。<br>これは、IIS の保護機能により WsusPool が停止した可能性があるからです。  </p><p>WsusPool のメモリ上限値であるプライベート メモリ制限値に達した場合、リサイクルを実行しメモリを解放する動作が起こります。このリサイクルの処理が短期間に頻繁に発生すると、 IIS のラピッド フェール保護と呼ばれる機能が働き、WsusPool を停止させるのです。  </p><p>ラピッド フェール保護の機能解説としては以下の公開情報をご参照ください。<br><a href="https://jpdsi.github.io/blog/web-apps/Rapid-Fail-Protection/">ラピッド フェール保護機能について</a>  </p><p>その為、 WsusPool のメモリ上限値であるプライベート メモリ制限値に達してリサイクルが頻発する状態を改善することで、ラピッド フェール保護による WsusPool が停止する事象を防ぐことができます。</p><h1 id="発生要因"><a href="#発生要因" class="headerlink" title="発生要因"></a>発生要因</h1><p>WsusPool のメモリ上限値であるプライベート メモリ制限値に達してしまう主な要因はなにか。<br>それは主に以下の2点です。<br>1．WsusPool のチューニングが実施されていない<br>2．クライアントのスキャン対象となる更新プログラムが多い  </p><h1 id="対処方法"><a href="#対処方法" class="headerlink" title="対処方法"></a>対処方法</h1><p>上記の要因を解消するためには、以下の対処により改善が見込めます。    </p><h2 id="1．WsusPool-のチューニング"><a href="#1．WsusPool-のチューニング" class="headerlink" title="1．WsusPool のチューニング"></a>1．WsusPool のチューニング</h2><p>WsusPool のチューニングを実施することにより、WsusPool が使用可能なプライベート メモリ上限が引き上げられる上、ラピッドフェール保護の発生条件を緩和できますので、ラピッド フェール保護の発生による WsusPool の停止を抑止することができます。<br>実施内容については、以下の公開記事にてご紹介しておりますのでご参照ください。<br> <a href="https://jpmem.github.io/blog/wsus/2022-05-09_01/#A-IIS-%E3%83%81%E3%83%A5%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E8%A8%AD%E5%AE%9A">IIS チューニング設定</a>  </p><h2 id="2．クライアントのスキャン対象となる更新プログラムの削減"><a href="#2．クライアントのスキャン対象となる更新プログラムの削減" class="headerlink" title="2．クライアントのスキャン対象となる更新プログラムの削減"></a>2．クライアントのスキャン対象となる更新プログラムの削減</h2><p>クライアントは WSUS 同様に IIS を介してデータベースへアクセスし更新プログラムのスキャン処理を行っています。<br>スキャン処理は、WSUS が保持する更新プログラムの情報（メタ データ）が参照され、メタ データをメモリ領域に展開するために必要なメモリ領域の確保とデータのメモリへのコピーが繰り返される為、 WsusPool のメモリ使用量を高める大きな要因となることが事例より判っております。</p><p>クライアントのスキャン処理の対象は、状態が “未承認” 及び “承認済み” の更新プログラムです。<br>“拒否済み” 状態の更新プログラムはスキャン処理の対象外であり、上記のようなメタ データへのメモリへのコピーは行われません。<br>このため、状態を “拒否済み” へ変更いただくことにより、スキャン対象から外すことができ、WsusPool のメモリ使用量を抑えることができます。<br>実施内容ついては、以下の公開記事にてご紹介しておりますのでご参照ください。<br><a href="https://jpmem.github.io/blog/wsus/2017-12-11_01/">不要な更新プログラムは「拒否済み」に設定しよう！</a>  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。 WSUS サポート チームです。&lt;br&gt;今回は、 WSUS コンソールが全く開かず、以下のような接続エラーがでてしまっているときにご一読いただきたい WsusPoolの停止 についてご紹介します。&lt;br&gt;&lt;img src=&quot;/blog/wsus/20</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>クラウド管理ゲートウェイ (CMG) の監視と運用</title>
    <link href="https://jpmem.github.io/blog/mecm/20220522_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220522_01/</id>
    <published>2022-05-21T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.816Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>本日は、クラウド管理ゲートウェイ (CMG) の監視と運用についてご案内させていただきます。CMG は クラウド上の PaaS 形式で提供されるサービスのため、必要な監視・運用作業は非常に少ないものとなっております。</p><h2 id="CMG-の監視"><a href="#CMG-の監視" class="headerlink" title="CMG の監視"></a>CMG の監視</h2><p>下記 Docs でご案内しております。CMG では CPU やメモリ使用量の監視は必要なく、主にトラフィック、コンテンツ、ログ状態を監視することになります。</p><p>CMG を監視する<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/monitor-clients-cloud-management-gateway">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/monitor-clients-cloud-management-gateway</a></p><h3 id="トラフィック監視"><a href="#トラフィック監視" class="headerlink" title="トラフィック監視"></a>トラフィック監視</h3><p>Docs でご案内している通り、以下にて CMG のトラフィック状態を監視できます。</p><p>[CM コンソール] - [管理] - [概要] - [クラウド サービス] - [クラウド管理ゲートウェイ] - 該当の CMG を選択 - 画面下部「接続ポイント」タブ</p><p><img src="/blog/mecm/20220522_01/20220522_01_01.png" alt="image.png"></p><h3 id="ストレージ監視"><a href="#ストレージ監視" class="headerlink" title="ストレージ監視"></a>ストレージ監視</h3><p>CMG の項目表示列を右クリックから追加することで CMG のストレージ利用量や、CMG からクライアントにコンテンツがダウンロードされた量 を確認できます。</p><p><img src="/blog/mecm/20220522_01/20220522_01_02.png" alt="image.png"></p><h3 id="ログ監視"><a href="#ログ監視" class="headerlink" title="ログ監視"></a>ログ監視</h3><p>こちらも Docs にある通りですが、CMG 自体の動作ログは 5 分周期で Azure ストレージから最上位サイトサーバーの Logs フォルダーに同期される仕組みとなっております。</p><p>ログを監視する<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/monitor-clients-cloud-management-gateway#monitor-logs">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/monitor-clients-cloud-management-gateway#monitor-logs</a></p><h3 id="クラウド管理ダッシュボード"><a href="#クラウド管理ダッシュボード" class="headerlink" title="クラウド管理ダッシュボード"></a>クラウド管理ダッシュボード</h3><p>Docsにもありますが以下に形で Azure AD 統計の後に CMG 関連の統計ダッシュボードを開けますのでご活用ください。CMG からの接続状況の確認にご活用できるかと存じます。</p><p>[監視] - [概要] - [クラウド管理]<br><img src="/blog/mecm/20220522_01/20220522_01_03.png" alt="image.png"></p><h2 id="CMG-の運用"><a href="#CMG-の運用" class="headerlink" title="CMG の運用"></a>CMG の運用</h2><p>CMG に必要な運用作業は以下となります。なお、下記の作業はすべて Azure ポータルからではなく、CM コンソールから実行ください。</p><ol><li>CMG の起動</li><li>CMG の停止</li><li>CMG と構成情報の同期</li><li>CMG サーバー証明書の更新</li><li>Azure AD アプリケーション秘密鍵の更新</li></ol><h3 id="CMG-の起動"><a href="#CMG-の起動" class="headerlink" title="CMG の起動"></a>CMG の起動</h3><p>以下を実行してください。  </p><p>[CM コンソール] - [管理] - [概要] - [クラウド サービス] - [クラウド管理ゲートウェイ] - 該当の CMG を選択 - [サービスの開始]</p><p><img src="/blog/mecm/20220522_01/20220522_01_06.png" alt="image.png"></p><p>実行すると ステータスの項目が「開始中」 -&gt; 「準備完了」と遷移します。</p><p><img src="/blog/mecm/20220522_01/20220522_01_07.png" alt="image.png"></p><h3 id="CMG-の停止"><a href="#CMG-の停止" class="headerlink" title="CMG の停止"></a>CMG の停止</h3><p>以下を実行してください。  </p><p>[CM コンソール] - [管理] - [概要] - [クラウド サービス] - [クラウド管理ゲートウェイ] - 該当の CMG を選択 - [サービスの停止]  </p><p><img src="/blog/mecm/20220522_01/20220522_01_04.png" alt="image.png"></p><p>実行すると ステータスの項目が「停止中」 -&gt; 「停止」と遷移します。  </p><p><img src="/blog/mecm/20220522_01/20220522_01_05.png" alt="image.png"></p><h3 id="CMG-と構成情報の同期"><a href="#CMG-と構成情報の同期" class="headerlink" title="CMG と構成情報の同期"></a>CMG と構成情報の同期</h3><p>接続するクラウド管理ゲートウェイサービス接続ポイントや管理ポイント等の設定変更等が行われると、構成情報の同期が必要となります。その際は以下を実行してください。  </p><p><img src="/blog/mecm/20220522_01/20220522_01_08.png" alt="image.png"></p><p>実行すると、ステータスの項目が「アップグレードしています」 -&gt; 「準備完了」と遷移後、ステータスの説明に「構成の更新が完了しました」と表示されます。</p><p><img src="/blog/mecm/20220522_01/20220522_01_09.png" alt="image.png"></p><h3 id="CMG-サーバー証明書の更新"><a href="#CMG-サーバー証明書の更新" class="headerlink" title="CMG サーバー証明書の更新"></a>CMG サーバー証明書の更新</h3><p>CMG のサーバー証明書の有効期限が切れる前に、サーバー証明書を更新ください。サーバー証明書のサブジェクト名、サブジェクト代替名の内容は変更せずに更新ください。</p><ol><li>[CM コンソール] - [管理] - [概要] - [クラウド サービス] - [クラウド管理ゲートウェイ] - [プロパティ] - [設定]タブ へ遷移します。</li><li>[参照]ボタンをクリックします。  </li></ol><p><img src="/blog/mecm/20220522_01/20220522_01_10.png" alt="image.png"></p><ol start="3"><li>更新したサーバー証明書を指定します。</li><li>指定した証明書ファイルが選択されていることを確認します。</li></ol><p><img src="/blog/mecm/20220522_01/20220522_01_11.png" alt="image.png">  </p><ol start="5"><li>ダイアログ右下の「適用」、「OK」ボタンをクリックします。</li><li>CMG のステータスが「準備完了」になれば終了です。</li></ol><h3 id="Azure-AD-アプリケーション秘密鍵の更新"><a href="#Azure-AD-アプリケーション秘密鍵の更新" class="headerlink" title="Azure AD アプリケーション秘密鍵の更新"></a>Azure AD アプリケーション秘密鍵の更新</h3><p>Azure AD アプリケーション秘密鍵の期限が切れる前に更新します。本秘密鍵は、MECM サーバーが Azure リソースとの通信の際に使われる秘密鍵になります。<strong>期限切れしてしまうと、 MECM サーバーが Azure リソースと通信できなくなるためご注意ください。 期限が切れてしまうと Azure AD アプリケーションの再作成、及び CMG の再構築が必要になってしまいます。</strong></p><p>なお、作業に該当の Azure AD のグローバル管理者権限が必要となりますので、事前に準備ください。</p><ol><li>[CMコンソール] - [管理] - [概要] - [クラウド サービス] - [Azure Active Directory テナント] - 利用しているテナントを選択 - 画面下部「アプリケーション」から 利用している Web アプリケーションを選択  </li></ol><p><img src="/blog/mecm/20220522_01/20220522_01_12.png" alt="image.png">  </p><ol start="2"><li>「秘密鍵を更新する」をクリックする。  </li></ol><p><img src="/blog/mecm/20220522_01/20220522_01_13.png" alt="image.png">  </p><ol start="3"><li>Azure AD 認証が求められたら、利用しているテナントのグローバル管理者権限でログインする。</li><li>ログイン後、以下のダイアログが表示されたら 「OK」をクリックする。　　</li></ol><p><img src="/blog/mecm/20220522_01/20220522_01_14.png" alt="image.png">  </p><ol start="5"><li>CM コンソールの画面を更新し、秘密キーの有効期限 (UTC) が更新されていることを確認する。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;本日は、クラウド管理ゲートウェイ (CMG) の監視と運用についてご案内させていただきます。CMG は クラウド上の PaaS 形式で提供されるサービスのため、必要な</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
    <category term="CMG" scheme="https://jpmem.github.io/blog/tags/CMG/"/>
    
  </entry>
  
  <entry>
    <title>MECM 環境下のクライアントにおける [更新プログラムのチェック] の動作について</title>
    <link href="https://jpmem.github.io/blog/mecm/20220520_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220520_01/</id>
    <published>2022-05-19T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.816Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。</p><p>今回は Microsoft Endpoint Configuration Manager (以下 MECM) 環境下において、クライアント側で [Windows の設定] - [Windows Update] - [更新とセキュリティ] - [更新プログラムのチェック] をクリックした際の動作についてご紹介いたします。</p><p><img src="/blog/mecm/20220520_01/1.png"></p><h1 id="MECM-環境下のクライアントで、-更新プログラムのチェック-をクリックすると、MECM-から展開した更新プログラムを受け取れるの？"><a href="#MECM-環境下のクライアントで、-更新プログラムのチェック-をクリックすると、MECM-から展開した更新プログラムを受け取れるの？" class="headerlink" title="MECM 環境下のクライアントで、[更新プログラムのチェック] をクリックすると、MECM から展開した更新プログラムを受け取れるの？"></a>MECM 環境下のクライアントで、[更新プログラムのチェック] をクリックすると、MECM から展開した更新プログラムを受け取れるの？</h1><p>いいえ。受け取れません。<br>Windows の更新とセキュリティでの [更新プログラムのチェック] のクリックしますと、クライアントが ソフトウェア更新ポイントの役割が追加されたサーバーにインストールした WSUS に対し WSUS コンソールで承認された更新プログラムの有無を確認する動作となります。<br>MECM 環境下においては、WSUS で承認を行わないため [更新プログラムのチェック] をクリックしても MECM からの展開を検出せず、更新プログラムはダウンロードされません。<br>その為、MECM クライアント コンソール で各サイクルの実行にて展開を受け取る操作を行う事が、MECM からの展開を受け取れているのかを確認する正しい方法となります。</p><p>展開を受け取るための MECM クライアント コンソールでの各サイクルの実行につきましては、以下ブログをご参考にしてくださいませ。<br>Title : Configuration Manager で、できる限り早く更新プログラムを適用する方法について<br>URL : <a href="https://jpmem.github.io/blog/mecm/20180619_01/">https://jpmem.github.io/blog/mecm/20180619_01/</a></p><h1 id="更新プログラムのチェック-と-MECM-クライアント-コンソールでの各サイクルの実行の動作の違いについて"><a href="#更新プログラムのチェック-と-MECM-クライアント-コンソールでの各サイクルの実行の動作の違いについて" class="headerlink" title="[更新プログラムのチェック] と MECM クライアント コンソールでの各サイクルの実行の動作の違いについて"></a>[更新プログラムのチェック] と MECM クライアント コンソールでの各サイクルの実行の動作の違いについて</h1><p>Windows の更新とセキュリティでの [更新プログラムのチェック] を実行した際の動作と MECM クライアントが展開された更新プログラムを受け取る場合の動作は異なるものでありますため、その差異を補足いたします。</p><p>クライアント側で Windows の更新とセキュリティでの「更新プログラムのチェック」を実行した際の動作としましては、OS の Update Orchestrator というサービスが Windows Update Agent (WUA) に要求を出し、 WSUS の承認情報を取得しにいきます。<br>その為、MECM 環境下においては、WSUS で承認を行わないため、[更新プログラムのチェック]をクリックしても MECM からの展開を検出せず、「最新です」と表示される動作になります。</p><p>一方、MECM から展開された更新プログラムを受け取る場合の動作としましては、以下の流れとなります。</p><ol><li>CcmExec (MECM クライアントのプロセス) が Windows Update Agent (WUA) に要求を出し、ソフトウェアの更新ポイント サーバー (WSUS サーバー) に対してスキャンを行い、更新プログラムの要否を判断します。</li><li>CcmExec が [コンピューター ポリシーの取得および評価サイクル] を実行するタイミングで MECM サーバーから更新プログラムの展開情報を受信します。</li><li>スキャンの結果「必要」と判断した更新プログラムが展開されている場合、展開設定に応じてダウンロード、インストールを行います。</li></ol><p>その為、MECM から展開されている更新プログラムが、すべて適用されているかの確認につきましては、Windows の更新とセキュリティでの [更新プログラムのチェック] ではなく、 MECM クライアント コンソールで、<a href="https://jpmem.github.io/blog/mecm/20180619_01/">上述の公開情報</a>に記載の各サイクルの実行にて展開を受け取る操作をご実施後、ダウンロードされてくる更新プログラムの有無によりご確認いただく事が可能でございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;/p&gt;
&lt;p&gt;今回は Microsoft Endpoint Configuration Manager (以下 MECM) 環境下において、クライアント側で [Windows の設定]</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Configuration Manager で削除された機能について</title>
    <link href="https://jpmem.github.io/blog/mecm/20220519_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220519_01/</id>
    <published>2022-05-18T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.812Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>Configuration Manager では バージョン アップにより、新機能の実装や、機能の修正が行われておりますが、機能の削除も行われております。<br>今回は、Configuration Manager で削除された機能について、弊社公開情報を基に整理いたしましたのでご紹介いたします。</p><p>※ 本記事は バージョン 2203 (Microsoft Endpoint Configuration Manager 2203) までの情報を整理し、作成いたしました。<br>　 今後、削除予定の機能 (推奨されない機能) の一覧 ならびに 最新情報につきましては、以下の弊社公開情報をご参照くださいますよう、お願いいたします。</p><p>(本記事のベースとなる弊社公開情報) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/plan-design/changes/deprecated/removed-and-deprecated-cmfeatures">Configuration Managerの削除および非推奨の機能</a></p><hr><h2 id="バージョン-2203-Microsoft-Endpoint-Configuration-Manager-2203"><a href="#バージョン-2203-Microsoft-Endpoint-Configuration-Manager-2203" class="headerlink" title="バージョン 2203 (Microsoft Endpoint Configuration Manager 2203)"></a>バージョン 2203 (Microsoft Endpoint Configuration Manager 2203)</h2><h3 id="クラウド管理ゲートウェイ-CMG"><a href="#クラウド管理ゲートウェイ-CMG" class="headerlink" title="クラウド管理ゲートウェイ (CMG)"></a>クラウド管理ゲートウェイ (CMG)</h3><ul><li>クラウド管理ゲートウェイ (CMG) を クラウド サービス (クラシック) としてデプロイする機能<ul><li>(参考情報) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/plan-cloud-management-gateway#virtual-machine-scale-sets">Configuration Managerで CMG を計画する - 仮想マシン スケール セット</a></li></ul></li></ul><h2 id="バージョン-2111-Microsoft-Endpoint-Configuration-Manager-2111"><a href="#バージョン-2111-Microsoft-Endpoint-Configuration-Manager-2111" class="headerlink" title="バージョン 2111 (Microsoft Endpoint Configuration Manager 2111)"></a>バージョン 2111 (Microsoft Endpoint Configuration Manager 2111)</h2><h3 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h3><ul><li>Microsoft .NET Framework バージョン 4.6.1 以前のバージョンを使用した Configuration Manager ライブラリに依存するサード パーティ製アドオン<ul><li>(参考情報) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/get-started/2021/technical-preview-2109#bkmk_dotnetsdk">Configuration Manager テクニカル プレビュー バージョン 2109 の機能 - 外部依存関係には .NET 4.6.2 が必要</a></li></ul></li></ul><h2 id="バージョン-2107-Microsoft-Endpoint-Configuration-Manager-2107"><a href="#バージョン-2107-Microsoft-Endpoint-Configuration-Manager-2107" class="headerlink" title="バージョン 2107 (Microsoft Endpoint Configuration Manager 2107)"></a>バージョン 2107 (Microsoft Endpoint Configuration Manager 2107)</h2><h3 id="Azure-連携"><a href="#Azure-連携" class="headerlink" title="Azure 連携"></a>Azure 連携</h3><ul><li>Azure Monitor 用 Log Analytics コネクタ<ul><li>(参考情報) <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/collect-sccm">Configuration Manager を Azure Monitor に接続する</a></li></ul></li></ul><h2 id="バージョン-2103-Microsoft-Endpoint-Configuration-Manager-2103"><a href="#バージョン-2103-Microsoft-Endpoint-Configuration-Manager-2103" class="headerlink" title="バージョン 2103 (Microsoft Endpoint Configuration Manager 2103)"></a>バージョン 2103 (Microsoft Endpoint Configuration Manager 2103)</h2><h3 id="ツール"><a href="#ツール" class="headerlink" title="ツール"></a>ツール</h3><ul><li>コレクション評価ビューアー<ul><li>(参考情報 1) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/support/ceviewer">Collection Evaluation Viewer</a></li><li>(参考情報 2) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/collections/collection-evaluation-view">コレクション評価の表示方法</a></li></ul></li></ul><h2 id="バージョン-1910-Microsoft-Endpoint-Configuration-Manager-1910"><a href="#バージョン-1910-Microsoft-Endpoint-Configuration-Manager-1910" class="headerlink" title="バージョン 1910 (Microsoft Endpoint Configuration Manager 1910)"></a>バージョン 1910 (Microsoft Endpoint Configuration Manager 1910)</h2><h3 id="コンプライアンス設定"><a href="#コンプライアンス設定" class="headerlink" title="コンプライアンス設定"></a>コンプライアンス設定</h3><ul><li>デバイス正常性構成証明の評価</li><li>Windows Hello for Business 設定における証明書ベース認証<ul><li>(参考情報) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/protect/deploy-use/windows-hello-for-business-settings#configure-a-profile">Configuration Manager の Windows Hello for Business設定 - プロファイルを構成する</a></li></ul></li></ul><h3 id="アプリケーション-カタログ"><a href="#アプリケーション-カタログ" class="headerlink" title="アプリケーション カタログ"></a>アプリケーション カタログ</h3><ul><li>アプリケーション カタログの役割 および サイト システムの役割<br>(アプリケーション カタログ Web サイト ポイントと Web サービス ポイント)<ul><li>(参考情報) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/apps/plan-design/plan-for-and-configure-application-management#remove-the-application-catalog">Configuration Manager でアプリケーション管理を計画および構成する - アプリケーション カタログを削除する</a></li></ul></li></ul><h3 id="クライアント"><a href="#クライアント" class="headerlink" title="クライアント"></a>クライアント</h3><ul><li>Configuration Manager ポータル サイト アプリ (Windows Phone 向けのアプリ)</li></ul><h2 id="バージョン-1810-System-Center-Configuration-Manager-1810"><a href="#バージョン-1810-System-Center-Configuration-Manager-1810" class="headerlink" title="バージョン 1810 (System Center Configuration Manager 1810)"></a>バージョン 1810 (System Center Configuration Manager 1810)</h2><h3 id="コンプライアンス設定-1"><a href="#コンプライアンス設定-1" class="headerlink" title="コンプライアンス設定"></a>コンプライアンス設定</h3><ul><li>セキュリティ コンテンツ オートメーション プロトコル (SCAP) 拡張機能<ul><li>(参考情報) <a href="https://www.microsoft.com/en-us/download/details.aspx?id=48741">Download Center - SCAP Extensions for System Center Configuration Manager</a></li></ul></li></ul><h2 id="バージョン-1806-System-Center-Configuration-Manager-1806"><a href="#バージョン-1806-System-Center-Configuration-Manager-1806" class="headerlink" title="バージョン 1806 (System Center Configuration Manager 1806)"></a>バージョン 1806 (System Center Configuration Manager 1806)</h2><h3 id="アプリケーション-カタログ-1"><a href="#アプリケーション-カタログ-1" class="headerlink" title="アプリケーション カタログ"></a>アプリケーション カタログ</h3><ul><li>アプリケーション カタログ Web サイト ポイントの Silverlight ユーザー エクスペリエンス<ul><li>(参考情報) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/apps/plan-design/plan-for-and-configure-application-management#remove-the-application-catalog">Configuration Manager でアプリケーション管理を計画および構成する - アプリケーション カタログを削除する</a></li></ul></li></ul><h2 id="バージョン-1802-System-Center-Configuration-Manager-1802"><a href="#バージョン-1802-System-Center-Configuration-Manager-1802" class="headerlink" title="バージョン 1802 (System Center Configuration Manager 1802)"></a>バージョン 1802 (System Center Configuration Manager 1802)</h2><h3 id="ソフトウェア-センター"><a href="#ソフトウェア-センター" class="headerlink" title="ソフトウェア センター"></a>ソフトウェア センター</h3><ul><li>以前のバージョンのソフトウェア センター<ul><li>(参考情報) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/apps/plan-design/plan-for-software-center">ソフトウェア センターの計画</a></li></ul></li></ul><h2 id="バージョン-1710-System-Center-Configuration-Manager-1710"><a href="#バージョン-1710-System-Center-Configuration-Manager-1710" class="headerlink" title="バージョン 1710 (System Center Configuration Manager 1710)"></a>バージョン 1710 (System Center Configuration Manager 1710)</h2><h3 id="タスク-シーケンス"><a href="#タスク-シーケンス" class="headerlink" title="タスク シーケンス"></a>タスク シーケンス</h3><ul><li>Configuration Manager 管理コンソール上での仮想ハード ディスク (VHD) の管理</li><li>ダイナミック ディスクへの変換・展開ツールのインストール</li></ul><h2 id="バージョン-1702-System-Center-Configuration-Manager-1702"><a href="#バージョン-1702-System-Center-Configuration-Manager-1702" class="headerlink" title="バージョン 1702 (System Center Configuration Manager 1702)"></a>バージョン 1702 (System Center Configuration Manager 1702)</h2><h3 id="ソフトウェア更新ポイント"><a href="#ソフトウェア更新ポイント" class="headerlink" title="ソフトウェア更新ポイント"></a>ソフトウェア更新ポイント</h3><ul><li>ネットワーク負荷分散 (NLB) クラスターを使用したソフトウェア更新ポイント<ul><li>(参考情報) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/deploy/configure/high-availability-options#redundancy-for-important-site-system-roles">Configuration Manager の高可用性オプション - 重要なサイト システムの役割の冗長性</a></li></ul></li></ul><h2 id="バージョン-1606-System-Center-Configuration-Manager-1606"><a href="#バージョン-1606-System-Center-Configuration-Manager-1606" class="headerlink" title="バージョン 1606 (System Center Configuration Manager 1606)"></a>バージョン 1606 (System Center Configuration Manager 1606)</h2><h3 id="タスク-シーケンス-1"><a href="#タスク-シーケンス-1" class="headerlink" title="タスク シーケンス"></a>タスク シーケンス</h3><ul><li>変数: OSDPreserveDriveLetter<ul><li>(参考情報) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/osd/understand/task-sequence-variables#osdpreservedriveletter">タスク シーケンス変数 - 非推奨の変数</a></li></ul></li></ul><h2 id="バージョン-1511-System-Center-Configuration-Manager-1511"><a href="#バージョン-1511-System-Center-Configuration-Manager-1511" class="headerlink" title="バージョン 1511 (System Center Configuration Manager 1511)"></a>バージョン 1511 (System Center Configuration Manager 1511)</h2><h3 id="その他-1"><a href="#その他-1" class="headerlink" title="その他"></a>その他</h3><ul><li>ネットワーク アクセス保護 (NAP)<ul><li>(参考情報) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/plan-design/changes/deprecated/removed-and-deprecated-cmfeatures#network-access-protection">Configuration Managerの削除および非推奨の機能 - ネットワーク アクセス保護</a></li></ul></li><li>帯域外管理<ul><li>(参考情報) <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/plan-design/changes/deprecated/removed-and-deprecated-cmfeatures#out-of-band-management">Configuration Managerの削除および非推奨の機能 - 帯域外管理</a></li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;Configuration Manager では バージョン アップにより、新機能の実装や、機能の修正が行われておりますが、機能の削除も行われております。&lt;br&gt;今回</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>WSUS でクライアントが正常に認識されない SusClientID の重複とは</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-05-18_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-05-18_01/</id>
    <published>2022-05-17T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.900Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。 WSUS サポート チームです。<br>WSUS サーバーに正常にアクセス可能な状態のソース PC からインストールイメージを作成し、ほかの PC にイメージを展開して建てた端末について、 WSUS 　サーバー側へ接続した際に、クライアントが表示されたりされなかったりといったように正常に認識されなくなる事象が発生することがございます。<br>今回はそのような事象がなぜ起こるのか対処方法を含めご紹介していきたいと思います。</p><h1 id="SusClientID-の重複とは"><a href="#SusClientID-の重複とは" class="headerlink" title="SusClientID の重複とは"></a>SusClientID の重複とは</h1><p>WSUS サーバーはクライアントを SusClientID という一意の ID で識別しています。<br>この SusClientID は、sysprep /generalize コマンドを実行し一般化することでリセットされますが、sysprep /generalize コマンドを実行をしていないマスターイメージをもとに複製した場合、同じ SusClientID を持つ端末が複製されて、SusClientID の重複が発生します。<br>そのため、ホスト名などが異なる場合にも SusClientID が重複しておりますと同じクライアントとして認識し、クライアントが正常に認識されない事象が発生いたします。</p><p>SusClientID は以下のレジストリキーにその値が格納されています。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate</span><br></pre></td></tr></table></figure><p>重複している場合は、以下の手順にて SusClientId を削除いただきますと、SusClientId は自動生成され重複状態が解消します。</p><p>手順</p><ol><li>問題のクライアントに管理者権限を持つユーザーでログオンし、コマンド プロンプトを「管理者として実行」にて起動します。</li><li>管理者として実行にて起動したコマンド プロンプトで、下記コマンドでサービスを停止します。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net stop usosvc</span><br><span class="line">net stop wuauserv</span><br></pre></td></tr></table></figure><ol start="3"><li>“regedit” コマンドでレジストリエディタを起動し、下記サブキーの中に存在するエントリをすべて削除します。</li></ol><p>・サブキー；<br>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate]</p><p>・削除するエントリ：（一部は存在しない場合もあります。クライアントのバージョンや使用経緯により異なります）<br>PingID<br>AccountDomainSid<br>SusClientId<br>SusClientIdValidation</p><ol start="4"><li>管理者として実行にて起動したコマンド プロンプトで、下記コマンドでサービスを開始します。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net start usosvc</span><br><span class="line">net start wuauserv</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。 WSUS サポート チームです。&lt;br&gt;WSUS サーバーに正常にアクセス可能な状態のソース PC からインストールイメージを作成し、ほかの PC にイメージを展開して建てた端末について、 WSUS 　サーバー側へ接続した際に、クライアントが表示され</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>クラウド PC で日本語入力ができない場合のチェック項目について</title>
    <link href="https://jpmem.github.io/blog/w365/2022-05-13_01/"/>
    <id>https://jpmem.github.io/blog/w365/2022-05-13_01/</id>
    <published>2022-05-12T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.840Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。<br>本日は、Windows 365 のクラウド PC で、日本語入力ができない場合のチェック項目ついてご紹介します。<br>言語を日本語にしているにも関わらず、メモ帳や Edge の検索欄に英語しか入力ができない際にご確認いただければ幸いです。  </p><h2 id="免責事項"><a href="#免責事項" class="headerlink" title="免責事項"></a>免責事項</h2><p>下記内容は 2022/5/13 時点での内容についての記載となっております。<br>今後内容が更新されることもございますので、その点ご承知置きくださいますようお願い致します。</p><h3 id="A-言語が日本語になっているか"><a href="#A-言語が日本語になっているか" class="headerlink" title="A. 言語が日本語になっているか"></a>A. 言語が日本語になっているか</h3><p>そもそも言語とキーボードの設定が日本語になっているか確認します。  </p><ol><li>スタートメニューから [設定] を選択し、[時刻と言語] を選択します。  </li><li>[言語] を選択し、Windows の表示言語が日本語になっているか確認します。  </li><li>[優先する言語] 欄から日本語を選択し、[オプション] を選択します。<br><img src="/blog/w365/2022-05-13_01/2022-05-13-08-57-14.png">  </li><li>[ハードウェア キーボード レイアウト] が “日本語キーボード（106/109 キー）” になっているか確認します。 “英語キーボード（101/102 キー）” になっている場合は日本語に変更し、再起動を実施します。<br><img src="/blog/w365/2022-05-13_01/2022-05-13-09-00-13.png">  </li><li>再起動後、メモ帳などで日本語が入力できるか確認します。  </li></ol><h3 id="B-代替キーボード-レイアウトが有効化になっているか"><a href="#B-代替キーボード-レイアウトが有効化になっているか" class="headerlink" title="B. 代替キーボード レイアウトが有効化になっているか"></a>B. 代替キーボード レイアウトが有効化になっているか</h3><p>こちらはブラウザーからアクセスしている場合にチェックする項目です。そのため、リモート デスクトップ接続している場合は後述の [C. Touch Keyboard and Handwriting Panel Service が有効になっているか] の項目をご確認ください。  </p><ol><li>画面右上の歯車マークから [セッション中] を選択します。<br><img src="/blog/w365/2022-05-13_01/2022-05-13-09-07-00.png">  </li><li>[代替キーボード レイアウトの有効化] を有効にし、[リモート キーボード レイアウトの選択] を “日本語キーボード（106/109 キー）” に設定し、Update を選択します。<br><img src="/blog/w365/2022-05-13_01/2022-05-13-09-26-57.png">  </li><li>一度セッションを切断する必要があるので、[現在] を選択した状態で Continue を選択します。<br><img src="/blog/w365/2022-05-13_01/2022-05-13-09-11-04.png">  </li><li>クラウド PC に再接続後、日本語が入力できるか確認します。    </li></ol><h3 id="C-Touch-Keyboard-and-Handwriting-Panel-Service-が有効になっているか"><a href="#C-Touch-Keyboard-and-Handwriting-Panel-Service-が有効になっているか" class="headerlink" title="C. Touch Keyboard and Handwriting Panel Service が有効になっているか"></a>C. Touch Keyboard and Handwriting Panel Service が有効になっているか</h3><p>Touch Keyboard and Handwriting Panel Service は日本語入力をはじめとして、様々な入力機能に使われているサービスです。このサービスが無効化されているとそれらの機能が正しく動作できません。<br>以下の手順で Touch Keyboard and Handwriting Panel Service が有効になっているかご確認いただき、無効になっている場合は有効としていただくようお願いいたします。  </p><ol><li>スタートボタンを右クリックし、[ファイル名を指定して実行] を選択します。  </li><li>services.msc と入力し、[OK] を選択します。  </li><li>Touch Keyboard and Handwriting Panel Service をダブルクリックします。  </li><li>[スタートアップの種類] が [無効] になっていれば、[自動] または [手動] に変更し、[OK] を選択します。  </li><li>クラウド PC を再起動し、Touch Keyboard and Handwriting Panel Service が実行中となっていることを確認します。<br><img src="/blog/w365/2022-05-13_01/2022-05-13-10-07-14.png">  </li><li>メモ帳などで日本語が入力できるか確認します。  </li></ol><p>以上、日本語入力ができない場合のチェック項目ついてご紹介させていただきましたので、参考になれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。&lt;br&gt;本日は、Windows 365 のクラウド PC で、日本語入力ができない場合のチェック項目ついてご紹介します。&lt;br&gt;言語を日本語にしているにも関わらず、メモ帳や E</summary>
      
    
    
    
    
    <category term="Windows 365" scheme="https://jpmem.github.io/blog/tags/Windows-365/"/>
    
  </entry>
  
  <entry>
    <title>ccmcache フォルダー配下のキャッシュ クリア方法</title>
    <link href="https://jpmem.github.io/blog/mecm/20220511_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220511_01/</id>
    <published>2022-05-10T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.812Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。</p><p>Configuration Manager を利用したアプリケーションや更新プログラムの配布運用をされているなかで、管理対象クライアントに対して過去配布したコンテンツを一括で削除されたいと思われたことはございませんか？<br>また、クライアント設定で指定したクライアント キャッシュのサイズを超過していることがあると不思議に思われたことはありませんか？<br>今回は、クライアント キャッシュの動作と管理対象デバイスへ配布したコンテンツをサーバーから一括で削除する方法についてご紹介させていただきます。</p><p>管理対象デバイスにコンテンツ（アプリケーション、パッケージや更新プログラム　など）を展開すると、管理対象デバイスはクライアント キャッシュ（ccmcache フォルダー）にコンテンツのダウンロードを行います。<br>クライアント キャッシュは、指定されたキャッシュ サイズまでコンテンツのダウンロードし保存します。<br>次に、新しいコンテンツをダウンロードする際に、指定されたキャッシュ サイズ（累積）を超えるコンテンツのダウンロードを行う場合は、新しいコンテンツをクライアント キャッシュ内にダウンロードを行うための領域を確保するのに、古いコンテンツを自動で削除してからダウンロードを行います。<br>ここまでが基本動作となりますが、ソフトウェア更新プログラム機能で配布した更新プログラムはクライアント キャッシュのサイズに関係なくダウンロードするため、指定したクライアント キャッシュのサイズを超過することが起きます。</p><p>実際にコンテンツのダウンロードが行われる際のコンテンツ情報（サイズ）を見てみましょう。<br>確認するログは、管理対象デバイスに生成される ”CAS.log” となります。</p><ul><li>パッケージを展開した場合</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">**** Received request for content PS10001B.2, size(KB) 1048848, under context System with priority Low, persist duration 0</span><br><span class="line">CacheManager: ADD new cache entry &#123;93CCFA37-5CC3-4E6E-A99A-21B120F10276&#125; for content PS10001B.2, Size : 1048848K, RefCount : 1, LastRef Minutes : 0, State : ACTIVE, PersistDuration : 0, Location : C:\Windows\ccmcache\1.</span><br></pre></td></tr></table></figure><ul><li>アプリケーションを展開した場合</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">**** Received request for content Content_8e82e01e-98fc-47c7-9f41-7f13b78e93a6.1, size(KB) 5532, under context System with priority Medium, persist duration 0</span><br><span class="line">CacheManager: ADD new cache entry &#123;611DEEB6-C117-4998-92AB-D996C28E2C49&#125; for content Content_8e82e01e-98fc-47c7-9f41-7f13b78e93a6.1, Size : 5532K, RefCount : 1, LastRef Minutes : 0, State : ACTIVE, PersistDuration : 0, Location : C:\Windows\ccmcache\2.</span><br></pre></td></tr></table></figure><ul><li>機能更新プログラムを展開した場合</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">**** Received request for content 627d1aed-c707-4b2f-8dc5-5ce588ef8308.1, size(KB) 0, under context System with priority Medium, persist duration 0</span><br><span class="line">CacheManager: ADD new cache entry &#123;160D2012-B37D-4AE1-B3B2-B4C94CF24E80&#125; for content 627d1aed-c707-4b2f-8dc5-5ce588ef8308.1, Size : 3749136K, RefCount : 1, LastRef Minutes : 0, State : ACTIVE, PersistDuration : 0, Location : C:\Windows\ccmcache\1.</span><br></pre></td></tr></table></figure><p>  ※「627d1aed-c707-4b2f-8dc5-5ce588ef8308」は、Windows 10 バージョン 21H2 の機能更新プログラムの ID となります。</p><ul><li>累積更新プログラムを展開した場合</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">**** Received request for content 9f8e1ae1-c800-4603-aa6d-378d65ba48f4.1, size(KB) 0, under context System with priority Medium, persist duration 0</span><br><span class="line">CacheManager: ADD new cache entry &#123;9CD3EEA7-DFD7-4EC2-ACB6-6A39972DDBF1&#125; for content 9f8e1ae1-c800-4603-aa6d-378d65ba48f4.1, Size : 655018K, RefCount : 1, LastRef Minutes : 0, State : ACTIVE, PersistDuration : 0, Location : C:\Windows\ccmcache\7.</span><br></pre></td></tr></table></figure><p>  ※「9f8e1ae1-c800-4603-aa6d-378d65ba48f4」は、2022-03 x64 ベース システム用 Windows 10 Version 21H1 の累積更新プログラム (KB5011487) の ID となります。</p><p>ご覧のとおり、パッケージとアプリケーションのデータ サイズは展開するデータ サイズと同一のデータ サイズでリクエストを受け取りますが、一方で機能更新プログラムおよび累積更新プログラムのデータ サイズは数百 MB や数 GB の実際のデータ サイズではなく、0KB としてリクエストを受け取っていることが確認できます。</p><h1 id="クライアント-キャッシュのクリア方法"><a href="#クライアント-キャッシュのクリア方法" class="headerlink" title="クライアント キャッシュのクリア方法"></a>クライアント キャッシュのクリア方法</h1><p>通常、クライアント キャッシュのクリアする場合、管理対象デバイス上で [コントロールパネル] にございます [Configuration Manager] の [キャッシュ] タブより、個別にキャッシュのクリアが必要となります。<br>しかしながら、こちらは管理者権限を持ち合わせたアカウントでないと実行いただけなく、また、ご利用者様にてご実施いただく必要があります。</p><p>以下にご案内する PowerShell スクリプトを実行することにより、管理対象デバイス上にて [Configuration Manager] でキャッシュのクリアを行わずに、ダウンロードしたコンテンツを削除いただけます。</p><h2 id="ccmcache-フォルダー内すべて削除"><a href="#ccmcache-フォルダー内すべて削除" class="headerlink" title="ccmcache フォルダー内すべて削除"></a>ccmcache フォルダー内すべて削除</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$UIResourceMgr</span> = <span class="built_in">New-Object</span> <span class="literal">-Com</span> <span class="string">&quot;UIResource.UIResourceMgr&quot;</span></span><br><span class="line"><span class="variable">$Cache</span> = <span class="variable">$UIResourceMgr</span>.GetCacheInfo()</span><br><span class="line"><span class="variable">$Cache</span>.GetCacheElements() | % &#123;<span class="variable">$Cache</span>.DeleteCacheElement(<span class="variable">$_</span>.CacheElementID)&#125;</span><br></pre></td></tr></table></figure><h2 id="ソフトウェア更新プログラムのみすべて削除"><a href="#ソフトウェア更新プログラムのみすべて削除" class="headerlink" title="ソフトウェア更新プログラムのみすべて削除"></a>ソフトウェア更新プログラムのみすべて削除</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$UIResourceMgr</span> = <span class="built_in">New-Object</span> <span class="literal">-Com</span> <span class="string">&quot;UIResource.UIResourceMgr&quot;</span></span><br><span class="line"><span class="variable">$Cache</span> = <span class="variable">$UIResourceMgr</span>.GetCacheInfo()</span><br><span class="line"><span class="variable">$Cache</span>.GetCacheElements() | <span class="built_in">where-object</span> &#123;<span class="variable">$_</span>.ContentId.Length <span class="operator">-ne</span> <span class="number">8</span> <span class="operator">-and</span> <span class="variable">$_</span>.ContentId <span class="operator">-notlike</span> <span class="string">&#x27;conten*&#x27;</span>&#125; | % &#123;<span class="variable">$Cache</span>.DeleteCacheElement(<span class="variable">$_</span>.CacheElementID)&#125;</span><br></pre></td></tr></table></figure><h1 id="リモートによるクライアント-キャッシュのクリア方法"><a href="#リモートによるクライアント-キャッシュのクリア方法" class="headerlink" title="リモートによるクライアント キャッシュのクリア方法"></a>リモートによるクライアント キャッシュのクリア方法</h1><h2 id="方法-1：スクリプト機能"><a href="#方法-1：スクリプト機能" class="headerlink" title="方法 1：スクリプト機能"></a>方法 1：スクリプト機能</h2><p>MECM の標準機能であるスクリプト機能を利用して、デバイス単位、または、デバイス コレクションに登録されたデバイスに対して一括でキャッシュのクリアを実行いただけます。<br>上述でご案内している PowerShell コマンドレットを登録しておくだけで任意のタイミングで実行いただけますので是非ご活用ください。<br>なお、スクリプト機能は以下のブログにて詳細にご説明していますので、こちらをご確認ください。</p><p>Title:スクリプト機能のご紹介<br>URL:<a href="https://jpmem.github.io/blog/mecm/20211025_01/">https://jpmem.github.io/blog/mecm/20211025_01/</a></p><h2 id="方法-2：パッケージ配布"><a href="#方法-2：パッケージ配布" class="headerlink" title="方法 2：パッケージ配布"></a>方法 2：パッケージ配布</h2><p>方法の 2 つ目は PowerShell コマンドレットを PS1 形式のスクリプト ファイルにし、パッケージングして配布する方法です。<br>方法 1 のスクリプト機能とは異なり即時性はございませんが、定期的に削除するようスケジュール設定できるメリットがございます。<br>定期的にクライアント キャッシュ上のコンテンツを削除する運用を取り入れたい場合にはパッケージ配布機能をご選択ください。</p><ul><li>1）パッケージの作成</li></ul><ol><li>MECM コンソールにて、[ソフトウェア ライブラリ] - [概要] - [アプリケーション管理] - [パッケージ] を開きます。</li><li>[パッケージ] を右クリックし、[パッケージの作成] をクリックします。</li><li>[パッケージとプログラムの作成ウィザード] の [パッケージ] より、[名前] に任意の名前を入力し、[このパッケージにソース ファイルを含める] にチェックを入れます。</li><li>[ソース フォルダー] の参照ボタンをクリックし、上述にご案内している PowerShell コマンドレットの *.PS1 ファイルを、スクリプト ファイルの格納場所 (共有フォルダー パス) を指定し、[次へ] をクリックします。</li><li>[プログラムの種類] にて、[次へ] をクリックします。</li><li>[標準プログラム] にて、[名前] に任意の名前を指定し、ログオン状態に関わらずスクリプトを実行するために次のように指定します。<br>　・コマンドライン<br>　　-32bit OS の場合：powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File .&lt;ファイル名&gt;.ps1<br>　　-64bit OS の場合：%windir%\sysnative\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File .&lt;ファイル名&gt;.ps1<br>　　　　※&lt;ファイル名&gt;.ps1 の「ファイル名」には、事前に作成したスクリプト ファイルの名に変更ください。<br>　・プログラムの実行条件<br>　　ユーザーのログオン状態に関係なし<br>　・実行モード<br>　　管理者権限で実行する</li><li>[要件] より、[次へ] をクリックします。</li><li>[概要] より、設定内容を確認して、[次へ] をクリックします。</li><li>[完了] より、正常に完了したことを確認し、[閉じる] をクリックします。</li></ol><ul><li>2） パッケージの展開</li></ul><ol><li>作成したパッケージを右クリックし、[展開] をクリックします。</li><li>ソフトウェアの展開ウィザードの [全般] より、[参照] をクリックし、配布先のコレクションを指定して [次へ] をクリックします。</li><li>[コンテンツ] より、[追加] をクリックし配布ポイントを選択し、[次へ] をクリックします。</li><li>[展開設定] より、目的を “必須” に設定して、[次へ] をクリックします。</li><li>[スケジュール] より、[割り当てスケジュール] から [新規] をクリックします。</li><li>[割り当てスケジュール] より、[スケジュール] をクリックします。<br>  ※直ちに実行されたい場合は、[次のイベントの直後に割り当てる] の “直ちに” をご指定ください。</li><li>[カスタム スケジュール] ページにおいて開始時刻を設定し、繰り返しパターンを設定して [OK] をクリックします。</li><li>[割り当てスケジュール] より、[OK] をクリックします。</li><li>[スケジュール] にて、[再実行の動作] を [プログラムを常に再実行する] に設定して [次へ] をクリックします。</li><li>[ユーザー側の表示と操作] より、必要に応じて通知設定を設定し [次へ] をクリックします。</li><li>[配布ポイント] より、上段の展開オプションを [配布ポイントからプログラムを実行する] に設定し [次へ] をクリックします。</li></ol><p>※ご参考<br><img src="/blog/mecm/20220511_01/1.png" alt="image.png"><br>  注：[配布ポイントからコンテンツをダウンロードしてローカルで実行する] を選択した場合はコンテンツ実行に失敗するため、パッケージのダウンロードは行わないようにします。  </p><ol start="12"><li>[概要] より、設定内容を確認して、[次へ] をクリックします。  </li><li>[完了] より、正常に完了したことを確認し、[閉じる] をクリックします。</li></ol><p>展開完了後、クライアントが MECM とポーリングを行うと展開ポリシーをダウンロードして順次実行されますので、クライアント キャッシュ上のコンテンツが削除されるのを待ちます。</p><h2 id="応用：n-日前のコンテンツを削除"><a href="#応用：n-日前のコンテンツを削除" class="headerlink" title="応用：n 日前のコンテンツを削除"></a>応用：n 日前のコンテンツを削除</h2><p>クライアント キャッシュ上のコンテンツが一気に削除されるのは心配という場合には、以下にご紹介する PowerShell コマンドレットにて、現在の日にちより前のコンテンツを削除条件としていただくことも可能ですので、こちらのご利用もご検討ください。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$targetdate</span>=(<span class="built_in">Get-Date</span>).AddDays(<span class="literal">-xx</span>)</span><br><span class="line"><span class="variable">$UIResourceMgr</span> = <span class="built_in">New-Object</span> <span class="literal">-Com</span> <span class="string">&quot;UIResource.UIResourceMgr&quot;</span></span><br><span class="line"><span class="variable">$Cache</span> = <span class="variable">$UIResourceMgr</span>.GetCacheInfo()</span><br><span class="line"><span class="variable">$Cache</span>.GetCacheElements() | <span class="built_in">where</span> &#123;<span class="variable">$_</span>.LastReferenceTime <span class="operator">-lt</span> <span class="variable">$targetdate</span>&#125; | % &#123;<span class="variable">$Cache</span>.DeleteCacheElement(<span class="variable">$_</span>.CacheElementID)&#125;</span><br></pre></td></tr></table></figure><p>※「xx」の箇所については、現在の日時より前のコンテンツを削除する日数をご指定ください。<br>　 例えば、90 日前とする場合は、「$targetdate=(Get-Date).AddDays(-90)」とします。</p><ul><li>免責事項<br>当ブログ内でご紹介しているサンプル スクリプトは弊社環境で検証した上でご案内しておりますが、弊社にてその動作を保証するものではございません。<br>ご使用の際は、お客様の環境に合わせて変更いただき、十分にテストした上で、ご利用くださいますようお願いいたします。</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;/p&gt;
&lt;p&gt;Configuration Manager を利用したアプリケーションや更新プログラムの配布運用をされているなかで、管理対象クライアントに対して過去配布したコンテンツを一</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>WSUS メンテナンスガイド新版</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-05-09_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-05-09_01/</id>
    <published>2022-05-08T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.900Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。 WSUS サポート チームです。<br>今回は、 WSUS でご実施いただきたいメンテナンスについてご紹介します。<br>長期運用や利用状況に従って、 WSUS のパフォーマンスは低下してしまいます。<br>WSUS を安定稼働させるためには日頃のメンテナンスが非常に重要となります為、ご利用環境での定期的な実施をご検討ください。</p><p>A. IIS チューニング設定<br>B. カスタム インデックスの追加<br>C. WSUS DB インデックスの再構成<br>D. データベースの統計情報の更新とインデックスの再構築<br>E. 不要な更新プログラムを「拒否済み」にする<br>F. WSUS のクリーンアップ ウィザード  </p><h1 id="A-IIS-チューニング設定"><a href="#A-IIS-チューニング設定" class="headerlink" title="A. IIS チューニング設定"></a>A. IIS チューニング設定</h1><p>クライアントから大量のスキャンが要求された場合に、WsusPool でメモリのリサイクルが頻発することにより、IIS の保護機能が働き WsusPool が停止するという事象が発生することがあります。その為、予め IIS のチューニング設定を実施することがお勧めです。<br>※以下の値はあくまでも参考値ですので、ご利用環境に合わせてパフォーマンスモニターなどをご利用いただきご調整ください。</p><p>具体的な手順は以下のとおりです。</p><ol><li>WSUS サーバー上で IIS マネージャーを起動します。</li><li>左ペインより、アプリケーション プールを選択し、中央ペインに表示された WsusPool を右クリックして [詳細設定] をクリックします。</li><li>以下の設定を行い、[OK] をクリックします。</li></ol><p>[(全般)] -&gt; [キューの長さ] : 2000<br>[CPU] -&gt; [制限 (%)] : 0<br>[ラピッド フェール保護] -&gt; [エラー間隔 (分)] : 30<br>[ラピッド フェール保護] -&gt; [最大エラー数] : 60<br>[リサイクル] -&gt; [プライベート メモリ制限 (KB)] : 8000000 (※)<br>[リサイクル] -&gt; [仮想メモリ制限 (KB)] : 0</p><p>(※) サーバーのメモリ搭載量が 8 GB 未満の場合は、4000000 に設定することをお勧めします。<br>搭載量が 20 GB を超える場合は、場合によって 16000000 など大きな値にしても問題ありません。</p><h1 id="B-カスタム-インデックスの追加"><a href="#B-カスタム-インデックスの追加" class="headerlink" title="B. カスタム インデックスの追加"></a>B. カスタム インデックスの追加</h1><p>データベースにカスタム インデックスを追加しておくことで、クエリパフォーマンスを向上させることができます。<br>予めカスタム インデックスを追加しておくことがお勧めです。</p><p>具体的な手順は以下のとおりです。</p><p>SUSDB データベースでカスタム インデックスを作成するために使用します。<br>これは 一度限りの作業であり、データベースのパフォーマンスを大幅に向上させることができるため、<br>実施いただくことを推奨しております。手順は以下の通りです。</p><ol><li>SQL Server Management Studio を管理者権限を持つアカウントで起動して、WSUS データベースに接続します。  </li></ol><p><img src="/blog/wsus/2022-05-09_01/2022-05-09_01_1.png">  </p><p>サーバーの種類 : データベース エンジン<br>サーバー名 :<br>Windows Internal Database をご利用の場合</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\.\pipe\Microsoft##WID\tsql\query</span><br></pre></td></tr></table></figure><p>SQL サーバーをご利用の場合</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">サーバー名を入力</span><br></pre></td></tr></table></figure><p>認証 : Windows 認証</p><ol start="2"><li>[新しいクエリ] をクリックし、クエリ ウィンドウに以下の SQL を入力して [実行] をクリックします。<br><img src="/blog/wsus/2022-05-09_01/2022-05-09_01_2.png">  </li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-- Create custom index in tbLocalizedPropertyForRevision</span><br><span class="line">USE [SUSDB]</span><br><span class="line"></span><br><span class="line">CREATE NONCLUSTERED INDEX [nclLocalizedPropertyID] ON [dbo].[tbLocalizedPropertyForRevision]</span><br><span class="line">(</span><br><span class="line">     [LocalizedPropertyID] ASC</span><br><span class="line">)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Create custom index in tbRevisionSupersedesUpdate</span><br><span class="line">CREATE NONCLUSTERED INDEX [nclSupercededUpdateID] ON [dbo].[tbRevisionSupersedesUpdate]</span><br><span class="line">(</span><br><span class="line">     [SupersededUpdateID] ASC</span><br><span class="line">)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]</span><br></pre></td></tr></table></figure><ol start="3"><li>SQL Server Management Studio を閉じます。  </li></ol><p>(補足) 以下のようなエラーが発生した場合には、既にカスタムインデックスが作成されていることを示します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">メッセージ 1913、レベル 16、状態 1、行 4</span><br><span class="line">&#x27;nclLocalizedPropertyID&#x27; という名前のインデックスまたは統計が既に テーブル &#x27;dbo.tbLocalizedPropertyForRevision&#x27; に存在するので、この操作に失敗しました。</span><br></pre></td></tr></table></figure><p>参考 <a href="https://docs.microsoft.com/ja-JP/troubleshoot/mem/configmgr/wsus-maintenance-guide#create-custom-indexes">カスタムインデックスを作成する</a></p><h1 id="C-WSUS-DB-インデックスの再構成"><a href="#C-WSUS-DB-インデックスの再構成" class="headerlink" title="C. WSUS DB インデックスの再構成"></a>C. WSUS DB インデックスの再構成</h1><p>運用継続に伴い、データベースが劣化しパフォーマンスが低下していきます。<br>インデックスの再構成を実施することにより、断片化比率に応じてデータベースのパフォーマンスを改善します。<br>手順については以下のブログでご紹介しておりますのでご参照ください。<br><a href="https://jpmem.github.io/blog/wsus/2014-03-05_01/">WSUS DB インデックスの再構成の手順について</a></p><h1 id="D-データベースの統計情報の更新とインデックスの再構築"><a href="#D-データベースの統計情報の更新とインデックスの再構築" class="headerlink" title="D. データベースの統計情報の更新とインデックスの再構築"></a>D. データベースの統計情報の更新とインデックスの再構築</h1><p>A. ～ C. を継続的に実施いただいているご状況でもなお、パフォーマンスの低下が見られる場合には、データベース パフォーマンスの改善を目的として、統計情報の更新クエリ (update statistics)、インデックスの再構築 (DBCC DBREINDEX) をご実施ください。<br>※ C. との内容の違いとして、C. は断片化比率に応じてインデックスの再構成を実施していることに対して、D. では全テーブル全インデックスを対象としてインデックスの再構築と統計情報の更新を行っています。  </p><ol><li>SQL Server Management Studio を管理者権限を持つアカウントで起動して、WSUS データベースに接続します。  </li></ol><p><img src="/blog/wsus/2022-05-09_01/2022-05-09_01_1.png">  </p><p>サーバーの種類 : データベース エンジン<br>サーバー名 :<br>Windows Internal Database をご利用の場合  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\.\pipe\Microsoft##WID\tsql\query</span><br></pre></td></tr></table></figure><p>SQL サーバーをご利用の場合  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">サーバー名を入力</span><br></pre></td></tr></table></figure><p>認証 : Windows 認証  </p><ol start="2"><li>[新しいクエリ] をクリックし、クエリ ウィンドウに以下の SQL を入力して [実行] をクリックします。<br><img src="/blog/wsus/2022-05-09_01/2022-05-09_01_2.png">  </li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Use SUSDB</span><br><span class="line">exec sp_msforeachtable &#x27;update statistics ? with fullscan&#x27;</span><br><span class="line">Go</span><br><span class="line"></span><br><span class="line">Use SUSDB</span><br><span class="line">Exec sp_MSForEachtable &#x27;DBCC DBREINDEX (&#x27;&#x27;?&#x27;&#x27;)&#x27;</span><br><span class="line">Go</span><br></pre></td></tr></table></figure><p>処理には数時間を要する場合がございます。完了するまでお待ちください。</p><h1 id="E-不要な更新プログラムを「拒否済み」にする"><a href="#E-不要な更新プログラムを「拒否済み」にする" class="headerlink" title="E. 不要な更新プログラムを「拒否済み」にする"></a>E. 不要な更新プログラムを「拒否済み」にする</h1><p>不要な更新プログラムを 「拒否済み」にすることで、 クライアントがスキャン処理をする対象の更新プログラムを減らすことができる為、WSUS の負荷を下げることにつながります。<br>実施内容については、以下のブログをご参照ください。</p><p><a href="https://jpmem.github.io/blog/wsus/2017-12-11_01/">不要な更新プログラムは「拒否済み」に設定しよう！</a></p><h1 id="F-WSUS-のクリーンアップ-ウィザード"><a href="#F-WSUS-のクリーンアップ-ウィザード" class="headerlink" title="F. WSUS のクリーンアップ ウィザード"></a>F. WSUS のクリーンアップ ウィザード</h1><p>WSUS の機能としてクリーンアップウィザードがございます。こちらについても定期的な実施をお勧めしております。<br>各実施内容については以下のブログでご紹介しておりますのでご参照ください。<br><a href="https://jpmem.github.io/blog/wsus/2017-12-05_01/">WSUS のクリーンアップ ウィザードについて</a></p><p>※階層構成（レプリカ）の WSUS をご利用の場合には、実施順序にご留意いただく必要がございます。<br>以下のブログをご参照ください。<br><a href="https://jpmem.github.io/blog/wsus/2012-06-07_01/">レプリカ構成では サーバー クリーンアップ ウィザード にご注意ください</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。 WSUS サポート チームです。&lt;br&gt;今回は、 WSUS でご実施いただきたいメンテナンスについてご紹介します。&lt;br&gt;長期運用や利用状況に従って、 WSUS のパフォーマンスは低下してしまいます。&lt;br&gt;WSUS を安定稼働させるためには日頃のメ</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>クラウド管理ゲートウェイ (CMG) の構築手順例</title>
    <link href="https://jpmem.github.io/blog/mecm/20220501_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220501_01/</id>
    <published>2022-04-30T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.800Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>本日は、クラウド管理ゲートウェイ (CMG) の構築手順例をご案内させていただきます。</p><p>なお、本記事の画面は Micorosoft Endpoint Manager Configuration Manager  (MECM) Current Branch (CB) 2203 のものです。他の Version では画面が異なる場合があります。</p><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><p>本構築例は以下の条件を前提としています。なお、以下で上げられている内容は CMG の設計段階で定めておくと良いでしょう。</p><ol><li>仮想マシン スケールセットを利用する。</li><li>数台のクライアントを管理する、ラボ環境としてのクラウド管理ゲートウェイ (CMG) を構築する。ラボ環境のため可用性は考慮しない。</li><li>上記のため、CMG は東日本リージョンに B2S インスタンスを 1 台のみ作成する。</li><li>この CMG はリバースプロキシ、及びクラウド上の配布ポイントとして利用する。</li><li>手順簡略化のため、以下で説明しているクライアント認証方式のうち、サイト トークン認証を選択する。<br>クラウド管理ゲートウェイ (CMG) の設計ポイントについて (1)<br><a href="https://jpmem.github.io/blog/mecm/20220328_01/#CMG-%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E8%AA%8D%E8%A8%BC">https://jpmem.github.io/blog/mecm/20220328_01/#CMG-%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E8%AA%8D%E8%A8%BC</a></li><li>サーバー証明書は別途プライベート CA で作成し、利用するものとする。</li><li>管理対象となるクライアントはオンプレミス AD に参加していない端末 (ワーク グループ) 端末とする。</li><li>管理対象となるクライアントに対して、サーバー証明書を発行した CA のルート証明書は別途ファイルコピーで配布する。</li><li>管理対象となるクライアントは、レジストリで「常にインターネット」フラグを有効化することで CMG を選択させる。</li><li>最上位サイトサーバーに存在する、サービス接続ポイントは Proxy サーバーを介さず、直接インターネットに接続出来る。</li><li>最上位サイトサーバーに管理ポイントとクラウド管理ゲートウェイ接続ポイント、ソフトウェア更新ポイントの役割を持たせる。</li><li>サイト システム間の通信は「拡張 HTTP 方式」とする。<br>Configuration Managerにおける拡張 HTTP の確認方法<br><a href="https://jpmem.github.io/blog/mecm/20220122_01/">https://jpmem.github.io/blog/mecm/20220122_01/</a>  </li><li>Azure サブスクリプションに紐付けられた、Azure AD のサブスクリプション共同管理者権限兼グローバル管理者権限アカウントを利用して作業出来る。</li><li>ラボ環境上には DNS サーバーが用意されており、こちらを利用して、管理対象となるクライアントは CMG のドメイン名を解決出来る。そのために、[ホスト名].[リージョン名].cloudapp.azure.com の CNAME をラボの DNS サーバーに登録する。</li><li>クラウド接続アナライザでの認証テストのため、Azure AD のユーザー情報を MECM サーバーと連携する。</li></ol><h2 id="事前に決めておくべきもの"><a href="#事前に決めておくべきもの" class="headerlink" title="事前に決めておくべきもの"></a>事前に決めておくべきもの</h2><p>以下の項目について事前に決めておきましょう。</p><ol><li>MECM 上の 「Azure サービス」名。</li><li>Azure AD 上のクラウド管理アプリケーションのうち、「Web アプリ」名、「ネイティブ クライアント　アプリ」名。</li><li>クラウド管理ゲートウェイのホスト名。本ホスト名は、Azure 上の 公開 URL にもなるので、URL 全体として(リージョン名を含めて) 世界で唯一である必要があります。</li></ol><h2 id="構築手順"><a href="#構築手順" class="headerlink" title="構築手順"></a>構築手順</h2><p>大凡以下が全体の流れとなります。</p><ol><li>Azure リソース プロバイダーの確認</li><li>クライアント設定の確認</li><li>Azure AD アプリケーションの作成</li><li>クラウド管理ゲートウェイの作成</li><li>DNS への CNAME 登録</li><li>クラウド管理ゲートウェイ接続ポイントの作成</li><li>管理ポイント、ソフトウェア更新ポイントの設定</li><li>クラウド接続アナライザの実施</li><li>クライアントでの接続検証</li></ol><h3 id="Azure-リソース-プロバイダーの確認"><a href="#Azure-リソース-プロバイダーの確認" class="headerlink" title="Azure リソース プロバイダーの確認"></a>Azure リソース プロバイダーの確認</h3><p>CMG が利用する以下のリソース プロバイダーの登録状況を確認します。<br>以下の画面で、リソース プロバイダーがそれぞれ ”Registered” 状態になっているかを確認し、”NotRegistered” になっている場合は画面上部の「登録」ボタンをクリックして ”Registered” 状態に変更してください。</p><ol><li>Microsoft.Compute</li><li>Microsoft.Storage</li><li>Microsoft.KeyVault</li><li>Microsoft.Network</li></ol><p>[Azure Portal] - [サブスクリプション] - ご利用のサブスクリプションを選択 - [リソース プロバイダー] ブレード</p><p><img src="/blog/mecm/20220501_01/20220501_01_01.png" alt="image.png"></p><h3 id="クライアント設定の確認"><a href="#クライアント設定の確認" class="headerlink" title="クライアント設定の確認"></a>クライアント設定の確認</h3><p>クライアントに対して CMG への接続を許可するクライアント設定を行います。一部のクライアントに対してだけ接続を許可する場合は、カスタム クライアント設定を使ってください。</p><ul><li>[CM コンソール] - [管理] - [概要] - [クライアント設定] - 対象のクライアント設定を選択 - [プロパティ] - [クラウド サービス]<ul><li>[クライアントでクラウド管理ゲートウェイを使用できるようにする] を 「はい」に</li><li>[クラウド配布ポイントへのアクセスを許可する] を 「はい」に</li></ul></li></ul><p><img src="/blog/mecm/20220501_01/20220501_01_02.png" alt="image.png"></p><h3 id="Azure-AD-アプリケーションの作成"><a href="#Azure-AD-アプリケーションの作成" class="headerlink" title="Azure AD アプリケーションの作成"></a>Azure AD アプリケーションの作成</h3><p>以下の手順で Azure AD アプリケーションを作成します。</p><ol><li>[CM コンソール] - [管理] - [概要] - [クラウド サービス] - [Azure サービス] - [Azure サービスの構成]  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_03.png" alt="image.png"></p><ol start="2"><li>[Azure サービス ウィザード]が表示されるので、「クラウド管理」が選択されていることを確認して、名前を入力し、「次へ」  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_04.png" alt="image.png"></p><ol start="3"><li>[Azure 環境]として [AzurePublicCloud] が選択されていることを確認して、[Web アプリ]の行の「参照」ボタンをクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_05.png" alt="image.png"></p><ol start="4"><li>「サーバー アプリ」ダイアログが表示されるので、「作成」ボタンをクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_06.png" alt="image.png"></p><ol start="5"><li>「サーバー アプリケーションの作成」ダイアログで「アプリケーション名」を入力し、「サインイン」ボタンをクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_07.png" alt="image.png"></p><ol start="6"><li>Azure AD アカウントのログイン画面が表示されるので、Azure AD のグローバル管理者権限を持つアカウントでログインします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_08.png" alt="image.png"></p><ol start="7"><li>ログインに成功すると赤枠の通り、「正常にサインインしました。」と表示されるので、「OK」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_09.png" alt="image.png"></p><ol start="8"><li>無事アプリケーションが追加されたことを確認して、「OK」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_10.png" alt="image.png"></p><ol start="9"><li>続けてネイティブ クライアント アプリの項目で「参照」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_11.png" alt="image.png"></p><ol start="10"><li>「クライアント アプリ」ダイアログで「作成」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_12.png" alt="image.png"></p><ol start="11"><li>「クライアント アプリケーションの作成」ダイアログで「アプリケーション名」を入力し、「サインイン」ボタンをクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_13.png" alt="image.png"></p><ol start="12"><li>Azure AD アカウントのログイン画面が表示されるので、Azure AD のグローバル管理者権限を持つアカウントでログインします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_08.png" alt="image.png"></p><ol start="13"><li>ログインに成功すると赤枠の通り、「正常にサインインしました。」と表示されるので、「OK」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_14.png" alt="image.png"></p><ol start="14"><li>「クライアント アプリ」ダイアログで「OK」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_15.png" alt="image.png"></p><ol start="15"><li>「アプリのプロパティ」で各アプリの名前が指定されているのを確認して、「次へ」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_16.png" alt="image.png"></p><ol start="16"><li>「検出の設定の構成」ステップで「Azure Active Directory ユーザーの探索を有効にする」を有効化にしたまま、「次へ」をクリックします。(クラウド接続アナライザにて グローバル 管理者アカウントを使ったAzure AD 認証テストを行うためにAzure AD ユーザー同期を使います)  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_17.png" alt="image.png"></p><ol start="17"><li>「設定の確認」ステップで内容を確認し、「次へ」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_18.png" alt="image.png"></p><ol start="18"><li>「完了」ステップで「閉じる」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_19.png" alt="image.png"></p><h3 id="クラウド管理ゲートウェイの作成"><a href="#クラウド管理ゲートウェイの作成" class="headerlink" title="クラウド管理ゲートウェイの作成"></a>クラウド管理ゲートウェイの作成</h3><p>以下の手順でクラウド管理ゲートウェイを作成します。事前にサーバー証明書をサイトサーバーにアップロードしておきましょう。</p><ol><li>[CM 管理コンソール] - [管理] - [概要] - [クラウド サービス] - [クラウド管理ゲートウェイ] - [クラウド管理ゲートウェイの作成]</li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_20.png" alt="image.png"></p><ol start="2"><li>「クラウド管理ゲートウェイの作成ウィザード」が起動したら、Azure 環境として「AzurePublicCloud」が選択されていることを確認して、「サインイン」ボタンをクリックします。</li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_21.png" alt="image.png"></p><ol start="3"><li>Azure AD アカウントのログイン画面が表示されるので、Azure サブスクリプションの共同管理者権限を持つアカウントでログインします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_08.png" alt="image.png"></p><ol start="4"><li>ログイン後、赤枠の「正常にサインインしました。」が表示されていること、利用するサブスクリプションが選択されていることを確認して、「次へ」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_22.png" alt="image.png"></p><ol start="5"><li>証明書ファイルの「参照」ボタンをクリックして、CMG 用のサーバー証明書を選択します。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_23.png" alt="image.png"></p><ol start="6"><li>「サービス名」、「展開名」が指定されていることを確認します。(ワイルドカード証明書を利用している場合、サービス名は別途入力します。)</li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_24.png" alt="image.png"></p><ol start="7"><li>「地域」を「東日本」、「リソースグループの新規作成要否」を「新規作成」、「VM サイズ」を ラボ (B2S) 、「VM インスタンス数」を 「1」に設定し、「次へ」をクリックします。なお、このときの展開名をメモしておきます。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_25.png" alt="image.png"></p><ol start="8"><li>「アラート」は特に設定せず、「次へ」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_26.png" alt="image.png"></p><ol start="9"><li>設定内容を確認して、「次へ」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_27.png" alt="image.png"></p><ol start="10"><li>「閉じる」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_28.png" alt="image.png"></p><ol start="11"><li>クラウド管理ゲートウェイの作成が完了するのを待ちます。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_29.png" alt="image.png"></p><ol start="12"><li>ステータスが「準備完了」になれば構築完了です。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_31.png" alt="image.png"></p><h3 id="DNS-への-CNAME-登録"><a href="#DNS-への-CNAME-登録" class="headerlink" title="DNS への CNAME 登録"></a>DNS への CNAME 登録</h3><ol><li>上記でメモしておいた展開名とサービス名の対応を CNAME として DNS に登録します。以下は Winodws Server の DNS を利用されている場合の例となります。</li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_30.png" alt="image.png"></p><h3 id="クラウド管理ゲートウェイ接続ポイントの作成"><a href="#クラウド管理ゲートウェイ接続ポイントの作成" class="headerlink" title="クラウド管理ゲートウェイ接続ポイントの作成"></a>クラウド管理ゲートウェイ接続ポイントの作成</h3><ol><li>[CM コンソール] - [管理] - [概要] - [サイトの構成] - [サーバーとサイト システムの役割] - 対象のサイト システムを選択 - [サイト システムの役割を追加]  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_32.png" alt="image.png"></p><ol start="2"><li>「サイト システムの役割の追加」ウィザードが起動する。「次へ」をクリック。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_33.png" alt="image.png"></p><ol start="3"><li>プロキシは使わないので、「次へ」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_34.png" alt="image.png"></p><ol start="4"><li>「クラウド管理ゲートウェイ接続ポイント」を選択して「次へ」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_35.png" alt="image.png"></p><ol start="5"><li>作成したクラウド管理ゲートウェイとリージョンが選択されているのを確認して「次へ」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_36.png" alt="image.png"></p><ol start="6"><li>設定内容を確認して「次へ」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_37.png" alt="image.png"></p><ol start="7"><li>設定完了。「閉じる」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_40.png" alt="image.png"></p><h3 id="管理ポイント、ソフトウェア更新ポイントの設定"><a href="#管理ポイント、ソフトウェア更新ポイントの設定" class="headerlink" title="管理ポイント、ソフトウェア更新ポイントの設定"></a>管理ポイント、ソフトウェア更新ポイントの設定</h3><ol><li><p>以下 URL の内容に従って各役割の通信方式が拡張 HTTP 方式になっているか確認する。<br>Configuration Managerにおける拡張 HTTP の確認方法<br><a href="https://jpmem.github.io/blog/mecm/20220122_01/">https://jpmem.github.io/blog/mecm/20220122_01/</a></p></li><li><p>[CM コンソール] - [管理] - [概要] - [サイトの構成] - [サーバーとサイト システムの役割] - 対象のサイト システムを選択 - 画面下部 - [管理ポイント] を選択- [プロパティ]</p></li><li><p>「全般」タブで「Configuration Manager のクラウド管理ゲートウェイ トラフィックを許可する」を有効化し、下部から「インターネットのみの接続を許可する」か「イントラネットとインターネットの接続を許可する」を選択して、OK をクリックします。</p></li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_38.png" alt="image.png"></p><ol start="4"><li><p>[CM コンソール] - [管理] - [概要] - [サイトの構成] - [サーバーとサイト システムの役割] - 対象のサイト システムを選択 - 画面下部 - [ソフトウェアの更新ポイント] を選択- [プロパティ]</p></li><li><p>「全般」タブで「Configuration Manager のクラウド管理ゲートウェイ トラフィックを許可する」を有効化し、下部から「インターネットのみのクライアント接続を許可する」か「インターネットおよびイントラネット クライアント接続を許可する」を選択して、OK をクリックします。</p></li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_39.png" alt="image.png"></p><h3 id="クラウド接続アナライザーの実施"><a href="#クラウド接続アナライザーの実施" class="headerlink" title="クラウド接続アナライザーの実施"></a>クラウド接続アナライザーの実施</h3><p>構築が完了したら、サーバー間の通信が問題無いかを確認するためにクラウド接続アナライザーを実行します。</p><ol><li>[CM 管理コンソール] - [管理] - [概要] - [クラウド サービス] - [クラウド管理ゲートウェイ] - 対象のクラウド管理ゲートウェイを選択 - [接続アナライザー]  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_41.png" alt="image.png"></p><ol start="2"><li>「クラウド管理ゲートウェイ接続アナライザー」が起動する。「Azure ADのユーザー」が選択されていることを確認して、「サインイン」をクリックし、検証用にAzure AD グローバル管理者のアカウントでログインします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_42.png" alt="image.png"></p><ol start="3"><li>正常にサインインすると赤枠の中に「正常にサインインしました。」と表示されるので、「開始」をクリックします。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_43.png" alt="image.png"></p><ol start="4"><li>問題無く完了すると 6 つのテスト項目全てで緑色のアイコンで合格と示されます。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_44.png" alt="image.png"></p><h3 id="クライアントでの接続検証"><a href="#クライアントでの接続検証" class="headerlink" title="クライアントでの接続検証"></a>クライアントでの接続検証</h3><h4 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h4><ol><li>クライアントにサーバー証明書を発行した CA のルート証明書をインストールしておきます。</li><li>MECM クライアントバイナリをクライアントに設置しておきます。</li></ol><h4 id="一括登録トークンの発行"><a href="#一括登録トークンの発行" class="headerlink" title="一括登録トークンの発行"></a>一括登録トークンの発行</h4><ol><li>プライマリ サイト サーバーにアクセスします。</li><li>コマンドプロンプトを管理者権限で開きます。</li><li>カレント フォルダを 以下に移動します。  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[MECM インストール フォルダ]\bin\x64</span><br></pre></td></tr></table></figure></li><li>以下のコマンドを実行します。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bulkregistrationtokentool.exe /new</span><br></pre></td></tr></table></figure><ol start="5"><li>以下の形でトークンが発行されるので、赤枠の箇所をコピーしてクライアントに渡します。(秘密情報のため途中でトークンを塗りつぶしています)  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_45.png" alt="image.png"></p><h4 id="CMG-URL-の取得"><a href="#CMG-URL-の取得" class="headerlink" title="CMG URL の取得"></a>CMG URL の取得</h4><ol><li>プライマリ サイト サーバーにアクセスします。</li><li>SQL Server Management Studio を起動します。</li><li>下記画面で「接続」をクリックします。<br><img src="/blog/mecm/20220501_01/20220501_01_47.png" alt="image.png"></li><li>サイト データベースのアイコン (CM_[サイト コード])を右クリックし、「新しいクエリ」を選択します。<br><img src="/blog/mecm/20220501_01/20220501_01_48.png" alt="image.png"></li><li>サイト データベース に対して以下のクエリを実行します。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [MutualAuthPath]  </span><br><span class="line"><span class="keyword">FROM</span> [dbo].[vProxy_Roles]  </span><br><span class="line"><span class="keyword">Where</span> [RoleTypeID] <span class="operator">=</span> <span class="string">&#x27;6&#x27;</span></span><br></pre></td></tr></table></figure></li><li>取得した URL をメモしておきます。  </li></ol><p><img src="/blog/mecm/20220501_01/20220501_01_49.png" alt="image.png"></p><h4 id="MECM-クライアントのインストール"><a href="#MECM-クライアントのインストール" class="headerlink" title="MECM クライアントのインストール"></a>MECM クライアントのインストール</h4><ol><li><p>クライアントにアクセスします。</p></li><li><p>コマンド プロンプトを管理者権限で開きます。</p></li><li><p>カレント フォルダをクライアント バイナリ (ccmsetup.exe ファイルを置いたフォルダー) の場所に移動します。</p></li><li><p>以下のコマンドで MECM クライアントをインストールします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ccmsetup.exe /NoCRLCheck /source:[クライアント バイナリの場所] SMSSITECODE=[接続先サイト コード] CCMHOSTNAME=&quot;[取得した CMG URL]&quot; SMSMP=&quot;[管理ポイントのFQDN]&quot; /regtoken:[取得した一括登録トークン] CCMALWAYSINF=1</span><br></pre></td></tr></table></figure><p><img src="/blog/mecm/20220501_01/20220501_01_46.png" alt="image.png"></p></li><li><p>上記実行後、C:\Windows\CCM\Logs\ClientIDManagerStartup.log に以下のログが出力されていたらインストール及びデバイス登録成功。</p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[RegTask] - Client is registered. Server assigned ClientID is GUID:A4AC8F79-FADE-4758-84B9-C8D5F2F56310. Approval status 1ClientIDManagerStartup2022/05/02 14:43:586488 (0x1958)</span><br></pre></td></tr></table></figure><h4 id="MECM-クライアントの接続確認"><a href="#MECM-クライアントの接続確認" class="headerlink" title="MECM クライアントの接続確認"></a>MECM クライアントの接続確認</h4><p>以下のログが出力されていたら CMG をリバースプロキシとして接続できていることを確認できます。</p><ol><li>C:\Windows\CCM\Logs\CcmMessaging.log<br>クライアントから CMG への状態メッセージ伝達がHRESULT = “0x00000000” とエラー無しで終了している。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Raising event:</span><br><span class="line">instance of CCM_CcmHttp_Status</span><br><span class="line">&#123;</span><br><span class="line">ClientID = &quot;GUID:A4AC8F79-FADE-4758-84B9-C8D5F2F56310&quot;;</span><br><span class="line">DateTime = &quot;20220502055308.653000+000&quot;;</span><br><span class="line">HostName = &quot;TKCMG01.EPLUS.LOCAL&quot;;</span><br><span class="line">HRESULT = &quot;0x00000000&quot;;</span><br><span class="line">ProcessID = 9596;</span><br><span class="line">StatusCode = 0;</span><br><span class="line">ThreadID = 9580;</span><br><span class="line">&#125;;</span><br><span class="line">CcmMessaging2022/05/02 14:53:089580 (0x256C)</span><br></pre></td></tr></table></figure><ol start="2"><li>C:\Windows\CCM\Logs\DataTransferService.log<br>クライアントから CMG 経由で管理ポイントへ行われた通信のジョブが成功している。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataTransferService: DTSJob(&#123;1BBCC127-0677-4E8B-AC26-8F1905884EF6&#125;) - created to download from &#x27;https://TKCMG01.EPLUS.LOCAL:443/CCM_Proxy_ServerAuth/72057594037927939/SMS_MP&#x27; to &#x27;C:\Windows\CCM\CIDownloader\Staging&#x27;.DataTransferService2022/05/02 14:44:408544 (0x2160)</span><br><span class="line">DTSJob(&#123;1BBCC127-0677-4E8B-AC26-8F1905884EF6&#125;): Job has completed: Status : SUCCESS, Start time : 05/02/2022 14:44:40, Completion time : 05/02/2022 14:44:41, Elapsed time : 0 secondsDataTransferService2022/05/02 14:44:418236 (0x202C)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;本日は、クラウド管理ゲートウェイ (CMG) の構築手順例をご案内させていただきます。&lt;/p&gt;
&lt;p&gt;なお、本記事の画面は Micorosoft Endpoint M</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
    <category term="CMG" scheme="https://jpmem.github.io/blog/tags/CMG/"/>
    
  </entry>
  
  <entry>
    <title>Configuration Manager の自動展開規則と WSUS の自動承認規則について</title>
    <link href="https://jpmem.github.io/blog/mecm/20220426_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220426_01/</id>
    <published>2022-04-25T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.788Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは。Configuration Manager サポート チームです。<br>今回は Configuration Manager の自動展開規則と WSUS の自動承認規則について各々概要を紹介いたします。  </p><p>自動展開規則と自動承認規則は双方ともに、新たに Configuration Manager 及び WSUS に同期した更新プログラムをクライアントへ自動的に展開する方法として用意された機能でございます。</p><h2 id="Configuration-Manager-の自動展開規則について"><a href="#Configuration-Manager-の自動展開規則について" class="headerlink" title="Configuration Manager の自動展開規則について"></a>Configuration Manager の自動展開規則について</h2><p>Configuration Manager の自動展開規則の機能を利用しますと、Windows OS 向けにリリースされた更新プログラムや Microsoft Defender の定義ファイルをクライアント コンピューターに自動的に展開することができます。</p><p><img src="/blog/mecm/20220426_01/2.png" alt="image.png"></p><p>自動展開規則は、Configuration Manager のソフトウェア更新プログラムの展開機能と同様にデバイス コレクションに対して展開を行います。  </p><p>一例としましては、Windows 10 version 21H2 のクライアントのみを含むデバイス コレクションを作成し、そちらのデバイス コレクションに対し、Windows 10 version 21H2 用の月例品質更新プログラムを自動展開規則で展開するという運用が考えられます。</p><p><img src="/blog/mecm/20220426_01/3.png" alt="image.png"></p><p>自動展開規則のプロパティ フィルターでは、いくつかの種類のフィルターが用意されており、設定したフィルターの条件を満たすソフトウェア更新プログラムが自動展開規則で展開されます。<br>なお、プロパティ フィルターはアンド条件でございますので、フィルターを設定いただいた数だけ条件が絞られていく動作となります。<br>例えば、下の画像に記載されているプロパティ フィルターの条件は、Windows 10 の毎月の定例セキュリティ更新プログラムを配信する設定でございます。</p><p><img src="/blog/mecm/20220426_01/4.png" alt="image.png"></p><p>公開情報でも自動展開規則の作成方法を紹介しておりますのでご参考にしてくださいませ。<br>Title : Configuration Manager を使用して定義の更新プログラムを配信する<br>URL : <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/protect/deploy-use/endpoint-definitions-configmgr">https://docs.microsoft.com/ja-jp/mem/configmgr/protect/deploy-use/endpoint-definitions-configmgr</a></p><p>また、Microsoft Defender の定義ファイルにつきましては、1 日に 複数回リリースされるため、Configuration Manager で配信する場合は、自動展開規則を作成することをお勧めいたします。<br>また、Configuration Manager から定義ファイルを配信する上でできる限りクライアントがダウンロードされる容量を少なくする方法について、自動展開規則のプロパティ フィルターを使用して Configuration Manager に同期された更新プログラムから Microsoft Defender の定義ファイルだけを自動展開するように構成する必要がありますが、この設定においてクライアントにダウンロードされる容量を少なくするためのポイントがあります。それは 「置き換えられる」 を「いいえ」に設定すること です。</p><p><img src="/blog/mecm/20220426_01/8.png" alt="image.png"></p><p>詳細は以下のブログで紹介しております。  </p><p>Title : Microsoft Defender / System Center Endpoint Protection の定義ファイルのダウンロードの最適化について<br>URL : <a href="https://jpmem.github.io/blog/mecm/20180308_01/">https://jpmem.github.io/blog/mecm/20180308_01/</a></p><h2 id="WSUS-の自動承認規則について"><a href="#WSUS-の自動承認規則について" class="headerlink" title="WSUS の自動承認規則について"></a>WSUS の自動承認規則について</h2><p>Configuration Manager の自動展開規則と似た機能として WSUS では自動承認規則が用意されております。<br>ただし、自動承認規則が自動展開規則と異なる部分としては、規則作成の際の条件として指定可能な項目が少ないという違いがあります。</p><p>WSUS の自動承認規則を利用しますと、Windows OS 向けにリリースされた更新プログラムや Defender のセキュリティ インテリジェンス更新プログラムをクライアント コンピューターが属するコンピューター グループに対し自動的に承認することができます。</p><p><img src="/blog/mecm/20220426_01/5.png" alt="image.png"></p><p>自動承認規則の規則の追加では、ステップ 1 で 3 種類のプロパティが用意されており、ステップ 2 でプロパティの条件を詳細に指定します。自動承認規則はこちらのプロパティの条件に従いソフトウェア更新プログラムを自動的に承認します。<br>なお、規則の追加については Configuration Manager の自動展開規則と同様にアンド条件でございますので、プロパティを設定いただいた数だけ条件が絞られていく動作となります。</p><p><img src="/blog/mecm/20220426_01/7.png" alt="image.png"></p><p>公開情報でも自動承認規則の作成方法を紹介しておりますのでご参考にしてくださいませ。<br>Title : 3.2. 自動承認規則を構成する<br>URL : <a href="https://docs.microsoft.com/ja-jp/windows-server/administration/windows-server-update-services/deploy/3-approve-and-deploy-updates-in-wsus#BKM_3.2.a">https://docs.microsoft.com/ja-jp/windows-server/administration/windows-server-update-services/deploy/3-approve-and-deploy-updates-in-wsus#BKM_3.2.a</a>.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;皆様こんにちは。Configuration Manager サポート チームです。&lt;br&gt;今回は Configuration Manager の自動展開規則と WSUS の自動承認規則について各々概要を紹介いたします。  &lt;/p&gt;
&lt;p&gt;自動展開規則と自動承認規則は双方とも</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Chromium Edge 更新プログラムを WSUS で配布する方法</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-04-22_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-04-22_01/</id>
    <published>2022-04-21T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.892Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。 WSUS サポート チームです。</p><p>長年皆様にご愛用いただいた Internet Explore のサポートの終了が 2022 年 6 月 15 日に予定されていることが発表されました。<br>それに伴い、 Chromium Edge 更新プログラムを WSUS から配信したいとのお問い合わせも増えてきております。<br>そこで、今回は WSUS から Chromium Edge へ更新プログラムを配信する方法をご紹介します。  </p><p>( ※ Internet Explore のサポートの終了については、こちらから最新情報、 Q&amp;A などをご確認ください。)<br><a href="https://jpdsi.github.io/blog/internet-explorer-microsoft-edge/internet-explorer-app-end-of-support/">Internet Explorer 11 デスクトップ アプリのサポート終了へ! IE モードへの移行を進めましょう!</a><br><a href="https://techcommunity.microsoft.com/t5/windows-it-pro-blog/internet-explorer-11-desktop-app-retirement-faq/ba-p/2366549">Internet Explorer 11 desktop app retirement FAQ</a>  </p><h3 id="WSUS-から-Chromium-Edge-更新プログラム配信する方法"><a href="#WSUS-から-Chromium-Edge-更新プログラム配信する方法" class="headerlink" title="WSUS から Chromium Edge 更新プログラム配信する方法"></a><strong>WSUS から Chromium Edge 更新プログラム配信する方法</strong></h3><h3 id="1-Chromium-Edge-の自動更新を制御する"><a href="#1-Chromium-Edge-の自動更新を制御する" class="headerlink" title="1. Chromium Edge の自動更新を制御する"></a>1. Chromium Edge の自動更新を制御する</h3><p>Chromium Edge には、不具合、パフォーマンス、セキュリティ更新が 既定で 10 時間ごとにブラウザで行われる自動更新という機能があります。<br>WSUS から Chromium Edge の更新プログラムを配布する場合は事前に Chromium Edge の自動更新によって勝手にバージョンが上がっていかないよう GPO にて以下の設定が必要です。</p><p>ポリシー ： [ 管理用テンプレート ]&gt;[ Microsoft Edge の更新 ]&gt;[ アプリケーション ]&gt;[ Microsoft Edge ]<br>[ 更新ポリシーのオーバーライドの規定値 ]：有効：[ 更新を無効にする ] を選択します。<br>※このポリシーはドメイン参加環境でのみ効果があります。<br>（ Chromium Edge 管理用テンプレ―トは<a href="https://www.microsoft.com/ja-jp/edge/business/download">こちら</a>から入手可能です。 )<br><img src="/blog/wsus/2022-04-22_01/2022-04-22_01_1.png"></p><h3 id="2-WSUS-から-Chromium-Edge-の更新を配信する"><a href="#2-WSUS-から-Chromium-Edge-の更新を配信する" class="headerlink" title="2. WSUS から Chromium Edge の更新を配信する"></a>2. WSUS から Chromium Edge の更新を配信する</h3><p>WSUS コンソールで [ オプション ] &gt; [ 製品と分類 ]<br>製品： Microsoft Edge 、分類： 更新 にチェックを追加し、更新プログラムを同期します。<br><img src="/blog/wsus/2022-04-22_01/2022-04-22_01_2.png"></p><p>WSUS にて承認作業を行います。<br><img src="/blog/wsus/2022-04-22_01/2022-04-22_01_3.png"></p><p>クライアント側で更新プログラムが適用されます。<br><img src="/blog/wsus/2022-04-22_01/2022-04-22_01_4.png"></p><p>Chromium Edge のバージョンが更新されます。<br><img src="/blog/wsus/2022-04-22_01/2022-04-22_01_5.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。 WSUS サポート チームです。&lt;/p&gt;
&lt;p&gt;長年皆様にご愛用いただいた Internet Explore のサポートの終了が 2022 年 6 月 15 日に予定されていることが発表されました。&lt;br&gt;それに伴い、 Chromium Edge 更</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>MECM パッケージの再実行の設定方法について解説！</title>
    <link href="https://jpmem.github.io/blog/mecm/20220421_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220421_01/</id>
    <published>2022-04-20T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.788Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームの草刈です。  </p><p>今回は多くの方が誤解しやすいパッケージの再実行について解説致します。  </p><h2 id="パッケージを再実行させる時のポイント"><a href="#パッケージを再実行させる時のポイント" class="headerlink" title="パッケージを再実行させる時のポイント"></a>パッケージを再実行させる時のポイント</h2><p>ポイントは「再実行の動作」の設定だけでは再実行はされない、という点です。実は「割り当てスケジュール」により繰り返し実行するように設定する必要があります。  </p><p>一度覚えてしまえば後はご利用のニーズに応じて「割り当てスケジュール」、「再実行の動作」を組み合わせてパッケージ機能を利用することができるうようになりますので、パッケージ実行の概要や各設定箇所について解説させていただきます。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_08.png">  </p><h3 id="パッケージ実行の概要について"><a href="#パッケージ実行の概要について" class="headerlink" title="パッケージ実行の概要について"></a>パッケージ実行の概要について</h3><p>パッケージを展開した際に、端末側で実行されるタイミングは展開設定によって決定されます。  </p><h4 id="必須展開の場合"><a href="#必須展開の場合" class="headerlink" title="必須展開の場合"></a>必須展開の場合</h4><p><img src="/blog/mecm/20220421_01/20220421_01_01.png">  </p><p>必須展開の場合には [スケジュール] にて設定した [割当スケジュール] に設定されたタイミングで実行されます。  </p><p>例えば下記のように「直ちに」とした場合には、クライアント端末側でパッケージ展開のポリシーを受信するとすぐに実行されます。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_02.png">  </p><p>※ スケジュールのオプションについて<br>・[この展開が使用可能になる日時を指定する] を設定した場合、指定した日時以降でのみ、実行が可能となります。（それまでは実行されません。）<br>・[この展開の有効期限を指定する] を指定した場合、有効期限をすぎると実行されなくなります。</p><h4 id="利用可能展開の場合"><a href="#利用可能展開の場合" class="headerlink" title="利用可能展開の場合"></a>利用可能展開の場合</h4><p><img src="/blog/mecm/20220421_01/20220421_01_03.png">  </p><p>利用可能で展開した場合には、クライアント端末上でユーザーがソフトウェア センターを開き、[インストール] ボタンをクリックしたタイミングで実行されます。  </p><h3 id="再実行の設定方法について"><a href="#再実行の設定方法について" class="headerlink" title="再実行の設定方法について"></a>再実行の設定方法について</h3><p>パッケージで再実行を設定する方法について解説させていただきます。　　</p><p>1.展開対象のパッケージを右クリック &gt; [展開] をクリックします。　　</p><p><img src="/blog/mecm/20220421_01/20220421_01_04.png">  </p><p>2.[全般] にて展開したいコレクションを指定し、[次へ] をクリックします。  </p><p>3.[コンテンツ] にて展開するパッケージがコンテンツを含む場合には、配布ポイントを指定してコンテンツ配布を設定し、[次へ] をクリックします。<br>既にコンテンツ配布済みの場合には、何も設定せずに [次へ] をクリックします。  </p><p>4.[展開設定] にて、目的 = [必須] を選択し、[次へ] をクリックします。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_01.png">  </p><p>5.[スケジュール] にて、下記の設定を行います。  </p><p>パケージは「割り当てスケジュール」により、実行タイミングを決定します。<strong>注意が必要なのはここで繰り返し設定、または、複数のスケジュールを指定しない限り、再実行はされないということです。</strong>  </p><p>例えば割り当てスケジュールに「直ちに」のみ設定した場合には、1 度のみの実行となり、仮に実行が失敗した場合でも再実行はされませんのでご注意ください。  </p><p>上記を踏まえて再実行させたい場合のスケジュールの設定方法を解説致します。  </p><h4 id="割り当てスケジュールの設定"><a href="#割り当てスケジュールの設定" class="headerlink" title="割り当てスケジュールの設定"></a>割り当てスケジュールの設定</h4><p>5-1. [新規] をクリックします。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_05.png">  </p><p>5-2. [割当スケジュール] ウィンドウにて [スケジュール] をクリックします。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_06.png">  </p><p>5-3. [カスタム スケジュール] ウィンドウにて繰り返しパターンを設定します。<br>ここで再実行させたい周期を設定します。下記は 1 時間ごとに実行を繰り返す設定の例です。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_07.png">  </p><p>上記設定が完了したら [OK] をクリックしていきます。  </p><h4 id="再実行の動作の設定"><a href="#再実行の動作の設定" class="headerlink" title="再実行の動作の設定"></a>再実行の動作の設定</h4><p>ここが混乱するポイントです。この設定は、このパッケージの実行が 2 回目以降の場合に適用される設定となります。よくある勘違いが「ここで [前回失敗した場合に再実行する] を選択しておけば、実行が失敗した時に再実行される」と思ってしまいがちなのですがこれは間違いです。  </p><p>上記の<strong>「割り当てスケジュール」が繰り返し実行するように設定されていない限り、たとえこの「再実行の動作」を設定していても再実行はされない</strong>のでご注意ください。  </p><p>あくまで、2 回以上実行がトリガーされた場合にのみ、「再実行の動作」の設定が評価されるという点がポイントです。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_08.png">  </p><p>例として、上記の様に、1 時間ごとに実行する「割り当てスケジュール」を設定し、「再実行の動作」にて [前回失敗した場合に再実行する] を選択し、展開を行った場合には、下記のような動作となります。  </p><p><strong>・前回実行 = 成功の場合</strong><br>実行 = 成功　→　1 時間経過　→　前回実行結果を評価　→　前回成功しているので再実行しない  </p><p><strong>・前回実行 = 失敗の場合</strong><br>実行 = 失敗　→　1 時間経過　→　前回実行結果を評価　→　前回失敗しているので再実行される　→　成功　→　1 時間経過　→　前回実行結果を評価　→　前回成功しているので再実行しない  </p><p>上記では [前回失敗した場合に再実行する] を例にあげましたが、実行結果に関わらず常に再実行させたい場合など、ご要件に応じで選択する項目を設定くださいませ。  </p><p>後は、残りの展開設定を進めて頂き、展開を完了させてください。  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームの草刈です。  &lt;/p&gt;
&lt;p&gt;今回は多くの方が誤解しやすいパッケージの再実行について解説致します。  &lt;/p&gt;
&lt;h2 id=&quot;パッケージを再実行させる時のポイント&quot;&gt;&lt;a href=&quot;#パ</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Configuration Manager で資産管理台帳のカスタム レポートを作成する</title>
    <link href="https://jpmem.github.io/blog/mecm/20220419_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220419_01/</id>
    <published>2022-04-18T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.776Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。<br>今回は Microsoft Endpoint Configuration Manager (以下 Configuration Manager) でカスタム レポートを作成する手順をご案内します。</p><p>例として、<strong>資産管理台帳</strong> ということでパソコンの所持ユーザーに紐づくマシン名と、管理者の部署名も表示するというものを作成します。<br>Configuration Manager の情報が格納されている SQL Server データベースの基礎知識などもカバーしますので、これから Configuration Manager で様々な情報を管理されたいという方は是非ともご参考ください。  </p><p>サンプルだとマシン数も少なく、機種名が仮想環境のため見栄えがしませんが、以下のようなレポートを作成します。<br><img src="/blog/mecm/20220419_01/20220419_01_01.png"></p><h2 id="ステップ-1-Active-Directory-ユーザーの探索-で、追加収集する属性を設定する"><a href="#ステップ-1-Active-Directory-ユーザーの探索-で、追加収集する属性を設定する" class="headerlink" title="ステップ 1: [Active Directory ユーザーの探索] で、追加収集する属性を設定する"></a>ステップ 1: [Active Directory ユーザーの探索] で、追加収集する属性を設定する</h2><p>資産管理台帳を表示するにあたって、管理者の会社名や部署名といった情報も取得したいという要件があります。<br>これを実現するには、「Active Directory ユーザーの探索」において収集する属性を追加します。</p><ol><li>Configuration Manager コンソールを開きます。</li><li>コンソール画面左のツリー表示より、[階層の構成] - [探索方法] を選択します。</li><li>画面右の、探索方法の一覧より、[Active Directory ユーザーの探索] をダブルクリックし、プロパティ画面を開きます。</li><li>[Active Directory の属性] タブを表示します。</li><li>ウィンドウ左下の [利用可能な属性] は、Active Directory 上のユーザー オブジェクトの属性を示します。<br><img src="/blog/mecm/20220419_01/20220419_01_02.png"></li></ol><p>例えば、部署名は [department]、会社名は [company] となります。<br><img src="/blog/mecm/20220419_01/20220419_01_03.png"></p><p>department, company を例として追加しますが、任意でその他の属性を追加いただいても構いません。</p><p>※ 補足: ここで追加した属性は、後述の Configuration Manager の SQL のビュー “v_R_User” に、当該の名称で属性が追加されます。</p><ol start="6"><li>追加した属性は、次回の Active Directory ユーザーの探索の周期にて、収集されて Configuration Manager のデータベースに格納されます。<br>直ちに実行したい場合、手順 3 の [Active Direcotry ユーザーの探索] を右クリックし、[今すぐ完全な探索を実行する] を選択します。</li></ol><p>上記は、Active Directory ユーザーの探索の例ですが、その他、Active Directory システムの探索 (コンピューター オブジェクト) でも、Active Directory 属性の追加が可能ですので、応用してください。</p><h2 id="ステップ-2-SQL-のクエリを作成する"><a href="#ステップ-2-SQL-のクエリを作成する" class="headerlink" title="ステップ 2: SQL のクエリを作成する"></a>ステップ 2: SQL のクエリを作成する</h2><p>Configuration Manager にて格納された情報について SQL クエリを実行し、必要な情報をまとめて表示します。<br>レポートの元となる SQL クエリについては、[SQL Server Management Studio] から試行錯誤し、作成します。<br>SQL クエリの実行方法については、以下の手順をご参照ください。</p><p>Title: SQL Query 結果の出力方法について<br>URL: <a href="https://jpmem.github.io/memlog/configmgr/sql/sqlquery.html">https://jpmem.github.io/memlog/configmgr/sql/sqlquery.html</a></p><p>クエリの作成にあたっては、後述補足の、”SCCM データベースのクエリ作成の基礎知識” をご参考ください。</p><p>以下は、ユーザー名に紐尽くプライマリ デバイスと、その基本的な情報を表示する資産台帳の表示を行うカスタム クエリです。<br>ユーザーが最も長く使用するプライマリ デバイスを使用しています。<br>ユーザー名と、そのプライマリ デバイスの関連性は v_UserMachineRelationship ビューに格納されています。</p><p>クエリ例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sys.Netbios_Name0 <span class="keyword">as</span> &quot;マシン名&quot;, u.Unique_User_Name0 <span class="keyword">as</span> &quot;AD上のユーザー名&quot;,</span><br><span class="line">u.Full_User_Name0 <span class="keyword">as</span> &quot;ユーザー名&quot;, u.department <span class="keyword">as</span> &quot;部署名&quot;,</span><br><span class="line">cs.Model0 <span class="keyword">as</span> &quot;機種のモデル名&quot;, cs.Manufacturer0 <span class="keyword">as</span> &quot;機種の製造元&quot;,</span><br><span class="line"><span class="keyword">left</span> (os.Name0,charindex (<span class="string">&#x27;|&#x27;</span>, os.Name0)<span class="number">-1</span>) <span class="keyword">as</span> &quot;OS名&quot;, os.TotalVisibleMemorySize0 <span class="keyword">as</span> &quot;物理メモリ(MB)&quot;,</span><br><span class="line">(ld.Size0 <span class="operator">/</span> <span class="number">1024</span>) <span class="keyword">as</span> &quot;C:の容量(GB)&quot;</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">v_UserMachineRelationship umr</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> v_R_User u</span><br><span class="line"><span class="keyword">on</span> umr.UniqueUserName <span class="operator">=</span> u.Unique_User_Name0</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> v_R_System sys</span><br><span class="line"><span class="keyword">on</span> umr.MachineResourceID <span class="operator">=</span> sys.ResourceID</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> v_GS_COMPUTER_SYSTEM cs</span><br><span class="line"><span class="keyword">on</span> sys.ResourceID <span class="operator">=</span> cs.ResourceID</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> v_GS_OPERATING_SYSTEM os</span><br><span class="line"><span class="keyword">on</span> os.ResourceID <span class="operator">=</span> sys.ResourceID</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> v_GS_LOGICAL_DISK ld</span><br><span class="line"><span class="keyword">on</span> ld.ResourceID <span class="operator">=</span> sys.ResourceID</span><br><span class="line"><span class="keyword">where</span> ld.DeviceID0 <span class="keyword">like</span> <span class="string">&#x27;%C%&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="ステップ-3-レポートを作成する"><a href="#ステップ-3-レポートを作成する" class="headerlink" title="ステップ 3: レポートを作成する"></a>ステップ 3: レポートを作成する</h2><p>B で作成した SQL クエリを表示する、簡単なカスタム レポートの作成手順です。<br>事前準備として、レポートの編集に必要な Report Builder をインストールしてください。</p><p>Title: Microsoft® Report Builder<br>URL: <a href="https://www.microsoft.com/en-us/download/details.aspx?id=53613">https://www.microsoft.com/en-us/download/details.aspx?id=53613</a></p><p>インストール ウィザードの途中の “既定の対象のサーバー” の入力項目はブランクのままインストールを進めてかまいません。<br><img src="/blog/mecm/20220419_01/20220419_01_04.png"></p><ol><li><p>Configuration Manager コンソールより、[監視] ワークスペースを開きます。</p></li><li><p>[レポート] - [レポート] を右クリックして [レポートの作成] をクリックします。</p></li></ol><p>※ Report Builder が未インストールの場合、以下のエラーが表示されますので、そのときは Report Builder をインストールしてください。<br><img src="/blog/mecm/20220419_01/20220419_01_05.png"></p><ol start="3"><li>[レポートの作成ウィザード] では、レポートの名前と説明を入力します。パスは、レポートがどのフォルダーに格納されるかが設定されますが、任意で結構です。</li></ol><p>※ 独自に作成したフォルダーをパスに指定したい場合は、予めブラウザでレポート マネージャー (http://&lt;ホスト名&gt;/Reports) を開き、[ConfigMgr_&lt;サイト コード&gt;] フォルダー直下に、任意の名前でフォルダーを作成してください。<br><img src="/blog/mecm/20220419_01/20220419_01_06.png"></p><ol start="4"><li><p>ウィザードを完了させると、SQL Server レポート ビルダーが起動します。初回起動時に以下のダイアログが出力されるので [はい] をクリックします。　　<br><img src="/blog/mecm/20220419_01/20220419_01_07.png"></p></li><li><p>画面中央の [テーブルまたはマトリックス] を選択します。<br><img src="/blog/mecm/20220419_01/20220419_01_08.png"></p></li><li><p>[新しいテーブル/マトリックス] ウィザードが表示されます。[データセットを作成する] のチェックのまま、次へ進みます。<br><img src="/blog/mecm/20220419_01/20220419_01_09.png"></p></li><li><p>[データソース接続] については、既定のまま、次へ進みます。”データ ソースの資格情報の入力” ダイアログが表示された場合、[現在の Windows ユーザーを使用する] を選択して [OK] をクリックします。<br><img src="/blog/mecm/20220419_01/20220419_01_10.png"></p></li><li><p>[クエリのデザイン] 画面では、画面左上の [テキストとして編集] をクリックし、白紙個所に B で作成したクエリを張り付けます。実行ボタン [!] を押すことで、プレビューも可能です。<br><img src="/blog/mecm/20220419_01/20220419_01_11.png"></p></li><li><p> [フィールドの配置] 画面では、[使用できるフィールド] のすべてを、[値] にドラッグ ドロップします。<br><img src="/blog/mecm/20220419_01/20220419_01_12.png"></p></li><li><p>[レイアウトの選択] 画面で、[次へ] をクリックします。<br><img src="/blog/mecm/20220419_01/20220419_01_13.png"></p></li><li><p>プレビューを確認して [完了] をクリックし、ウィザードを完了します。<br><img src="/blog/mecm/20220419_01/20220419_01_14.png"></p></li><li><p> Report Builder の最初の画面に戻ります。列幅やフォントなどレイアウトを任意で整えた後、[ファイル] - [保存] をクリックして閉じます。<br><img src="/blog/mecm/20220419_01/20220419_01_15.png"></p></li></ol><p>※ Report Builder 内の [実行] をクリックすることで、Report Builder 上で結果のプレビューを確認することもできます。<br><img src="/blog/mecm/20220419_01/20220419_01_16.png"></p><ol start="13"><li>Configuration Manager コンソールの [監視] ワークスペース、[レポート] - [レポート] から、作成したレポートを検索して、実行します。<br><img src="/blog/mecm/20220419_01/20220419_01_17.png"></li></ol><p>このように、SQL Server に直接クエリするのではなく Configuration Managerのレポートから閲覧可能となります。<br>レポートごとにアクセス権を設定できる点や、様々な形式でエクスポート可能であることがメリットです。</p><h2 id="補足-Configuration-Manager-データベースのクエリ作成の基礎知識"><a href="#補足-Configuration-Manager-データベースのクエリ作成の基礎知識" class="headerlink" title="補足: Configuration Manager データベースのクエリ作成の基礎知識"></a>補足: Configuration Manager データベースのクエリ作成の基礎知識</h2><p>カスタム クエリを作成いただくにあたって、知っておきたい Configuration Manager データベースの基礎知識は以下となります。</p><ul><li><p>はじめに、既存のレポートを色々と触ってみることをお奨めします。既存のレポートは様々な「よくある要望」を達成するため、用意されています。レポートの一覧は<a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/list-of-reports">こちらの公開情報</a>にも掲載されておりますので、ご確認ください。</p></li><li><p>カスタム レポートを作成すると決断した場合、手始めに、Configuration Manager の既存のレポートから、目的に類似したものをまずは見つけることをお奨めします。既存のレポートを [右クリック] - [編集] し Report Builder から見ることで、どのようなクエリを発行しているのか確認できます。<br>以下の画面ショットのように、[データセット] - [DataSet] のプロパティを表示し、クエリを確認します。<br>特に、”from” 句で、どのビューを参照・結合しているのかが分かれば、SQL データベースとにらめっこをしなくても、即座に見るべきビューのあたりをつけることができます。</p></li><li><p>SQL クエリを書く場合、Configuration Manager では、テーブルではなく、ビューを使用してクエリを作成してください。(テーブルの直接参照はサポートされません。)</p></li><li><p>[Active Directory ユーザーの探索] で探索したユーザー属性は、”v_R_User” ビューに格納されます。また、コンピューター オブジェクトの場合、”v_R_System” になります。</p></li><li><p>Configuration Manager で収集されたハードウェア インベントリ情報の多くは、”v_GS_&lt;カテゴリー名&gt;” のビューに格納されています。これらのビューを結合するにあたっては、マシンごとに一意に振られている “ResourceID” というキー値を使用することが有効です。”ResourceID” が一致するよう、これらのビューを結合 (Join) することで、特定のマシンについての様々なインベントリ情報を結合出来ます。</p></li></ul><p>インベントリにて、どのような情報が収集されているかについては、[リソース エクスプローラー] からご確認ください。<br>Configuration Manager コンソールの [資産とコンプライアンス] ワークスペースより、コレクションからマシン名を選択し、[開始] - [リソース エクスプローラー] を開始します。<br>画面左のツリーから一覧可能なカテゴリーは、すべて v_GS_&lt;カテゴリー名&gt; のビューに格納されています。</p><p>上記のようなビューに関する情報は、以下の公開情報でもご案内しておりますので、こちらもどのビューを使用するか決定する際にお役立ていただければと思います。</p><p>Title: SQL Serverマネージャーのビューを表示する<br>URL: <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/develop/core/understand/sqlviews/sql-server-views-configuration-manager">https://docs.microsoft.com/ja-jp/mem/configmgr/develop/core/understand/sqlviews/sql-server-views-configuration-manager</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;br&gt;今回は Microsoft Endpoint Configuration Manager (以下 Configuration Manager) でカスタム レポートを作成する手順</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>MECM クライアントがインストールされた PC でマスター イメージを新規取得・再取得する手順</title>
    <link href="https://jpmem.github.io/blog/mecm/20220418_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220418_01/</id>
    <published>2022-04-17T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.776Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>今回は Microsoft Endpoint Configuration Manager (以下 MECM) クライアント エージェントがインストールされた PC で、マスター イメージを新規取得するシナリオと、再取得するシナリオの手順をまとめてご紹介します。</p><p>※本記事は、以下の 2 つの過去記事を最新の情報をもとに取り纏めたものとなります。<br><a href="https://jpmem.github.io/blog/mecm/20171025_01/">System Center Configuration Manager クライアントがインストールされた PC でマスター イメージを再取得する手順</a><br><a href="https://jpmem.github.io/blog/mecm/20171107_01/">System Center Configuration Manager クライアントがインストールされた PC でマスター イメージを取得する手順 (ワークグループ対応版)</a></p><p>MECM クライアントは、端末に一意の情報が保持されているため、そのままマスター イメージを作成すると一意の情報が重複することで、デバイス一覧の重複して表示されたり、配布物が正しく配布出来なくなるといった不都合が発生しますので、一意の情報を削除し、マスター イメージを再取得する手順をご案内致します。<br>利用シナリオとしては VDI クライアントやイメージ展開を他社製品で行う場合に、予め MECM エージェントをインストールしておくことを想定しております。<br>本手順を実施していない場合は、展開後に一意の情報が重複して、正常に管理することができなくなりますので、本手順をご参考ください。</p><h2 id="シナリオ"><a href="#シナリオ" class="headerlink" title="-シナリオ"></a>-シナリオ</h2><p>以下の 2 パターンのシナリオについて、手順をご紹介致します。</p><p>A. MECM クライアントがインストールされていない状態から、マスターイメージの “新規” 取得を行う手順<br>B. 既に MECM クライアントがインストールされている状態から、マスター イメージの “再” 取得を行う手順</p><h2 id="関連情報"><a href="#関連情報" class="headerlink" title="-関連情報"></a>-関連情報</h2><p>本手順が未実施であることで、固有の ID (GUID) 重複の問題が発生している場合には、別途以下の記事で対処方法をご紹介しております。<br><a href="https://jpmem.github.io/blog/mecm/20210922_01/">重複 GUID の対処について</a></p><h2 id="対象製品"><a href="#対象製品" class="headerlink" title="-対象製品"></a>-対象製品</h2><ul><li>System Center Configuration Manager LTSB  </li><li>Microsoft Endpoint Configuration Manager (Current Branch)  </li></ul><h1 id="A-MECM-クライアントがインストールされていない状態から、マスターイメージの-“新規”-取得を行う手順"><a href="#A-MECM-クライアントがインストールされていない状態から、マスターイメージの-“新規”-取得を行う手順" class="headerlink" title="A. MECM クライアントがインストールされていない状態から、マスターイメージの “新規” 取得を行う手順"></a>A. MECM クライアントがインストールされていない状態から、マスターイメージの “新規” 取得を行う手順</h1><h3 id="事前説明"><a href="#事前説明" class="headerlink" title="-事前説明"></a>-事前説明</h3><p>意図しないサイトコードの割り当てを防ぐため、MECM サーバーと通信できない状態で手順を実施します。<br>ネットワークを未接続にすることは必須ではなく、あくまで MECM サーバーと疎通できない状態として頂ければ問題ございません。<br>※文中では “ネットワーク ケーブルを抜く” と表現しております。</p><p>&lt;目次&gt;</p><ol><li>サイト コード未割り当ての状態で MECM クライアントをインストールする</li><li>[SMS Agent Host] サービスの停止とスタート アップの種類の変更</li><li>MECM で使用する自己署名証明書を削除する</li><li>MECM 独自の信頼キーと管理ポイントの証明書を削除する</li><li>[SMS Agent Host] サービスのスタート アップの種類の変更</li><li>マスターイメージの採取</li></ol><h3 id="1-サイト-コード未割り当ての状態で-MECM-クライアントをインストールする"><a href="#1-サイト-コード未割り当ての状態で-MECM-クライアントをインストールする" class="headerlink" title="1. サイト コード未割り当ての状態で  MECM クライアントをインストールする"></a>1. サイト コード未割り当ての状態で  MECM クライアントをインストールする</h3><p>以下の手順にて、サイト コードが “未割り当て” の状態でエージェントのセットアップを行います。</p><ol><li><p>プライマリ サイト サーバーより、MECM インストール フォルダー配下に存在する [Client] フォルダーをコピーし保存します。<br>※インストール フォルダーの初期設定は以下になりますが、お客様環境によっては変更されている場合がございます。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\Program Files\Microsoft Configuration Manager\Client</span><br></pre></td></tr></table></figure></li><li><p>対象の PC にローカル管理者権限を保有するユーザーでログインします。</p></li><li><p>項番 1) でコピーした [Client] フォルダーを、クライアント上の任意のフォルダーに格納します。</p></li><li><p>MECM サーバーと通信できないようにするため、ネットワーク ケーブルを抜きます。</p></li><li><p>[管理者として実行] にてコマンド プロンプトを開き、cd コマンドで Client フォルダーに移動し、以下のコマンドを実行します。<br> ※SMSSITECODE オプションなしで ccmsetup.exe を実行することにより、”未割り当て” の状態でエージェントがセットアップされます。<br> ※ワーク グループ環境の場合は、SMSMP もしくは DNSSUFFIX オプションなどを任意で指定してください。ただし、その場合も SMSSITECODE オプションは使用しないようにしてください。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ccmsetup.exe</span><br></pre></td></tr></table></figure></li><li><p>Windows キー + R キーを押下し、<strong>taskmgr</strong> を実行し、[タスク マネージャー] 画面を開き、[プロセス] 欄で ccmsetup.exe が表示されなくなるまで待ちます。</p></li><li><p>Windows キー + R キーを押下し、<strong>control</strong> を実行し、[コントロール パネル] 画面を開き、[システムとセキュリティ] から [Configuration Manager] を開き、以下のようにサイト コードが “未割り当て” の状態であることを確認します。  </p><p> ・[コンポーネント] タブ： 「CCM 通知エージェント」 以外のすべての項目が「インストール済み」であることを確認します。<br> ※ 「CCM 通知エージェント」 は 「無効」 になります。</p><p> ・[サイト] タブ : 「現在の割り当てサイト コード」が空欄であることを確認します。</p></li></ol><h3 id="2-SMS-Agent-Host-サービスの停止とスタート-アップの種類の変更"><a href="#2-SMS-Agent-Host-サービスの停止とスタート-アップの種類の変更" class="headerlink" title="2. [SMS Agent Host] サービスの停止とスタート アップの種類の変更"></a>2. [SMS Agent Host] サービスの停止とスタート アップの種類の変更</h3><ol><li><p>Windows キー + R キーを押下し、<strong>Sevices.msc</strong> を実行し、[サービス] 画面を表示し、[SMS Agent Host] サービスを停止します。</p></li><li><p>続けて、自動でサービスが起動しないように、[SMS Agent Host] サービスを右クリックし、プロパティを開き、スタートアップの種類を [手動] に変更します。</p></li><li><p>注意点として、タスク スケジューラ (<strong>taskschd.msc</strong>) の以下のタスクが実行された場合、自動で [SMS Agent Host] サービスが起動するため、手順の項番 2. ～ 5. の実行に時間がかかる場合は、手順実行中は本タスクを右クリックより [無効] にしてください。</p><p> ・[タスク スケジューラ ライブラリ] - [Microsoft] - [Configuration Manager]<br> タスク名：[Configuration Manager Health Evaluation]</p></li></ol><h3 id="3-自己署名証明書の削除"><a href="#3-自己署名証明書の削除" class="headerlink" title="3. 自己署名証明書の削除"></a>3. 自己署名証明書の削除</h3><ol><li>Windows キー + R キーを押下し、<strong>certlm.msc</strong> を実行し、ローカル コンピューターの証明書ストアを開きます。</li><li>[証明書 - ローカル コンピューター] - [SMS] - [証明書] を選択します。</li><li>発行先と発行者が “SMS” となっている 自己署名証明書が 2 枚ありますので、これらを右クリックより削除します。</li><li>「選択された証明書を永久的に削除しますか ? 」というメッセージが表示されますので、[はい] を選択します。</li><li>certlm 画面を閉じます。</li></ol><p><strong>※</strong> <strong>PKI</strong> <strong>証明書を利用している環境</strong> <strong>(HTTPS 構成)</strong> <strong>の場合</strong><br>お客様環境が HTTPS 通信の構成であり、クライアント証明書認証のために、 証明書をインストールされている場合には、同様に以下の手順で PKI 証明書を削除します。</p><ol><li>Windows キー + R キーを押下し、<strong>certlm.msc</strong> を実行し、ローカル コンピューターの証明書ストアを開きます。</li><li>[証明書 - ローカル コンピューター] - [個人] - [証明書] を選択します。※カスタム ストアを利用している場合は、該当箇所を選択してください。</li><li>該当の証明書を選択し、右クリックより削除します。</li><li>certlm 画面を閉じます。</li></ol><h3 id="4-MECM-独自の信頼キーと管理ポイントの証明書を削除する"><a href="#4-MECM-独自の信頼キーと管理ポイントの証明書を削除する" class="headerlink" title="4. MECM 独自の信頼キーと管理ポイントの証明書を削除する"></a>4. MECM 独自の信頼キーと管理ポイントの証明書を削除する</h3><p>MECM クライアントのインストール完了後に、もしネットワークに接続して、MECM サーバー(管理ポイント サーバー) との通信が可能となった場合、参照コンピューターが、MECM で使用する信頼キーと管理ポイントの証明書を WMI の中に保持した状態となる可能性があります。</p><p>この場合、参照コンピューターに保存されている信頼キーや管理ポイントの証明書を削除する必要があります。<br>wbemtest より、WMI 名前空間 “root\ccm\locationservices” に接続できない場合は、MECM サーバーと一度も接続がされていないため、問題ありません。<br>接続できる場合は、情報を削除するため、以下の手順を実施してください。</p><p>・管理者権限で PowerShell を起動し、以下のコマンドを実行し、信頼されたルート キー (TrustedRootKey) の情報と管理ポイントの証明書を削除します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\locationservices <span class="literal">-class</span> trustedrootkey | <span class="built_in">rwmi</span></span><br></pre></td></tr></table></figure><p>スクリプト実行完了後、以下の手順で、正常に信頼キーや証明書が削除されたことを確認します。</p><ol><li>コマンド プロンプトを “管理者として実行” にて起動して <strong>wbemtest</strong> を実行し、”root\ccm\locationservices” 名前空間に接続します。</li><li>「スーパークラス名の入力」はブランクのまま、「クラスの列挙」を “再帰” を有効にして実行します。</li><li>一覧から “TrustedRootKey” を選択し、ダブルクリックして開きます。</li><li>開いた画面で「インスタンス」をクリックします。</li><li>インスタンスが存在しないことを確認します。</li></ol><h3 id="5-SMS-Agent-Host-サービスのスタート-アップの種類の変更"><a href="#5-SMS-Agent-Host-サービスのスタート-アップの種類の変更" class="headerlink" title="5. [SMS Agent Host] サービスのスタート アップの種類の変更"></a>5. [SMS Agent Host] サービスのスタート アップの種類の変更</h3><p>Windows キー + R キーを押下し、<strong>Sevices.msc</strong> を実行し、[サービス] 画面を表示し、[SMS Agent Host] サービスを右クリックし、スタートアップの種類を [自動  (遅延開始) ] に変更します。<br>ここでは、サービスは停止したままで、[SMS Agent Host] サービスを開始しないように注意してください。<br>また、手順実施中に [Configuration Manager Health Evaluation] タスクを無効にした場合は、有効に戻してください。</p><h3 id="6-マスターイメージの採取"><a href="#6-マスターイメージの採取" class="headerlink" title="6. マスターイメージの採取"></a>6. マスターイメージの採取</h3><p>sysprep /generalize が実行された参照コンピューターをキャプチャして、マスター イメージを採取します。<br>なお、MECM のキャプチャ メディア機能を使用すれば、 sysprep /generalize  は内部的に自動実行されます。<br>また、上記情報の削除も内部的に実行されますのでキャプチャしたイメージを MECM から展開する際には、こちらを実施することもご検討ください。</p><p>参考)<br>キャプチャ メディアの作成<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/osd/deploy-use/create-capture-media">https://docs.microsoft.com/ja-jp/mem/configmgr/osd/deploy-use/create-capture-media</a></p><h1 id="B-既に-MECM-クライアントがインストールされている状態から、マスター-イメージの-“再”-取得を行う手順"><a href="#B-既に-MECM-クライアントがインストールされている状態から、マスター-イメージの-“再”-取得を行う手順" class="headerlink" title="B. 既に MECM クライアントがインストールされている状態から、マスター イメージの “再” 取得を行う手順"></a>B. 既に MECM クライアントがインストールされている状態から、マスター イメージの “再” 取得を行う手順</h1><p>&lt;目次&gt;</p><ol><li>[SMS Agent Host] サービスの停止とスタート アップの種類の変更</li><li>サイト コードのクリアと信頼キーの削除</li><li>自己署名証明書の削除</li><li>SMSCFG.ini の削除</li><li>[SMS Agent Host] サービスのスタート アップの種類の変更</li><li>マスターイメージの採取</li></ol><p>各手順の詳細は以下の通りです。</p><h3 id="1-SMS-Agent-Host-サービスの停止とスタート-アップの種類の変更"><a href="#1-SMS-Agent-Host-サービスの停止とスタート-アップの種類の変更" class="headerlink" title="1. [SMS Agent Host] サービスの停止とスタート アップの種類の変更"></a>1. [SMS Agent Host] サービスの停止とスタート アップの種類の変更</h3><ol><li><p>Windows キー + R キーを押下し、[ファイル名を指定して実行] にて <strong>Sevices.msc</strong> を実行し、[サービス] 画面を表示し、[SMS Agent Host] サービスを停止します。</p></li><li><p>続けて、自動でサービスが起動しないように、[SMS Agent Host] サービスを右クリックし、プロパティを開き、スタートアップの種類を [手動] に変更します。</p></li><li><p>注意点として、タスク スケジューラ (<strong>taskschd.msc</strong>) の以下のタスクが実行された場合、自動で [SMS Agent Host] サービスが起動するため、手順の項番 2. ～ 5. の実行に時間がかかる場合は、手順実行中は本タスクを右クリックより [無効] にしてください。</p><p> ・[タスク スケジューラ ライブラリ] - [Microsoft] - [Configuration Manager]<br> タスク名：[Configuration Manager Health Evaluation]</p></li></ol><h3 id="2-信頼されたルート-キーの削除とサイト-コードのクリア"><a href="#2-信頼されたルート-キーの削除とサイト-コードのクリア" class="headerlink" title="2. 信頼されたルート キーの削除とサイト コードのクリア"></a>2. 信頼されたルート キーの削除とサイト コードのクリア</h3><p>・管理者権限で PowerShell を起動し、以下のコマンドを実行し、信頼されたルート キー (TrustedRootKey) とサイト コードをクリアし、サイト コードの自動割り当てを有効にします。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\locationservices <span class="literal">-class</span> trustedrootkey | <span class="built_in">rwmi</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$oSMSClient</span>=<span class="built_in">New-Object</span> <span class="literal">-comobject</span> Microsoft.SMS.Client</span><br><span class="line"><span class="variable">$oSMSClient</span>.RemoveAssignedSites()</span><br><span class="line"><span class="variable">$oSMSClient</span>.EnableAutoAssignment(<span class="variable">$True</span>)</span><br></pre></td></tr></table></figure><p>スクリプト実行完了後、以下の手順で、正常に信頼キーや証明書が削除されたことを確認します。</p><ol><li>コマンド プロンプトを “管理者として実行” にて起動して <strong>wbemtest</strong> を実行し、”root\ccm\locationservices” 名前空間に接続します。</li><li>「スーパークラス名の入力」はブランクのまま、「クラスの列挙」を “再帰” を有効にして実行します。</li><li>一覧から “TrustedRootKey” を選択し、ダブルクリックして開きます。</li><li>開いた画面で「インスタンス」をクリックします。</li><li>インスタンスが存在しないことを確認します。</li></ol><h3 id="3-自己署名証明書の削除-1"><a href="#3-自己署名証明書の削除-1" class="headerlink" title="3. 自己署名証明書の削除"></a>3. 自己署名証明書の削除</h3><ol><li>Windows キー + R キーを押下し、<strong>certlm.msc</strong> を実行し、ローカル コンピューターの証明書ストアを開きます。</li><li>[証明書 - ローカル コンピューター] - [SMS] - [証明書] を選択します。</li><li>発行先と発行者が “SMS” となっている 自己署名証明書が 2 枚ありますので、これらを右クリックより削除します。</li><li>「選択された証明書を永久的に削除しますか ? 」というメッセージが表示されますので、[はい] を選択します。</li><li>certlm 画面を閉じます。</li></ol><p><strong>※</strong> <strong>PKI</strong> <strong>証明書を利用している環境</strong> <strong>(HTTPS 構成)</strong> <strong>の場合</strong><br>お客様環境が HTTPS 通信の構成であり、クライアント証明書認証のために、 証明書をインストールされている場合には、同様に以下の手順で PKI 証明書を削除します。</p><ol><li>Windows キー + R キーを押下し、<strong>certlm.msc</strong> を実行し、ローカル コンピューターの証明書ストアを開きます。</li><li>[証明書 - ローカル コンピューター] - [個人] - [証明書] を選択します。※カスタム ストアを利用している場合は、該当箇所を選択してください。</li><li>該当の証明書を選択し、右クリックより削除します。</li><li>certlm 画面を閉じます。</li></ol><h3 id="4-SMSCFG-ini-の削除"><a href="#4-SMSCFG-ini-の削除" class="headerlink" title="4. SMSCFG.ini の削除"></a>4. SMSCFG.ini の削除</h3><p>Configuration Manager 一意の識別子の情報が格納されている “SMSCFG.ini” を削除します。<br>ファイルは、 以下の場所に存在します。</p><p><code>%windir%\SMSCFG.ini</code></p><h3 id="5-SMS-Agent-Host-サービスのスタート-アップの種類の変更-1"><a href="#5-SMS-Agent-Host-サービスのスタート-アップの種類の変更-1" class="headerlink" title="5. [SMS Agent Host] サービスのスタート アップの種類の変更"></a>5. [SMS Agent Host] サービスのスタート アップの種類の変更</h3><p>Windows キー + R キーを押下し、<strong>Sevices.msc</strong> を実行し、[サービス] 画面を表示し、[SMS Agent Host] サービスを右クリックし、スタートアップの種類を [自動  (遅延開始) ] に変更します。<br>ここでは、サービスは停止したままで、[SMS Agent Host] サービスを開始しないように注意してください。<br>また、手順実施中に [Configuration Manager Health Evaluation] タスクを無効にした場合は、有効に戻してください。</p><h3 id="6-マスターイメージの採取-1"><a href="#6-マスターイメージの採取-1" class="headerlink" title="6. マスターイメージの採取"></a>6. マスターイメージの採取</h3><p>sysprep /generalize が実行された参照コンピューターをキャプチャして、マスター イメージを採取します。</p><p>なお、MECM のキャプチャ メディア機能を使用すれば、 sysprep /generalize  は内部的に自動実行されます。<br>また、上記情報の削除も内部的に実行されますのでキャプチャしたイメージを MECM から展開する際には、こちらを実施することもご検討ください。</p><p>参考)<br>キャプチャ メディアの作成<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/osd/deploy-use/create-capture-media">https://docs.microsoft.com/ja-jp/mem/configmgr/osd/deploy-use/create-capture-media</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;今回は Microsoft Endpoint Configuration Manager (以下 MECM) クライアント エージェントがインストールされた PC で</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>IP サブネット境界設定の考え方</title>
    <link href="https://jpmem.github.io/blog/mecm/20220414_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220414_01/</id>
    <published>2022-04-13T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.776Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>本日は、IP サブネット境界設定について簡単に解説させていただきます。</p><p>なお、本記事の画面は Micorosoft Endpoint Manager Configuration Manager  (MECM) Current Branch (CB) 2111 のものです。他の Version では画面が異なる場合があります。</p><p>IP サブネット境界を設定する際、以下の画面をご覧になるかと存じます。</p><p><img src="/blog/mecm/20220414_01/20220414_01_01.png"></p><p>この画面の赤枠の文章を見て、「どういうことだろう･･･」と思われた方も多いかと存じます。 </p><p>これは、「MECM のサブネット境界判定においては、ネットワーク IP アドレスや サブネット マスク アドレスは使われず、それらから割り出された、サブネット ID のみが使われる」ということを示します。</p><p>上の文章だけでもどういうことか分からないかと思いますので、以下の例をご確認ください。</p><h2 id="サブネット境界判定の例-1"><a href="#サブネット境界判定の例-1" class="headerlink" title="サブネット境界判定の例 1"></a>サブネット境界判定の例 1</h2><p>以下のサブネット境界を作成したとします。</p><ul><li>ネットワーク IP アドレス  : 192.168.10.0</li><li>サブネット マスク アドレス: 255.255.255.0</li></ul><p>上記の場合、割り出されるサブネット ID は･･･以下の通り、 <strong>192.168.10.0</strong> となります。</p><p><img src="/blog/mecm/20220414_01/20220414_01_02.png"></p><p>このとき、クライアント端末 A の IP アドレスが以下の場合、この<strong>サブネット境界に割り当たります。</strong></p><ul><li>クライアント IP アドレス:    192.168.10.1</li><li>サブネット マスク アドレス: 255.255.255.0</li></ul><p>一方、クライアント端末 B の IP アドレスが以下の場合、この<strong>サブネット境界に割り当たりません。</strong></p><ul><li>クライアント IP アドレス:    192.168.10.10</li><li>サブネット マスク アドレス: 255.255.255.248</li></ul><p>上記、違和感を感じますよね。/24 の サブネットを境界で指定したのだから、192.168.10.0 - 192.168.10.255 のIP アドレスは指定したサブネット境界として判定される筈だ、と考えるはずです。</p><p>ここで、注意書きの「ネットワークとサブネット マスクの値からサブネット ID が割り出されます。」を思い出してください。</p><p>クライアント 端末 A の IP アドレスとサブネット マスク の値から、サブネット境界と同様の方法でサブネット ID を割り出してみましょう。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">クライアント端末 A のサブネット ID: 192.168.10.0</span><br></pre></td></tr></table></figure><p><strong>192.168.10.0</strong> となります。<strong>この ID はサブネット境界のサブネット ID と等しい</strong>ですね。</p><p>一方、クライアント 端末 B の IP アドレスとサブネット マスク の値から、サブネット境界と同様の方法でサブネット ID を割り出してみると、</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">クライアント端末 B のサブネット ID: 192.168.10.8</span><br></pre></td></tr></table></figure><p><strong>192.168.10.8</strong> となります。<strong>この ID はサブネット境界のサブネット ID と異なります</strong>ね。</p><p>もう一つ、例を挙げてみましょう。以下の例の方がよく見かけられるものではあります。</p><h2 id="サブネット境界判定の例-2"><a href="#サブネット境界判定の例-2" class="headerlink" title="サブネット境界判定の例 2"></a>サブネット境界判定の例 2</h2><p>以下のサブネット境界を作成したとします。</p><ul><li>ネットワーク IP アドレス  : 10.0.0.0</li><li>サブネット マスク アドレス: 255.255.0.0</li></ul><p>/16 のサブネット空間です。多くの /24 のサブネット空間をひとまとめにした境界を作成されたい場合、このような境界を作りたいことは多いかと存じます。</p><p>では同様にサブネット ID を計算してみましょう。以下の通り、 <strong>10.0.0.0</strong> がサブネット ID となります。</p><p><img src="/blog/mecm/20220414_01/20220414_01_03.png"></p><p>では、この境界に割当たるクライアント端末の IP アドレスを見ていきましょう。</p><p>クライアント端末 C の IP アドレスが以下の場合、この<strong>サブネット境界に割り当たりません。</strong></p><ul><li>クライアント IP アドレス:    10.0.1.1</li><li>サブネット マスク アドレス: 255.255.255.0</li></ul><p>同じく、クライアント端末 D の IP アドレスが以下の場合、この<strong>サブネット境界に割り当たりません。</strong></p><ul><li>クライアント IP アドレス:    10.0.2.1</li><li>サブネット マスク アドレス: 255.255.255.0</li></ul><p>なぜなら、サブネット ID を計算したとき、以下のようになるからです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">クライアント端末 C のサブネット ID: 10.0.1.0</span><br><span class="line">クライアント端末 D のサブネット ID: 10.0.2.0</span><br></pre></td></tr></table></figure><p>そう、両方のサブネット ID がサブネット境界 のサブネット ID 10.0.0.0 と<strong>一致しません。</strong> そのため、/16 のサブネット境界を作った時、それに含まれると考えられる /24 のサブネットの IP アドレスを持つクライアントは、このサブネット境界に含まれません。</p><p>なら、どのようなクライアントならサブネット境界に割り当たるかと言うと、以下のような IP アドレスを持つクライアント E の端末となります。</p><ul><li>クライアント IP アドレス:   10.0.1.10</li><li>サブネット マスク アドレス: 255.255.0.0</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">クライアント端末 E のサブネット ID: 10.0.0.0</span><br></pre></td></tr></table></figure><h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>ここまで見てきたらお分かりかと存じます。クライアントが IP サブネット の境界に含まれると判定されるには、境界サブネット ID と、クライアントが所属するサブネットのネットワーク アドレスが一致する必要がある、つまりサイズも全く同一の、同じサブネットに所属する必要がある、ということです。そのため、複数の小さなサブネットを含む大きなサブネット境界を設定することは出来ません。</p><p>上記のようなことを実施されたい場合は、「IP アドレスの範囲」の境界を使いましょう。例えば、以下のような開始 IP アドレスと終了 IP アドレスを持つ境界を作れば 10.0.1.0/24 と 10.0.2.0/24 のサブネットの 端末を同一の境界として判定させることができます。</p><p><img src="/blog/mecm/20220414_01/20220414_01_04.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;本日は、IP サブネット境界設定について簡単に解説させていただきます。&lt;/p&gt;
&lt;p&gt;なお、本記事の画面は Micorosoft Endpoint Manager C</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>クラウド PC へのリダイレクトを禁止する方法について</title>
    <link href="https://jpmem.github.io/blog/w365/2022-04-12_01/"/>
    <id>https://jpmem.github.io/blog/w365/2022-04-12_01/</id>
    <published>2022-04-11T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.840Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。<br>本日は、接続元の PC からクラウド PC へのクリップボードやファイルのコピーなどのリダイレクトを禁止する方法についてご紹介します。<br>今回は Intune の構成プロファイルを使用した方法をご案内いたしますが、この方法を使用すると iOS や Android OS など、Windows 以外のデバイスからのリダイレクトも禁止することが可能です。</p><h2 id="免責事項"><a href="#免責事項" class="headerlink" title="免責事項"></a>免責事項</h2><p>下記内容は 2022/4/12 時点での内容についての記載となっております。<br>今後内容が更新されることもございますので、その点ご承知置きくださいますようお願い致します。</p><h2 id="構成プロファイルの作成方法"><a href="#構成プロファイルの作成方法" class="headerlink" title="構成プロファイルの作成方法"></a>構成プロファイルの作成方法</h2><ol><li>グローバル管理者などの権限を持つアカウントで Microsoft Endpoint Manager admin center (<a href="https://aka.ms/memac">https://aka.ms/memac</a>) にログインします。</li><li>[デバイス] - [構成プロファイル] と辿り、[プロファイルの作成] を選択します。</li><li>以下のように選択し、[作成] を選択します。<br>プラットフォーム：Windows 10 以降<br>プロファイルの種類：設定カタログ（プレビュー）<br><img src="/blog/w365/2022-04-12_01/2022-04-12-19-51-50.png">  </li><li>[名前] を入力し、[次へ] を選択します。<br><img src="/blog/w365/2022-04-12_01/2022-04-12-19-52-06.png">  </li><li>[設定の追加] を選択し、”redirect” と入力して [検索] を選択します。</li><li>表示された検索結果から、[管理用テンプレート\Windows コンポーネント\リモート デスクトップ サービス\リモート デスクトップ セッション ホスト\デバイスとリソースのリダイレクト] を選択し、必要な項目にチェックを入れて [次へ] を選択します。<br><img src="/blog/w365/2022-04-12_01/2022-04-12-19-52-33.png">  </li></ol><p>■補足事項<br>プリンターのリダイレクトを禁止したい場合は [管理用テンプレート\Windows コンポーネント\リモート デスクトップ サービス\リモート デスクトップ セッション ホスト\プリンターのリダイレクト] から [Do not allow client printer redirection] を選択します。<br><img src="/blog/w365/2022-04-12_01/2022-04-12-19-54-07.png">  </p><ol start="7"><li>割り当てるグループを選択し、[次へ] を選択します。</li><li>必要に応じて スコープ タグ を設定し、 [次へ] を選択します。</li><li>[作成] を選択し、構成プロファイルの作成を完了させます。</li><li>接続元 PC から文字やファイルなどをコピーし、クラウド PC で貼り付けができないことを確認します。</li></ol><p>参考公開情報<br>Title : クラウド PC の RDP デバイス リダイレクトを管理します<br>URL : <a href="https://docs.microsoft.com/ja-jp/windows-365/enterprise/manage-rdp-device-redirections">https://docs.microsoft.com/ja-jp/windows-365/enterprise/manage-rdp-device-redirections</a></p><p>以上、クラウド PC へのクリップボードやファイルのコピーなどのリダイレクトを禁止する方法について参考になりましたら幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。&lt;br&gt;本日は、接続元の PC からクラウド PC へのクリップボードやファイルのコピーなどのリダイレクトを禁止する方法についてご紹介します。&lt;br&gt;今回は Intune の構</summary>
      
    
    
    
    
    <category term="Windows 365" scheme="https://jpmem.github.io/blog/tags/Windows-365/"/>
    
  </entry>
  
  <entry>
    <title>クライアント設定が適用されない！確認すべき 3 つのポイント</title>
    <link href="https://jpmem.github.io/blog/mecm/20220408_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220408_01/</id>
    <published>2022-04-07T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.768Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>今回はクライアント設定がクライアント上で適用されない時に確認すべき 3 つのポイントについて解説致します。  </p><h2 id="1-管理コンソールの設定を確認しよう"><a href="#1-管理コンソールの設定を確認しよう" class="headerlink" title="1.管理コンソールの設定を確認しよう"></a>1.管理コンソールの設定を確認しよう</h2><p>まずはデバイスに意図したクライアント設定が展開されているのかを確認しましょう。クライアント設定には「優先順位」が設けられております。優先順位が高い順（1 が一番強い）に反映されていきますので、カスタム　クライアント設定を複数作成、展開している場合には、優先順位に注意が必要となります。  </p><p>※ 優先順位はクライアント設定間で設定箇所が重複した場合にどちらを優先するのかを決定するものとなります。重複していない設定については優先順位に関係なく、クライアントに反映されます。  </p><p>複数のクライアント設定を展開していて、最終的に何が反映されるのかわからなくても大丈夫です。  </p><p>MECM 管理コンソール &gt; [資産とコンプライアンス] &gt; [概要] &gt; [デバイス] にて確認したいデバイスを右クリック &gt; [クライアント設定] &gt; [クライアントの設定の結果] をクリックすると、最終的にどの設定が反映されているのかを確認することができますので、ここで想定していた設定となっていることを確認ください。<br><img src="/blog/mecm/20220408_01/20220408_01_01.png">  </p><p>このように結果を確認することができます。  </p><p><img src="/blog/mecm/20220408_01/20220408_01_02.png"></p><h2 id="2-カスタム-クライアント設定を上書き展開してみよう"><a href="#2-カスタム-クライアント設定を上書き展開してみよう" class="headerlink" title="2.カスタム クライアント設定を上書き展開してみよう"></a>2.カスタム クライアント設定を上書き展開してみよう</h2><p>1 で想定している設定値となっているにも関わらず、クライアント端末側に反映されていない場合には、新たにカスタム クライアント設定を作成し、展開してみましょう。  </p><p>反映されない設定と全く同じ内容でカスタム クライアント設定を作成してください。<br>[管理] &gt; [概要] &gt; [クライアント設定] &gt; [カスタム クライアント デバイスの作成]<br><img src="/blog/mecm/20220408_01/20220408_01_03.png">  </p><p>この時「優先順位」をなるべく高くしておくことがポイントです。<br>（少なくとも反映されないカスタム クライアント設定よりも高くしてください。）<br>新規に作成したカスタム クライアント設定を右クリック &gt; [優先順位を上げる] をクリックします。<br><img src="/blog/mecm/20220408_01/20220408_01_04.png">  </p><p>優先順位を高くしたら、該当のコレクションに展開してみましょう。  </p><p>展開後はクライアント側の次回のコンピューター ポリシー取得のタイミングで反映されるので少し時間をおきましょう。  </p><p>もしすぐに反映を促したい場合には、[資産とコンプライアンス] &gt; [概要] &gt; [デバイス コレクション] にてコレクションを右クリック &gt; [クライアント通知] &gt; [コンピューター ポリシーのダウンロード] をクリックすることでクライアント通知により、ポリシー取得を促すことができますのでお試しください。  </p><p><img src="/blog/mecm/20220408_01/20220408_01_05.png">  </p><h2 id="3-クライアント側で管理ポイントとの疎通状況を確認しよう"><a href="#3-クライアント側で管理ポイントとの疎通状況を確認しよう" class="headerlink" title="3.クライアント側で管理ポイントとの疎通状況を確認しよう"></a>3.クライアント側で管理ポイントとの疎通状況を確認しよう</h2><p>それでも反映されない場合には、クライアントと管理ポイントとの疎通の状態を確認しましょう。  </p><p>1.C:\Windows\CCM\Logs フォルダー配下の CcmMessaging.log を開き、直近の日付で下記のような出力があるかを確認します。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OutgoingMessage(Queue=&#x27;XXXXXXXXXXXXX&#x27;, ID=&#123;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXX&#125;): Delivered successfully to host &#x27;&lt;管理ポイント FQDN&gt;&#x27;.</span><br></pre></td></tr></table></figure><p>2.C:\Windows\CCM\Logs フォルダー配下の PolicyAgent.log を開き、「2.カスタム クライアント設定を再展開してみよう」を展開後に下記のような出力があるかを確認します。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Raising event:instance of CCM_PolicyAgent_PolicyDownloadSucceeded</span><br><span class="line">Raising event:instance of CCM_PolicyAgent_PolicyEvaluationComplete</span><br></pre></td></tr></table></figure><p>もし、上記のどちらかが確認できなかった場合には、管理ポイントからポリシーのダウンロードが完了していないことになります。管理ポイントとの通信状況を確認しましょう。  </p><p>クライアント端末にて、PowerShell を開き、下記コマンドを実行します。  </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-WebRequest</span> <span class="literal">-Uri</span> <span class="string">&quot;http://&lt;管理ポイントの FQDN&gt;/sms_mp/.sms_aut?mplist&quot;</span> <span class="literal">-UseBasicParsing</span></span><br></pre></td></tr></table></figure><p>正常にアクセスできる場合、StatusCode : 200 となります。<br>それ以外の場合には、クライアントと管理ポイントとの間で疎通できていない状態となりますので、ご利用のネットワーク環境上で通信を妨げる何かしらの要因がありますのでご確認くださいませ。  </p><h2 id="4-ログ出力が確認できないが、疎通は成功する場合"><a href="#4-ログ出力が確認できないが、疎通は成功する場合" class="headerlink" title="4.ログ出力が確認できないが、疎通は成功する場合"></a>4.ログ出力が確認できないが、疎通は成功する場合</h2><p>この場合には、詳細な調査が必要となることが想定されますので、弊社サポートへのお問い合わせをご検討下さいませ。  </p><p>なお、お問い合わせいただける際には、下記の情報が必要となりますので予め採取いただけると幸いでございます。</p><h3 id="クライアント設定が格納されている-WMI-の取得"><a href="#クライアント設定が格納されている-WMI-の取得" class="headerlink" title="クライアント設定が格納されている WMI の取得"></a>クライアント設定が格納されている WMI の取得</h3><p>PowerShell を管理者として開き、下記コマンドを実行ください。</p><p>「&lt;取得する WMI クラス名&gt;」箇所は <a href="#WMI-%E3%82%AF%E3%83%A9%E3%82%B9%E5%AF%BE%E5%BF%9C%E8%A1%A8">WMI クラス対応表</a> をご確認の上、問題となるクライアント設定と紐づくクラス名に置き換えて実行くださいませ。  </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\actualconfig <span class="literal">-class</span> &lt;取得する WMI クラス名&gt; &gt; C:\result\actualconfig.txt</span><br><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\requestedconfig <span class="literal">-class</span> &lt;取得する WMI クラス名&gt; &gt; C:\result\requestedconfig.txt</span><br></pre></td></tr></table></figure><p>例：「バックグラウンド インテリジェント転送」のクライアント設定が問題の場合<br>この場合には対象の WMI クラスが 2 つ存在するため、出力ファイル名を変えて実行します。  </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\actualconfig <span class="literal">-class</span> CCM_Service_BITS2Configuration &gt; C:\result\actualconfig_1.txt</span><br><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\requestedconfig <span class="literal">-class</span> CCM_Service_BITS2Configuration &gt; C:\result\requestedconfig_1.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\actualconfig <span class="literal">-class</span> CCM_Service_BITSConfiguration &gt; C:\result\actualconfig_2.txt</span><br><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\requestedconfig <span class="literal">-class</span> CCM_Service_BITSConfiguration &gt; C:\result\requestedconfig_2.txt</span><br></pre></td></tr></table></figure><h3 id="WMI-クラス対応表"><a href="#WMI-クラス対応表" class="headerlink" title="WMI クラス対応表"></a>WMI クラス対応表</h3><hr><table><thead><tr><th>名前</th><th>クラス</th></tr></thead><tbody><tr><td>バックグラウンド インテリジェント転送</td><td>CCM_Service_BITS2Configuration</td></tr><tr><td></td><td>CCM_Service_BITSConfiguration</td></tr><tr><td>クライアント キャッシュの設定</td><td>CCM_SuperPeerClientConfig</td></tr><tr><td>クライアント ポリシー</td><td>CCM_PolicyAgent_Configuration</td></tr><tr><td>クラウド サービス</td><td>CCM_CloudClientConfig</td></tr><tr><td>コンプライアンス設定</td><td>CCM_ConfigurationManagementClientConfig</td></tr><tr><td>コンピューター エージェント</td><td>CCM_ClientAgentConfig</td></tr><tr><td>コンピューターの再起動</td><td>CCM_RebootSettings</td></tr><tr><td>配信の最適化</td><td>CCM_WindowsDOClientConfig</td></tr><tr><td>Endpoint Protection</td><td>CCM_EndpointProtectionClientConfig</td></tr><tr><td>ハードウェア インベントリ</td><td>InventoryDataItem</td></tr><tr><td></td><td>CCM_HardwareInventoryClientConfig</td></tr><tr><td></td><td>CCM_Scheduler_ScheduledMessage</td></tr><tr><td>従量制インターネット接続</td><td>CCM_NetworkSettings</td></tr><tr><td>電源管理</td><td>CCM_Scheduler_ScheduledMessage</td></tr><tr><td>リモート ツール</td><td>CCM_RemoteToolsConfig</td></tr><tr><td>ソフトウェア センター</td><td>CCM_SoftwareCenterClientConfig</td></tr><tr><td>ソフトウェアの展開</td><td>CCM_Scheduler_ScheduledMessage</td></tr><tr><td>ソフトウェア インベントリ</td><td>CCM_SoftwareInventoryClientConfig</td></tr><tr><td>ソフトウェア使用状況の測定</td><td>CCM_SoftwareMeteringClientConfig</td></tr><tr><td>ソフトウェア更新プログラム</td><td>CCM_SoftwareUpdatesClientConfig</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;今回はクライアント設定がクライアント上で適用されない時に確認すべき 3 つのポイントについて解説致します。  &lt;/p&gt;
&lt;h2 id=&quot;1-管理コンソールの設定を確認</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>WSUS サーバーを新しいハードへ移設したい</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-04-08_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-04-08_01/</id>
    <published>2022-04-07T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.884Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。 WSUS サポート チームです。</p><p>今回は、旧サーバーから新サーバーへ WSUS を移行する方法をご紹介します。<br>ハードウェアの老朽化や運用上の様々な理由から WSUS サーバー を移行する必要があるといったようなときに際にお役立ていただける情報です。  </p><ul><li><strong>A. 一時的にレプリカ構成にする</strong></li><li><strong>B. 更新プログラム情報をファイル ベースで移行する</strong></li><li><strong>C. データベースバックアップをリストアし移行する</strong>  </li></ul><h3 id="A-一時的にレプリカ構成にする"><a href="#A-一時的にレプリカ構成にする" class="headerlink" title="A. 一時的にレプリカ構成にする"></a><strong>A. 一時的にレプリカ構成にする</strong></h3><p>旧 WSUS サーバーを親とし、移設先の新しい WSUS サーバーを子として新規構築します<br>この時、新しい WSUS サーバーをレプリカとして設定し、旧 WSUS サーバーと同期を行う方法です。<br>＜手順＞    </p><ol><li><p>WSUS コンソールを開き、 [オプション] - [更新元およびプロキシ サーバー] にて以下の設定を行います。<br>・親となる旧 WSUS サーバーの指定<br>・[このサーバーはアップストリーム サーバーのレプリカです] へのチェック<br><img src="/blog/wsus/2022-04-08_01/2022-04-08_01_1.png">  </p></li><li><p>同期が完了した後で親子構成を解除すると、新しい WSUS サーバーへ、旧 WSUS サーバーの情報が複製された状態で、スタンドアロンの WSUS が出来上がります。<br>忘れずに新しい WSUS サーバー側でオプションを再設定すれば、移行は完了です。  </p></li></ol><p>※ 注意 ※<br>レプリカ構成の場合、WSUS サーバーのバージョンは、下位が上位と同じバージョン又は上位よりも下位が古いバージョンである必要があります。<br>下位が上位よりもバージョンが新しい場合はサポートされません。（ ※ WSUS バージョンは OS バージョンと紐づいています ）  </p><h3 id="B-更新プログラム情報をファイル-ベースで移行する"><a href="#B-更新プログラム情報をファイル-ベースで移行する" class="headerlink" title="B. 更新プログラム情報をファイル ベースで移行する"></a><strong>B. 更新プログラム情報をファイル ベースで移行する</strong></h3><p>オフライン環境に WSUS サーバーを構築するのと同じ要領で、旧 WSUS サーバーで保持している更新プログラムの情報を移行させる方法です。  </p><p>下記の 2 つを旧 WSUS サーバーより取得し、新しい WSUS サーバーへインポートし取り入れます。<br>– カタログのメタデータ ( 更新プログラムのリスト )<br>– WsusContent フォルダ ( 更新ファイル )  </p><p>＜手順＞  </p><ol><li>旧 WSUS サーバー上で下記のコマンドを実行し、データベース内の更新プログラム情報をファイルへエクスポートします。  </li></ol><p>C:\Program Files\Update Services\Tools に作成する場合  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">　cd &quot;C:\Program Files\Update Services\Tools&quot;  </span><br><span class="line">　wsusutil.exe export export.xml.gz export.log  </span><br></pre></td></tr></table></figure><ol start="2"><li>旧 WSUS サーバーの WsusContent フォルダ内にあるダウンロード済みファイルを、すべて新 WSUS サーバーへコピーします。<br>もし新 WSUS サーバーでファイルのダウンロードをやり直す場合には、コピー不要です。  </li></ol><ol start="3"><li>新 WSUS サーバー上で下記のコマンドを実行し、旧 WSUS サーバーの更新プログラム情報をインポートします。  </li></ol><p>C:\Program Files\Update Services\Tools にコピーした場合    </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &quot;C:\Program Files\Update Services\Tools&quot;  </span><br><span class="line">wsusutil.exe import import.xml.gz import.log  </span><br></pre></td></tr></table></figure><ol start="4"><li>新 WSUS サーバー上で下記のコマンドを実行し、データベース内の更新プログラム情報と、WsusContent フォルダ内のファイル情報の整合性をチェックします。<br>ドキュメントに記載のない手順なのですが、もしファイル コピーに抜けがあると配布に支障が出るため、念のために実行してください。  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsusutil.exe reset  </span><br></pre></td></tr></table></figure>もし 3. でファイルのコピーを実施しなかった場合や、コピーに抜けがありファイルが不足している場合には、ダウンロードが行われます。  </li></ol><p>※ 注意 ※<br>この方法では、データベース内の更新プログラムのカタログ情報 及び その更新プログラムの実体となるコンテンツファイルのコピーを新 WSUS サーバーへ取り入れる方法ですので、旧 WSUS サーバーのインストール承認や拒否済みの情報、コンピュータグループ情報などは移行されません。  </p><p>参考情報<br> <a href="https://docs.microsoft.com/ja-jp/security-updates/windowsupdateservices/18111626">コマンド ラインからの WSUS の管理</a></p><h3 id="C-データベースバックアップをリストアし移行する"><a href="#C-データベースバックアップをリストアし移行する" class="headerlink" title="C. データベースバックアップをリストアし移行する"></a><strong>C. データベースバックアップをリストアし移行する</strong></h3><p>旧 WSUS サーバーのバックアップを取得し、新 WSUS サーバーにリストアする方法です。  </p><p>＜手順＞<br>下記の公開記事にてデータベースを取得してリストアする方法での手順をご紹介しておりますのでご参照ください。<br>参考情報<br><a href="https://jpmem.github.io/blog/wsus/2021-10-19_01/#WSUS-%E7%A7%BB%E8%A1%8C%E6%89%8B%E9%A0%86%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6-WID-gt-WID">WSUS 移行手順について (WID -&gt; WID)</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。 WSUS サポート チームです。&lt;/p&gt;
&lt;p&gt;今回は、旧サーバーから新サーバーへ WSUS を移行する方法をご紹介します。&lt;br&gt;ハードウェアの老朽化や運用上の様々な理由から WSUS サーバー を移行する必要があるといったようなときに際にお役立て</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>Windows 365 のクラウド PC を以前の状態に復元する方法について</title>
    <link href="https://jpmem.github.io/blog/w365/2022-04-06_01/"/>
    <id>https://jpmem.github.io/blog/w365/2022-04-06_01/</id>
    <published>2022-04-05T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.836Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。<br>本日は、Windows 365 のクラウド PC を以前の状態に復元する方法についてご案内します。</p><p>2022 年 3 月より、Windows 365 Enterprise / Business ともに特定の時点に復元することができるようになりました。本機能はまだパブリック プレビュー段階ですが、その使用方法をご紹介いたします。</p><h2 id="免責事項"><a href="#免責事項" class="headerlink" title="免責事項"></a>免責事項</h2><p>下記内容は 2022/4/6 時点での内容についての記載となっております。<br>今後内容が更新されることもございますので、その点ご承知置きくださいますようお願い致します。</p><h2 id="Windows-365-Enterprise-環境のクラウド-PC-を以前の状態に復元"><a href="#Windows-365-Enterprise-環境のクラウド-PC-を以前の状態に復元" class="headerlink" title="Windows 365 Enterprise 環境のクラウド PC を以前の状態に復元"></a>Windows 365 Enterprise 環境のクラウド PC を以前の状態に復元</h2><ol><li><p>グローバル管理者などの権限を持つアカウントで Microsoft Endpoint Manager admin center (<a href="https://aka.ms/memac">https://aka.ms/memac</a>) にログインします。</p></li><li><p>[デバイス] - [Windows 365] - [すべてのクラウド PC] と辿り、特定の地点に復元したいクラウド PC を選択します。</p></li><li><p>画面上部の [復元（プレビュー）] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-29-32.png"></p></li><li><p>復元したい地点の日時を選択し、画面下部の [選択] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-30-55.png"></p></li><li><p>以下の画面が表示されるので、[復元] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-31-14.png"></p></li><li><p>[Restore 保留中…] と表示されるので、復元されるまで待ちます。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-31-37.png"></p></li><li><p>[Restore 完了] と表示されたら（弊社環境では約 15 分ほどで完了しました）、クラウド PC にサインインし、選択した日時の状態に復元していることを確認します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-32-21.png"></p></li></ol><p>■ 補足事項<br>Windows 365 Enterprise ではユーザーによる復元を許可するか否かと復元ポイントの更新頻度を設定することが可能です。設定箇所は以下です。</p><ol><li>グローバル管理者などの権限を持つアカウントで Microsoft Endpoint Manager admin center (<a href="https://aka.ms/memac">https://aka.ms/memac</a>) にログインします。</li><li>[デバイス] - [Windows 365] - [ユーザー設定] と辿り、[追加] を選択します。</li><li>[名前] を入力し、ユーザーによる復元を許可する場合は [ユーザーによる復元サービスの開始を許可する] にチェックを入れます。</li><li>[復元ポイント サービスの頻度] からプルダウンメニューで復元ポイントの更新頻度を選択し、[次へ] を選択します。</li><li>割り当てるグループを選択し、[次へ] を選択します。</li><li>[作成] を選択し、ユーザー設定を完了させます。</li></ol><p>参考公開情報<br>Title : 単一のクラウド PC を以前の状態に復元する<br>URL : <a href="https://docs.microsoft.com/ja-jp/windows-365/enterprise/restore-single-cloud-pc">https://docs.microsoft.com/ja-jp/windows-365/enterprise/restore-single-cloud-pc</a></p><h2 id="Windows-365-Business-環境のクラウド-PC-を以前の状態に復元"><a href="#Windows-365-Business-環境のクラウド-PC-を以前の状態に復元" class="headerlink" title="Windows 365 Business 環境のクラウド PC を以前の状態に復元"></a>Windows 365 Business 環境のクラウド PC を以前の状態に復元</h2><p>Business は Microsoft Endpoint Manager admin center からの復元はできませんが、以下の手順で復元することが可能です。</p><ol><li><p>Windows 365 Business のライセンスを持ったユーザーで以下の URL にサインインします。<br><a href="https://windows365.microsoft.com/">https://windows365.microsoft.com/</a></p></li><li><p>歯車アイコンから、[復元（プレビュー）] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-32-45.png"></p></li><li><p>[はい、この クラウド PC を復元します。] にチェックを入れ、復元したい日時を選択して [復元] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-33-07.png"></p></li><li><p>数十分待ち、[クラウド PC が復元されました] と表示されたら復元成功です（弊社環境では約 15 分ほどで完了しました）。クラウド PC にサインインし、選択した日時の状態に復元していることを確認します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-33-26.png"></p></li></ol><p>■ 補足事項<br>2022/4/6 時点では、Windows 365 Business は復元ポイントの更新頻度が 12 時間で固定されています。</p><p>参考公開情報<br>Title : Windows 365 Business (プレビュー) の特定の時点への復元<br>URL : <a href="https://docs.microsoft.com/ja-jp/windows-365/business/restore-overview">https://docs.microsoft.com/ja-jp/windows-365/business/restore-overview</a></p><p>以上、クラウド PC を以前の状態に復元する方法について参考になりましたら幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。&lt;br&gt;本日は、Windows 365 のクラウド PC を以前の状態に復元する方法についてご案内します。&lt;/p&gt;
&lt;p&gt;2022 年 3 月より、Windows 365 En</summary>
      
    
    
    
    
    <category term="Windows 365" scheme="https://jpmem.github.io/blog/tags/Windows-365/"/>
    
  </entry>
  
  <entry>
    <title>クラウド管理ゲートウェイ (CMG) の設計ポイントについて (2)</title>
    <link href="https://jpmem.github.io/blog/mecm/20220401_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220401_01/</id>
    <published>2022-03-31T15:00:00.000Z</published>
    <updated>2022-05-30T03:28:54.768Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Microsoft Endpoint Configuration Manager (MECM) にて提供されるクラウド管理ゲートウェイ (CMG) の設計ポイントについてご案内します。  </p><p>本記事は以下の二部構成としております。</p><ol><li>CMG の概要とユースケース、及びリバース プロキシとして CMG を利用する際の設計ポイントについてご案内いたします。</li><li>(本記事) 配布ポイントとしての CMG についてとインターネット アクセス要件、セキュリティ、サイジング設計、コスト見積についてご案内致します。  </li></ol><p>なお、下記は MECM CB 2111 および仮想マシン スケール セット (VMSS) の CMG のご利用を前提としておりますのでご留意くださいませ。</p><h2 id="CMG-のクラウド上の配布ポイント機能"><a href="#CMG-のクラウド上の配布ポイント機能" class="headerlink" title="CMG のクラウド上の配布ポイント機能"></a>CMG のクラウド上の配布ポイント機能</h2><p>CMG を Azure 上の配布ポイントとして提供する機能です。本機能はリバース プロキシ機能とは異なり、イントラネット端末、インターネット端末両方で利用可能です。イントラネット端末が CMG を配布ポイントとして利用する場合は境界グループへの CMG の紐付けが必要です。インターネット端末はイントラネット端末と異なり、境界グループの影響無しにダウンロード元を決定します。コンテンツ別の、ダウンロード元については以下の図を参考ください。</p><p><img src="/blog/mecm/20220401_01/20220401_01_01.png">  </p><p>上記図で示している、イントラネット端末に対して、Windows Update や Office CDN をダウンロード元のリストに追加する「展開設定」とは以下のオプションを指します。  </p><p>[CM コンソール] - [ソフトウェア ライブラリ] - [概要] - [ソフトウェア更新プログラム] - [すべてのソフトウェア更新プログラム] - [展開] - [プロパティ] - [ダウンロードの設定]タブ</p><p><img src="/blog/mecm/20220401_01/20220401_01_02.png">  </p><p>また、イントラネット端末に対して、イントラネットの配布ポイントよりも、Windows Update や Office CDN, CMG からのダウンロードを優先させるためには以下のオプションを有効化します。  </p><p>[CM コンソール] - [管理] - [概要] - [階層の構成] - [境界グループ] - 対象の境界グループを選択 - [プロパティ] - [オプション]タブ - [オンプレミスのソースよりクラウド ベースのソースを優先します]  </p><p><img src="/blog/mecm/20220401_01/20220401_01_03.png">  </p><h3 id="CMG-での-Microsoft-365-Apps-更新プログラムの配布について"><a href="#CMG-での-Microsoft-365-Apps-更新プログラムの配布について" class="headerlink" title="CMG での Microsoft 365 Apps 更新プログラムの配布について"></a>CMG での Microsoft 365 Apps 更新プログラムの配布について</h3><p>以下でもご案内している通り、 Microsoft 365 Apps の更新プログラムは CMG からの配布をサポートしておりません。 インターネット端末に対しては、 Office CDN からのダウンロード、イントラネット端末に対しては、イントラネットの配布ポイントもしくは Office CDN からダウンロードするようにご対応ください。</p><p>クラウド管理ゲートウェイでサポートされる構成<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/supported-configurations">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/supported-configurations</a>  </p><h3 id="CMG-利用による-VPN-帯域使用料削減の条件"><a href="#CMG-利用による-VPN-帯域使用料削減の条件" class="headerlink" title="CMG 利用による VPN 帯域使用料削減の条件"></a>CMG 利用による VPN 帯域使用料削減の条件</h3><p>多くのお客様において、VPN 帯域の利用料削減を目的に CMG 導入をご検討されることが多くございます。この際の条件としては、URL 指定による VPN スプリット トンネリング機能が必要になって参ります。お客様によっては、IP アドレス指定による VPN スプリット トンネリング機能しかご利用できない場合がございますが、Windows Update や Office CDN, および CMG は URL 指定によるサービスを前提としております。URL 指定の VPN スプリット トンネリング機能のご利用をお勧め致します。</p><h2 id="CMG-のインターネットアクセス要件"><a href="#CMG-のインターネットアクセス要件" class="headerlink" title="CMG のインターネットアクセス要件"></a>CMG のインターネットアクセス要件</h2><p>以下ドキュメントにまとまっております。</p><p>CMG のデータ フロー<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/data-flow">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/data-flow</a></p><p>主な通信経路は以下の図の通りです。<br><img src="/blog/mecm/20220401_01/20220401_01_04.png"></p><p>なお、CMDB 内の AzureEnvironments テーブルの中身はそれぞれご確認くださいますようお願い致します。ご参考までに、弊社環境における MECM CB 2111 の場合、他との重複を除きますと、AzurePublicCloud レコードの値は以下の通りです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">https://management.core.windows.net/</span><br><span class="line">https://login.microsoftonline.com/</span><br><span class="line">https://gallery.azure.com/</span><br><span class="line">https://vault.azure.net/</span><br><span class="line">core.windows.net</span><br><span class="line">database.windows.net</span><br><span class="line">trafficmanager.net</span><br><span class="line">vault.azure.net</span><br><span class="line">servicebus.azure.com</span><br><span class="line">cloudapp.net</span><br><span class="line">https://graph.microsoft.com/</span><br><span class="line">https://gateway.configmgr.manage.microsoft.com/</span><br><span class="line">https://cmmicrosvc.manage.microsoft.com/</span><br><span class="line">https://portal.manage.microsoft.com/</span><br><span class="line">https://enrollment.manage.microsoft.com/</span><br><span class="line">https://login.windows.net/</span><br><span class="line">cloudapp.azure.com</span><br></pre></td></tr></table></figure><h2 id="CMG-のセキュリティ"><a href="#CMG-のセキュリティ" class="headerlink" title="CMG のセキュリティ"></a>CMG のセキュリティ</h2><p>CMG は PaaS レベルで提供されるクラウド サービスです。そのため、責任共有モデルも PaaS のものに準じます。</p><p>クラウドにおける共同責任<br><a href="https://docs.microsoft.com/ja-jp/azure/security/fundamentals/shared-responsibility">https://docs.microsoft.com/ja-jp/azure/security/fundamentals/shared-responsibility</a></p><p>CMG で考慮すべき(設定可能な)セキュリティについては以下にまとまっておりますのでこちらをご参照ください。</p><p>クラウド管理ゲートウェイのセキュリティとプライバシー<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/security-and-privacy-for-cloud-management-gateway">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/security-and-privacy-for-cloud-management-gateway</a></p><h2 id="CMG-のサイジング設計について"><a href="#CMG-のサイジング設計について" class="headerlink" title="CMG のサイジング設計について"></a>CMG のサイジング設計について</h2><p>CMG のサイジングについては下記ガイドをご参照ください。</p><p>CMG のパフォーマンスとスケール<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/perf-scale">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/perf-scale</a></p><p>上記 URL の注意点としましては、表記される数値はあくまで同時クライアント接続数であることです。1 台のクライアントから CMG に対して複数の接続がある場合もあり、その場合クライアント台数とは完全には一致しませんので、余裕を持って設計されることをお勧め致します。</p><h2 id="CMG-のコスト見積について"><a href="#CMG-のコスト見積について" class="headerlink" title="CMG のコスト見積について"></a>CMG のコスト見積について</h2><p>CMG のコスト見積については下記を参照ください。多くの場合、仮想マシンより Azure からクライアントに対するアウトバウンド ネットワークの費用が、総コストのうち、多くの割合を占めます。</p><p>CMG のコスト<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/cost">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/cost</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Microsoft Endpoint Configuration Manager (MECM) にて提供されるクラウド管理ゲートウェイ (CMG) の設計ポイントについてご案内し</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
    <category term="CMG" scheme="https://jpmem.github.io/blog/tags/CMG/"/>
    
  </entry>
  
</feed>
