<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Microsoft Endpoint Manager Support Blog</title>
  
  <subtitle>日本マイクロソフトの Microsoft Endpoint Manager に関するサポート情報のブログです。</subtitle>
  <link href="https://jpmem.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpmem.github.io/blog/"/>
  <updated>2022-04-06T11:28:26.402Z</updated>
  <id>https://jpmem.github.io/blog/</id>
  
  <author>
    <name>Microsoft Endpoint Manager Support Japan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Windows 365 のクラウド PC を以前の状態に復元する方法について</title>
    <link href="https://jpmem.github.io/blog/w365/2022-04-06_01/"/>
    <id>https://jpmem.github.io/blog/w365/2022-04-06_01/</id>
    <published>2022-04-05T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.402Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。<br>本日は、Windows 365 のクラウド PC を以前の状態に復元する方法についてご案内します。</p><p>2022 年 3 月より、Windows 365 Enterprise / Business ともに特定の時点に復元することができるようになりました。本機能はまだパブリック プレビュー段階ですが、その使用方法をご紹介いたします。</p><h2 id="免責事項"><a href="#免責事項" class="headerlink" title="免責事項"></a>免責事項</h2><p>下記内容は 2022/4/6 時点での内容についての記載となっております。<br>今後内容が更新されることもございますので、その点ご承知置きくださいますようお願い致します。</p><h2 id="Windows-365-Enterprise-環境のクラウド-PC-を以前の状態に復元"><a href="#Windows-365-Enterprise-環境のクラウド-PC-を以前の状態に復元" class="headerlink" title="Windows 365 Enterprise 環境のクラウド PC を以前の状態に復元"></a>Windows 365 Enterprise 環境のクラウド PC を以前の状態に復元</h2><ol><li><p>グローバル管理者などの権限を持つアカウントで Microsoft Endpoint Manager admin center (<a href="https://aka.ms/memac">https://aka.ms/memac</a>) にログインします。</p></li><li><p>[デバイス] - [Windows 365] - [すべてのクラウド PC] と辿り、特定の地点に復元したいクラウド PC を選択します。</p></li><li><p>画面上部の [復元（プレビュー）] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-29-32.png"></p></li><li><p>復元したい地点の日時を選択し、画面下部の [選択] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-30-55.png"></p></li><li><p>以下の画面が表示されるので、[復元] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-31-14.png"></p></li><li><p>[Restore 保留中…] と表示されるので、復元されるまで待ちます。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-31-37.png"></p></li><li><p>[Restore 完了] と表示されたら（弊社環境では約 15 分ほどで完了しました）、クラウド PC にサインインし、選択した日時の状態に復元していることを確認します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-32-21.png"></p></li></ol><p>■ 補足事項<br>Windows 365 Enterprise ではユーザーによる復元を許可するか否かと復元ポイントの更新頻度を設定することが可能です。設定箇所は以下です。</p><ol><li>グローバル管理者などの権限を持つアカウントで Microsoft Endpoint Manager admin center (<a href="https://aka.ms/memac">https://aka.ms/memac</a>) にログインします。</li><li>[デバイス] - [Windows 365] - [ユーザー設定] と辿り、[追加] を選択します。</li><li>[名前] を入力し、ユーザーによる復元を許可する場合は [ユーザーによる復元サービスの開始を許可する] にチェックを入れます。</li><li>[復元ポイント サービスの頻度] からプルダウンメニューで復元ポイントの更新頻度を選択し、[次へ] を選択します。</li><li>割り当てるグループを選択し、[次へ] を選択します。</li><li>[作成] を選択し、ユーザー設定を完了させます。</li></ol><p>参考公開情報<br>Title : 単一のクラウド PC を以前の状態に復元する<br>URL : <a href="https://docs.microsoft.com/ja-jp/windows-365/enterprise/restore-single-cloud-pc">https://docs.microsoft.com/ja-jp/windows-365/enterprise/restore-single-cloud-pc</a></p><h2 id="Windows-365-Business-環境のクラウド-PC-を以前の状態に復元"><a href="#Windows-365-Business-環境のクラウド-PC-を以前の状態に復元" class="headerlink" title="Windows 365 Business 環境のクラウド PC を以前の状態に復元"></a>Windows 365 Business 環境のクラウド PC を以前の状態に復元</h2><p>Business は Microsoft Endpoint Manager admin center からの復元はできませんが、以下の手順で復元することが可能です。</p><ol><li><p>Windows 365 Business のライセンスを持ったユーザーで以下の URL にサインインします。<br><a href="https://windows365.microsoft.com/">https://windows365.microsoft.com/</a></p></li><li><p>歯車アイコンから、[復元（プレビュー）] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-32-45.png"></p></li><li><p>[はい、この クラウド PC を復元します。] にチェックを入れ、復元したい日時を選択して [復元] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-33-07.png"></p></li><li><p>数十分待ち、[クラウド PC が復元されました] と表示されたら復元成功です（弊社環境では約 15 分ほどで完了しました）。クラウド PC にサインインし、選択した日時の状態に復元していることを確認します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-33-26.png"></p></li></ol><p>■ 補足事項<br>2022/4/6 時点では、Windows 365 Business は復元ポイントの更新頻度が 12 時間で固定されています。</p><p>参考公開情報<br>Title : Windows 365 Business (プレビュー) の特定の時点への復元<br>URL : <a href="https://docs.microsoft.com/ja-jp/windows-365/business/restore-overview">https://docs.microsoft.com/ja-jp/windows-365/business/restore-overview</a></p><p>以上、クラウド PC を以前の状態に復元する方法について参考になりましたら幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。&lt;br&gt;本日は、Windows 365 のクラウド PC を以前の状態に復元する方法についてご案内します。&lt;/p&gt;
&lt;p&gt;2022 年 3 月より、Windows 365 En</summary>
      
    
    
    
    
    <category term="Windows 365" scheme="https://jpmem.github.io/blog/tags/Windows-365/"/>
    
  </entry>
  
  <entry>
    <title>クラウド管理ゲートウェイ (CMG) の設計ポイントについて (2)</title>
    <link href="https://jpmem.github.io/blog/mecm/20220401_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220401_01/</id>
    <published>2022-03-31T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.382Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Microsoft Endpoint Configuration Manager (MECM) にて提供されるクラウド管理ゲートウェイ (CMG) の設計ポイントについてご案内します。  </p><p>本記事は以下の二部構成としております。</p><ol><li>CMG の概要とユースケース、及びリバース プロキシとして CMG を利用する際の設計ポイントについてご案内いたします。</li><li>(本記事) 配布ポイントとしての CMG についてとインターネット アクセス要件、セキュリティ、サイジング設計、コスト見積についてご案内致します。  </li></ol><p>なお、下記は MECM CB 2111 および仮想マシン スケール セット (VMSS) の CMG のご利用を前提としておりますのでご留意くださいませ。</p><h2 id="CMG-のクラウド上の配布ポイント機能"><a href="#CMG-のクラウド上の配布ポイント機能" class="headerlink" title="CMG のクラウド上の配布ポイント機能"></a>CMG のクラウド上の配布ポイント機能</h2><p>CMG を Azure 上の配布ポイントとして提供する機能です。本機能はリバース プロキシ機能とは異なり、イントラネット端末、インターネット端末両方で利用可能です。イントラネット端末が CMG を配布ポイントとして利用する場合は境界グループへの CMG の紐付けが必要です。インターネット端末はイントラネット端末と異なり、境界グループの影響無しにダウンロード元を決定します。コンテンツ別の、ダウンロード元については以下の図を参考ください。</p><p><img src="/blog/mecm/20220401_01/20220401_01_01.png">  </p><p>上記図で示している、イントラネット端末に対して、Windows Update や Office CDN をダウンロード元のリストに追加する「展開設定」とは以下のオプションを指します。  </p><p>[CM コンソール] - [ソフトウェア ライブラリ] - [概要] - [ソフトウェア更新プログラム] - [すべてのソフトウェア更新プログラム] - [展開] - [プロパティ] - [ダウンロードの設定]タブ</p><p><img src="/blog/mecm/20220401_01/20220401_01_02.png">  </p><p>また、イントラネット端末に対して、イントラネットの配布ポイントよりも、Windows Update や Office CDN, CMG からのダウンロードを優先させるためには以下のオプションを有効化します。  </p><p>[CM コンソール] - [管理] - [概要] - [階層の構成] - [境界グループ] - 対象の境界グループを選択 - [プロパティ] - [オプション]タブ - [オンプレミスのソースよりクラウド ベースのソースを優先します]  </p><p><img src="/blog/mecm/20220401_01/20220401_01_03.png">  </p><h3 id="CMG-での-Microsoft-365-Apps-更新プログラムの配布について"><a href="#CMG-での-Microsoft-365-Apps-更新プログラムの配布について" class="headerlink" title="CMG での Microsoft 365 Apps 更新プログラムの配布について"></a>CMG での Microsoft 365 Apps 更新プログラムの配布について</h3><p>以下でもご案内している通り、 Microsoft 365 Apps の更新プログラムは CMG からの配布をサポートしておりません。 インターネット端末に対しては、 Office CDN からのダウンロード、イントラネット端末に対しては、イントラネットの配布ポイントもしくは Office CDN からダウンロードするようにご対応ください。</p><p>クラウド管理ゲートウェイでサポートされる構成<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/supported-configurations">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/supported-configurations</a>  </p><h3 id="CMG-利用による-VPN-帯域使用料削減の条件"><a href="#CMG-利用による-VPN-帯域使用料削減の条件" class="headerlink" title="CMG 利用による VPN 帯域使用料削減の条件"></a>CMG 利用による VPN 帯域使用料削減の条件</h3><p>多くのお客様において、VPN 帯域の利用料削減を目的に CMG 導入をご検討されることが多くございます。この際の条件としては、URL 指定による VPN スプリット トンネリング機能が必要になって参ります。お客様によっては、IP アドレス指定による VPN スプリット トンネリング機能しかご利用できない場合がございますが、Windows Update や Office CDN, および CMG は URL 指定によるサービスを前提としております。URL 指定の VPN スプリット トンネリング機能のご利用をお勧め致します。</p><h2 id="CMG-のインターネットアクセス要件"><a href="#CMG-のインターネットアクセス要件" class="headerlink" title="CMG のインターネットアクセス要件"></a>CMG のインターネットアクセス要件</h2><p>以下ドキュメントにまとまっております。</p><p>CMG のデータ フロー<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/data-flow">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/data-flow</a></p><p>主な通信経路は以下の図の通りです。<br><img src="/blog/mecm/20220401_01/20220401_01_04.png"></p><p>なお、CMDB 内の AzureEnvironments テーブルの中身はそれぞれご確認くださいますようお願い致します。ご参考までに、弊社環境における MECM CB 2111 の場合、他との重複を除きますと、AzurePublicCloud レコードの値は以下の通りです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">https://management.core.windows.net/</span><br><span class="line">https://login.microsoftonline.com/</span><br><span class="line">https://gallery.azure.com/</span><br><span class="line">https://vault.azure.net/</span><br><span class="line">core.windows.net</span><br><span class="line">database.windows.net</span><br><span class="line">trafficmanager.net</span><br><span class="line">vault.azure.net</span><br><span class="line">servicebus.azure.com</span><br><span class="line">cloudapp.net</span><br><span class="line">https://graph.microsoft.com/</span><br><span class="line">https://gateway.configmgr.manage.microsoft.com/</span><br><span class="line">https://cmmicrosvc.manage.microsoft.com/</span><br><span class="line">https://portal.manage.microsoft.com/</span><br><span class="line">https://enrollment.manage.microsoft.com/</span><br><span class="line">https://login.windows.net/</span><br><span class="line">cloudapp.azure.com</span><br></pre></td></tr></table></figure><h2 id="CMG-のセキュリティ"><a href="#CMG-のセキュリティ" class="headerlink" title="CMG のセキュリティ"></a>CMG のセキュリティ</h2><p>CMG は PaaS レベルで提供されるクラウド サービスです。そのため、責任共有モデルも PaaS のものに準じます。</p><p>クラウドにおける共同責任<br><a href="https://docs.microsoft.com/ja-jp/azure/security/fundamentals/shared-responsibility">https://docs.microsoft.com/ja-jp/azure/security/fundamentals/shared-responsibility</a></p><p>CMG で考慮すべき(設定可能な)セキュリティについては以下にまとまっておりますのでこちらをご参照ください。</p><p>クラウド管理ゲートウェイのセキュリティとプライバシー<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/security-and-privacy-for-cloud-management-gateway">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/security-and-privacy-for-cloud-management-gateway</a></p><h2 id="CMG-のサイジング設計について"><a href="#CMG-のサイジング設計について" class="headerlink" title="CMG のサイジング設計について"></a>CMG のサイジング設計について</h2><p>CMG のサイジングについては下記ガイドをご参照ください。</p><p>CMG のパフォーマンスとスケール<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/perf-scale">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/perf-scale</a></p><p>上記 URL の注意点としましては、表記される数値はあくまで同時クライアント接続数であることです。1 台のクライアントから CMG に対して複数の接続がある場合もあり、その場合クライアント台数とは完全には一致しませんので、余裕を持って設計されることをお勧め致します。</p><h2 id="CMG-のコスト見積について"><a href="#CMG-のコスト見積について" class="headerlink" title="CMG のコスト見積について"></a>CMG のコスト見積について</h2><p>CMG のコスト見積については下記を参照ください。多くの場合、仮想マシンより Azure からクライアントに対するアウトバウンド ネットワークの費用が、総コストのうち、多くの割合を占めます。</p><p>CMG のコスト<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/cost">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/cost</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Microsoft Endpoint Configuration Manager (MECM) にて提供されるクラウド管理ゲートウェイ (CMG) の設計ポイントについてご案内し</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
    <category term="CMG" scheme="https://jpmem.github.io/blog/tags/CMG/"/>
    
  </entry>
  
  <entry>
    <title>クラウド管理ゲートウェイ (CMG) の設計ポイントについて (1)</title>
    <link href="https://jpmem.github.io/blog/mecm/20220328_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220328_01/</id>
    <published>2022-03-27T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.378Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Microsoft Endpoint Configuration Manager (MECM) にて提供されるクラウド管理ゲートウェイ (CMG) の設計ポイントについてご案内します。  </p><p>本記事は以下の二部構成としております。  </p><ol><li> (本記事) CMG の概要とユースケース、及びリバース プロキシとして CMG を利用する際の設計ポイントについてご案内いたします。</li><li>配布ポイントとしての CMG についてとインターネット アクセス要件、セキュリティ、サイジング設計、コスト見積についてご案内致します。</li></ol><p>なお、下記は MECM CB 2111 および仮想マシン スケール セット (VMSS) の CMG のご利用を前提としておりますのでご留意くださいませ。</p><p>CMG とは以下の機能を提供する Azure 上で提供されるクラウド サービスです。</p><ul><li>リバース プロキシ機能<ul><li>インターネット上の端末からの通信をイントラネット上の MECM の管理ポイントやソフトウェア更新ポイントに中継する機能。イントラネット上の配布ポイントには中継しませんのでご注意ください。</li></ul></li><li>クラウド上の配布ポイント機能<ul><li>イントラネット、インターネットのどちらの端末に対してもアプリケーションやパッケージを提供するための配布ポイント機能を提供する機能。</li></ul></li></ul><p>下記 URL でもドキュメントをご提供しておりますのでご参照くださいませ。</p><p>クラウド管理ゲートウェイの概要<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/overview">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/overview</a></p><h2 id="CMG-のユースケース"><a href="#CMG-のユースケース" class="headerlink" title="CMG のユースケース"></a>CMG のユースケース</h2><p>CMG を使われるユースケースとしては以下のようなものがございます。</p><ol><li>リモート ワーク向けに貸し出した企業端末をMECMを使ってインターネット経由で管理したい。これを VPN を使わずに実現したい。</li><li>リモート ワーク向けに貸し出した企業端末の更新プログラム適用を実施する際、WSUS と同様レベルで管理したい。その際に、VPN 経由でイントラネットの配布ポイントからコンテンツをダウンロードさせるのでは無く、Microsoft の Windows Update や Office CDN からダウンロードさせることにより、限られた社内インターネット帯域の逼迫を回避したい。</li><li>社内にある端末だが、事業拠点とデータセンター間の帯域より、インターネット回線の方が早い、もしくは空いているのでそちらを使いたい。</li></ol><h2 id="CMG-のリバース-プロキシ機能"><a href="#CMG-のリバース-プロキシ機能" class="headerlink" title="CMG のリバース プロキシ機能"></a>CMG のリバース プロキシ機能</h2><p>CMG をリバース プロキシとして利用する場合、以下の要素をご理解くださいますようお願い致します。</p><ol><li>インターネット端末のみが CMG をリバース プロキシとして利用する<ul><li>イントラネットとして判定されている端末は CMG をリバース プロキシとして利用できません。後述するインターネット端末の判定フローで、イントラネット端末として判定された端末は例え御社外のネットワークにいる端末でも CMG をリバース プロキシとして利用しません。</li></ul></li><li>CMG を利用するためクライアント認証が発生する<ul><li>CMG はインターネット上に公開されているサービスなので、不特定多数の端末から管理対象のデバイスの通信のみを受け付けるため、認証行為が発生します。この認証方式は全 3 種類存在し、どの認証方式を採用しているかよく理解しておかないと、CMG に接続出来ないなどのトラブル シューティングの際に苦労することになります。</li></ul></li><li>サイト サーバー間の通信暗号化が必要<ul><li>過去の MECM サーバーの通信と異なり、通信の暗号化のために SSL 証明書が必要となります。各 サイト サーバーにどの証明書が必要かを理解しておかないと環境構築の際のトラブルの原因となります。</li></ul></li></ol><h3 id="MECM-におけるインターネット端末の判定"><a href="#MECM-におけるインターネット端末の判定" class="headerlink" title="MECM におけるインターネット端末の判定"></a>MECM におけるインターネット端末の判定</h3><p>上記でもご案内の通り、インターネット端末として判定されない場合、クライアントはイントラネット用の管理ポイントに対して通信を試みる形となります。<br>MECM において、端末がインターネット経由で接続しているのか、イントラネット経由で接続しているのかの判定条件は以下の図のとおりです。オンプレミス ADに参加している、リモート ワーク向け端末が VPN を介して、オンプレミス ADのドメイン コントローラーやイントラネットの管理ポイントに接続できてしまうと、たとえ利用している回線がインターネット回線でもイントラネット端末として判定されてしまいます。こちらを回避するためにはレジストリを使って「常にインターネット」の設定をする必要がございますのでご理解くださいますようお願い致します。</p><p><img src="/blog/mecm/20220328_01/20220328_01_01.png"></p><h3 id="CMG-におけるクライアント認証"><a href="#CMG-におけるクライアント認証" class="headerlink" title="CMG におけるクライアント認証"></a>CMG におけるクライアント認証</h3><p>CMG は不特定多数の端末からアクセスがあるため、クライアント認証を行い、成功した端末の通信のみをイントラネットの MECM サーバーに中継する仕組みを持ちます。認証の仕組みとしては以下の3つがございます。</p><ol><li>Azure AD 認証</li><li>PKI 証明書認証</li><li>サイト トークン認証</li></ol><p>CMG の認証は 1 -&gt; 2 -&gt; 3 の流れでフォールバックしていきます。　　</p><h4 id="Azure-AD-認証"><a href="#Azure-AD-認証" class="headerlink" title="Azure AD 認証"></a>Azure AD 認証</h4><p>Windows 10 / 11 端末のみが利用できる Azure AD を使った認証です。Azure AD connect を使ってオンプレミスの AD の情報を Azure AD に同期したり、直接端末を Azure AD に参加させて、その際の シングル サインオン情報を使って認証を行います。 インターネット上の Windows 8.1 や Windows Server 端末は本認証は利用できませんので、他の認証方式と併用する形となります。</p><p>なお、CMG では 他のクライアント認証方式を使う場合、Azure AD connectを使った AD - Azure AD 間同期は不要です。ただし、多くの場合、CMG 利用と共同管理の利用は同時に検討されることが多いので、その場合は Hybrid Azure AD 構成が必要になります。</p><h4 id="PKI-証明書認証"><a href="#PKI-証明書認証" class="headerlink" title="PKI 証明書認証"></a>PKI 証明書認証</h4><p>企業内のクライアント証明書配布基盤により配布されたクライアント証明書により認証を行う方式です。例えば、Active Directory 証明書サービスとグループ ポリシーを使って配布する、といった方法があるでしょう。よくありがちなトラブルとして、証明書失効リスト (CRL) の公開元がインターネット公開されていないために CRL チェックが出来ずに認証失敗と言ったものがあります。CRL をインターネット公開していない場合は、以下のように CMG のクライアント認証設定で CRL チェックを外すと解決します。  </p><p><img src="/blog/mecm/20220328_01/20220328_01_07.png">  </p><p>また、同様に CMG のサーバー証明書の CRL をインターネット公開していないために CMG と通信できない場合は、以下のようにサイトの設定で CRL チェックを外すと解決します。  </p><p>[CM コンソール] - [管理] - [概要] - [サイトの構成] - [サイト] - 対象のサイトを選択 - [プロパティ] - [通信セキュリティ]タブ</p><p><img src="/blog/mecm/20220328_01/20220328_01_08.png">  </p><h4 id="サイト-トークン認証"><a href="#サイト-トークン認証" class="headerlink" title="サイト トークン認証"></a>サイト トークン認証</h4><p>Azure AD 認証や PKI 証明書認証基盤が利用出来ない環境における認証手段となります。サイト トークン認証は以下の二つの場合に利用されますが、それぞれ利用するトークンが異なります。</p><ul><li><p>インターネット端末の MECM サーバーへの登録: 一括登録トークン</p><ul><li><p>インターネット端末が MECM サーバーと初めて通信を行う際、サーバー登録用の認証が必要となります。Azure AD や証明書の代替として、登録の際に利用されるトークンが一括登録トークンです。一括登録トークンは階層内の最上位サイト サーバー (中央管理サイト サーバーもしくはプライマリサイト サーバー) にある  BulkRegistrationTokenTool.exe ツールを使用して発行します。このトークンは既定では 3 日間、最大 7 日間有効であり、期間内にインターネット端末にて ccmsetup のオプションでこのトークンを指定すると、インターネット越しでの端末登録が成功します。  </p><p>一括登録トークン<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/deploy/deploy-clients-cmg-token#bulk-registration-token">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/deploy/deploy-clients-cmg-token#bulk-registration-token</a></p></li></ul></li><li><p>MECM サーバーとの通信: 自己証明 (SelfProve) トークン</p><ul><li>一度でも MECM サーバーとの通信に成功したことのあるデバイスに自動的に割り当てられるトークンです。本トークンは 90 日間有効で、インターネット経由でも、イントラネット経由でも MECM サーバーに通信が行われると月に 1 回、自動で更新される仕組みとなっています。90 日間、1度も MECM サーバーに接続出来ないで居ると、本トークンは無効化されます。トークンが無効化された端末はイントラネット経由で MECM サーバーに接続して再度、本トークンを取得する必要があります。<br>なお、本トークンの発行は無効化できません。</li></ul></li></ul><h3 id="クライアント認証方式の選択方針"><a href="#クライアント認証方式の選択方針" class="headerlink" title="クライアント認証方式の選択方針"></a>クライアント認証方式の選択方針</h3><p>環境に依りますが、大凡以下の方針で選択されるのが良いかと存じます。各認証方式を組み合わせることも可能です。</p><ol><li>Windows 10 / 11 端末しか管理しない -&gt; Azure AD 認証</li><li>Windows 8.1 端末や Windows Server もインターネット越しに管理したい -&gt; PKI 証明書認証</li><li>認証基盤の都合上、Azure AD 認証が利用出来ない -&gt; PKI 証明書認証</li><li>Azure AD 認証や PKI 証明書認証が利用出来ない -&gt; サイト トークン認証</li><li>端末のキッティング/再キッティングは必ず企業ネットワークで行われ、かつリモート ワークを行う期間は数日なので3ヶ月以内に企業ネットワークに接続する機会がある -&gt; サイト トークン認証</li></ol><h3 id="サイト-サーバー間の通信暗号化"><a href="#サイト-サーバー間の通信暗号化" class="headerlink" title="サイト サーバー間の通信暗号化"></a>サイト サーバー間の通信暗号化</h3><p>最新の MECM ではサイト サーバー間通信で平文通信 (http) が非推奨となっているため、問題無いかと存じますが、CMG を利用する際、各サイト サーバー間の通信は SSL を使った暗号化通信が必須となっております。選択方式としては、以下の 2 方式がございます。</p><ul><li>拡張 HTTP</li><li>HTTPS</li></ul><p>また、CMG リバース プロキシ シナリオにおいて関係するサイト システムは以下の通りです。</p><ul><li>CMG</li><li>クラウド管理ゲートウェイ接続ポイント (CMG-CP)<ul><li>CMG に対して HTTPS 通信を行い、その通信を維持することでクライアント -&gt; CMG -&gt; CMG-CP -&gt; 管理ポイントもしくはソフトウェア更新ポイントへの通信を中継するサイト システムの役割です。</li></ul></li><li>管理ポイント</li></ul><h4 id="拡張-HTTP"><a href="#拡張-HTTP" class="headerlink" title="拡張 HTTP"></a>拡張 HTTP</h4><p>CM が独自に発行・管理する自己署名証明書を使って、秘匿性の高い、サイト システム間の通信を暗号化する方式です。本証明書は有効期限が自動更新されるため、証明書管理の負担が下がるメリットがあります。</p><h4 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h4><p>企業内のPKI 証明書基盤が発行する証明書を使って全てのサイト システム間の通信を暗号化する方式です。サイト システム間同士がお互いのサーバー証明書・クライアント証明書を認証する必要があるため、多くの証明書が必要となります。これらの証明書には有効期限があるため、期限が切れた証明書は更新する必要があります。</p><h4 id="認証方式、通信方式に伴う必要な-PKI-証明書の一覧"><a href="#認証方式、通信方式に伴う必要な-PKI-証明書の一覧" class="headerlink" title="認証方式、通信方式に伴う必要な PKI 証明書の一覧"></a>認証方式、通信方式に伴う必要な PKI 証明書の一覧</h4><p>拡張HTTP、HTTPS 方式それぞれに伴う各ポイントに必要な PKI 証明書は以下の図の通りです。</p><p><img src="/blog/mecm/20220328_01/20220328_01_02.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Microsoft Endpoint Configuration Manager (MECM) にて提供されるクラウド管理ゲートウェイ (CMG) の設計ポイントについてご案内し</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
    <category term="CMG" scheme="https://jpmem.github.io/blog/tags/CMG/"/>
    
  </entry>
  
  <entry>
    <title>Windows 365 Enterprise 環境の Azure AD 結合によるプロビジョニング ポリシーの作成方法</title>
    <link href="https://jpmem.github.io/blog/w365/2022-03-28_01/"/>
    <id>https://jpmem.github.io/blog/w365/2022-03-28_01/</id>
    <published>2022-03-27T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.398Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。<br>本日は、Azure AD 結合によるプロビジョニング ポリシーの作成方法についてご案内します。</p><p>Hybrid Azure AD 環境を構築せずに Windows 365 Enterprise を利用したいというご要望はこれまでも多くのフィードバックを頂いておりましたが、本機能によって Hybrid Azure AD 環境をご用意いただかなくても、Windows 365 Enterprise をご利用いただけるようになります。<br>本機能はまだパブリック プレビュー段階ですが、その使用方法をご紹介いたします。</p><h2 id="免責事項"><a href="#免責事項" class="headerlink" title="免責事項"></a>免責事項</h2><p>下記内容は 2022/3/28 時点での内容についての記載となっております。<br>今後内容が更新されることもございますので、その点ご承知置きくださいますようお願い致します。</p><h2 id="Azure-AD-結合について"><a href="#Azure-AD-結合について" class="headerlink" title="Azure AD 結合について"></a>Azure AD 結合について</h2><p>従来の Windows 365 Enterprise では、Hybrid Azure AD Join の環境が前提だったため、オンプレミスの環境が必要でした。<br>また、Azure 上に作成した仮想ネットワークとオンプレミスを接続しなければならないため、Windows 365 Enterprise を使用するまでに環境の構築が必要でしたが、Azure AD 結合の Microsoft のホステッド ネットワークを使用することで、オンプレミス環境や Azure の仮想ネットワークなしで Windows 365 Enterprise を使えるようになりました。</p><h2 id="設定手順"><a href="#設定手順" class="headerlink" title="設定手順"></a>設定手順</h2><p>以下の順番で設定を行うことで、Microsoft のホステッド ネットワークを使用してプロビジョニング ポリシーを作成し、クラウド PC を使用することができます。</p><ol><li>グローバル管理者などの権限を持つアカウントで Microsoft Endpoint Manager admin center (<a href="https://aka.ms/memac">https://aka.ms/memac</a>) にログインします。</li></ol><ol start="2"><li><p>[デバイス] - [Windows 365] - [プロビジョニング ポリシー] と辿り、[ポリシーの作成] を選択します。</p></li><li><p>[統合の種類] で [Azure AD 結合（プレビュー）] にチェックを入れます。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-06-23.png"></p></li><li><p>[ネットワーク] で [Microsoft のホステッド ネットワーク] を選択し、任意でリージョンを選択して次へ進みます。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-06-54.png"><br>※ 組み込みのネットワークと Azure network connection の違いについては後述いたします。</p></li><li><p>ギャラリー イメージかカスタム イメージを選択し、次へ進みます。</p></li></ol><p><img src="/blog/w365/2022-03-28_01/2022-03-28-18-07-43.png"> 6. 言語を選択し、次へ進みます。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-08-05.png"></p><ol start="7"><li><p>本プロビジョニング ポリシーを適用させたいグループを選択し、次へ進みます。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-08-25.png"></p></li><li><p>[作成] を選択し、プロビジョニング ポリシーを作成します。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-08-41.png"></p></li><li><p>プロビジョニングが開始されますので、クラウド PC が作成されるまで待ちます。</p></li></ol><h2 id="組み込みのネットワークと-Azure-network-connection（旧名：オンプレミスのネットワーク接続）-の違いについて"><a href="#組み込みのネットワークと-Azure-network-connection（旧名：オンプレミスのネットワーク接続）-の違いについて" class="headerlink" title="組み込みのネットワークと Azure network connection（旧名：オンプレミスのネットワーク接続） の違いについて"></a>組み込みのネットワークと Azure network connection（旧名：オンプレミスのネットワーク接続） の違いについて</h2><p>それぞれ以下の違いがあります。</p><h4 id="a-組み込みのネットワーク"><a href="#a-組み込みのネットワーク" class="headerlink" title="a. 組み込みのネットワーク"></a>a. 組み込みのネットワーク</h4><p>Windows 365 Business のように Microsoft でホストされる仮想ネットワークにクラウド PC がデプロイされます。そのため、事前に Azure 上に仮想ネットワークを用意する必要がありません。また、オンプレミス環境も必要ないため、すぐに使用可能です。<br>社内ネットワークに接続させたくない場合等にもおすすめです。</p><h4 id="b-Azure-network-connection（旧名：オンプレミスのネットワーク接続）"><a href="#b-Azure-network-connection（旧名：オンプレミスのネットワーク接続）" class="headerlink" title="b. Azure network connection（旧名：オンプレミスのネットワーク接続）"></a>b. Azure network connection（旧名：オンプレミスのネットワーク接続）</h4><p>Azure 上の仮想ネットワークを使用することができるため、カスタマイズされたネットワークを使用することが出来ます。<br>[Azure network connection] - [Azure AD 結合（プレビュー）] から新規作成します。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-09-48.png"></p><p>以上、Azure AD 結合によるプロビジョニング ポリシーの作成方法について参考になりましたら幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。&lt;br&gt;本日は、Azure AD 結合によるプロビジョニング ポリシーの作成方法についてご案内します。&lt;/p&gt;
&lt;p&gt;Hybrid Azure AD 環境を構築せずに Wind</summary>
      
    
    
    
    
    <category term="Windows 365" scheme="https://jpmem.github.io/blog/tags/Windows-365/"/>
    
  </entry>
  
  <entry>
    <title>クライアントの更新プログラムのダウンロードが 0 %で進まない場合のチェックポイント ( WSUS )</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-03-25_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-03-25_01/</id>
    <published>2022-03-24T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.430Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。 WSUS サポート チームです。</p><p>よくあるお問い合わせの中で、 WSUS から配信した更新プログラムのダウンロードがクライアント端末上で 0 % から進まず、更新プログラムの適用処理が完了できないといった事象があります。</p><p>クライアント側で WSUS から取得する更新プログラムのダウンロードに失敗する要因は様々ございますが、<br>今回は、そんなときにまずは一度ご確認いただきたいポイントについてお伝えしようと思います。<br>クライアントのダウンロードが進まない、失敗する といったご状況の際はぜひご一読ください。</p><ul><li><strong>WSUS サーバー上のコンテンツ ファイルの有無を確認</strong></li><li><strong>Windows Firewall サービス の無効化についての確認</strong></li></ul><p>上記項目の説明及び確認手順は以下の通りです。</p><h3 id="＜-確認手順-WSUS-サーバー上のコンテンツ-ファイルの有無を確認-＞"><a href="#＜-確認手順-WSUS-サーバー上のコンテンツ-ファイルの有無を確認-＞" class="headerlink" title="＜ 確認手順 : WSUS サーバー上のコンテンツ ファイルの有無を確認 ＞"></a><strong>＜ 確認手順 : WSUS サーバー上のコンテンツ ファイルの有無を確認 ＞</strong></h3><p>＜説明＞<br>WSUS サーバーに実体となる更新プログラムのファイルが存在していない場合、<br>クライアントは、更新プログラムのダウンロードを実行しても取るファイルが存在しないためダウンロードが進捗しない状況になります。<br>この場合、 WSUS サーバー上で、更新プログラムの承認後、実体ファイルのダウンロードが正常にできていない可能性などが疑われます。</p><p>＜手順＞<br>1． WSUS コンソールで対象の更新プログラムを右クリックし「 ファイル情報 」を参照します。<br><img src="/blog/wsus/2022-03-25_01/2022-03-25_01_1.png"><br>2．更新プログラムの URI が表示されています。これが更新プログラムの実体ファイルの格納先になります。<br><img src="/blog/wsus/2022-03-25_01/2022-03-25_01_2.png"><br>3． WSUS サーバーのエクスプローラーから「 WsusContent 」フォルダーを開きます。<br> 　 2 ケタの英数字で名づけられたフォルダーが複数存在しますので、手順2 で確認したファイルパス内に記載されているフォルダーをたどっていきます。<br> <img src="/blog/wsus/2022-03-25_01/2022-03-25_01_3.png"></p><p>4．フォルダー内に格納されているファイルが存在するかを確認します。<br> <img src="/blog/wsus/2022-03-25_01/2022-03-25_01_4.png"></p><h3 id="＜-確認手順-Windows-Firewall-サービス-の無効化についての確認＞"><a href="#＜-確認手順-Windows-Firewall-サービス-の無効化についての確認＞" class="headerlink" title="＜ 確認手順 : Windows Firewall サービス の無効化についての確認＞"></a><strong>＜ 確認手順 : Windows Firewall サービス の無効化についての確認＞</strong></h3><p>＜説明＞<br>OS の標準機能として Windows Firewall のサービス無効化はサポートされておらず、WSUS から更新プログラムをダウンロードする際に利用される Background Intelligent Transfer Service (BITS) と呼ばれるコンポーネントの動作に影響を与えてしまい、正常にダウンロードすることができなくなります。</p><p>参考情報 <a href="https://docs.microsoft.com/ja-jp/windows/win32/bits/">Background Intelligent Transfer Service</a></p><p>＜手順＞<br>1．サービス を開き　Windows Firewall もしくは Windows Defender Firewall の名称（サービス名： MpsSvc）を探します。<br><img src="/blog/wsus/2022-03-25_01/2022-03-25_01_5.png"></p><p>2．サービスの状態が [無効] となっているかをご確認いただき、無効とされていた場合はスタートアップの種類を [自動] にしてサービスを開始してください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。 WSUS サポート チームです。&lt;/p&gt;
&lt;p&gt;よくあるお問い合わせの中で、 WSUS から配信した更新プログラムのダウンロードがクライアント端末上で 0 % から進まず、更新プログラムの適用処理が完了できないといった事象があります。&lt;/p&gt;
&lt;p&gt;</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>Configuration Manager における共同管理機能について</title>
    <link href="https://jpmem.github.io/blog/mecm/20220321_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220321_01/</id>
    <published>2022-03-20T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.374Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Configuration Manager (CM) にて提供される共同管理機能についてご案内します。<br>なお、下記は MECM CB 2111 を前提に記載しておりますのでご留意くださいませ。また、MECM CB 2107 より共同管理機能は「クラウドの接続 (Cloud Attach)」と名前を変更しておりますが、本記事では従来通り「共同管理」の名前を継続利用しておりますのでご承知置きくださいませ。</p><p>共同管理機能は、同様の機能を持つ CM と Intune について、重複する機能は、どちらかの機能を使い、重複しない機能についてはそれぞれの機能を利用を可能にする機能のことです。本機能は、CM と Intune のみで利用でき、他社 EMM 製品等とは組み合わせられない機能です。また、クライアントがイントラネットに接続している時は CM を使い、 インターネットに接続している時は Intune を使うと言った、Location aware を実現する機能ではございませんので、ご注意ください。インターネット経由で CM の管理下に置く場合、通常、クラウド管理ゲートウェイが必要となります。(なお、ここで言うインターネット経由とは VPN で接続されている環境は通常省きます)  </p><p><img src="/blog/mecm/20220321_01/20220321_01_01.png"></p><h2 id="よくあるユースケース"><a href="#よくあるユースケース" class="headerlink" title="よくあるユースケース"></a>よくあるユースケース</h2><p>共同管理機能を使われるユースケースとしては以下のものが挙げられます。</p><ol><li>スマートフォン等と同一の製品でWindows端末を管理したい。多くの機能は Intune で十分だが、OS の更新プログラムは細やかに管理したいので CM の更新プログラム配布機能を継続利用したい。</li><li>Intune のインベントリ機能では必要な情報が収集できないので、CM のカスタマイズ可能なインベントリ機能を使ってより詳細な情報収集を行いたい。</li><li>CM の構成基準を使って Intune より細やかなポリシー制御を行いたい。</li><li>CM で十分に運用管理出来ているが、Intune の条件付き制御やリモート制御機能を使いたい。</li><li>企業ネットワークに接続した際のインターネット回線帯域が限られているので、更新プログラムやアプリケーションの配布は CM の企業ネットワーク配布ポイントを活用したい。</li></ol><h2 id="共同管理機能の前提条件"><a href="#共同管理機能の前提条件" class="headerlink" title="共同管理機能の前提条件"></a>共同管理機能の前提条件</h2><p>共同管理機能の利用前提は以下でご案内しております。<br>よくあるご質問として、Azure AD Registered の端末が利用できるかのご質問がありますが、共同管理において Azure AD Registered の端末はサポートされておりませんのでご承知おきください。</p><p>共同管理とは<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/comanage/overview#prerequisites">https://docs.microsoft.com/ja-jp/mem/configmgr/comanage/overview#prerequisites</a></p><h2 id="ワークロード"><a href="#ワークロード" class="headerlink" title="ワークロード"></a>ワークロード</h2><p>ワークロード とは、CM と Intune で重複する機能群のことです。共同管理構成ポリシーでは、重複する以下の機能を CM と Intune のどちらで担当するかを設定する必要がございます。なお、一部のワークロードでは 設定次第で CM と Intune どちらでも利用が出来る場合がございますので、ご留意くださいますようお願い致します。</p><ul><li>コンプライアンス ポリシー<ul><li> 本ワークロードを Intune 側に設定した場合でも、Intune 上で以下を設定することで、CM のコンプライアンス ポリシーを　Intune のコンプライアンス ポリシーの一部として利用できます。<br>[コンプライアンス ポリシー] - [コンプライアンス設定] - [Configuration Manager のコンプライアンス] - [Configuration Manager からのデバイス コンプライアンスが必要]<br><img src="/blog/mecm/20220321_01/20220321_01_02.png"></li></ul></li><li>デバイス構成<ul><li>本ワークロードを Intune 側に設定した場合でも、CM 上で以下を設定することで、構成基準を継続して利用出来ます。<br>[資産とコンプライアンス] - [概要] - [コンプライアンス設定] - [構成基準] - 該当の構成基準を選択 - [プロパティ] - [全般]タブ - [共同管理のクライアントに対しても常にこの基準を適用する]<br><img src="/blog/mecm/20220321_01/20220321_01_03.png"></li></ul></li><li>リソース アクセス ポリシー</li><li>Endpoint Protection</li><li>クライアント アプリ<ul><li>本ワークロードを Intune 側に設定すると、 CM と Intune 両方のアプリケーションをダウンロード、インストール出来ます。CM 側に設定した場合は CM のアプリケーションのみが配布される形となります。</li></ul></li><li>Office クイック実行アプリ</li><li>Windows Update のポリシー</li></ul><h2 id="ワークロード外の機能"><a href="#ワークロード外の機能" class="headerlink" title="ワークロード外の機能"></a>ワークロード外の機能</h2><p>CM と Intune 間で重複しない以下の機能は共同管理を有効にすることで並行利用が可能となります。</p><ul><li>CM <ul><li>インベントリ</li><li>ソフトウェア利用状況</li><li>電源管理</li></ul></li><li>Intune<ul><li>リモート管理(リタイヤ、ワイプ)</li><li>条件付きアクセス制御ポリシーの配布</li></ul></li></ul><h1 id="共同管理構成の設定方法"><a href="#共同管理構成の設定方法" class="headerlink" title="共同管理構成の設定方法"></a>共同管理構成の設定方法</h1><p>共同管理構成の設定方法を以下でご案内します。なお、共同管理構成は CM 側でのみ設定可能で、Intune 側からは設定できませんのでご留意ください。</p><h2 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h2><p>共同管理構成のウィザードではいくつかの設定を同時に行う形となっております。事前に下記についてご検討くださいますようお願い致します。</p><ol><li>Azure AD グローバル管理者権限を持ち、Intune ライセンスが割当たっているAzure AD ユーザーアカウントをご用意ください。</li><li>共同管理構成を有効にする対象をご検討ください。すべてのデバイスを共同管理にする場合は特に検討は必要ございませんが、 一部のデバイスのみを対象にしたい場合は、そのデバイスが所属するデバイス コレクションを事前に設定する必要がございます。なお、本デバイス コレクションは1つだけしか割り当てられないのでご理解くださいますようお願い致します。</li><li>Intune 画面から CM の管理デバイスを操作する「テナントアタッチ」機能を全ての CM 管理デバイスを対象にするか、一部のコレクションのみを対象にするかどうか事前にご検討ください。  <ul><li>Microsoft エンドポイント マネージャーのテナントのアタッチ: デバイスの同期とデバイスの操作<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/tenant-attach/device-sync-actions">https://docs.microsoft.com/ja-jp/mem/configmgr/tenant-attach/device-sync-actions</a></li></ul></li><li>デスクトップの利用情報等を分析できる「Endpoint Analytics」機能をご利用されるかどうか事前にご検討ください。後から設定変更も可能です。  <ul><li>エンドポイント分析とは?<br><a href="https://docs.microsoft.com/ja-jp/mem/analytics/overview">https://docs.microsoft.com/ja-jp/mem/analytics/overview</a></li></ul></li><li>共同管理構成を有効にしたタイミングで端末を Intune に自動登録させるか事前にご検討ください。一部デバイスのみを自動登録させる場合は該当のデバイスが所属するコレクションを作成ください。</li><li>事前にワークロードの設定内容をご検討ください。「ワークロード」ステップで設定することになります。</li></ol><h2 id="クライアントのネットワーク要件"><a href="#クライアントのネットワーク要件" class="headerlink" title="クライアントのネットワーク要件"></a>クライアントのネットワーク要件</h2><ul><li>CM のポリシーとして共同管理構成は配布されるため、クライアントが CM の管理ポイントと接続出来る必要があります。</li><li>Intune の自動登録を有効にする場合、Intune を提供する各サイトに接続できる必要がございます。下記 URL をご参考ください。<br>Microsoft Intune のネットワーク エンドポイント<br><a href="https://docs.microsoft.com/ja-jp/mem/intune/fundamentals/intune-endpoints">https://docs.microsoft.com/ja-jp/mem/intune/fundamentals/intune-endpoints</a></li></ul><h2 id="実際の設定手順"><a href="#実際の設定手順" class="headerlink" title="実際の設定手順"></a>実際の設定手順</h2><ol><li>CM サーバーに接続し、CM コンソールを起動します。</li><li>[CM コンソール] - [管理] - [概要] - [クラウド サービス] - [クラウドの接続] を選択します。<br><img src="/blog/mecm/20220321_01/20220321_01_04.png"></li><li>[クラウド接続の構成] を選択します。<br><img src="/blog/mecm/20220321_01/20220321_01_05.png"></li><li>「クラウド接続の構成」のウィザードが起動します。<br><img src="/blog/mecm/20220321_01/20220321_01_06.png">  </li><li>Azure 環境として「AzurePublicCloud」が選択されていることを確認し、「サインイン」ボタンをクリックします。</li><li>Azure AD の認証が始まりますので事前準備したグローバル管理者権限でサインインします。<br><img src="/blog/mecm/20220321_01/20220321_01_07.png">  </li><li>事前検討で全てのデバイスを Intune に自動登録できるようにする、Endpoint Analyticsを利用できるようにする、全てのデバイスをテナントアタッチを利用出来るようにする、ことを決定されている場合は「既定の設定を使用する(推奨)」を選択ください。以下では「設定をカスタマイズする」の選択を前提にウィザードを進めていきます。選択後、「次へ」をクリックください。<br><img src="/blog/mecm/20220321_01/20220321_01_08.png">  </li><li>事前に検討された内容に従って、「テナントアタッチ」の対象を「Microsoft エンドポイント マネージャーにアップロードするデバイスを選択する」の項目を設定ください。</li><li>事前に検討された内容に従って、「エンドポイント分析」の項目を設定ください。選択後、「次へ」をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_09.png">  </li><li> 対象のデバイスを Intune に自動登録させる場合は、「Intune で自動登録」にて「すべて」か「パイロット」を選択して「次へ」を選択します。一部のコレクションのみを自動登録する場合は「パイロット」を選択し、事前に作成しておいたコレクションを指定します。自動登録させない場合は「なし」を選択します。選択後、「次へ」をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_10.png">  </li><li>設定内容を確認し、「次へ」をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_11.png">  </li><li>設定完了したら、「閉じる」をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_12.png">  </li><li>[クラウドの接続] 画面に戻り、作成された “CoMgmtSettingsProd” を選択して [プロパティ] をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_13.png">  </li><li>[ワークロード] タブに遷移し、事前に検討したワークロードを設定します。<br><img src="/blog/mecm/20220321_01/20220321_01_14.png">  </li><li>ワークロードにて「パイロット Intune」を選択した場合、「ステージング」タブに遷移して、該当のワークロードを配布するパイロット コレクションを指定して「OK」をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_15.png">  </li></ol><h2 id="設定がクライアントに適用されたかの確認"><a href="#設定がクライアントに適用されたかの確認" class="headerlink" title="設定がクライアントに適用されたかの確認"></a>設定がクライアントに適用されたかの確認</h2><h3 id="クライアントからの確認方法"><a href="#クライアントからの確認方法" class="headerlink" title="クライアントからの確認方法"></a>クライアントからの確認方法</h3><p>共同管理構成ポリシーがクライアントに適用されると、Configuration Manager のコントロール パネル アプレットの「構成タブ」に以下のように “CoMgmtSettings” で始まる項目が表示されます。各項目の意味は以下の通りです。  </p><p><img src="/blog/mecm/20220321_01/20220321_01_16.png">  </p><ul><li>CoMgmtSettingsProd<ul><li>共同管理構成ポリシーが設定された全てのデバイスに設定される項目です。</li></ul></li><li>CoMgmtSettingsPilotAutoEnroll<ul><li>Intune への自動登録の設定にパイロットコレクションとして指定されたデバイスに設定される項目です。</li></ul></li><li>CoMgmtSettingsPilotCP<ul><li>ワークロード「コンプライアンスポリシー」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotDC<ul><li>ワークロード「デバイスの構成」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotEP<ul><li>ワークロード「Endpoint Protection」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotRAP<ul><li>ワークロード「リソース アクセス」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotCApp<ul><li>ワークロード「クライアントアプリ」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotO365<ul><li>ワークロード「Office クイック実行アプリ」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotWUP<ul><li>ワークロード「Windows Update のポリシー」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li></ul><h3 id="CM-コンソールからの確認方法"><a href="#CM-コンソールからの確認方法" class="headerlink" title="CM コンソールからの確認方法"></a>CM コンソールからの確認方法</h3><p>下記ダッシュボードを利用して共同管理の登録状況を確認できます。  </p><p>[CM コンソール] - [監視] - [共同管理]  </p><p><img src="/blog/mecm/20220321_01/20220321_01_17.png"></p><h3 id="MEM-管理センターからの確認方法"><a href="#MEM-管理センターからの確認方法" class="headerlink" title="MEM 管理センターからの確認方法"></a>MEM 管理センターからの確認方法</h3><p>通常、デバイス一覧で「管理者」が「共同管理」となっているデバイスが共同管理状態となっているデバイスとなります。なお、ここで「管理者」が「ConfigMgr」となっているデバイスはテナントアタッチのみされているデバイスであり、共同管理状態にはなっていないのでご注意ください。  </p><p><img src="/blog/mecm/20220321_01/20220321_01_18.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Configuration Manager (CM) にて提供される共同管理機能についてご案内します。&lt;br&gt;なお、下記は MECM CB 2111 を前提に記載しておりますので</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Windows Server 2022 に更新プログラムを配布するためのポイント</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-03-11_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-03-11_01/</id>
    <published>2022-03-10T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.430Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。WSUS サポート チームです。</p><p>近頃のお問い合わせで、「 WSUS から Windows Server 2022 へ更新プログラムを配信することはできますか 」との声をよくいただくようになりました。<br>そこで、今回は 2021年9月1日（米国時間）リリースされた Windows Server 2022 に WSUS を利用して更新プログラムを配布する為のポイントをご紹介します。  </p><p>Windows Server 2022 向けの更新プログラムを WSUSへ 同期するためには、同期対象に以下の “製品” を追加する必要があります。</p><p><strong>製品「Microsoft Server operating system-21H2」</strong></p><p>ー同期対象追加手順ー  </p><p>１．WSUSコンソールを開きます。  </p><p>２．[オプション]&gt;[製品と分類]&gt;”製品” を開きます。<br> Windows配下の製品項目「Microsoft Server operating system-21H2」にチェックを入れてOKを押します。<br> （※取得したい更新プログラムに応じて “分類” 項目の追加も実施ください）<br><img src="/blog/wsus/2022-03-11_01/2022-03-11_01_1.PNG"></p><p>３．その後、WSUSで同期を実施いただくことで、Windows Server 2022 向けの更新プログラムを取得することができます。<br><img src="/blog/wsus/2022-03-11_01/2022-03-11_01_2.PNG"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。WSUS サポート チームです。&lt;/p&gt;
&lt;p&gt;近頃のお問い合わせで、「 WSUS から Windows Server 2022 へ更新プログラムを配信することはできますか 」との声をよくいただくようになりました。&lt;br&gt;そこで、今回は 2021年9月</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>Configuration Manager の便利な機能</title>
    <link href="https://jpmem.github.io/blog/mecm/20220307_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220307_01/</id>
    <published>2022-03-06T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.370Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。</p><p>本日は Configuration Manager の便利な機能について、以下 2 点についてご紹介させていただきます。</p><p>a. クライアントのログを Configuration Manager コンソールから収集する機能<br>b. CSV へのエクスポート機能</p><p>a は何らかの状況でクライアントの操作が出来ない際に、MECM コンソール上からクライアントのログを確認したい、もしくは採取したい時に有効な機能です。<br>b は Configuration Manager 2111 から追加された機能で、デバイスやユーザーの一覧を CSV にエクスポートすることが可能です。<br>それぞれの手順について以下に記載させていただきますので、ぜひご活用ください。</p><ol><li>Configuration Manager コンソールを開き、[資産とコンプライアンス] &gt; [概要] &gt; [デバイス] を開き、クライアント ログを収集したいデバイスを選択します。</li></ol><ol start="2"><li><p>選択したデバイスを右クリックし、[クライアント診断] &gt; [クライアント ログの収集] を選択します。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-05-00.png"></p></li><li><p>下記の警告が表示されますので、[OK] を選択します。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-05-40.png"></p></li><li><p>[資産とコンプライアンス] &gt; [概要] &gt; [デバイス] に戻り、手順 2 のデバイスを選択し、右クリックから [開始] &gt; [リソース エクスプローラー] を選択します。</p></li></ol><p><img src="/blog/mecm/20220307_01/2022-03-08-13-06-59.png">  </p><ol start="5"><li><p>[リソース エクスプローラー] が開きますので、左側ペインから [診断ファイル] を選択します。右側ペインに収集した診断ファイルが表示されます。表示されない場合は少し待ち、再度表示されるまで待ちます。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-08-24.png"></p></li><li><p>診断ファイルを選択し、右クリックから [サポート センターを開く] を選択します。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-12-35.png"></p></li><li><p>Configuration Manager Support Center Viewer が起動しますので、確認したいログをダブルクリックすると以下のようにログが表示されます。<br>下図は PolicyAgent.log を表示した画面です。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-14-38.png"></p></li><li><p>採取したログを保存したい場合は手順 6 で [保存] を選択します。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-15-54.png"></p></li></ol><h1 id="b-CSV-へのエクスポート機能"><a href="#b-CSV-へのエクスポート機能" class="headerlink" title="b. CSV へのエクスポート機能"></a>b. CSV へのエクスポート機能</h1><ol><li>デバイスやユーザーなど、CSV にエクスポートしたい対象の一覧を表示します。</li><li>画面上部にある [CSV ファイルにエクスポート] から [すべてのアイテムをエクスポート] もしくは [選択したアイテムをエクスポート] を選択します。<br><img src="/blog/mecm/20220307_01/2022-03-10-10-52-11.png"></li><li>[名前を付けて保存] 画面が表示されますので、任意の場所を選択し、[保存] を選択します。 </li><li>CSV ファイルを開くと、Configuration Manager コンソール上で閲覧できている状態の情報が表示されています。<br><img src="/blog/mecm/20220307_01/2022-03-10-10-56-24.png"></li></ol><p>■注意事項<br>エクスポートした CSV ファイルを開くと文字化けしている場合がございます。<br>その場合は、以下の手順で直すことが可能です。  </p><p>a. CSV ファイルを右クリックし、[プログラムから開く] - [メモ帳] を選択します。<br>b. メモ帳が開かれたら、[ファイル] - [名前を付けて保存] を選択します。<br>c. 画面右下の [エンコード] を [ANSI] に変更し、上書き保存します。<br>d. 再度 CSV ファイルを開き、文字化けが改善され、正常に表示されていることを確認します。</p><p>◆  文字化けしている CSV ファイルの例<br><img src="/blog/mecm/20220307_01/2022-03-10-10-59-03.png"></p><p>参考公開情報<br>Title : CSV へのエクスポート<br>URL : <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/admin-console-tips#export-to-csv">https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/admin-console-tips#export-to-csv</a></p><p>※本情報の内容（添付画像を含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;/p&gt;
&lt;p&gt;本日は Configuration Manager の便利な機能について、以下 2 点についてご紹介させていただきます。&lt;/p&gt;
&lt;p&gt;a. クライアントのログを Con</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>CMPivot 機能について</title>
    <link href="https://jpmem.github.io/blog/mecm/20220208_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220208_01/</id>
    <published>2022-02-07T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.366Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。</p><p>本日は CMPivot についてご紹介させていただきます。</p><p>CMPivot とは・・・Configuration Manager コンソールからクエリを実行し、リアルタイムでクライアントの情報を取得できる、とても優れた機能です！</p><p>参考公開情報<br>Title : CMPivot の概要<br>URL   : <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/cmpivot-overview">https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/cmpivot-overview</a></p><p>今回は例として、特定のイベントログを抽出する方法について記載させていただきますので、ぜひお試しください。  </p><ol><li>デバイス一覧より対象デバイス（またはデバイスコレクション）を右クリックして [CMPivot の開始]  をクリックします。<br><img src="/blog/mecm/20220208_01/2022-02-08-20-02-16.png"></li></ol><ol start="2"><li><p>以下の画面が表示されますので、[クエリ] タブに移動します。<br><img src="/blog/mecm/20220208_01/2022-02-08-20-03-31.png"></p></li><li><p>クエリを記載します。以下はシステムイベントログの ID 1500 を抽出するクエリです。</p><p>EventLog(‘System’)<br>| where EventID == 1500<br>※イベントログは既定で 24 時間以内のログを抽出しますので、3 日以内など日数をしたい場合は以下のようにクエリを作成します。  </p><p> EventLog(‘System’,3d)<br>| where EventID == 1500  </p></li></ol><ol start="4"><li>[クエリの実行] をクリックし、結果が得られたら成功です。<br><img src="/blog/mecm/20220208_01/2022-02-08-20-09-56.png"></li></ol><h1 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h1><p>CMPivot を使用いただくにあたり、前提条件やアクセス許可などが必要がございますので、あらかじめご承知おきいただきますようお願いいたします。</p><p>参考公開情報<br>Title : 前提条件<br>URL   : <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/cmpivot#prerequisites">https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/cmpivot#prerequisites</a></p><p>※本情報の内容（添付画像を含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;/p&gt;
&lt;p&gt;本日は CMPivot についてご紹介させていただきます。&lt;/p&gt;
&lt;p&gt;CMPivot とは・・・Configuration Manager コンソールからクエリを実行</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>パッケージの展開が失敗した時に確認したいポイント ~ sysnative 編 ~</title>
    <link href="https://jpmem.github.io/blog/mecm/20220125_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220125_01/</id>
    <published>2022-01-24T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.366Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。</p><p>今回は Configuration Manager からのパッケージ展開が失敗した際ご確認いただきたい sysnative について解説させていただきます。</p><hr><h2 id="パッケージ展開対象のアプリケーションが-64-bit-の場合には-sysnative-の指定が必要になることがあります"><a href="#パッケージ展開対象のアプリケーションが-64-bit-の場合には-sysnative-の指定が必要になることがあります" class="headerlink" title="パッケージ展開対象のアプリケーションが 64 bit の場合には sysnative の指定が必要になることがあります"></a>パッケージ展開対象のアプリケーションが 64 bit の場合には sysnative の指定が必要になることがあります</h2><p>現在展開対象としているアプリケーション、クライアント端末は 64 bit ではありませんか ?<br>その場合、パッケージの展開が失敗してしまう可能性があります。</p><h2 id="ファイル-リダイレクトについて"><a href="#ファイル-リダイレクトについて" class="headerlink" title="ファイル リダイレクトについて"></a>ファイル リダイレクトについて</h2><p>ファイルリ ダイレクトという機能をご存知でしょうか ? これは 64 bit 端末上で 32 bit のアプリケーションを実行するために使用されております。通常 64 bit のアプリケーションの dll は %windir%\System32\ から呼び出されます。しかし、64 bit の端末上の 32 bit アプリケーションの dll は、異なるディレクトリに格納されており、各 bit によって、パスを使い分ける必要があります。</p><p>その際を埋めるのが WOW64 です。<br>WOW64 は上記のディレクトリ パスの差異をファイル リダイレクトによりあたかも同じ場所にあるように扱うことを可能にしています。</p><p>32 bit アプリケーションから %windir%\System32 が指定された場合には、WOW64 は %windir%\SysWOW64（32 bit プログラム用のファイルがおいてあるフォルダー） にリダイレクトします。</p><h2 id="ファイルリダイレクトによる弊害"><a href="#ファイルリダイレクトによる弊害" class="headerlink" title="ファイルリダイレクトによる弊害"></a>ファイルリダイレクトによる弊害</h2><p>しかし、パッケージ展開の際には注意が必要となります。<br>パッケージ展開処理は 32 bit で動作します。そのため、64 bit の OS の端末上でパッケージ展開を実行する際には WOW64 を介して 32 bit 用の dll が存在するパスにリダイレクトされます。</p><p>例えば、64 bit の exe を実行する場合に、パッケージのコマンド ラインに「cmd /c test.exe」と指定した場合には、C:\Windows\SysWOW64 配下の cmd が呼び出され、32 bit の cmd から 64 bit のアプリケーション（exe）を実行する事となり、正常に動作しないことがあります。</p><h3 id="パッケージのコマンドラインの確認方法"><a href="#パッケージのコマンドラインの確認方法" class="headerlink" title="パッケージのコマンドラインの確認方法"></a>パッケージのコマンドラインの確認方法</h3><p>1.MECM 管理コンソール &gt; [ソフトウェア ライブラリ] &gt; [概要] &gt; [アプリケーション管理] &gt; [パッケージ] にて、[プログラム] タブを開き、該当のプログラムを右クリック &gt; [プロパティ] を開きます。</p><p><img src="/blog/mecm/20220125_01/20220125_01_01.png"></p><p>2.[全般] タブにて「コマンド ライン」を確認することができます。</p><p><img src="/blog/mecm/20220125_01/20220125_01_02.png"></p><h2 id="回避策"><a href="#回避策" class="headerlink" title="回避策"></a>回避策</h2><p>以下のように sysnative をコマンドラインに指定することにより、回避することが可能となります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%windir%\sysnative\cmd /c test.exe</span><br></pre></td></tr></table></figure><p>※ 適宜ファイル名を変更してお試し下さい。</p><h3 id="ps1-の場合"><a href="#ps1-の場合" class="headerlink" title="ps1 の場合"></a>ps1 の場合</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;%Windir%\sysnative\WindowsPowerShell\v1.0\powershell.exe&quot;</span> <span class="literal">-ExecutionPolicy</span> Bypass <span class="literal">-Command</span> .\xxx.ps1</span><br></pre></td></tr></table></figure><h3 id="bat-の場合"><a href="#bat-の場合" class="headerlink" title="bat の場合"></a>bat の場合</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%windir%\sysnative\cmd.exe /c xxx.bat</span><br></pre></td></tr></table></figure><h3 id="vbs-の場合"><a href="#vbs-の場合" class="headerlink" title="vbs の場合"></a>vbs の場合</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">％windir％\sysnative\cscript.exe xxx.vbs</span><br></pre></td></tr></table></figure><h3 id="msi-の場合"><a href="#msi-の場合" class="headerlink" title="msi の場合"></a>msi の場合</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">％windir％\sysnative\msiexec.exe xxx.msi</span><br></pre></td></tr></table></figure><h2 id="パッケージのコマンドラインの変更箇所"><a href="#パッケージのコマンドラインの変更箇所" class="headerlink" title="パッケージのコマンドラインの変更箇所"></a>パッケージのコマンドラインの変更箇所</h2><p>1.MECM 管理コンソール &gt; [ソフトウェア ライブラリ] &gt; [概要] &gt; [アプリケーション管理] &gt; [パッケージ] にて、[プログラム] タブを開き、該当のプログラムを右クリック &gt; [プロパティ] を開きます。</p><p><img src="/blog/mecm/20220125_01/20220125_01_01.png"></p><p>2.[全般] タブにて「コマンド ライン」の修正を行います。</p><p><img src="/blog/mecm/20220125_01/20220125_01_03.png"></p><p>3.[OK] ボタンをクリックし、変更を完了します。</p><p>4.パッケージの再展開を行い、改善が見られるかご確認くださいませ。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;/p&gt;
&lt;p&gt;今回は Configuration Manager からのパッケージ展開が失敗した際ご確認いただきたい sysnative について解説させていただきます。&lt;/p&gt;
&lt;h</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Configuration Managerにおける拡張 HTTP の確認方法</title>
    <link href="https://jpmem.github.io/blog/mecm/20220122_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220122_01/</id>
    <published>2022-01-21T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.362Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Configuration Manager (CM) にて拡張 HTTP 接続が設定されているかどうかをサーバー側で確認する手順をご案内します。特に、HTTPS 接続方式から、拡張 HTTP 接続方式に変更された場合、IIS にバインドされている証明書が誤っている場合がございますので、心当たりのある方はご確認されるようお勧め致します。</p><p>拡張 HTTP について詳しくは下記URLをご参照ください。  </p><p>拡張 HTTP - Configuration Manager | Microsoft Docs<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/plan-design/hierarchy/enhanced-http">https://docs.microsoft.com/ja-jp/mem/configmgr/core/plan-design/hierarchy/enhanced-http</a></p><p>確認箇所は以下の 4 点となります。</p><ol><li>サイト設定</li><li>管理ポイント設定</li><li>配布ポイント設定</li><li>IIS マネージャーのバインド設定</li></ol><h2 id="サイト設定の確認"><a href="#サイト設定の確認" class="headerlink" title="サイト設定の確認"></a>サイト設定の確認</h2><p>以下の画面を確認ください。</p><p>[CM コンソール] - [管理] - [概要] - [サイトの構成] - [サイト] - 対象のサイトを選択 - [プロパティ] - [通信セキュリティ] タブ</p><ul><li>サイト システムの設定にて、[HTTPS または HTTP] が選択されている。</li><li>[HTTP サイト システムには Configuration Manager によって生成された証明書を使用する] にチェックが入っている。</li></ul><p><img src="/blog/mecm/20220122_01/20220122_01_01.png"></p><h2 id="管理ポイント設定"><a href="#管理ポイント設定" class="headerlink" title="管理ポイント設定"></a>管理ポイント設定</h2><p>以下の画面を確認ください。このとき、下記の設定が「HTTPS」だと拡張 HTTP は使われず、PKI 証明書を使った HTTPS 通信が強制的に実施されますのでお気を付けください。</p><p>[CM コンソール] - [管理] - [概要] - [サイトの構成] - [サーバーとサイト システムの役割] - 対象のサイト システムを選択- 画面下部 - [管理ポイント] - [プロパティ] - [全般]タブ</p><ul><li>クライアント接続に [HTTP] が選択されている</li></ul><p><img src="/blog/mecm/20220122_01/20220122_01_02.png"></p><h2 id="配布ポイント設定"><a href="#配布ポイント設定" class="headerlink" title="配布ポイント設定"></a>配布ポイント設定</h2><p>以下の画面を確認ください。このとき、下記の設定が「HTTPS」だと拡張 HTTP は使われず、PKI 証明書を使った HTTPS 通信が強制的に実施されますのでお気を付けください。</p><p>[CM コンソール] - [管理] - [概要] - [サイトの構成] - [サーバーとサイト システムの役割] - 対象のサイト システムを選択- 画面下部 - [配布ポイント] - [プロパティ] - [通信]タブ</p><ul><li>「クライアント コンピューターまたはモバイル デバイスがこの配布ポイントと通信する方法を指定します」にて [HTTP] が選択されている。</li></ul><p><img src="/blog/mecm/20220122_01/20220122_01_03.png"></p><h2 id="IIS-マネージャーのバインド設定"><a href="#IIS-マネージャーのバインド設定" class="headerlink" title="IIS マネージャーのバインド設定"></a>IIS マネージャーのバインド設定</h2><p>管理ポイント、 配布ポイント の役割を持つサーバーにて、「インターネット インフォメーション サービス (IIS) マネージャー」 を起動し、以下を確認ください。</p><ol><li>[IIS マネージャー] - サーバーを選択 - [サイト] - [Default Web Site] - 操作タブ - 「バインド」</li></ol><p><img src="/blog/mecm/20220122_01/20220122_01_04.png"></p><ol start="2"><li>[https] を選択し、[編集] ボタン をクリック。</li></ol><p><img src="/blog/mecm/20220122_01/20220122_01_05.png"></p><ol start="3"><li>[SSL 証明書] として、「 SMS Role SSL Certificate 」が選択されている。</li></ol><p><img src="/blog/mecm/20220122_01/20220122_01_06.png"></p><h3 id="バインド設定の修復方法"><a href="#バインド設定の修復方法" class="headerlink" title="バインド設定の修復方法"></a>バインド設定の修復方法</h3><p>もともと、HTTPS 形式を通信方式として設定されていた場合、バインド 設定にて PKI 証明書が設定されていて、変更しようとしても、選択肢に 「SMS Role SSL Certificate」 が表示されていない場合がございます。その場合は、下記手順にて修復できますので、お試しくださいませ。</p><ol><li>IIS マネージャーを起動ください。</li><li>[サイト] - [Default Web Site] を選択し、画面右カラムから「バインド」 を選択してください。</li><li>「https」 を選択し、「削除」 を実施ください。</li><li> [CMコンソール] - [管理] - [概要] - [サイトの構成] - [サイト] - 対象のサイトを選択 -「プロパティ」 を選択ください。</li><li>「通信セキュリティ」 タブで 「 HTTP サイトシステムには Configuration Managerによって生成された証明書を使用する」 のフラグを一度、無効化し、画面右下の「適用」ボタンをクリックください。</li><li>1 分程度お待ちください。</li><li>「HTTP サイトシステムには Configuration Manager によって生成された証明書を使用する」 のフラグを再度有効化し、<br>画面右下の「適用」ボタンをクリックください。</li><li>SMS_EXECUTIVE サービスを再起動ください。</li><li>数分待機ください。</li><li>再度 IIS マネージャーを起動ください。</li><li> [サイト] - [Default Web Site] を選択し、画面右カラムから「バインド」 を選択してください。</li><li>削除していた「https」のバインドが復帰していることを確認ください。</li><li>「https」 のバインドの中身を確認し、SSL 証明書として「SMS SSL Role Certificate」が選択されていることを確認してください。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Configuration Manager (CM) にて拡張 HTTP 接続が設定されているかどうかをサーバー側で確認する手順をご案内します。特に、HTTPS 接続方式から、拡</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Configuration Manager (CM) における共存状態について</title>
    <link href="https://jpmem.github.io/blog/mecm/20211214_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20211214_01/</id>
    <published>2021-12-13T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.362Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Configuration Manager (CM) とIntune を含む EMM (MDM) 製品のクライアントが同居した際に発生する「共存」状態についてご案内させていただきます。</p><p>共存状態とは、CM クライアントが  EMM (MDM) 製品を検出した際に変更される状態です。この「共存」状態になると、CM のほとんどの機能が無効化されます。例えば、CM から配布している OS や Office の更新プログラムの適用が出来なくなったり、アプリケーションの配布が出来なくなったりします。  </p><p>サード パーティ製 MDM と Configuration Manager の共存<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/comanage/coexistence">https://docs.microsoft.com/ja-jp/mem/configmgr/comanage/coexistence</a></p><h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><p>共同管理ポリシーが適用されていない場合、該当の EMM (MDM) 製品が Intune であったとしても共存状態に変更されます。</p><h2 id="共存状態で無効化される機能"><a href="#共存状態で無効化される機能" class="headerlink" title="共存状態で無効化される機能"></a>共存状態で無効化される機能</h2><ul><li>VPN、Wi-Fi、電子メール、および証明書の設定のリソース アクセス ポリシー</li><li>アプリケーション配布</li><li>パッケージ配布</li><li>更新プログラムのスキャンとインストール</li><li>Endpoint Protection, マルウェア対策ポリシーの配布</li><li>条件付きアクセスのコンプライアンス ポリシー</li><li>デバイス構成</li><li>Office クイック実行管理</li></ul><h2 id="共存状態でも利用できる機能"><a href="#共存状態でも利用できる機能" class="headerlink" title="共存状態でも利用できる機能"></a>共存状態でも利用できる機能</h2><ul><li>ハードウェアインベントリ</li><li>ソフトウェアインベントリ</li><li>資産インテリジェンス</li><li>ソフトウェア使用状況の測定</li><li>電源管理レポート</li></ul><h1 id="共存状態であることを確認する方法"><a href="#共存状態であることを確認する方法" class="headerlink" title="共存状態であることを確認する方法"></a>共存状態であることを確認する方法</h1><p>CM クライアントの CoManagementHandler.log を確認いただき、以下のログが出力された後に、特に共同管理状態に変更されていなければ、CM は共存状態となっている可能性が高いです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Co-existence mode detected. This device is externally managed</span><br></pre></td></tr></table></figure><h1 id="共存状態として検出される条件"><a href="#共存状態として検出される条件" class="headerlink" title="共存状態として検出される条件"></a>共存状態として検出される条件</h1><p>CM では Intune を含む MDM 製品の登録情報がある、下記レジストリをチェックします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[HKLM\SOFTWARE\Microsoft\Provisioning\OMADM\Accounts\]</span><br><span class="line">[HKLM\Software\Microsoft\Enrollments\]</span><br></pre></td></tr></table></figure><p>上記 情報を確認した結果、登録されているのが Intune であれば、共同管理ポリシーの適用状態を確認しますが、登録されているのがサードベンダー製 MDM であったり、Intune が登録されていても共同管理ポリシーが配布されていない場合、共存状態として判定します。共存状態として判定されると、上記のような動作制限がかかります。CM の機能を引き続きご利用されたい場合は、サードベンダー製 MDM からデバイスの登録を削除したり、 Intune をご利用されたい場合は、共同管理ポリシーを配布するようにお願い致します。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Configuration Manager (CM) とIntune を含む EMM (MDM) 製品のクライアントが同居した際に発生する「共存」状態についてご案内させていただき</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>仮想マシン スケールセットのクラウド管理ゲートウェイについて</title>
    <link href="https://jpmem.github.io/blog/mecm/20211212_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20211212_01/</id>
    <published>2021-12-11T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.358Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Configuration Manager Current Branch (CM CB) 2107 より正式リリースとなりました仮想マシン スケールセットについてとその変換手順についてご案内させて頂きます。</p><p>仮想マシン スケールセットのクラウド管理ゲートウェイは、CM CB 2103 以前まで主に提供しております、クラウド管理ゲートウェイ (CMG) がベースとしている、Azure のクラウドサービス (クラシック) が 2024年 8月 31日に非推奨となるのに伴い、代替として登場した 仮想マシン スケールセット (VMSS) ベースの CMG です。CB CB 2107 より正式リリースされており、主な特徴として、CSP サブスクリプションをご利用のお客様につきましても、CMG を利用できるようになっております。</p><h1 id="クラウドサービス-クラシック-版の-CMG-について"><a href="#クラウドサービス-クラシック-版の-CMG-について" class="headerlink" title="クラウドサービス (クラシック) 版の CMG について"></a>クラウドサービス (クラシック) 版の CMG について</h1><p>以下ページでもご案内している通り、クラウドサービス (クラシック) 版の CMG のデプロイは、2022年3月1日 以降の CM CB がリリースされ次第、サポートされなくなります。可能な限り、VMSS 版 CMG をご利用頂くようお願い致します。</p><p>Title: 推奨されない機能 - Configuration Manager | Microsoft Docs<br>URL: <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/plan-design/changes/deprecated/removed-and-deprecated-cmfeatures#deprecated-features">https://docs.microsoft.com/ja-jp/mem/configmgr/core/plan-design/changes/deprecated/removed-and-deprecated-cmfeatures#deprecated-features</a></p><h2 id="VMSS-版-CMG-の変更点"><a href="#VMSS-版-CMG-の変更点" class="headerlink" title="VMSS 版 CMG の変更点"></a>VMSS 版 CMG の変更点</h2><p>以下、サービス外部仕様の変更点となります。  </p><ol><li>展開名サフィックスの変更</li><li>仮想マシンサイズの選択が可能に</li><li>TCP-TLS ポート利用の廃止</li></ol><h3 id="展開名サフィックスの変更"><a href="#展開名サフィックスの変更" class="headerlink" title="展開名サフィックスの変更"></a>展開名サフィックスの変更</h3><table><thead><tr><th>クラウドサービス</th><th>VMSS</th></tr></thead><tbody><tr><td>[ホスト名].cloudapp.net</td><td>[ホスト名].[リージョン名].cloudapp.azure.com</td></tr></tbody></table><p>上記の通り展開名のサフィックスが変更となります。この変更に伴い、お客様がインターネットからの名前解決にご利用されている、DNS にて CNAME レコードの設定変更が必要となりますのでご注意ください。DNS の更新手続きが必要な場合は早めに手続き方法その他をご担当者様にご確認されることをお勧め致します。</p><h3 id="仮想マシンサイズの選択が可能に"><a href="#仮想マシンサイズの選択が可能に" class="headerlink" title="仮想マシンサイズの選択が可能に"></a>仮想マシンサイズの選択が可能に</h3><p>クラウドサービス(クラシック) では、A2V2 インスタンスのみがご利用可能でしたが、CM CB 2107 以降の VMSS 版 CMG ではお客様の管理台数規模に応じて、3種類のインスタンスが選択できるようになりました。ラボ環境はテストや Small PoC のみにご利用くださいますようお願い致します。</p><table><thead><tr><th>用途</th><th>インスタンスサイズ</th><th align="right">サポート台数</th></tr></thead><tbody><tr><td>ラボ</td><td>B2s</td><td align="right">10</td></tr><tr><td>Standard</td><td>A2_V2</td><td align="right">6,000</td></tr><tr><td>大</td><td>A4_V2</td><td align="right">10,000</td></tr></tbody></table><p>Title: CMG のパフォーマンスとスケール - Configuration Manager | Microsoft Docs<br>URL: <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/perf-scale#size-and-scale-for-cmg">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/perf-scale#size-and-scale-for-cmg</a></p><h3 id="TCP-TLS-ポート利用の廃止"><a href="#TCP-TLS-ポート利用の廃止" class="headerlink" title="TCP-TLS ポート利用の廃止"></a>TCP-TLS ポート利用の廃止</h3><p>クラウドサービス (クラシック) で利用していた、クラウド管理ゲートウェイ接続ポイント (CMG-CP) から CMG への TCP-TLS ポート (10140 - 10155) が利用されなくなり、HTTPSポート (443, 10124 - 10139) のみが利用できるようになりました。この変更により、サイト システム設定で Proxy サーバーを設定している場合において、CMG の通信が Proxy サーバーを回避できなくなりました。そのため、VMSS 版 CMG ご利用に当たっては、ご利用されている Proxy サーバーの挙動について良くご確認くださいますようお願い致します。</p><p>Title: CMG のデータ フロー - Configuration Manager | Microsoft Docs<br>URL: <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/data-flow#required-ports">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/data-flow#required-ports</a></p><h1 id="VMSS-版-CMG-への変換について"><a href="#VMSS-版-CMG-への変換について" class="headerlink" title="VMSS 版 CMG への変換について"></a>VMSS 版 CMG への変換について</h1><p>以降、VMSS 版 CMG への変換についてご案内させていただきます。</p><ol><li>変換機能をサポートできない場合について</li><li>事前作業</li><li>実際の変換手順</li><li>DNS CNAMEの変更または更新</li></ol><h2 id="変換機能をサポートできない場合について"><a href="#変換機能をサポートできない場合について" class="headerlink" title="変換機能をサポートできない場合について"></a>変換機能をサポートできない場合について</h2><p>サービス名として展開名と同じ、[ホスト名].cloudapp.netをそのままご利用されている場合は、本変換機能をサポートできません。恐れ入りますが、新規に VMSS 版 CMG を構築いただきますようお願い致します。</p><p>Title: CMG を変更する - Configuration Manager | Microsoft Docs<br>URL: <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/modify-cloud-management-gateway#convert">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/modify-cloud-management-gateway#convert</a></p><h2 id="事前作業"><a href="#事前作業" class="headerlink" title="事前作業"></a>事前作業</h2><p>問題無く変換を完了させるために、以下を確認しておきます。</p><ul><li>機能の有効化</li><li>リソースプロバイダーの登録確認</li></ul><h3 id="機能の有効化"><a href="#機能の有効化" class="headerlink" title="機能の有効化"></a>機能の有効化</h3><p>以下画面より、「Azure VM スケールセットを利用するクラウド管理ゲートウェイ」のステータスがオンになっていることを確認します。ステータスがオフの場合は、該当機能を選択後、リボンから「有効にする」を選択し、有効化してください。</p><p>[CM コンソール] - [管理] - [概要] - [更新とサービス] - [機能]</p><p><img src="/blog/mecm/20211212_01/20211212_01_01.png"></p><h3 id="リソースプロバイダーの登録確認"><a href="#リソースプロバイダーの登録確認" class="headerlink" title="リソースプロバイダーの登録確認"></a>リソースプロバイダーの登録確認</h3><p>VMSS 版の CMG が利用するリソースプロバイダーの登録状況を確認します。</p><p>[Azure Portal] - [サブスクリプション] - ご利用のサブスクリプションを選択 - [リソース プロバイダー]ブレード</p><p><img src="/blog/mecm/20211212_01/20211212_01_02.png"></p><p>上記画面で、以下のリソースプロバイダーがそれぞれ”Registered”状態になっているかを確認し、”NotRegistered”になっている場合は画面上部の「登録」ボタンをクリックして”Registered”状態に変更してください。</p><ul><li>Microsoft.Compute<br><img src="/blog/mecm/20211212_01/20211212_01_03.png"></li><li>Microsoft.Storage<br><img src="/blog/mecm/20211212_01/20211212_01_04.png"></li><li>Microsoft.KeyVault<br><img src="/blog/mecm/20211212_01/20211212_01_05.png"></li><li>Microsoft.Network<br><img src="/blog/mecm/20211212_01/20211212_01_06.png"></li></ul><h2 id="実際の変換作業"><a href="#実際の変換作業" class="headerlink" title="実際の変換作業"></a>実際の変換作業</h2><p>実際の変換作業については下記でもご案内しております。  </p><p>Title: CMG を変更する - Configuration Manager | Microsoft Docs<br>URL: <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/modify-cloud-management-gateway#convert">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/modify-cloud-management-gateway#convert</a></p><p>以下、スクリーンショット付きでのご案内となります。<br>なお、変換自体はバックグラウンドで動作し、環境にも依りますが、通常 30 分から 60 分で完了します。</p><ol><li><p>MECM CB 2107 以降で下記の画面まで遷移します。<br>[CM コンソール] - [管理] - [概要] - [クラウド サービス] - [クラウド管理ゲートウェイ]</p></li><li><p>「デプロイ モデル」が「クラウド サービス（クラシック)」のクラウド管理ゲートウェイのレコードを選択すると、画面上部のリボンに「変換」アイコンが表示されるので、クリックします。</p></li></ol><p><img src="/blog/mecm/20211212_01/20211212_01_07.png"></p><ol start="3"><li>変換ウィザードが起動します。サインイン状態かどうかを確認し、「次へ」をクリックします。</li></ol><p><img src="/blog/mecm/20211212_01/20211212_01_08.png"></p><ol start="4"><li>追加詳細を選択します。本画面で展開名の確認が出来るのでメモしておきましょう。</li></ol><p><img src="/blog/mecm/20211212_01/20211212_01_10.png"></p><p>変更できるのは、以下となります。適宜変更後、「次へ」をクリックします。</p><ul><li>説明</li><li>VM サイズ<br><img src="/blog/mecm/20211212_01/20211212_01_11.png"></li><li>VM インスタンス数</li><li>クライアント証明書のCRLチェックの要否</li><li>TLS 設定</li><li>CMG-CDPの有効可否</li></ul><ol start="5"><li>最終確認画面で設定内容を確認後、「次へ」を選択します。</li></ol><p><img src="/blog/mecm/20211212_01/20211212_01_12.png"></p><ol start="6"><li>時間経過でウィザードの正常完了画面を確認し、「閉じる」をクリックします。</li></ol><p><img src="/blog/mecm/20211212_01/20211212_01_13.png"></p><ol start="7"><li>ウィザードを閉じて、クラウド管理ゲートウェイのテーブルを更新すると、現在の変換状況を確認できます。「ステータスの説明」が「サーバーを移行しています」の状態の時は移行作業中です。環境にも依りますが、30分から60分程度作業完了までお待ちください。</li></ol><p><img src="/blog/mecm/20211212_01/20211212_01_14.png"></p><h2 id="DNS-CNAMEの変更または更新"><a href="#DNS-CNAMEの変更または更新" class="headerlink" title="DNS CNAMEの変更または更新"></a>DNS CNAMEの変更または更新</h2><p>展開名が [ホスト名].cloudapp.net から [ホスト名].[リージョン名].cloudapp.azure.com に変更されているため、インターネットからの名前解決に利用しているDNS のCNAME レコードの更新または作成が必要ですので、ご対応ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Configuration Manager Current Branch (CM CB) 2107 より正式リリースとなりました仮想マシン スケールセットについてとその変換手順に</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>MECM クライアント 手動インストール手順</title>
    <link href="https://jpmem.github.io/blog/mecm/20211122_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20211122_01/</id>
    <published>2021-11-21T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.358Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。</p><p>本日は、Configuration Manager を手動でインストールする基本的な手順について解説致します。</p><p>ご利用頂いているインストール手法が失敗する際などに、本手順によるインストールも失敗するのかを切り分ける方法として、ご活用下さい。</p><ol><li>SCCM サイト サーバーから以下の “client” フォルダを丸ごとコピーし、クライアント端末のローカルの任意の場所に貼り付けます。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\Microsoft Configuration Manager\Client</span><br></pre></td></tr></table></figure><ol start="2"><li><p>クライアント端末にてコマンド プロンプトを管理者権限で開きます。</p></li><li><p>以下のようなコマンドを実行し、クライアントをインストールします。</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Client フォルダをコピーしたパス&gt;\client\ccmsetup.exe /<span class="built_in">source</span>:&lt;Client フォルダをコピーしたパス&gt;\client  SMSSITECODE=&lt;サイトコード&gt; SMSMP=&lt;プライマリサイトの管理ポイントサーバーの FQDN&gt;</span><br></pre></td></tr></table></figure><p>例えば、client フォルダのコピー先が、”c:\temp”で、サイトコードが “P01”、プライマリサイトの管理ポイントサーバーの FQDN が “sccm.contoso.com” の場合、以下のコマンドを実行します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\temp\client\ccmsetup.exe /<span class="built_in">source</span>:c:\temp\client SMSSITECODE=P01 SMSMP=sccm.contoso.com</span><br></pre></td></tr></table></figure><p>※ サイトコードやプライマリサイトの管理ポイントサーバーの FQDN は、SCCM コンソールの以下の画面にてご確認いただけます。<br>[管理] &gt; [概要] &gt; [サイトの構成] &gt; [サーバーとサイト システムの役割]</p><p><img src="/blog/mecm/20211122_01/20211122_01_01.png"></p><ol start="4"><li><p>コマンドプロンプトを閉じます。</p></li><li><p>インストールが行われる間、クライアント端末のタスクマネージャーにて、ccmsetup が動作していることをご確認いただけます。<br>インストールの完了は、以下のログにてご確認いただけます。</p></li></ol><ul><li>ファイル場所<br>C:\Windows\ccmsetup\logs\ccmsetup.log<br></li><li>ログ出力<br>最後に、以下のログが出力されたことで、インストール完了と判断できます。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CcmSetup is exiting with return code 0</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;/p&gt;
&lt;p&gt;本日は、Configuration Manager を手動でインストールする基本的な手順について解説致します。&lt;/p&gt;
&lt;p&gt;ご利用頂いているインストール手法が失敗する際</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>MECM クライアント インストールがうまく行かない時の確認箇所</title>
    <link href="https://jpmem.github.io/blog/mecm/20211122_02/"/>
    <id>https://jpmem.github.io/blog/mecm/20211122_02/</id>
    <published>2021-11-21T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.358Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。</p><p>今回は Configuration Manager のクライアント インストール・登録がうまく行かない際にご確認頂きたいポイントについて、解説させて頂きます。</p><hr><p><img src="/blog/mecm/20211122_02/1.png"></p><ol><li>ccmsetup（クライアント インストール）を実行します。</li><li>インストールが成功すると、管理ポイントと通信し、クライアント登録を試行します。</li><li>登録が完了すると、各種ポリシーをダウンロードします。<br>これが成功すると、コントロール パネル &gt; Configuration Manager の [操作] タブの各項目が表示されます。</li></ol><p>クライアント登録がうまく行かない場合には、上記フロー中のどこかで失敗していることになりますので、以下の確認ポイントに沿って切り分けを行うことが有効です。</p><hr><h1 id="クライアント登録がうまく行かない時の確認ポイント"><a href="#クライアント登録がうまく行かない時の確認ポイント" class="headerlink" title="クライアント登録がうまく行かない時の確認ポイント"></a>クライアント登録がうまく行かない時の確認ポイント</h1><h2 id="1-ccmsetup-log-の確認"><a href="#1-ccmsetup-log-の確認" class="headerlink" title="1. ccmsetup.log の確認"></a>1. ccmsetup.log の確認</h2><p>まずは ccmsetup のログを確認しましょう。クライアント端末の下記のログファイルを開きます。<br>C:\Windows\ccmsetup\logs\ccmsetup.log</p><p>最終的な実行結果がご確認いただけます。正常であれば 0 となります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CcmSetup is exiting with return code 0</span><br></pre></td></tr></table></figure><p>ここで 0 以外のコードで終了している場合には、ccmsetup が失敗している可能性がありますので、調査が必要となります。</p><h2 id="2-ClientIDManagerStartup-log-の確認"><a href="#2-ClientIDManagerStartup-log-の確認" class="headerlink" title="2. ClientIDManagerStartup.log の確認"></a>2. ClientIDManagerStartup.log の確認</h2><p>ccmsetup が return code 0 で終了していれば、インストール処理は問題なく完了していますので、次は登録処理の確認です。<br>クライアント端末の下記のログファイルを開きます。<br>C:\Windows\CCM\Logs\ClientIDManagerStartup.log</p><p>下記のような出力が確認できれば、クライアントの登録処理は成功していることがご確認いただけます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[RegTask] - Client is registered. Server assigned ClientID is GUID:XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX. Approval status 1</span><br></pre></td></tr></table></figure><h2 id="3-管理ポイントとの疎通確認"><a href="#3-管理ポイントとの疎通確認" class="headerlink" title="3. 管理ポイントとの疎通確認"></a>3. 管理ポイントとの疎通確認</h2><p>もし、ClientIDManagerStartup.log にて上記出力が確認できなかった場合には、管理ポイントとの通信状況を確認しましょう。</p><p>クライアント端末にて、PowerShell を開き、下記コマンドを実行します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-WebRequest</span> <span class="literal">-Uri</span> <span class="string">&quot;http://&lt;管理ポイントの FQDN&gt;/sms_mp/.sms_aut?mplist&quot;</span> <span class="literal">-UseBasicParsing</span></span><br></pre></td></tr></table></figure><p>正常にアクセスできる場合、StatusCode : 200 となります。<br>それ以外の場合には、クライアントと管理ポイントとの間で疎通できていない状態となりますので、ネットワーク観点で問題の特定を進める必要がございます。</p><h2 id="4-管理ポイントとの疎通も問題がない場合"><a href="#4-管理ポイントとの疎通も問題がない場合" class="headerlink" title="4.管理ポイントとの疎通も問題がない場合"></a>4.管理ポイントとの疎通も問題がない場合</h2><p>この場合には、詳細な調査が必要となることが想定されますので、弊社サポートへのお問い合わせをご検討下さいませ。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;/p&gt;
&lt;p&gt;今回は Configuration Manager のクライアント インストール・登録がうまく行かない際にご確認頂きたいポイントについて、解説させて頂きます。&lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Configuration Manager コンソールからのログ詳細化について</title>
    <link href="https://jpmem.github.io/blog/mecm/20211118_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20211118_01/</id>
    <published>2021-11-17T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.358Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>本日は Configuration Manager (CM) コンソールから、クライアント端末のログを詳細化する方法についてご紹介させていただきます。<br>以下の方法でクライアント端末側から手動でログを詳細化することも可能でございますが、今回ご紹介する方法は Configuration Manager コンソール上から操作することが可能でございますので、用途に合わせて使い分けていただければ幸いです。</p><p>■MECM エージェント ログの詳細化方法について<br><a href="https://jpmem.github.io/memlog/configmgr/logverbose/verbose_client.html">https://jpmem.github.io/memlog/configmgr/logverbose/verbose_client.html</a> </p><br> <ol><li><p>デバイス一覧より対象デバイスを右クリックして [クライアント診断] - [詳細なログ記録の有効化] をクリックします。<br><img src="/blog/mecm/20211118_01/2021-12-24-16-09-13.png"></p></li><li><p>以下のウィンドウが表示されますので、OK をクリックします。<br><img src="/blog/mecm/20211118_01/2021-12-24-16-10-35.png"></p></li><li><p>[監視] - [クライアントの操作] と辿り、成功していることを確認します。<br><img src="/blog/mecm/20211118_01/2021-12-24-16-11-32.png"></p></li></ol><br>※本情報の内容（添付画像を含む）は、作成日時点でのものであり、予告なく変更される場合があります。]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;本日は Configuration Manager (CM) コンソールから、クライアント端末のログを詳細化する方法についてご紹介させていただきます。&lt;br&gt;以下の方</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>MECM CB 2103 以前での 「クラウド管理」Azure サービス作成時における AAD アプリケーション設定の仕様変更の影響について</title>
    <link href="https://jpmem.github.io/blog/mecm/20211108_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20211108_01/</id>
    <published>2021-11-07T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.358Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>本日は、10/15に Azure AD Applicationの仕様が一部変更されたのに伴い、Configuration Manaer (CM) 側で<br>「クラウド管理」の Azure サービスが利用する Azure AD アプリケーションを作成する際の仕様変更についてご連絡致します。</p><p>なお、上記 Azure サービスは主にクラウド管理ゲートウェイ関連で利用することが多いものでございます。</p><p>以下の記事の通り、Azure アプリケーションを作成する際に指定する App ID URI のフォーマット形式が変更となりました。</p><p><a href="https://docs.microsoft.com/en-US/azure/active-directory/develop/reference-breaking-changes#appid-uri-in-single-tenant-applications-will-require-use-of-default-scheme-or-verified-domains">https://docs.microsoft.com/en-US/azure/active-directory/develop/reference-breaking-changes#appid-uri-in-single-tenant-applications-will-require-use-of-default-scheme-or-verified-domains</a></p><h1 id="影響を受ける範囲"><a href="#影響を受ける範囲" class="headerlink" title="影響を受ける範囲"></a>影響を受ける範囲</h1><p>すでに作成済みの Azure サービスは影響を受けません。そのまま利用可能でございます。</p><p>影響を受けるのは、<br>Configuration Manager Current Branch (CM CB) 2103 以前で「クラウド管理」のアプリケーションを作成する場合となります。</p><h1 id="対処方法"><a href="#対処方法" class="headerlink" title="対処方法"></a>対処方法</h1><p>Configuration Manager Current Branch (CM CB) 2103 以前で、新規に「クラウド管理」アプリケーションを作成する際の、 “Web App” を指定する際の、URIの形式を下記サイトでもご案内している通り、デフォルトの形式<a href="https://configmgrservice/">https://ConfigMgrService</a> に近い文字列ではなく、以下のフォーマットに従った文字列を指定くださいますようお願い致します。</p><ul><li>api://{tenantId}/{string}</li><li>https://{verifiedCustomerDomain}/{string}</li></ul><p><a href="https://docs.microsoft.com/en-us/mem/configmgr/core/clients/manage/cmg/configure-azure-ad#create-the-web-server-app-registration">https://docs.microsoft.com/en-us/mem/configmgr/core/clients/manage/cmg/configure-azure-ad#create-the-web-server-app-registration</a></p><ul><li>{tenantId}: アプリケーションを作成する対象の Azure AD のテナント ID を指定ください。<br>[Azure Portal]- [Azure Active Directory] - [概要] から確認できます。</li><li>{verifiedCustomerDomain}: アプリケーションを作成する対象の利用可能なカスタム ドメインを指定ください。<br>[Azure Portal]- [Azure Active Directory] - [カスタム ドメイン名] から確認できます。</li><li>{string}:　自由な文字列を指定ください。ただし、他の Azure AD アプリケーションと URI が重複しないようにする必要がございます。</li></ul><p>※例: </p><ul><li>api://a8573488-ff46-450a-b09a-6eca0c6a02dc/ConfigMgrService</li><li><a href="https://contoso.onmicrosoft.com/ConfigMgrService">https://contoso.onmicrosoft.com/ConfigMgrService</a></li></ul><h1 id="対処を行わない場合に発生する事象"><a href="#対処を行わない場合に発生する事象" class="headerlink" title="対処を行わない場合に発生する事象"></a>対処を行わない場合に発生する事象</h1><p>上記形式に従わない URI を指定すると、正しい ID でログインしているのに ログイン エラーが発生します。</p><p><img src="/blog/mecm/20211108_01/20211108_01_03.png"></p><h1 id="CM-CB-2107-以降の対応"><a href="#CM-CB-2107-以降の対応" class="headerlink" title="CM CB 2107 以降の対応"></a>CM CB 2107 以降の対応</h1><p>CM CB 2107 以降については、本 URI の指定は以下のようにシステム側で自動的に行われるため、必要がございませんので、ご安心ください。</p><p><img src="/blog/mecm/20211108_01/20211108_01_01.png"></p><p>Azure AD アプリケーション画面から該当のURIが自動作成されていると確認できます。</p><p><img src="/blog/mecm/20211108_01/20211108_01_02.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;本日は、10/15に Azure AD Applicationの仕様が一部変更されたのに伴い、Configuration Manaer (CM) 側で&lt;br&gt;「クラウ</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Windows Update の有効期限ポリシーについて</title>
    <link href="https://jpmem.github.io/blog/mecm/20211028_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20211028_01/</id>
    <published>2021-10-27T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.354Z</updated>
    
    <content type="html"><![CDATA[<p>** この投稿は、2021 年 10 月 19 日に、<a href="https://techcommunity.microsoft.com/t5/windows-it-pro-blog/windows-update-expiration-policy-explained/ba-p/2860928">Windows update expiration policy explained</a> に掲載されたブログ(英語)の抄訳です。 **</p><p>Microsoft は、サポートされているWindows プラットフォームごとに毎月2〜3つの更新プログラムを作成しています。<br>これにより、更新のバックログが発生し、更新パッケージのサイズが大きくなる可能性があります。<br>ただし、これらの更新の多くは累積的であり、そのプラットフォーム用に公開された以前のすべての更新が含まれています。<br>つまり、古いパッケージの有効期限が切れても、累積的な更新をインストールすることで、それらのパッケージに含まれている更新を引き続き受け取ることができます。</p><p>古い冗長パッケージを期限切れにすることで、パフォーマンスが向上し、スキャン時間が短縮され、ユーザーエクスペリエンスが向上し、新しい、より安全な更新に置き換えられた古い更新を展開するリスクが軽減されます。<br>WindowsUpdate の有効期限ポリシーに関してよく寄せられる質問への回答は次のとおりです。</p><h2 id="更新パッケージはどのくらいの頻度で期限切れになりますか？"><a href="#更新パッケージはどのくらいの頻度で期限切れになりますか？" class="headerlink" title="更新パッケージはどのくらいの頻度で期限切れになりますか？"></a>更新パッケージはどのくらいの頻度で期限切れになりますか？</h2><p>公開されたパッケージは、定期的に有効期限が評価されます。十分な数の候補が見つかると、有効期限が切れます。</p><h2 id="古いアップデートの有効期限が切れていないのはなぜですか？"><a href="#古いアップデートの有効期限が切れていないのはなぜですか？" class="headerlink" title="古いアップデートの有効期限が切れていないのはなぜですか？"></a>古いアップデートの有効期限が切れていないのはなぜですか？</h2><p>一部の古いパッケージは、まだ評価されていないか、有効期限の基準を満たしていない可能性があります。<br>その特定の更新への既存の依存関係のために、それらがまだ期限切れになっていない可能性もあります。</p><h2 id="有効期限が切れないパッケージはありますか？"><a href="#有効期限が切れないパッケージはありますか？" class="headerlink" title="有効期限が切れないパッケージはありますか？"></a>有効期限が切れないパッケージはありますか？</h2><p>Windows 8.1、Windows Server 2012 SP2、Windows Server 2012、Windows 7 SP1、Windows Server 2008 R2、およびWindows Server 2008 SP2 のセキュリティのみの更新パッケージは、累積的ではなく、1か月分の修正しか保持されていないため、有効期限はありません。<br>さらに、最新の更新パッケージが古いパッケージに依存している場合、古いパッケージは、新しいパッケージに置き換えられるまで期限切れになりません。</p><h2 id="アップデートの有効期限が切れているかどうかを確認するにはどうすればよいですか？"><a href="#アップデートの有効期限が切れているかどうかを確認するにはどうすればよいですか？" class="headerlink" title="アップデートの有効期限が切れているかどうかを確認するにはどうすればよいですか？"></a>アップデートの有効期限が切れているかどうかを確認するにはどうすればよいですか？</h2><p>更新の有効期限が切れている場合は、support.microsoft.com の特定の更新に関連するリリースノート記事のタイトルに「EXPIRED」という単語が追加されています。</p><p><img src="/blog/mecm/20211028_01/1.png" alt="image.png"></p><p>記事の上部にも有効期限の通知があります。</p><p><img src="/blog/mecm/20211028_01/2.png" alt="image.png"></p><p>Windows Server Update Services（WSUS）を使用している場合、特定の更新プログラムの有効期限が切れていると、詳細ウィンドウの上部にバナーが表示されます。</p><p>注：このポリシーは、WindowsUpdate にのみ適用されます。他の Microsoft ソフトウェアまたはファームウェアの更新には異なるポリシーがある場合があるため、個別に検討する必要があります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;** この投稿は、2021 年 10 月 19 日に、&lt;a href=&quot;https://techcommunity.microsoft.com/t5/windows-it-pro-blog/windows-update-expiration-policy-explained</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>スクリプト機能のご紹介</title>
    <link href="https://jpmem.github.io/blog/mecm/20211025_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20211025_01/</id>
    <published>2021-10-24T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.350Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>本日は Configuration Manager (CM) の便利な機能である<strong>スクリプト機能</strong>のご紹介をさせていただきます。本機能により CM 管理下の端末にリアルタイムに遠隔からスクリプトを実行させることが出来ます。</p><p>Configuration Manager コンソールから PowerShell スクリプトを作成して実行する<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/apps/deploy-use/create-deploy-scripts">https://docs.microsoft.com/ja-jp/mem/configmgr/apps/deploy-use/create-deploy-scripts</a></p><h1 id="機能の説明"><a href="#機能の説明" class="headerlink" title="機能の説明"></a>機能の説明</h1><p>CM サーバーから CM コンソールを使って、デバイス単位、コレクション単位に指定したPowershell を、<strong>リアルタイム</strong>に実行する機能です。同じことは Enter-PSSession コマンドレットを使えば出来ますが、本機能は複数のデバイスに対して Powershell を実行できることに強みがあります。また、Intune によるスクリプト配布機能と比較した場合、こちらの方がオンデマンドな処理を行う際には便利です。</p><h1 id="ユースケース"><a href="#ユースケース" class="headerlink" title="ユースケース"></a>ユースケース</h1><p>Powershell で実現できることは何でも出来ますが、CM 管理者であれば例えば以下のような点で利用出来るでしょう。</p><ol><li>一時的に、デバイスのレジストリの値を採取する。定期的な回収が必要ではないようなものには便利。(定期的な回収はハードウェア インベントリを利用したほうが良い)</li><li>あるデバイスから、あるサーバーへのネットワーク到達性のチェック。HTTPリクエストが通るか、デバイスに対してポートが開放されているか、はたまたデバイスでサーバーのURLへの名前解決が可能かどうか、などをチェックする。</li><li>CM クライアントの状態チェック。あるソフトウェア センターの表示状態のアイテムの確認。</li></ol><h1 id="利用に当たっての推奨事項"><a href="#利用に当たっての推奨事項" class="headerlink" title="利用に当たっての推奨事項"></a>利用に当たっての推奨事項</h1><p>「大いなる力には大いなる責任が伴う」の言葉通り、何でも出来るということはセキュリティ上のリスクでもあります。ご利用の組織のポリシーに従って、明確なルールを制定してご利用ください。</p><p>以下、ご利用に当たっての推奨事項になります。</p><h2 id="スクリプトの承認プロセスを設ける"><a href="#スクリプトの承認プロセスを設ける" class="headerlink" title="スクリプトの承認プロセスを設ける"></a>スクリプトの承認プロセスを設ける</h2><p>スクリプトの作成者と承認者で担当者を分け、CM にスクリプトを追加する前に承認が必要なようにしましょう。<br>なお、CM コンソール上の既定の設定では、作成者が直接承認を行えないよう、<br>以下のフラグが有効化されています。  </p><p>[CM コンソール] - [管理] - [概要] - [サイトの構成] - [サイト]-対象のサイトを選択-[階層設定] - [全般タブ] -「スクリプトの作成者には追加のスクリプト承認者が必要」</p><p><img src="/blog/mecm/20211025_01/20211025_01_01.png"></p><h2 id="承認ルールを定める"><a href="#承認ルールを定める" class="headerlink" title="承認ルールを定める"></a>承認ルールを定める</h2><p>スクリプトの承認者が判断に迷わないよう、承認に当たってルールを決めておきましょう。例えば、以下のようなルールが考えられるかと思います。</p><ul><li><p>CM クライアントに対して変更処理が入るようなスクリプトは承認しない</p><ul><li>例: ファイルの作成、機能の有効化、レジストリ値の変更、等</li></ul></li><li><p>操作誤りによりインフラに影響を与えるようなスクリプトは承認しない</p><ul><li>例: 複数クライアントによる負荷テスト</li></ul></li></ul><h2 id="実行ルールを定める"><a href="#実行ルールを定める" class="headerlink" title="実行ルールを定める"></a>実行ルールを定める</h2><p>CM としてはスクリプトの実行後、特に証跡が残るような仕組みは用意されておりません。また、実行にあたっての承認プロセスを実装する仕組みもまた、提供されておりません。</p><p>お客様のポリシーに依るかと存じますが、ポリシー上、厳密な管理を要求される場合であれば、スクリプトの実行記録について台帳等で記録を残す<br>る、スクリプト実行前後に承認プロセスを用意する、等の実行ルールを定めると良いかと存じます。</p><h1 id="スクリプト作成のコツ"><a href="#スクリプト作成のコツ" class="headerlink" title="スクリプト作成のコツ"></a>スクリプト作成のコツ</h1><h2 id="スクリプトの結果は少ない文字数で標準出力しよう。"><a href="#スクリプトの結果は少ない文字数で標準出力しよう。" class="headerlink" title="スクリプトの結果は少ない文字数で標準出力しよう。"></a>スクリプトの結果は少ない文字数で標準出力しよう。</h2><p>CMでスクリプトを実行すると、以下のように、デバイスごとに標準出力の内容が1行で出力されます。</p><p><img src="/blog/mecm/20211025_01/20211025_01_03.png"></p><p>スクリプトの出力欄をダブルクリックすると、以下のように出力内容の詳細を確認できます。</p><p><img src="/blog/mecm/20211025_01/20211025_01_04.png"></p><p>コレクションに対する実行結果を一覧で見たい時などは、上記の例のような出力だと比較が難しいので、スクリプトの実行目的に従って、出力結果の文字数を制限するようにしましょう。</p><p>例えば、以下のような形が良いかと存じます。この例では、.Net Framework の Version を確認するためのスクリプトを実行し、結果を短い文字列で出力するようにしています。</p><p><img src="/blog/mecm/20211025_01/20211025_01_05.png"></p><p>なお、スクリプトを上手く作ると、実行結果を出した後、「概要」タブを選択することで、出力結果を以下のようにグラフ表示できます。</p><p><img src="/blog/mecm/20211025_01/20211025_01_06.png"></p><h2 id="実行失敗時は終了コードを0以外の数値を出力しよう。"><a href="#実行失敗時は終了コードを0以外の数値を出力しよう。" class="headerlink" title="実行失敗時は終了コードを0以外の数値を出力しよう。"></a>実行失敗時は終了コードを0以外の数値を出力しよう。</h2><p>上記のスクリーンショットで示したとおり、「スクリプトの出力」で表示される文字数は限定されていますので、実行時エラーもスクリプト出力に表示させると一覧性が悪化します。<br>代わりに、想定されるエラー発生時のエラーコードを決め、エラーコードを内部で保持し、対応する方が良いでしょう。</p><h2 id="パラメータを受け取る場合は、パラメーター内容の妥当性確認を実施しよう"><a href="#パラメータを受け取る場合は、パラメーター内容の妥当性確認を実施しよう" class="headerlink" title="パラメータを受け取る場合は、パラメーター内容の妥当性確認を実施しよう"></a>パラメータを受け取る場合は、パラメーター内容の妥当性確認を実施しよう</h2><p>スクリプト作成時に下記の通り Param を指定することで実行時パラメーターを指定することが出来ます。</p><p><img src="/blog/mecm/20211025_01/20211025_01_07.png"></p><p>パラメーターを入力すると、下記画面で各パラメーターの妥当性確認を行います。正規表現も利用可能ですので、受け取ったパラメーターの妥当性を厳密に実施するようにしましょう。こちらで妥当性確認が出来ない内容についてはスクリプト側で確認するようにしましょう。</p><p><img src="/blog/mecm/20211025_01/20211025_01_08.png"></p><h2 id="スクリプトを-CM-コンソールに登録する前に開発環境でテストしよう"><a href="#スクリプトを-CM-コンソールに登録する前に開発環境でテストしよう" class="headerlink" title="スクリプトを CM コンソールに登録する前に開発環境でテストしよう"></a>スクリプトを CM コンソールに登録する前に開発環境でテストしよう</h2><p>お客様のポリシーによりますが、本番環境に置いては、上記の通りスクリプトの登録時に承認プロセスがある筈ですので、CMコンソールで実施する前に開発環境で十分にスクリプトをテストしてからスクリプトを登録するようにした方が良いかと存じます。ちょっとしたスクリプトの修正で承認プロセス通してたら時間がかかってしまいますので･･･。</p><h1 id="スクリプトの作成手順"><a href="#スクリプトの作成手順" class="headerlink" title="スクリプトの作成手順"></a>スクリプトの作成手順</h1><p><strong>以下、パラメーターを指定しない場合の</strong>、スクリプト 作成者による CM コンソールでのスクリプトの作成手順は以下の通りです。</p><ol><li><strong>スクリプト作成者</strong>の ID で CM コンソールが動く端末にログインします。  </li><li>[CMコンソール]-[ソフトウェア ライブラリ]-[概要]-[スクリプト]に遷移します。  </li><li>[スクリプトの作成]をクリックします。<br><img src="/blog/mecm/20211025_01/20211025_01_02.png"></li><li>「スクリプト名」に適宜名前を付けます。  </li><li>「スクリプト」にスクリプトを書きます。「インポート」でps1ファイルから読み込む事も出来ます。<br><img src="/blog/mecm/20211025_01/20211025_01_09.png">  </li><li>以降はウィザードに従って、最後まで「次へ」をクリックし、完了後「閉じる」をクリックします。  </li></ol><h1 id="スクリプトの承認手順"><a href="#スクリプトの承認手順" class="headerlink" title="スクリプトの承認手順"></a>スクリプトの承認手順</h1><ol><li><strong>スクリプト承認者</strong>の ID で  CM コンソールが動く端末にログインします。  </li><li>[CM コンソール] - [ソフトウェア ライブラリ] - [概要] - [スクリプト]に遷移します。  </li><li>スクリプト作成者から報告のあったスクリプトの名前を選択します。「承認状態」が「承認を待っています」となっていることからも判断出来ます。<br><img src="/blog/mecm/20211025_01/20211025_01_10.png">  </li><li>画面上部「承認/拒否」ボタンをクリックします。<br><img src="/blog/mecm/20211025_01/20211025_01_11.png">  </li><li>起動したウィザードにて、スクリプト内容を確認、レビューします。<br><img src="/blog/mecm/20211025_01/20211025_01_12.png">  </li><li>レビュー結果を記載します。適宜レビューコメントを入力できます。<br><img src="/blog/mecm/20211025_01/20211025_01_13.png">  </li><li>以降はウィザードに従って、最後まで「次へ」をクリックし、完了後「閉じる」をクリックします。  </li><li>登録完了後、該当のスクリプトが「承認済み」となっていることを確認します。<br><img src="/blog/mecm/20211025_01/20211025_01_14.png">  </li></ol><h1 id="スクリプトの実行手順"><a href="#スクリプトの実行手順" class="headerlink" title="スクリプトの実行手順"></a>スクリプトの実行手順</h1><ol><li>スクリプトの実行権限を持つ ID で、CM コンソールが動く端末にログインします。  </li><li>スクリプトの実行対象によって以下を選択します。  <ul><li>[CM コンソール] - [資産とコンプライアンス] - [概要] - [デバイス]  </li><li>[CM コンソール」- [資産とコンプライアンス] - [概要] - [デバイス コレクション]  </li></ul></li><li>実行対象を右クリックすると、「スクリプトの実行」メニューがあるので、そちらをクリックします。<br><img src="/blog/mecm/20211025_01/20211025_01_15.png">  </li><li>実行するスクリプトを選択し、「次へ」をクリックします。<br><img src="/blog/mecm/20211025_01/20211025_01_16.png"><br>5．概要画面で「次へ」を選択します。<br><img src="/blog/mecm/20211025_01/20211025_01_17.png">  </li><li>実行が完了するのを待機します。オンデマンドで指定したクライアントに対してスクリプトを配布し、実行し、その結果を表示しますので時間がかかります。  </li><li>実行結果を確認します。適宜、結果をスクリーンショット等に取りましょう。<br><img src="/blog/mecm/20211025_01/20211025_01_18.png">  </li><li>出力セルを選択した後、「Ctrl+A」を押下して、メモ帳等に貼り付けると結果をテキスト形式で取得できます。<br><img src="/blog/mecm/20211025_01/20211025_01_19.png">  </li><li>ウィザードを適宜閉じます。  </li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;本日は Configuration Manager (CM) の便利な機能である&lt;strong&gt;スクリプト機能&lt;/strong&gt;のご紹介をさせていただきます。本機能に</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Windows Server 2012 R2 WSUS から Windows Server 2022 WSUS への移行手順 (WID -&gt; WID の場合)</title>
    <link href="https://jpmem.github.io/blog/wsus/2021-10-19_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2021-10-19_01/</id>
    <published>2021-10-18T15:00:00.000Z</published>
    <updated>2022-04-06T11:28:26.430Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。WSUS サポート チームです。</p><p>今回は Windows Server 2012 R2 にインストールした WSUS を、最新の 2022 へ移行する手順をご紹介します。</p><p>サポート ライフサイクルにあわせて、新しいバージョンへの移行を検討されている方も多いかと思います。<br>WSUS サーバーを新しいバージョンに移行する場合、以下の方法があります。</p><ol><li>新サーバーで WSUS を新規構築  </li><li>旧サーバーでバックアップを取得し、新サーバーにリストア</li></ol><p>基本的には 1. 新規構築してご利用いただく方法が最もシンプルな方法になります。<br>既存のデータを引き継ぎたい場合には、今回ご紹介する 2. データベースのバックアップ / リストアをご検討ください。  </p><p>なお、WSUS データベースの変更に関して、こちら (<a href="https://docs.microsoft.com/ja-jp/windows-server/administration/windows-server-update-services/manage/wid-to-sql-migration">https://docs.microsoft.com/ja-jp/windows-server/administration/windows-server-update-services/manage/wid-to-sql-migration</a>) にデータベースのアタッチ / デタッチの方法を掲載していますが、こちらは同一サーバー上で WSUS データベースを WID から SQL に変更することを目的とした手順であり、今回のように異なるサーバー間の移行シナリオにはご利用いただけませんのでご留意ください。  </p><h1 id="WSUS-移行手順について-WID-gt-WID"><a href="#WSUS-移行手順について-WID-gt-WID" class="headerlink" title="WSUS 移行手順について (WID -&gt; WID)"></a>WSUS 移行手順について (WID -&gt; WID)</h1><ul><li><p>前提条件<br>移行元 サーバー : Windows Server 2012 R2 の WSUS 環境<br>移行先 サーバー : Windows Server 2022 の WSUS 環境<br>WSUS は移行元も移行先もデータベースに Windows Internal Database (WID) を利用していることを前提とします。</p></li><li><p>手順<br>Windows Server 2022 の WSUS のインストールとデータ移行の手順は以下の通りです。</p></li></ul><ol><li>Windows Server 2022 の WSUS のインストール  </li><li>データ移行  <ol><li>WSUS 更新プログラム バイナリを移行する  </li><li>WSUS セキュリティ グループを移行する  </li><li>WSUS データベースをバックアップする  </li><li>WSUS データベースのバックアップを移行先サーバーで復元する  </li><li>WSUS サーバー ID を変更する  </li><li>インデックスを再構成する  (任意)</li><li>不足ファイルをダウンロードする  (任意) </li></ol></li><li>完了確認  </li></ol><p>各手順の詳細を以下に記載いたします。</p><br>  <br>  <h1 id="1-Windows-Server-2022-への-WSUS-インストール"><a href="#1-Windows-Server-2022-への-WSUS-インストール" class="headerlink" title="1.Windows Server 2022 への WSUS インストール"></a>1.Windows Server 2022 への WSUS インストール</h1><p>まず初めに、Windows Server 2022 の WSUS のインストールは、サーバー マネージャーから[役割と機能の追加] をクリックして、インストールします。こちらの手順は以下の公開情報をご参照ください。<br><br>  </p><ul><li>手順 1:WSUS サーバー ロールをインストールする<br><a href="https://docs.microsoft.com/ja-jp/windows-server/administration/windows-server-update-services/deploy/1-install-the-wsus-server-role">https://docs.microsoft.com/ja-jp/windows-server/administration/windows-server-update-services/deploy/1-install-the-wsus-server-role</a></li></ul><p>WSUS サーバーの役割のインストールが正常に完了すると、Windows Server Update Services 設定ウィザードが自動的に起動しますが、このウィザードは閉じてください。</p><h1 id="2-データ移行"><a href="#2-データ移行" class="headerlink" title="2.データ移行"></a>2.データ移行</h1><h2 id="2-1-WSUS-更新プログラム-バイナリを移行する"><a href="#2-1-WSUS-更新プログラム-バイナリを移行する" class="headerlink" title="2.1. WSUS 更新プログラム バイナリを移行する"></a>2.1. WSUS 更新プログラム バイナリを移行する</h2><p>移行元のコンテンツ フォルダー「\&lt;移行元サーバー名&gt;\WsusContent」の内容を、移行先のコンテンツ フォルダー「\&lt;移行先サーバー名&gt;\WsusContent」へコピーします。エクスプローラー、xcopy コマンド、robocopy コマンド等を利用し、コピーすることが可能です。robocopy コマンドを利用する場合は、以下の通りです。</p><p>例) 移行元が WSUSOld で、移行先が WSUSNew の場合</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">robocopy \\WSUSOld\WsusContent \\WSUSNew\WsusContent /E /COPYALL</span><br></pre></td></tr></table></figure><h2 id="2-2-WSUS-セキュリティ-グループを移行する"><a href="#2-2-WSUS-セキュリティ-グループを移行する" class="headerlink" title="2.2. WSUS セキュリティ グループを移行する"></a>2.2. WSUS セキュリティ グループを移行する</h2><p>WSUS Administrators ローカル セキュリティ グループと WSUS Reporters ローカル セキュリティ グループのみ手動で移行することを選択できます。</p><p>この手順を実行する前に、ローカル グループのメンバーであるドメイン ユーザーの名前を、移行先サーバーでも解決できることを確認します。移行元サーバーと移行先サーバーの属するドメインが異なる場合は、移行元ドメインのユーザー アカウントがあるフォレストのグローバル カタログ サーバーに移行先サーバーがアクセスできる必要があります。</p><p>WSUS Administrators ローカル セキュリティ グループと WSUS Reporters ローカル セキュリティ グループに手動でユーザーを移行するには、移行先サーバーで次の手順を実行します。</p><ul><li>手順  </li></ul><ol><li>「ファイル名を指定して実行」画面で lusrmgr.msc と入力して、Enter キーを押します。  </li><li>「ローカル ユーザーとグループ MMC スナップイン」のコンソール ツリーで、[ユーザー] をダブルクリックします。  </li><li>移行元サーバーの WSUS Administrators グループと WSUS Reporters グループに存在したユーザーを手動で作成します。  </li><li>ローカル ユーザーとグループ MMC スナップインのコンソール ツリーで、[グループ] をダブルクリックします。  </li><li>移行元サーバーの WSUS Administrators グループと WSUS Reporters グループに存在したユーザーを移行先サーバーの WSUS Administrators グループと WSUS Reporters グループに手動で追加します。</li></ol><h2 id="2-3-WSUS-データベースをバックアップする"><a href="#2-3-WSUS-データベースをバックアップする" class="headerlink" title="2.3. WSUS データベースをバックアップする"></a>2.3. WSUS データベースをバックアップする</h2><p>移行元 WSUS サーバーにおいて以下の手順を実施し、WSUS データベース (SUSDB) をバックアップします。</p><ol><li><p>下記 URL より SQL Server Management Studio をダウンロードし、WSUS サーバーにインストールします。<br>Microsoft SQL Server Management Studio<br>(<a href="https://docs.microsoft.com/ja-jp/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15">https://docs.microsoft.com/ja-jp/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15</a>)</p></li><li><p>SQL Server Management Studio を起動して、以下の接続文字列を指定してインスタンスに接続します。<br>サーバーの種類 : データベース エンジン<br>サーバー名 : \.\pipe\Microsoft##WID\tsql\query<br>認証 : Windows 認証</p></li><li><p>[データベース] を展開し、[SUSDB] データベースを選択します。  </p></li><li><p>データベースを右クリックし、[タスク] をポイントして、[バックアップ] をクリックします。[データベースのバックアップ] ダイアログ ボックスが表示されます。  </p></li><li><p>[データベース] ボックスの一覧で、データベース名を確認します。  </p></li><li><p>[バックアップの種類] ボックスの一覧で、[完全] をクリックします。  </p></li><li><p>[コピーのみのバックアップ] を選択します。コピーのみのバックアップとは、定期的に実行される一連の SQL Server バックアップとは別の SQL Server バックアップです。  </p></li><li><p>[バックアップ コンポーネント] で [データベース] をクリックします。  </p></li><li><p>[バックアップ先] に [ディスク] を選択して、[追加] からバックアップ先を選択します。  </p></li><li><p>[ページの選択] ウィンドウの [メディア オプション] をクリックします。  </p></li><li><p>[メディアに上書きする] オプションで、[既存のバックアップ セットに追加する] にチェックがされていることを確認します。  </p></li><li><p>[信頼性] セクションで、必要に応じて、次のチェック ボックスをオンにします。    </p><ul><li>[完了時にバックアップを検証する]  </li><li>[メディアに書き込む前にチェックサムを行う]  </li><li>[エラーのまま続行する]  </li></ul></li><li><p>[OK] をクリックして、バックアップを作成します。  </p></li><li><p>バックアップ完了後、指定したバックアップ先に作成されたバックアップ ファイルを移行先 WSUS サーバーの任意の場所にコピーします。  </p></li></ol><h2 id="2-4-WSUS-データベースのバックアップを移行先サーバーで復元する"><a href="#2-4-WSUS-データベースのバックアップを移行先サーバーで復元する" class="headerlink" title="2.4. WSUS データベースのバックアップを移行先サーバーで復元する"></a>2.4. WSUS データベースのバックアップを移行先サーバーで復元する</h2><p>移行先 WSUS サーバーにおいて以下の手順を実施し、WSUS データベース (SUSDB) を復元します。</p><ol><li><p>下記 URL より SQL Server Management Studio をダウンロードし、WSUS サーバーにインストールします。<br>Microsoft SQL Server Management Studio<br>(<a href="https://docs.microsoft.com/ja-jp/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15">https://docs.microsoft.com/ja-jp/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15</a>)</p></li><li><p>SQL Server Management Studio を起動して、以下の接続文字列を指定してインスタンスに接続します。<br>サーバーの種類 : データベース エンジン<br>サーバー名 : \.\pipe\Microsoft##WID\tsql\query<br>認証 : Windows 認証  </p></li><li><p>[新しいクエリ] をクリックし、次の SQL コマンドをコピーして [実行] をクリックしてクエリを実行します。このクエリにより、WSUS データベースが削除されます。</p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">USE master</span><br><span class="line">GO</span><br><span class="line">ALTER DATABASE SUSDB SET SINGLE_USER WITH ROLLBACK IMMEDIATE</span><br><span class="line">GO</span><br><span class="line">DROP DATABASE SUSDB</span><br><span class="line">GO</span><br></pre></td></tr></table></figure><ol start="4"><li><p>[実行] をクリックしてクエリを実行します。  </p></li><li><p>続けて、次の SQL コマンドをコピーして [実行] をクリックしてクエリを実行します。WSUS データベースをバックアップから復元します。<br>例) バックアップ ファイルを C:\SUSDB.bak に配置している場合</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RESTORE DATABASE [SUSDB] FROM DISK = N&#x27;C:\SUSDB.bak&#x27; WITH FILE = 1, MOVE N&#x27;SUSDB&#x27; TO N&#x27;c:\Windows\WID\Data\susdb.mdf&#x27;, MOVE N&#x27;SUSDB_log&#x27; TO N&#x27;c:\Windows\WID\Data\SUSDB_log.ldf&#x27;, NOUNLOAD, STATS = 10</span><br></pre></td></tr></table></figure></li><li><p>この結果として、次のエラー メッセージが表示される場合があります。エラー メッセージを無視して、続行してください。<br>メッセージ 3605、レベル 16、状態 1、行 1<br>データベース ‘SUSDB’ のスキーマの検証が失敗しました。<br>メッセージ 3013、レベル 16、状態 1、行 1<br>RESTORE DATABASE が異常終了しています。</p></li><li><p>移行先 WSUS サーバー (Windows Server 2022) でコマンド プロンプトを [管理者として実行] にて開き、次のコマンドを実行します。<br>例) WSUS のインストール フォルダーが D:\WSUS の場合</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd %programfiles%\Update Services\Tools</span><br><span class="line">wsusutil postinstall content_dir=D:\WSUS  </span><br></pre></td></tr></table></figure></li></ol><h2 id="2-5-WSUS-サーバー-ID-を変更する"><a href="#2-5-WSUS-サーバー-ID-を変更する" class="headerlink" title="2.5. WSUS サーバー ID を変更する"></a>2.5. WSUS サーバー ID を変更する</h2><p>移行先サーバーの WSUS サーバー ID は変更する必要があります。この手順を実行すると、移行プロセス中に WSUS 管理のクライアントは影響を受けなくなります。移行元サーバーと移行先サーバーが同じ ID を使用して実行されている場合、サーバーの一方に対して変更を行うと、クライアントとサーバー間の通信は失敗します。</p><ol><li><p>移行先サーバーで、Windows PowerShell を [管理者として実行] にて開き、次のスクリプトを実行します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$updateServer = get-wsusserver</span><br><span class="line">$config = $updateServer.GetConfiguration()</span><br><span class="line">$config.ServerId = [System.Guid]::NewGuid()</span><br><span class="line">$config.Save()</span><br></pre></td></tr></table></figure></li><li><p>サーバー ID が変更されたら、すぐにコマンド プロンプトを [管理者として実行] にて開き、次のコマンドを実行して新しい暗号化キーを生成します。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd %programfiles%\Update Services\Tools</span><br><span class="line">wsusutil.exe postinstall</span><br></pre></td></tr></table></figure><br>  </li></ol><h2 id="任意-2-6-インデックスを再構成する"><a href="#任意-2-6-インデックスを再構成する" class="headerlink" title="(任意) 2.6. インデックスを再構成する"></a>(任意) 2.6. インデックスを再構成する</h2><p>インデックスの再構成を定期的に実施していない場合、移行前の WSUS データベースにてインデックスの断片化が発生し、クエリ パフォーマンスが劣化していることがございます。その場合は、インデックス再構成により、クエリ パフォーマンスを改善できます。</p><p>コマンドを使ってインデックスの再構成を行う場合には、インデックス再構成用のスクリプトを sql ファイルに保存した上で、以下のコマンドを実行します。</p><p>例) C:\Temp\WsusDBMaintenance.sql に実行する SQL 文を保存しており、C:\Temp 配下に実行結果ログを出力する場合<br>   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sqlcmd -E -S &lt;インスタンス名&gt; -i</span><br><span class="line">C:\Temp\WsusDBMaintenance.sql -o</span><br><span class="line">C:\Temp\WsusDBMaintenance.out -f 65001</span><br><span class="line">※ WSUS データベースに WID をご利用の場合、&lt;インスタンス名&gt; は、以下を指定します。</span><br><span class="line">\\.\pipe\Microsoft##WID\tsql\query</span><br></pre></td></tr></table></figure></p><p>出力ファイルに “Statistics for all tables have been updated” または”全テーブルの統計が更新されました” というメッセージが 表示されていれば、インデックスの再構成が完了しています。</p><p>～ 参考情報 ～<br>sqlcmd ユーティリティ<br><a href="https://msdn.microsoft.com/ja-jp/library/ms162773.aspx">https://msdn.microsoft.com/ja-jp/library/ms162773.aspx</a></p><p>WSUS DB インデックスの再構成の手順について<br><a href="https://blogs.technet.com/b/jpwsus/archive/2014/03/06/wsusdb.aspx">https://blogs.technet.com/b/jpwsus/archive/2014/03/06/wsusdb.aspx</a><br><br>  </p><h2 id="任意-2-7-不足ファイルをダウンロードする"><a href="#任意-2-7-不足ファイルをダウンロードする" class="headerlink" title="(任意) 2.7. 不足ファイルをダウンロードする"></a>(任意) 2.7. 不足ファイルをダウンロードする</h2><p>手順 2.1. でバイナリ ファイルは移行元からコピーされていますが、もし移行元で承認されていたにも関わらず、バイナリが不足している場合は、wsusutil reset コマンドで不足ファイルのみをダウンロードすることができます。もし、クライアントの接続確認の際に 80244019 エラー (HTTP status 404 File Not Found) が発生した場合は、サーバー側の WsusContent フォルダー配下に必要なファイルが不足している可能性がございますので、以下のコマンドの実行をお試しください。</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /d &quot;C:\Program Files\Update Services\Tools&quot;</span><br><span class="line">wsusutil reset</span><br></pre></td></tr></table></figure><p>コマンド ラインからの WSUS の管理<br><a href="https://technet.microsoft.com/ja-jp/library/cc720466(v=ws.10).aspx">https://technet.microsoft.com/ja-jp/library/cc720466(v=ws.10).aspx</a>  </p><p>—– 抜粋ここから —–<br>resetデータベースのすべての更新メタデータ行に、ファイル システムに格納されている対応する更新ファイルが含まれていることを確認します。更新ファイルが不足していたり壊れていた場合、WSUS は更新ファイルをもう一度ダウンロードします。  </p><ul><li>WSUS データベースを復元した後  </li><li>トラブルシューティング時    </li><li>—- 抜粋ここまで —–  <br>  <br>  </li></ul><h2 id="3-完了確認"><a href="#3-完了確認" class="headerlink" title="3.完了確認"></a>3.完了確認</h2><p>移行先サーバーで WSUS 管理コンソールを起動し、初回の設定を必要に応じて行います。WSUS 管理コンソール起動後、更新プログラムの情報や承認情報、グループ情報が移行されていることをご確認ください。また、ダウンストリーム サーバーの接続や WSUS クライアントを移行先の WSUS サーバーと接続できるかどうか確認するためには、以下の内容をご確認ください。  </p><p>～ 参考情報 ～<br>3.5. Apply security settings<br>-Point the downstream servers to the new WSUS server<br>-Point the WSUS clients to the new WSUS server<br><a href="https://docs.microsoft.com/ja-jp/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh852349(v=ws.11)?redirectedfrom=MSDN#point-the-downstream-servers-to-the-new-wsus-server">https://docs.microsoft.com/ja-jp/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh852349(v=ws.11)?redirectedfrom=MSDN#point-the-downstream-servers-to-the-new-wsus-server</a></p><p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。WSUS サポート チームです。&lt;/p&gt;
&lt;p&gt;今回は Windows Server 2012 R2 にインストールした WSUS を、最新の 2022 へ移行する手順をご紹介します。&lt;/p&gt;
&lt;p&gt;サポート ライフサイクルにあわせて、新しいバージョンへの移行を</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
</feed>
