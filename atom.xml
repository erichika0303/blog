<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Microsoft Endpoint Manager Support Blog</title>
  
  <subtitle>日本マイクロソフト Microsoft Endpoint Manager サポート チームのブログです。</subtitle>
  <link href="https://jpmem.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpmem.github.io/blog/"/>
  <updated>2022-04-28T06:54:42.821Z</updated>
  <id>https://jpmem.github.io/blog/</id>
  
  <author>
    <name>Microsoft Endpoint Manager Support Japan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Configuration Manager の自動展開規則と WSUS の自動承認規則について</title>
    <link href="https://jpmem.github.io/blog/mecm/20220426_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220426_01/</id>
    <published>2022-04-25T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.821Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは。Configuration Manager サポート チームです。<br>今回は Configuration Manager の自動展開規則と WSUS の自動承認規則について各々概要を紹介いたします。  </p><p>自動展開規則と自動承認規則は双方ともに、新たに Configuration Manager 及び WSUS に同期した更新プログラムをクライアントへ自動的に展開する方法として用意された機能でございます。</p><h2 id="Configuration-Manager-の自動展開規則について"><a href="#Configuration-Manager-の自動展開規則について" class="headerlink" title="Configuration Manager の自動展開規則について"></a>Configuration Manager の自動展開規則について</h2><p>Configuration Manager の自動展開規則の機能を利用しますと、Windows OS 向けにリリースされた更新プログラムや Microsoft Defender の定義ファイルをクライアント コンピューターに自動的に展開することができます。</p><p><img src="/blog/mecm/20220426_01/2.png" alt="image.png"></p><p>自動展開規則は、Configuration Manager のソフトウェア更新プログラムの展開機能と同様にデバイス コレクションに対して展開を行います。  </p><p>一例としましては、Windows 10 version 21H2 のクライアントのみを含むデバイス コレクションを作成し、そちらのデバイス コレクションに対し、Windows 10 version 21H2 用の月例品質更新プログラムを自動展開規則で展開するという運用が考えられます。</p><p><img src="/blog/mecm/20220426_01/3.png" alt="image.png"></p><p>自動展開規則のプロパティ フィルターでは、いくつかの種類のフィルターが用意されており、設定したフィルターの条件を満たすソフトウェア更新プログラムが自動展開規則で展開されます。<br>なお、プロパティ フィルターはアンド条件でございますので、フィルターを設定いただいた数だけ条件が絞られていく動作となります。<br>例えば、下の画像に記載されているプロパティ フィルターの条件は、Windows 10 の毎月の定例セキュリティ更新プログラムを配信する設定でございます。</p><p><img src="/blog/mecm/20220426_01/4.png" alt="image.png"></p><p>公開情報でも自動展開規則の作成方法を紹介しておりますのでご参考にしてくださいませ。<br>Title : Configuration Manager を使用して定義の更新プログラムを配信する<br>URL : <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/protect/deploy-use/endpoint-definitions-configmgr">https://docs.microsoft.com/ja-jp/mem/configmgr/protect/deploy-use/endpoint-definitions-configmgr</a></p><p>また、Microsoft Defender の定義ファイルにつきましては、1 日に 複数回リリースされるため、Configuration Manager で配信する場合は、自動展開規則を作成することをお勧めいたします。<br>また、Configuration Manager から定義ファイルを配信する上でできる限りクライアントがダウンロードされる容量を少なくする方法について、自動展開規則のプロパティ フィルターを使用して Configuration Manager に同期された更新プログラムから Microsoft Defender の定義ファイルだけを自動展開するように構成する必要がありますが、この設定においてクライアントにダウンロードされる容量を少なくするためのポイントがあります。それは 「置き換えられる」 を「いいえ」に設定すること です。</p><p><img src="/blog/mecm/20220426_01/8.png" alt="image.png"></p><p>詳細は以下のブログで紹介しております。  </p><p>Title : Microsoft Defender / System Center Endpoint Protection の定義ファイルのダウンロードの最適化について<br>URL : <a href="https://jpmem.github.io/blog/mecm/20180308_01/">https://jpmem.github.io/blog/mecm/20180308_01/</a></p><h2 id="WSUS-の自動承認規則について"><a href="#WSUS-の自動承認規則について" class="headerlink" title="WSUS の自動承認規則について"></a>WSUS の自動承認規則について</h2><p>Configuration Manager の自動展開規則と似た機能として WSUS では自動承認規則が用意されております。<br>ただし、自動承認規則が自動展開規則と異なる部分としては、規則作成の際の条件として指定可能な項目が少ないという違いがあります。</p><p>WSUS の自動承認規則を利用しますと、Windows OS 向けにリリースされた更新プログラムや Defender のセキュリティ インテリジェンス更新プログラムをクライアント コンピューターが属するコンピューター グループに対し自動的に承認することができます。</p><p><img src="/blog/mecm/20220426_01/5.png" alt="image.png"></p><p>自動承認規則の規則の追加では、ステップ 1 で 3 種類のプロパティが用意されており、ステップ 2 でプロパティの条件を詳細に指定します。自動承認規則はこちらのプロパティの条件に従いソフトウェア更新プログラムを自動的に承認します。<br>なお、規則の追加については Configuration Manager の自動展開規則と同様にアンド条件でございますので、プロパティを設定いただいた数だけ条件が絞られていく動作となります。</p><p><img src="/blog/mecm/20220426_01/7.png" alt="image.png"></p><p>公開情報でも自動承認規則の作成方法を紹介しておりますのでご参考にしてくださいませ。<br>Title : 3.2. 自動承認規則を構成する<br>URL : <a href="https://docs.microsoft.com/ja-jp/windows-server/administration/windows-server-update-services/deploy/3-approve-and-deploy-updates-in-wsus#BKM_3.2.a">https://docs.microsoft.com/ja-jp/windows-server/administration/windows-server-update-services/deploy/3-approve-and-deploy-updates-in-wsus#BKM_3.2.a</a>.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;皆様こんにちは。Configuration Manager サポート チームです。&lt;br&gt;今回は Configuration Manager の自動展開規則と WSUS の自動承認規則について各々概要を紹介いたします。  &lt;/p&gt;
&lt;p&gt;自動展開規則と自動承認規則は双方とも</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Chromium Edge 更新プログラムを WSUS で配布する方法</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-04-22_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-04-22_01/</id>
    <published>2022-04-21T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.889Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。 WSUS サポート チームです。</p><p>長年皆様にご愛用いただいた Internet Explore のサポートの終了が 2022 年 6 月 15 日に予定されていることが発表されました。<br>それに伴い、 Chromium Edge 更新プログラムを WSUS から配信したいとのお問い合わせも増えてきております。<br>そこで、今回は WSUS から Chromium Edge へ更新プログラムを配信する方法をご紹介します。</p><h3 id="WSUS-から-Chromium-Edge-更新プログラム配信する方法"><a href="#WSUS-から-Chromium-Edge-更新プログラム配信する方法" class="headerlink" title="WSUS から Chromium Edge 更新プログラム配信する方法"></a><strong>WSUS から Chromium Edge 更新プログラム配信する方法</strong></h3><h3 id="1-Chromium-Edge-の自動更新を制御する"><a href="#1-Chromium-Edge-の自動更新を制御する" class="headerlink" title="1. Chromium Edge の自動更新を制御する"></a>1. Chromium Edge の自動更新を制御する</h3><p>Chromium Edge には、不具合、パフォーマンス、セキュリティ更新が 既定で 10 時間ごとにブラウザで行われる自動更新という機能があります。<br>WSUS から Chromium Edge の更新プログラムを配布する場合は事前に Chromium Edge の自動更新によって勝手にバージョンが上がっていかないよう GPO にて以下の設定が必要です。</p><p>ポリシー ： [ 管理用テンプレート ]&gt;[ Microsoft Edge の更新 ]&gt;[ アプリケーション ]&gt;[ Microsoft Edge ]<br>[ 更新ポリシーのオーバーライドの規定値 ]：有効：[ 更新を無効にする ] を選択します。<br>※このポリシーはドメイン参加環境でのみ効果があります。<br>（ Chromium Edge 管理用テンプレ―トは<a href="https://www.microsoft.com/ja-jp/edge/business/download">こちら</a>から入手可能です。 )<br><img src="/blog/wsus/2022-04-22_01/2022-04-22_01_1.png"></p><h3 id="2-WSUS-から-Chromium-Edge-の更新を配信する"><a href="#2-WSUS-から-Chromium-Edge-の更新を配信する" class="headerlink" title="2. WSUS から Chromium Edge の更新を配信する"></a>2. WSUS から Chromium Edge の更新を配信する</h3><p>WSUS コンソールで [ オプション ] &gt; [ 製品と分類 ]<br>製品： Microsoft Edge 、分類： 更新 にチェックを追加し、更新プログラムを同期します。<br><img src="/blog/wsus/2022-04-22_01/2022-04-22_01_2.png"></p><p>WSUS にて承認作業を行います。<br><img src="/blog/wsus/2022-04-22_01/2022-04-22_01_3.png"></p><p>クライアント側で更新プログラムが適用されます。<br><img src="/blog/wsus/2022-04-22_01/2022-04-22_01_4.png"></p><p>Chromium Edge のバージョンが更新されます。<br><img src="/blog/wsus/2022-04-22_01/2022-04-22_01_5.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。 WSUS サポート チームです。&lt;/p&gt;
&lt;p&gt;長年皆様にご愛用いただいた Internet Explore のサポートの終了が 2022 年 6 月 15 日に予定されていることが発表されました。&lt;br&gt;それに伴い、 Chromium Edge 更</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>MECM パッケージの再実行の設定方法について解説！</title>
    <link href="https://jpmem.github.io/blog/mecm/20220421_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220421_01/</id>
    <published>2022-04-20T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.821Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームの草刈です。  </p><p>今回は多くの方が誤解しやすいパッケージの再実行について解説致します。  </p><h2 id="パッケージを再実行させる時のポイント"><a href="#パッケージを再実行させる時のポイント" class="headerlink" title="パッケージを再実行させる時のポイント"></a>パッケージを再実行させる時のポイント</h2><p>ポイントは「再実行の動作」の設定だけでは再実行はされない、という点です。実は「割り当てスケジュール」により繰り返し実行するように設定する必要があります。  </p><p>一度覚えてしまえば後はご利用のニーズに応じて「割り当てスケジュール」、「再実行の動作」を組み合わせてパッケージ機能を利用することができるうようになりますので、パッケージ実行の概要や各設定箇所について解説させていただきます。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_08.png">  </p><h3 id="パッケージ実行の概要について"><a href="#パッケージ実行の概要について" class="headerlink" title="パッケージ実行の概要について"></a>パッケージ実行の概要について</h3><p>パッケージを展開した際に、端末側で実行されるタイミングは展開設定によって決定されます。  </p><h4 id="必須展開の場合"><a href="#必須展開の場合" class="headerlink" title="必須展開の場合"></a>必須展開の場合</h4><p><img src="/blog/mecm/20220421_01/20220421_01_01.png">  </p><p>必須展開の場合には [スケジュール] にて設定した [割当スケジュール] に設定されたタイミングで実行されます。  </p><p>例えば下記のように「直ちに」とした場合には、クライアント端末側でパッケージ展開のポリシーを受信するとすぐに実行されます。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_02.png">  </p><p>※ スケジュールのオプションについて<br>・[この展開が使用可能になる日時を指定する] を設定した場合、指定した日時以降でのみ、実行が可能となります。（それまでは実行されません。）<br>・[この展開の有効期限を指定する] を指定した場合、有効期限をすぎると実行されなくなります。</p><h4 id="利用可能展開の場合"><a href="#利用可能展開の場合" class="headerlink" title="利用可能展開の場合"></a>利用可能展開の場合</h4><p><img src="/blog/mecm/20220421_01/20220421_01_03.png">  </p><p>利用可能で展開した場合には、クライアント端末上でユーザーがソフトウェア センターを開き、[インストール] ボタンをクリックしたタイミングで実行されます。  </p><h3 id="再実行の設定方法について"><a href="#再実行の設定方法について" class="headerlink" title="再実行の設定方法について"></a>再実行の設定方法について</h3><p>パッケージで再実行を設定する方法について解説させていただきます。　　</p><p>1.展開対象のパッケージを右クリック &gt; [展開] をクリックします。　　</p><p><img src="/blog/mecm/20220421_01/20220421_01_04.png">  </p><p>2.[全般] にて展開したいコレクションを指定し、[次へ] をクリックします。  </p><p>3.[コンテンツ] にて展開するパッケージがコンテンツを含む場合には、配布ポイントを指定してコンテンツ配布を設定し、[次へ] をクリックします。<br>既にコンテンツ配布済みの場合には、何も設定せずに [次へ] をクリックします。  </p><p>4.[展開設定] にて、目的 = [必須] を選択し、[次へ] をクリックします。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_01.png">  </p><p>5.[スケジュール] にて、下記の設定を行います。  </p><p>パケージは「割り当てスケジュール」により、実行タイミングを決定します。<strong>注意が必要なのはここで繰り返し設定、または、複数のスケジュールを指定しない限り、再実行はされないということです。</strong>  </p><p>例えば割り当てスケジュールに「直ちに」のみ設定した場合には、1 度のみの実行となり、仮に実行が失敗した場合でも再実行はされませんのでご注意ください。  </p><p>上記を踏まえて再実行させたい場合のスケジュールの設定方法を解説致します。  </p><h4 id="割り当てスケジュールの設定"><a href="#割り当てスケジュールの設定" class="headerlink" title="割り当てスケジュールの設定"></a>割り当てスケジュールの設定</h4><p>5-1. [新規] をクリックします。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_05.png">  </p><p>5-2. [割当スケジュール] ウィンドウにて [スケジュール] をクリックします。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_06.png">  </p><p>5-3. [カスタム スケジュール] ウィンドウにて繰り返しパターンを設定します。<br>ここで再実行させたい周期を設定します。下記は 1 時間ごとに実行を繰り返す設定の例です。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_07.png">  </p><p>上記設定が完了したら [OK] をクリックしていきます。  </p><h4 id="再実行の動作の設定"><a href="#再実行の動作の設定" class="headerlink" title="再実行の動作の設定"></a>再実行の動作の設定</h4><p>ここが混乱するポイントです。この設定は、このパッケージの実行が 2 回目以降の場合に適用される設定となります。よくある勘違いが「ここで [前回失敗した場合に再実行する] を選択しておけば、実行が失敗した時に再実行される」と思ってしまいがちなのですがこれは間違いです。  </p><p>上記の<strong>「割り当てスケジュール」が繰り返し実行するように設定されていない限り、たとえこの「再実行の動作」を設定していても再実行はされない</strong>のでご注意ください。  </p><p>あくまで、2 回以上実行がトリガーされた場合にのみ、「再実行の動作」の設定が評価されるという点がポイントです。  </p><p><img src="/blog/mecm/20220421_01/20220421_01_08.png">  </p><p>例として、上記の様に、1 時間ごとに実行する「割り当てスケジュール」を設定し、「再実行の動作」にて [前回失敗した場合に再実行する] を選択し、展開を行った場合には、下記のような動作となります。  </p><p><strong>・前回実行 = 成功の場合</strong><br>実行 = 成功　→　1 時間経過　→　前回実行結果を評価　→　前回成功しているので再実行しない  </p><p><strong>・前回実行 = 失敗の場合</strong><br>実行 = 失敗　→　1 時間経過　→　前回実行結果を評価　→　前回失敗しているので再実行される　→　成功　→　1 時間経過　→　前回実行結果を評価　→　前回成功しているので再実行しない  </p><p>上記では [前回失敗した場合に再実行する] を例にあげましたが、実行結果に関わらず常に再実行させたい場合など、ご要件に応じで選択する項目を設定くださいませ。  </p><p>後は、残りの展開設定を進めて頂き、展開を完了させてください。  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームの草刈です。  &lt;/p&gt;
&lt;p&gt;今回は多くの方が誤解しやすいパッケージの再実行について解説致します。  &lt;/p&gt;
&lt;h2 id=&quot;パッケージを再実行させる時のポイント&quot;&gt;&lt;a href=&quot;#パ</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Configuration Manager で資産管理台帳のカスタム レポートを作成する</title>
    <link href="https://jpmem.github.io/blog/mecm/20220419_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220419_01/</id>
    <published>2022-04-18T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.809Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。<br>今回は Microsoft Endpoint Configuration Manager (以下 Configuration Manager) でカスタム レポートを作成する手順をご案内します。</p><p>例として、<strong>資産管理台帳</strong> ということでパソコンの所持ユーザーに紐づくマシン名と、管理者の部署名も表示するというものを作成します。<br>Configuration Manager の情報が格納されている SQL Server データベースの基礎知識などもカバーしますので、これから Configuration Manager で様々な情報を管理されたいという方は是非ともご参考ください。  </p><p>サンプルだとマシン数も少なく、機種名が仮想環境のため見栄えがしませんが、以下のようなレポートを作成します。<br><img src="/blog/mecm/20220419_01/20220419_01_01.png"></p><h2 id="ステップ-1-Active-Directory-ユーザーの探索-で、追加収集する属性を設定する"><a href="#ステップ-1-Active-Directory-ユーザーの探索-で、追加収集する属性を設定する" class="headerlink" title="ステップ 1: [Active Directory ユーザーの探索] で、追加収集する属性を設定する"></a>ステップ 1: [Active Directory ユーザーの探索] で、追加収集する属性を設定する</h2><p>資産管理台帳を表示するにあたって、管理者の会社名や部署名といった情報も取得したいという要件があります。<br>これを実現するには、「Active Directory ユーザーの探索」において収集する属性を追加します。</p><ol><li>Configuration Manager コンソールを開きます。</li><li>コンソール画面左のツリー表示より、[階層の構成] - [探索方法] を選択します。</li><li>画面右の、探索方法の一覧より、[Active Directory ユーザーの探索] をダブルクリックし、プロパティ画面を開きます。</li><li>[Active Directory の属性] タブを表示します。</li><li>ウィンドウ左下の [利用可能な属性] は、Active Directory 上のユーザー オブジェクトの属性を示します。<br><img src="/blog/mecm/20220419_01/20220419_01_02.png"></li></ol><p>例えば、部署名は [department]、会社名は [company] となります。<br><img src="/blog/mecm/20220419_01/20220419_01_03.png"></p><p>department, company を例として追加しますが、任意でその他の属性を追加いただいても構いません。</p><p>※ 補足: ここで追加した属性は、後述の Configuration Manager の SQL のビュー “v_R_User” に、当該の名称で属性が追加されます。</p><ol start="6"><li>追加した属性は、次回の Active Directory ユーザーの探索の周期にて、収集されて Configuration Manager のデータベースに格納されます。<br>直ちに実行したい場合、手順 3 の [Active Direcotry ユーザーの探索] を右クリックし、[今すぐ完全な探索を実行する] を選択します。</li></ol><p>上記は、Active Directory ユーザーの探索の例ですが、その他、Active Directory システムの探索 (コンピューター オブジェクト) でも、Active Directory 属性の追加が可能ですので、応用してください。</p><h2 id="ステップ-2-SQL-のクエリを作成する"><a href="#ステップ-2-SQL-のクエリを作成する" class="headerlink" title="ステップ 2: SQL のクエリを作成する"></a>ステップ 2: SQL のクエリを作成する</h2><p>Configuration Manager にて格納された情報について SQL クエリを実行し、必要な情報をまとめて表示します。<br>レポートの元となる SQL クエリについては、[SQL Server Management Studio] から試行錯誤し、作成します。<br>SQL クエリの実行方法については、以下の手順をご参照ください。</p><p>Title: SQL Query 結果の出力方法について<br>URL: <a href="https://jpmem.github.io/memlog/configmgr/sql/sqlquery.html">https://jpmem.github.io/memlog/configmgr/sql/sqlquery.html</a></p><p>クエリの作成にあたっては、後述補足の、”SCCM データベースのクエリ作成の基礎知識” をご参考ください。</p><p>以下は、ユーザー名に紐尽くプライマリ デバイスと、その基本的な情報を表示する資産台帳の表示を行うカスタム クエリです。<br>ユーザーが最も長く使用するプライマリ デバイスを使用しています。<br>ユーザー名と、そのプライマリ デバイスの関連性は v_UserMachineRelationship ビューに格納されています。</p><p>クエリ例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sys.Netbios_Name0 <span class="keyword">as</span> &quot;マシン名&quot;, u.Unique_User_Name0 <span class="keyword">as</span> &quot;AD上のユーザー名&quot;,</span><br><span class="line">u.Full_User_Name0 <span class="keyword">as</span> &quot;ユーザー名&quot;, u.department <span class="keyword">as</span> &quot;部署名&quot;,</span><br><span class="line">cs.Model0 <span class="keyword">as</span> &quot;機種のモデル名&quot;, cs.Manufacturer0 <span class="keyword">as</span> &quot;機種の製造元&quot;,</span><br><span class="line"><span class="keyword">left</span> (os.Name0,charindex (<span class="string">&#x27;|&#x27;</span>, os.Name0)<span class="number">-1</span>) <span class="keyword">as</span> &quot;OS名&quot;, os.TotalVisibleMemorySize0 <span class="keyword">as</span> &quot;物理メモリ(MB)&quot;,</span><br><span class="line">(ld.Size0 <span class="operator">/</span> <span class="number">1024</span>) <span class="keyword">as</span> &quot;C:の容量(GB)&quot;</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">v_UserMachineRelationship umr</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> v_R_User u</span><br><span class="line"><span class="keyword">on</span> umr.UniqueUserName <span class="operator">=</span> u.Unique_User_Name0</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> v_R_System sys</span><br><span class="line"><span class="keyword">on</span> umr.MachineResourceID <span class="operator">=</span> sys.ResourceID</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> v_GS_COMPUTER_SYSTEM cs</span><br><span class="line"><span class="keyword">on</span> sys.ResourceID <span class="operator">=</span> cs.ResourceID</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> v_GS_OPERATING_SYSTEM os</span><br><span class="line"><span class="keyword">on</span> os.ResourceID <span class="operator">=</span> sys.ResourceID</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> v_GS_LOGICAL_DISK ld</span><br><span class="line"><span class="keyword">on</span> ld.ResourceID <span class="operator">=</span> sys.ResourceID</span><br><span class="line"><span class="keyword">where</span> ld.DeviceID0 <span class="keyword">like</span> <span class="string">&#x27;%C%&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="ステップ-3-レポートを作成する"><a href="#ステップ-3-レポートを作成する" class="headerlink" title="ステップ 3: レポートを作成する"></a>ステップ 3: レポートを作成する</h2><p>B で作成した SQL クエリを表示する、簡単なカスタム レポートの作成手順です。<br>事前準備として、レポートの編集に必要な Report Builder をインストールしてください。</p><p>Title: Microsoft® Report Builder<br>URL: <a href="https://www.microsoft.com/en-us/download/details.aspx?id=53613">https://www.microsoft.com/en-us/download/details.aspx?id=53613</a></p><p>インストール ウィザードの途中の “既定の対象のサーバー” の入力項目はブランクのままインストールを進めてかまいません。<br><img src="/blog/mecm/20220419_01/20220419_01_04.png"></p><ol><li><p>Configuration Manager コンソールより、[監視] ワークスペースを開きます。</p></li><li><p>[レポート] - [レポート] を右クリックして [レポートの作成] をクリックします。</p></li></ol><p>※ Report Builder が未インストールの場合、以下のエラーが表示されますので、そのときは Report Builder をインストールしてください。<br><img src="/blog/mecm/20220419_01/20220419_01_05.png"></p><ol start="3"><li>[レポートの作成ウィザード] では、レポートの名前と説明を入力します。パスは、レポートがどのフォルダーに格納されるかが設定されますが、任意で結構です。</li></ol><p>※ 独自に作成したフォルダーをパスに指定したい場合は、予めブラウザでレポート マネージャー (http://&lt;ホスト名&gt;/Reports) を開き、[ConfigMgr_&lt;サイト コード&gt;] フォルダー直下に、任意の名前でフォルダーを作成してください。<br><img src="/blog/mecm/20220419_01/20220419_01_06.png"></p><ol start="4"><li><p>ウィザードを完了させると、SQL Server レポート ビルダーが起動します。初回起動時に以下のダイアログが出力されるので [はい] をクリックします。　　<br><img src="/blog/mecm/20220419_01/20220419_01_07.png"></p></li><li><p>画面中央の [テーブルまたはマトリックス] を選択します。<br><img src="/blog/mecm/20220419_01/20220419_01_08.png"></p></li><li><p>[新しいテーブル/マトリックス] ウィザードが表示されます。[データセットを作成する] のチェックのまま、次へ進みます。<br><img src="/blog/mecm/20220419_01/20220419_01_09.png"></p></li><li><p>[データソース接続] については、既定のまま、次へ進みます。”データ ソースの資格情報の入力” ダイアログが表示された場合、[現在の Windows ユーザーを使用する] を選択して [OK] をクリックします。<br><img src="/blog/mecm/20220419_01/20220419_01_10.png"></p></li><li><p>[クエリのデザイン] 画面では、画面左上の [テキストとして編集] をクリックし、白紙個所に B で作成したクエリを張り付けます。実行ボタン [!] を押すことで、プレビューも可能です。<br><img src="/blog/mecm/20220419_01/20220419_01_11.png"></p></li><li><p> [フィールドの配置] 画面では、[使用できるフィールド] のすべてを、[値] にドラッグ ドロップします。<br><img src="/blog/mecm/20220419_01/20220419_01_12.png"></p></li><li><p>[レイアウトの選択] 画面で、[次へ] をクリックします。<br><img src="/blog/mecm/20220419_01/20220419_01_13.png"></p></li><li><p>プレビューを確認して [完了] をクリックし、ウィザードを完了します。<br><img src="/blog/mecm/20220419_01/20220419_01_14.png"></p></li><li><p> Report Builder の最初の画面に戻ります。列幅やフォントなどレイアウトを任意で整えた後、[ファイル] - [保存] をクリックして閉じます。<br><img src="/blog/mecm/20220419_01/20220419_01_15.png"></p></li></ol><p>※ Report Builder 内の [実行] をクリックすることで、Report Builder 上で結果のプレビューを確認することもできます。<br><img src="/blog/mecm/20220419_01/20220419_01_16.png"></p><ol start="13"><li>Configuration Manager コンソールの [監視] ワークスペース、[レポート] - [レポート] から、作成したレポートを検索して、実行します。<br><img src="/blog/mecm/20220419_01/20220419_01_17.png"></li></ol><p>このように、SQL Server に直接クエリするのではなく Configuration Managerのレポートから閲覧可能となります。<br>レポートごとにアクセス権を設定できる点や、様々な形式でエクスポート可能であることがメリットです。</p><h2 id="補足-Configuration-Manager-データベースのクエリ作成の基礎知識"><a href="#補足-Configuration-Manager-データベースのクエリ作成の基礎知識" class="headerlink" title="補足: Configuration Manager データベースのクエリ作成の基礎知識"></a>補足: Configuration Manager データベースのクエリ作成の基礎知識</h2><p>カスタム クエリを作成いただくにあたって、知っておきたい Configuration Manager データベースの基礎知識は以下となります。</p><ul><li><p>はじめに、既存のレポートを色々と触ってみることをお奨めします。既存のレポートは様々な「よくある要望」を達成するため、用意されています。レポートの一覧は<a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/list-of-reports">こちらの公開情報</a>にも掲載されておりますので、ご確認ください。</p></li><li><p>カスタム レポートを作成すると決断した場合、手始めに、Configuration Manager の既存のレポートから、目的に類似したものをまずは見つけることをお奨めします。既存のレポートを [右クリック] - [編集] し Report Builder から見ることで、どのようなクエリを発行しているのか確認できます。<br>以下の画面ショットのように、[データセット] - [DataSet] のプロパティを表示し、クエリを確認します。<br>特に、”from” 句で、どのビューを参照・結合しているのかが分かれば、SQL データベースとにらめっこをしなくても、即座に見るべきビューのあたりをつけることができます。</p></li><li><p>SQL クエリを書く場合、Configuration Manager では、テーブルではなく、ビューを使用してクエリを作成してください。(テーブルの直接参照はサポートされません。)</p></li><li><p>[Active Directory ユーザーの探索] で探索したユーザー属性は、”v_R_User” ビューに格納されます。また、コンピューター オブジェクトの場合、”v_R_System” になります。</p></li><li><p>Configuration Manager で収集されたハードウェア インベントリ情報の多くは、”v_GS_&lt;カテゴリー名&gt;” のビューに格納されています。これらのビューを結合するにあたっては、マシンごとに一意に振られている “ResourceID” というキー値を使用することが有効です。”ResourceID” が一致するよう、これらのビューを結合 (Join) することで、特定のマシンについての様々なインベントリ情報を結合出来ます。</p></li></ul><p>インベントリにて、どのような情報が収集されているかについては、[リソース エクスプローラー] からご確認ください。<br>Configuration Manager コンソールの [資産とコンプライアンス] ワークスペースより、コレクションからマシン名を選択し、[開始] - [リソース エクスプローラー] を開始します。<br>画面左のツリーから一覧可能なカテゴリーは、すべて v_GS_&lt;カテゴリー名&gt; のビューに格納されています。</p><p>上記のようなビューに関する情報は、以下の公開情報でもご案内しておりますので、こちらもどのビューを使用するか決定する際にお役立ていただければと思います。</p><p>Title: SQL Serverマネージャーのビューを表示する<br>URL: <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/develop/core/understand/sqlviews/sql-server-views-configuration-manager">https://docs.microsoft.com/ja-jp/mem/configmgr/develop/core/understand/sqlviews/sql-server-views-configuration-manager</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;br&gt;今回は Microsoft Endpoint Configuration Manager (以下 Configuration Manager) でカスタム レポートを作成する手順</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>MECM クライアントがインストールされた PC でマスター イメージを新規取得・再取得する手順</title>
    <link href="https://jpmem.github.io/blog/mecm/20220418_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220418_01/</id>
    <published>2022-04-17T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.809Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>今回は Microsoft Endpoint Configuration Manager (以下 MECM) クライアント エージェントがインストールされた PC で、マスター イメージを新規取得するシナリオと、再取得するシナリオの手順をまとめてご紹介します。</p><p>※本記事は、以下の 2 つの過去記事を最新の情報をもとに取り纏めたものとなります。<br><a href="https://jpmem.github.io/blog/mecm/20171025_01/">System Center Configuration Manager クライアントがインストールされた PC でマスター イメージを再取得する手順</a><br><a href="https://jpmem.github.io/blog/mecm/20171107_01/">System Center Configuration Manager クライアントがインストールされた PC でマスター イメージを取得する手順 (ワークグループ対応版)</a></p><p>MECM クライアントは、端末に一意の情報が保持されているため、そのままマスター イメージを作成すると一意の情報が重複することで、デバイス一覧の重複して表示されたり、配布物が正しく配布出来なくなるといった不都合が発生しますので、一意の情報を削除し、マスター イメージを再取得する手順をご案内致します。<br>利用シナリオとしては VDI クライアントやイメージ展開を他社製品で行う場合に、予め MECM エージェントをインストールしておくことを想定しております。<br>本手順を実施していない場合は、展開後に一意の情報が重複して、正常に管理することができなくなりますので、本手順をご参考ください。</p><h2 id="シナリオ"><a href="#シナリオ" class="headerlink" title="-シナリオ"></a>-シナリオ</h2><p>以下の 2 パターンのシナリオについて、手順をご紹介致します。</p><p>A. MECM クライアントがインストールされていない状態から、マスターイメージの “新規” 取得を行う手順<br>B. 既に MECM クライアントがインストールされている状態から、マスター イメージの “再” 取得を行う手順</p><h2 id="関連情報"><a href="#関連情報" class="headerlink" title="-関連情報"></a>-関連情報</h2><p>本手順が未実施であることで、固有の ID (GUID) 重複の問題が発生している場合には、別途以下の記事で対処方法をご紹介しております。<br><a href="https://jpmem.github.io/blog/mecm/20210922_01/">重複 GUID の対処について</a></p><h2 id="対象製品"><a href="#対象製品" class="headerlink" title="-対象製品"></a>-対象製品</h2><ul><li>System Center Configuration Manager LTSB  </li><li>Microsoft Endpoint Configuration Manager (Current Branch)  </li></ul><h1 id="A-MECM-クライアントがインストールされていない状態から、マスターイメージの-“新規”-取得を行う手順"><a href="#A-MECM-クライアントがインストールされていない状態から、マスターイメージの-“新規”-取得を行う手順" class="headerlink" title="A. MECM クライアントがインストールされていない状態から、マスターイメージの “新規” 取得を行う手順"></a>A. MECM クライアントがインストールされていない状態から、マスターイメージの “新規” 取得を行う手順</h1><h3 id="事前説明"><a href="#事前説明" class="headerlink" title="-事前説明"></a>-事前説明</h3><p>意図しないサイトコードの割り当てを防ぐため、MECM サーバーと通信できない状態で手順を実施します。<br>ネットワークを未接続にすることは必須ではなく、あくまで MECM サーバーと疎通できない状態として頂ければ問題ございません。<br>※文中では “ネットワーク ケーブルを抜く” と表現しております。</p><p>&lt;目次&gt;</p><ol><li>サイト コード未割り当ての状態で MECM クライアントをインストールする</li><li>[SMS Agent Host] サービスの停止とスタート アップの種類の変更</li><li>MECM で使用する自己署名証明書を削除する</li><li>MECM 独自の信頼キーと管理ポイントの証明書を削除する</li><li>[SMS Agent Host] サービスのスタート アップの種類の変更</li><li>マスターイメージの採取</li></ol><h3 id="1-サイト-コード未割り当ての状態で-MECM-クライアントをインストールする"><a href="#1-サイト-コード未割り当ての状態で-MECM-クライアントをインストールする" class="headerlink" title="1. サイト コード未割り当ての状態で  MECM クライアントをインストールする"></a>1. サイト コード未割り当ての状態で  MECM クライアントをインストールする</h3><p>以下の手順にて、サイト コードが “未割り当て” の状態でエージェントのセットアップを行います。</p><ol><li><p>プライマリ サイト サーバーより、MECM インストール フォルダー配下に存在する [Client] フォルダーをコピーし保存します。<br>※インストール フォルダーの初期設定は以下になりますが、お客様環境によっては変更されている場合がございます。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\Program Files\Microsoft Configuration Manager\Client</span><br></pre></td></tr></table></figure></li><li><p>対象の PC にローカル管理者権限を保有するユーザーでログインします。</p></li><li><p>項番 1) でコピーした [Client] フォルダーを、クライアント上の任意のフォルダーに格納します。</p></li><li><p>MECM サーバーと通信できないようにするため、ネットワーク ケーブルを抜きます。</p></li><li><p>[管理者として実行] にてコマンド プロンプトを開き、cd コマンドで Client フォルダーに移動し、以下のコマンドを実行します。<br> ※SMSSITECODE オプションなしで ccmsetup.exe を実行することにより、”未割り当て” の状態でエージェントがセットアップされます。<br> ※ワーク グループ環境の場合は、SMSMP もしくは DNSSUFFIX オプションなどを任意で指定してください。ただし、その場合も SMSSITECODE オプションは使用しないようにしてください。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ccmsetup.exe</span><br></pre></td></tr></table></figure></li><li><p>Windows キー + R キーを押下し、<strong>taskmgr</strong> を実行し、[タスク マネージャー] 画面を開き、[プロセス] 欄で ccmsetup.exe が表示されなくなるまで待ちます。</p></li><li><p>Windows キー + R キーを押下し、<strong>control</strong> を実行し、[コントロール パネル] 画面を開き、[システムとセキュリティ] から [Configuration Manager] を開き、以下のようにサイト コードが “未割り当て” の状態であることを確認します。  </p><p> ・[コンポーネント] タブ： 「CCM 通知エージェント」 以外のすべての項目が「インストール済み」であることを確認します。<br> ※ 「CCM 通知エージェント」 は 「無効」 になります。</p><p> ・[サイト] タブ : 「現在の割り当てサイト コード」が空欄であることを確認します。</p></li></ol><h3 id="2-SMS-Agent-Host-サービスの停止とスタート-アップの種類の変更"><a href="#2-SMS-Agent-Host-サービスの停止とスタート-アップの種類の変更" class="headerlink" title="2. [SMS Agent Host] サービスの停止とスタート アップの種類の変更"></a>2. [SMS Agent Host] サービスの停止とスタート アップの種類の変更</h3><ol><li><p>Windows キー + R キーを押下し、<strong>Sevices.msc</strong> を実行し、[サービス] 画面を表示し、[SMS Agent Host] サービスを停止します。</p></li><li><p>続けて、自動でサービスが起動しないように、[SMS Agent Host] サービスを右クリックし、プロパティを開き、スタートアップの種類を [手動] に変更します。</p></li><li><p>注意点として、タスク スケジューラ (<strong>taskschd.msc</strong>) の以下のタスクが実行された場合、自動で [SMS Agent Host] サービスが起動するため、手順の項番 2. ～ 5. の実行に時間がかかる場合は、手順実行中は本タスクを右クリックより [無効] にしてください。</p><p> ・[タスク スケジューラ ライブラリ] - [Microsoft] - [Configuration Manager]<br> タスク名：[Configuration Manager Health Evaluation]</p></li></ol><h3 id="3-自己署名証明書の削除"><a href="#3-自己署名証明書の削除" class="headerlink" title="3. 自己署名証明書の削除"></a>3. 自己署名証明書の削除</h3><ol><li>Windows キー + R キーを押下し、<strong>certlm.msc</strong> を実行し、ローカル コンピューターの証明書ストアを開きます。</li><li>[証明書 - ローカル コンピューター] - [SMS] - [証明書] を選択します。</li><li>発行先と発行者が “SMS” となっている 自己署名証明書が 2 枚ありますので、これらを右クリックより削除します。</li><li>「選択された証明書を永久的に削除しますか ? 」というメッセージが表示されますので、[はい] を選択します。</li><li>certlm 画面を閉じます。</li></ol><p><strong>※</strong> <strong>PKI</strong> <strong>証明書を利用している環境</strong> <strong>(HTTPS 構成)</strong> <strong>の場合</strong><br>お客様環境が HTTPS 通信の構成であり、クライアント証明書認証のために、 証明書をインストールされている場合には、同様に以下の手順で PKI 証明書を削除します。</p><ol><li>Windows キー + R キーを押下し、<strong>certlm.msc</strong> を実行し、ローカル コンピューターの証明書ストアを開きます。</li><li>[証明書 - ローカル コンピューター] - [個人] - [証明書] を選択します。※カスタム ストアを利用している場合は、該当箇所を選択してください。</li><li>該当の証明書を選択し、右クリックより削除します。</li><li>certlm 画面を閉じます。</li></ol><h3 id="4-MECM-独自の信頼キーと管理ポイントの証明書を削除する"><a href="#4-MECM-独自の信頼キーと管理ポイントの証明書を削除する" class="headerlink" title="4. MECM 独自の信頼キーと管理ポイントの証明書を削除する"></a>4. MECM 独自の信頼キーと管理ポイントの証明書を削除する</h3><p>MECM クライアントのインストール完了後に、もしネットワークに接続して、MECM サーバー(管理ポイント サーバー) との通信が可能となった場合、参照コンピューターが、MECM で使用する信頼キーと管理ポイントの証明書を WMI の中に保持した状態となる可能性があります。</p><p>この場合、参照コンピューターに保存されている信頼キーや管理ポイントの証明書を削除する必要があります。<br>wbemtest より、WMI 名前空間 “root\ccm\locationservices” に接続できない場合は、MECM サーバーと一度も接続がされていないため、問題ありません。<br>接続できる場合は、情報を削除するため、以下の手順を実施してください。</p><p>・管理者権限で PowerShell を起動し、以下のコマンドを実行し、信頼されたルート キー (TrustedRootKey) の情報と管理ポイントの証明書を削除します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\locationservices <span class="literal">-class</span> trustedrootkey | <span class="built_in">rwmi</span></span><br></pre></td></tr></table></figure><p>スクリプト実行完了後、以下の手順で、正常に信頼キーや証明書が削除されたことを確認します。</p><ol><li>コマンド プロンプトを “管理者として実行” にて起動して <strong>wbemtest</strong> を実行し、”root\ccm\locationservices” 名前空間に接続します。</li><li>「スーパークラス名の入力」はブランクのまま、「クラスの列挙」を “再帰” を有効にして実行します。</li><li>一覧から “TrustedRootKey” を選択し、ダブルクリックして開きます。</li><li>開いた画面で「インスタンス」をクリックします。</li><li>インスタンスが存在しないことを確認します。</li></ol><h3 id="5-SMS-Agent-Host-サービスのスタート-アップの種類の変更"><a href="#5-SMS-Agent-Host-サービスのスタート-アップの種類の変更" class="headerlink" title="5. [SMS Agent Host] サービスのスタート アップの種類の変更"></a>5. [SMS Agent Host] サービスのスタート アップの種類の変更</h3><p>Windows キー + R キーを押下し、<strong>Sevices.msc</strong> を実行し、[サービス] 画面を表示し、[SMS Agent Host] サービスを右クリックし、スタートアップの種類を [自動  (遅延開始) ] に変更します。<br>ここでは、サービスは停止したままで、[SMS Agent Host] サービスを開始しないように注意してください。<br>また、手順実施中に [Configuration Manager Health Evaluation] タスクを無効にした場合は、有効に戻してください。</p><h3 id="6-マスターイメージの採取"><a href="#6-マスターイメージの採取" class="headerlink" title="6. マスターイメージの採取"></a>6. マスターイメージの採取</h3><p>sysprep /generalize が実行された参照コンピューターをキャプチャして、マスター イメージを採取します。<br>なお、MECM のキャプチャ メディア機能を使用すれば、 sysprep /generalize  は内部的に自動実行されます。<br>また、上記情報の削除も内部的に実行されますのでキャプチャしたイメージを MECM から展開する際には、こちらを実施することもご検討ください。</p><p>参考)<br>キャプチャ メディアの作成<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/osd/deploy-use/create-capture-media">https://docs.microsoft.com/ja-jp/mem/configmgr/osd/deploy-use/create-capture-media</a></p><h1 id="B-既に-MECM-クライアントがインストールされている状態から、マスター-イメージの-“再”-取得を行う手順"><a href="#B-既に-MECM-クライアントがインストールされている状態から、マスター-イメージの-“再”-取得を行う手順" class="headerlink" title="B. 既に MECM クライアントがインストールされている状態から、マスター イメージの “再” 取得を行う手順"></a>B. 既に MECM クライアントがインストールされている状態から、マスター イメージの “再” 取得を行う手順</h1><p>&lt;目次&gt;</p><ol><li>[SMS Agent Host] サービスの停止とスタート アップの種類の変更</li><li>サイト コードのクリアと信頼キーの削除</li><li>自己署名証明書の削除</li><li>SMSCFG.ini の削除</li><li>[SMS Agent Host] サービスのスタート アップの種類の変更</li><li>マスターイメージの採取</li></ol><p>各手順の詳細は以下の通りです。</p><h3 id="1-SMS-Agent-Host-サービスの停止とスタート-アップの種類の変更"><a href="#1-SMS-Agent-Host-サービスの停止とスタート-アップの種類の変更" class="headerlink" title="1. [SMS Agent Host] サービスの停止とスタート アップの種類の変更"></a>1. [SMS Agent Host] サービスの停止とスタート アップの種類の変更</h3><ol><li><p>Windows キー + R キーを押下し、[ファイル名を指定して実行] にて <strong>Sevices.msc</strong> を実行し、[サービス] 画面を表示し、[SMS Agent Host] サービスを停止します。</p></li><li><p>続けて、自動でサービスが起動しないように、[SMS Agent Host] サービスを右クリックし、プロパティを開き、スタートアップの種類を [手動] に変更します。</p></li><li><p>注意点として、タスク スケジューラ (<strong>taskschd.msc</strong>) の以下のタスクが実行された場合、自動で [SMS Agent Host] サービスが起動するため、手順の項番 2. ～ 5. の実行に時間がかかる場合は、手順実行中は本タスクを右クリックより [無効] にしてください。</p><p> ・[タスク スケジューラ ライブラリ] - [Microsoft] - [Configuration Manager]<br> タスク名：[Configuration Manager Health Evaluation]</p></li></ol><h3 id="2-信頼されたルート-キーの削除とサイト-コードのクリア"><a href="#2-信頼されたルート-キーの削除とサイト-コードのクリア" class="headerlink" title="2. 信頼されたルート キーの削除とサイト コードのクリア"></a>2. 信頼されたルート キーの削除とサイト コードのクリア</h3><p>・管理者権限で PowerShell を起動し、以下のコマンドを実行し、信頼されたルート キー (TrustedRootKey) とサイト コードをクリアし、サイト コードの自動割り当てを有効にします。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\locationservices <span class="literal">-class</span> trustedrootkey | <span class="built_in">rwmi</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$oSMSClient</span>=<span class="built_in">New-Object</span> <span class="literal">-comobject</span> Microsoft.SMS.Client</span><br><span class="line"><span class="variable">$oSMSClient</span>.RemoveAssignedSites()</span><br><span class="line"><span class="variable">$oSMSClient</span>.EnableAutoAssignment(<span class="variable">$True</span>)</span><br></pre></td></tr></table></figure><p>スクリプト実行完了後、以下の手順で、正常に信頼キーや証明書が削除されたことを確認します。</p><ol><li>コマンド プロンプトを “管理者として実行” にて起動して <strong>wbemtest</strong> を実行し、”root\ccm\locationservices” 名前空間に接続します。</li><li>「スーパークラス名の入力」はブランクのまま、「クラスの列挙」を “再帰” を有効にして実行します。</li><li>一覧から “TrustedRootKey” を選択し、ダブルクリックして開きます。</li><li>開いた画面で「インスタンス」をクリックします。</li><li>インスタンスが存在しないことを確認します。</li></ol><h3 id="3-自己署名証明書の削除-1"><a href="#3-自己署名証明書の削除-1" class="headerlink" title="3. 自己署名証明書の削除"></a>3. 自己署名証明書の削除</h3><ol><li>Windows キー + R キーを押下し、<strong>certlm.msc</strong> を実行し、ローカル コンピューターの証明書ストアを開きます。</li><li>[証明書 - ローカル コンピューター] - [SMS] - [証明書] を選択します。</li><li>発行先と発行者が “SMS” となっている 自己署名証明書が 2 枚ありますので、これらを右クリックより削除します。</li><li>「選択された証明書を永久的に削除しますか ? 」というメッセージが表示されますので、[はい] を選択します。</li><li>certlm 画面を閉じます。</li></ol><p><strong>※</strong> <strong>PKI</strong> <strong>証明書を利用している環境</strong> <strong>(HTTPS 構成)</strong> <strong>の場合</strong><br>お客様環境が HTTPS 通信の構成であり、クライアント証明書認証のために、 証明書をインストールされている場合には、同様に以下の手順で PKI 証明書を削除します。</p><ol><li>Windows キー + R キーを押下し、<strong>certlm.msc</strong> を実行し、ローカル コンピューターの証明書ストアを開きます。</li><li>[証明書 - ローカル コンピューター] - [個人] - [証明書] を選択します。※カスタム ストアを利用している場合は、該当箇所を選択してください。</li><li>該当の証明書を選択し、右クリックより削除します。</li><li>certlm 画面を閉じます。</li></ol><h3 id="4-SMSCFG-ini-の削除"><a href="#4-SMSCFG-ini-の削除" class="headerlink" title="4. SMSCFG.ini の削除"></a>4. SMSCFG.ini の削除</h3><p>Configuration Manager 一意の識別子の情報が格納されている “SMSCFG.ini” を削除します。<br>ファイルは、 以下の場所に存在します。</p><p><code>%windir%\SMSCFG.ini</code></p><h3 id="5-SMS-Agent-Host-サービスのスタート-アップの種類の変更-1"><a href="#5-SMS-Agent-Host-サービスのスタート-アップの種類の変更-1" class="headerlink" title="5. [SMS Agent Host] サービスのスタート アップの種類の変更"></a>5. [SMS Agent Host] サービスのスタート アップの種類の変更</h3><p>Windows キー + R キーを押下し、<strong>Sevices.msc</strong> を実行し、[サービス] 画面を表示し、[SMS Agent Host] サービスを右クリックし、スタートアップの種類を [自動  (遅延開始) ] に変更します。<br>ここでは、サービスは停止したままで、[SMS Agent Host] サービスを開始しないように注意してください。<br>また、手順実施中に [Configuration Manager Health Evaluation] タスクを無効にした場合は、有効に戻してください。</p><h3 id="6-マスターイメージの採取-1"><a href="#6-マスターイメージの採取-1" class="headerlink" title="6. マスターイメージの採取"></a>6. マスターイメージの採取</h3><p>sysprep /generalize が実行された参照コンピューターをキャプチャして、マスター イメージを採取します。</p><p>なお、MECM のキャプチャ メディア機能を使用すれば、 sysprep /generalize  は内部的に自動実行されます。<br>また、上記情報の削除も内部的に実行されますのでキャプチャしたイメージを MECM から展開する際には、こちらを実施することもご検討ください。</p><p>参考)<br>キャプチャ メディアの作成<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/osd/deploy-use/create-capture-media">https://docs.microsoft.com/ja-jp/mem/configmgr/osd/deploy-use/create-capture-media</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;今回は Microsoft Endpoint Configuration Manager (以下 MECM) クライアント エージェントがインストールされた PC で</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>IP サブネット境界設定の考え方</title>
    <link href="https://jpmem.github.io/blog/mecm/20220414_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220414_01/</id>
    <published>2022-04-13T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.809Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>本日は、IP サブネット境界設定について簡単に解説させていただきます。</p><p>なお、本記事の画面は Micorosoft Endpoint Manager Configuration Manager  (MECM) Current Branch (CB) 2111 のものです。他の Version では画面が異なる場合があります。</p><p>IP サブネット境界を設定する際、以下の画面をご覧になるかと存じます。</p><p><img src="/blog/mecm/20220414_01/20220414_01_01.png"></p><p>この画面の赤枠の文章を見て、「どういうことだろう･･･」と思われた方も多いかと存じます。 </p><p>これは、「MECM のサブネット境界判定においては、ネットワーク IP アドレスや サブネット マスク アドレスは使われず、それらから割り出された、サブネット ID のみが使われる」ということを示します。</p><p>上の文章だけでもどういうことか分からないかと思いますので、以下の例をご確認ください。</p><h2 id="サブネット境界判定の例-1"><a href="#サブネット境界判定の例-1" class="headerlink" title="サブネット境界判定の例 1"></a>サブネット境界判定の例 1</h2><p>以下のサブネット境界を作成したとします。</p><ul><li>ネットワーク IP アドレス  : 192.168.10.0</li><li>サブネット マスク アドレス: 255.255.255.0</li></ul><p>上記の場合、割り出されるサブネット ID は･･･以下の通り、 <strong>192.168.10.0</strong> となります。</p><p><img src="/blog/mecm/20220414_01/20220414_01_02.png"></p><p>このとき、クライアント端末 A の IP アドレスが以下の場合、この<strong>サブネット境界に割り当たります。</strong></p><ul><li>クライアント IP アドレス:    192.168.10.1</li><li>サブネット マスク アドレス: 255.255.255.0</li></ul><p>一方、クライアント端末 B の IP アドレスが以下の場合、この<strong>サブネット境界に割り当たりません。</strong></p><ul><li>クライアント IP アドレス:    192.168.10.10</li><li>サブネット マスク アドレス: 255.255.255.248</li></ul><p>上記、違和感を感じますよね。/24 の サブネットを境界で指定したのだから、192.168.10.0 - 192.168.10.255 のIP アドレスは指定したサブネット境界として判定される筈だ、と考えるはずです。</p><p>ここで、注意書きの「ネットワークとサブネット マスクの値からサブネット ID が割り出されます。」を思い出してください。</p><p>クライアント 端末 A の IP アドレスとサブネット マスク の値から、サブネット境界と同様の方法でサブネット ID を割り出してみましょう。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">クライアント端末 A のサブネット ID: 192.168.10.0</span><br></pre></td></tr></table></figure><p><strong>192.168.10.0</strong> となります。<strong>この ID はサブネット境界のサブネット ID と等しい</strong>ですね。</p><p>一方、クライアント 端末 B の IP アドレスとサブネット マスク の値から、サブネット境界と同様の方法でサブネット ID を割り出してみると、</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">クライアント端末 B のサブネット ID: 192.168.10.8</span><br></pre></td></tr></table></figure><p><strong>192.168.10.8</strong> となります。<strong>この ID はサブネット境界のサブネット ID と異なります</strong>ね。</p><p>もう一つ、例を挙げてみましょう。以下の例の方がよく見かけられるものではあります。</p><h2 id="サブネット境界判定の例-2"><a href="#サブネット境界判定の例-2" class="headerlink" title="サブネット境界判定の例 2"></a>サブネット境界判定の例 2</h2><p>以下のサブネット境界を作成したとします。</p><ul><li>ネットワーク IP アドレス  : 10.0.0.0</li><li>サブネット マスク アドレス: 255.255.0.0</li></ul><p>/16 のサブネット空間です。多くの /24 のサブネット空間をひとまとめにした境界を作成されたい場合、このような境界を作りたいことは多いかと存じます。</p><p>では同様にサブネット ID を計算してみましょう。以下の通り、 <strong>10.0.0.0</strong> がサブネット ID となります。</p><p><img src="/blog/mecm/20220414_01/20220414_01_03.png"></p><p>では、この境界に割当たるクライアント端末の IP アドレスを見ていきましょう。</p><p>クライアント端末 C の IP アドレスが以下の場合、この<strong>サブネット境界に割り当たりません。</strong></p><ul><li>クライアント IP アドレス:    10.0.1.1</li><li>サブネット マスク アドレス: 255.255.255.0</li></ul><p>同じく、クライアント端末 D の IP アドレスが以下の場合、この<strong>サブネット境界に割り当たりません。</strong></p><ul><li>クライアント IP アドレス:    10.0.2.1</li><li>サブネット マスク アドレス: 255.255.255.0</li></ul><p>なぜなら、サブネット ID を計算したとき、以下のようになるからです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">クライアント端末 C のサブネット ID: 10.0.1.0</span><br><span class="line">クライアント端末 D のサブネット ID: 10.0.2.0</span><br></pre></td></tr></table></figure><p>そう、両方のサブネット ID がサブネット境界 のサブネット ID 10.0.0.0 と<strong>一致しません。</strong> そのため、/16 のサブネット境界を作った時、それに含まれると考えられる /24 のサブネットの IP アドレスを持つクライアントは、このサブネット境界に含まれません。</p><p>なら、どのようなクライアントならサブネット境界に割り当たるかと言うと、以下のような IP アドレスを持つクライアント E の端末となります。</p><ul><li>クライアント IP アドレス:   10.0.1.10</li><li>サブネット マスク アドレス: 255.255.0.0</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">クライアント端末 E のサブネット ID: 10.0.0.0</span><br></pre></td></tr></table></figure><h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>ここまで見てきたらお分かりかと存じます。クライアントが IP サブネット の境界に含まれると判定されるには、境界サブネット ID と、クライアントが所属するサブネットのネットワーク アドレスが一致する必要がある、つまりサイズも全く同一の、同じサブネットに所属する必要がある、ということです。そのため、複数の小さなサブネットを含む大きなサブネット境界を設定することは出来ません。</p><p>上記のようなことを実施されたい場合は、「IP アドレスの範囲」の境界を使いましょう。例えば、以下のような開始 IP アドレスと終了 IP アドレスを持つ境界を作れば 10.0.1.0/24 と 10.0.2.0/24 のサブネットの 端末を同一の境界として判定させることができます。</p><p><img src="/blog/mecm/20220414_01/20220414_01_04.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;本日は、IP サブネット境界設定について簡単に解説させていただきます。&lt;/p&gt;
&lt;p&gt;なお、本記事の画面は Micorosoft Endpoint Manager C</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>クラウド PC へのリダイレクトを禁止する方法について</title>
    <link href="https://jpmem.github.io/blog/w365/2022-04-12_01/"/>
    <id>https://jpmem.github.io/blog/w365/2022-04-12_01/</id>
    <published>2022-04-11T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.849Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。<br>本日は、接続元の PC からクラウド PC へのクリップボードやファイルのコピーなどのリダイレクトを禁止する方法についてご紹介します。<br>今回は Intune の構成プロファイルを使用した方法をご案内いたしますが、この方法を使用すると iOS や Android OS など、Windows 以外のデバイスからのリダイレクトも禁止することが可能です。</p><h2 id="免責事項"><a href="#免責事項" class="headerlink" title="免責事項"></a>免責事項</h2><p>下記内容は 2022/4/12 時点での内容についての記載となっております。<br>今後内容が更新されることもございますので、その点ご承知置きくださいますようお願い致します。</p><h2 id="構成プロファイルの作成方法"><a href="#構成プロファイルの作成方法" class="headerlink" title="構成プロファイルの作成方法"></a>構成プロファイルの作成方法</h2><ol><li>グローバル管理者などの権限を持つアカウントで Microsoft Endpoint Manager admin center (<a href="https://aka.ms/memac">https://aka.ms/memac</a>) にログインします。</li><li>[デバイス] - [構成プロファイル] と辿り、[プロファイルの作成] を選択します。</li><li>以下のように選択し、[作成] を選択します。<br>プラットフォーム：Windows 10 以降<br>プロファイルの種類：設定カタログ（プレビュー）<br><img src="/blog/w365/2022-04-12_01/2022-04-12-19-51-50.png">  </li><li>[名前] を入力し、[次へ] を選択します。<br><img src="/blog/w365/2022-04-12_01/2022-04-12-19-52-06.png">  </li><li>[設定の追加] を選択し、”redirect” と入力して [検索] を選択します。</li><li>表示された検索結果から、[管理用テンプレート\Windows コンポーネント\リモート デスクトップ サービス\リモート デスクトップ セッション ホスト\デバイスとリソースのリダイレクト] を選択し、必要な項目にチェックを入れて [次へ] を選択します。<br><img src="/blog/w365/2022-04-12_01/2022-04-12-19-52-33.png">  </li></ol><p>■補足事項<br>プリンターのリダイレクトを禁止したい場合は [管理用テンプレート\Windows コンポーネント\リモート デスクトップ サービス\リモート デスクトップ セッション ホスト\プリンターのリダイレクト] から [Do not allow client printer redirection] を選択します。<br><img src="/blog/w365/2022-04-12_01/2022-04-12-19-54-07.png">  </p><ol start="7"><li>割り当てるグループを選択し、[次へ] を選択します。</li><li>必要に応じて スコープ タグ を設定し、 [次へ] を選択します。</li><li>[作成] を選択し、構成プロファイルの作成を完了させます。</li><li>接続元 PC から文字やファイルなどをコピーし、クラウド PC で貼り付けができないことを確認します。</li></ol><p>参考公開情報<br>Title : クラウド PC の RDP デバイス リダイレクトを管理します<br>URL : <a href="https://docs.microsoft.com/ja-jp/windows-365/enterprise/manage-rdp-device-redirections">https://docs.microsoft.com/ja-jp/windows-365/enterprise/manage-rdp-device-redirections</a></p><p>以上、クラウド PC へのクリップボードやファイルのコピーなどのリダイレクトを禁止する方法について参考になりましたら幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。&lt;br&gt;本日は、接続元の PC からクラウド PC へのクリップボードやファイルのコピーなどのリダイレクトを禁止する方法についてご紹介します。&lt;br&gt;今回は Intune の構</summary>
      
    
    
    
    
    <category term="Windows 365" scheme="https://jpmem.github.io/blog/tags/Windows-365/"/>
    
  </entry>
  
  <entry>
    <title>クライアント設定が適用されない！確認すべき 3 つのポイント</title>
    <link href="https://jpmem.github.io/blog/mecm/20220408_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220408_01/</id>
    <published>2022-04-07T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.805Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。  </p><p>今回はクライアント設定がクライアント上で適用されない時に確認すべき 3 つのポイントについて解説致します。  </p><h2 id="1-管理コンソールの設定を確認しよう"><a href="#1-管理コンソールの設定を確認しよう" class="headerlink" title="1.管理コンソールの設定を確認しよう"></a>1.管理コンソールの設定を確認しよう</h2><p>まずはデバイスに意図したクライアント設定が展開されているのかを確認しましょう。クライアント設定には「優先順位」が設けられております。優先順位が高い順（1 が一番強い）に反映されていきますので、カスタム　クライアント設定を複数作成、展開している場合には、優先順位に注意が必要となります。  </p><p>※ 優先順位はクライアント設定間で設定箇所が重複した場合にどちらを優先するのかを決定するものとなります。重複していない設定については優先順位に関係なく、クライアントに反映されます。  </p><p>複数のクライアント設定を展開していて、最終的に何が反映されるのかわからなくても大丈夫です。  </p><p>MECM 管理コンソール &gt; [資産とコンプライアンス] &gt; [概要] &gt; [デバイス] にて確認したいデバイスを右クリック &gt; [クライアント設定] &gt; [クライアントの設定の結果] をクリックすると、最終的にどの設定が反映されているのかを確認することができますので、ここで想定していた設定となっていることを確認ください。<br><img src="/blog/mecm/20220408_01/20220408_01_01.png">  </p><p>このように結果を確認することができます。  </p><p><img src="/blog/mecm/20220408_01/20220408_01_02.png"></p><h2 id="2-カスタム-クライアント設定を上書き展開してみよう"><a href="#2-カスタム-クライアント設定を上書き展開してみよう" class="headerlink" title="2.カスタム クライアント設定を上書き展開してみよう"></a>2.カスタム クライアント設定を上書き展開してみよう</h2><p>1 で想定している設定値となっているにも関わらず、クライアント端末側に反映されていない場合には、新たにカスタム クライアント設定を作成し、展開してみましょう。  </p><p>反映されない設定と全く同じ内容でカスタム クライアント設定を作成してください。<br>[管理] &gt; [概要] &gt; [クライアント設定] &gt; [カスタム クライアント デバイスの作成]<br><img src="/blog/mecm/20220408_01/20220408_01_03.png">  </p><p>この時「優先順位」をなるべく高くしておくことがポイントです。<br>（少なくとも反映されないカスタム クライアント設定よりも高くしてください。）<br>新規に作成したカスタム クライアント設定を右クリック &gt; [優先順位を上げる] をクリックします。<br><img src="/blog/mecm/20220408_01/20220408_01_04.png">  </p><p>優先順位を高くしたら、該当のコレクションに展開してみましょう。  </p><p>展開後はクライアント側の次回のコンピューター ポリシー取得のタイミングで反映されるので少し時間をおきましょう。  </p><p>もしすぐに反映を促したい場合には、[資産とコンプライアンス] &gt; [概要] &gt; [デバイス コレクション] にてコレクションを右クリック &gt; [クライアント通知] &gt; [コンピューター ポリシーのダウンロード] をクリックすることでクライアント通知により、ポリシー取得を促すことができますのでお試しください。  </p><p><img src="/blog/mecm/20220408_01/20220408_01_05.png">  </p><h2 id="3-クライアント側で管理ポイントとの疎通状況を確認しよう"><a href="#3-クライアント側で管理ポイントとの疎通状況を確認しよう" class="headerlink" title="3.クライアント側で管理ポイントとの疎通状況を確認しよう"></a>3.クライアント側で管理ポイントとの疎通状況を確認しよう</h2><p>それでも反映されない場合には、クライアントと管理ポイントとの疎通の状態を確認しましょう。  </p><p>1.C:\Windows\CCM\Logs フォルダー配下の CcmMessaging.log を開き、直近の日付で下記のような出力があるかを確認します。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OutgoingMessage(Queue=&#x27;XXXXXXXXXXXXX&#x27;, ID=&#123;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXX&#125;): Delivered successfully to host &#x27;&lt;管理ポイント FQDN&gt;&#x27;.</span><br></pre></td></tr></table></figure><p>2.C:\Windows\CCM\Logs フォルダー配下の PolicyAgent.log を開き、「2.カスタム クライアント設定を再展開してみよう」を展開後に下記のような出力があるかを確認します。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Raising event:instance of CCM_PolicyAgent_PolicyDownloadSucceeded</span><br><span class="line">Raising event:instance of CCM_PolicyAgent_PolicyEvaluationComplete</span><br></pre></td></tr></table></figure><p>もし、上記のどちらかが確認できなかった場合には、管理ポイントからポリシーのダウンロードが完了していないことになります。管理ポイントとの通信状況を確認しましょう。  </p><p>クライアント端末にて、PowerShell を開き、下記コマンドを実行します。  </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-WebRequest</span> <span class="literal">-Uri</span> <span class="string">&quot;http://&lt;管理ポイントの FQDN&gt;/sms_mp/.sms_aut?mplist&quot;</span> <span class="literal">-UseBasicParsing</span></span><br></pre></td></tr></table></figure><p>正常にアクセスできる場合、StatusCode : 200 となります。<br>それ以外の場合には、クライアントと管理ポイントとの間で疎通できていない状態となりますので、ご利用のネットワーク環境上で通信を妨げる何かしらの要因がありますのでご確認くださいませ。  </p><h2 id="4-ログ出力が確認できないが、疎通は成功する場合"><a href="#4-ログ出力が確認できないが、疎通は成功する場合" class="headerlink" title="4.ログ出力が確認できないが、疎通は成功する場合"></a>4.ログ出力が確認できないが、疎通は成功する場合</h2><p>この場合には、詳細な調査が必要となることが想定されますので、弊社サポートへのお問い合わせをご検討下さいませ。  </p><p>なお、お問い合わせいただける際には、下記の情報が必要となりますので予め採取いただけると幸いでございます。</p><h3 id="クライアント設定が格納されている-WMI-の取得"><a href="#クライアント設定が格納されている-WMI-の取得" class="headerlink" title="クライアント設定が格納されている WMI の取得"></a>クライアント設定が格納されている WMI の取得</h3><p>PowerShell を管理者として開き、下記コマンドを実行ください。</p><p>「&lt;取得する WMI クラス名&gt;」箇所は <a href="#WMI-%E3%82%AF%E3%83%A9%E3%82%B9%E5%AF%BE%E5%BF%9C%E8%A1%A8">WMI クラス対応表</a> をご確認の上、問題となるクライアント設定と紐づくクラス名に置き換えて実行くださいませ。  </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\actualconfig <span class="literal">-class</span> &lt;取得する WMI クラス名&gt; &gt; C:\result\actualconfig.txt</span><br><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\requestedconfig <span class="literal">-class</span> &lt;取得する WMI クラス名&gt; &gt; C:\result\requestedconfig.txt</span><br></pre></td></tr></table></figure><p>例：「バックグラウンド インテリジェント転送」のクライアント設定が問題の場合<br>この場合には対象の WMI クラスが 2 つ存在するため、出力ファイル名を変えて実行します。  </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\actualconfig <span class="literal">-class</span> CCM_Service_BITS2Configuration &gt; C:\result\actualconfig_1.txt</span><br><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\requestedconfig <span class="literal">-class</span> CCM_Service_BITS2Configuration &gt; C:\result\requestedconfig_1.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\actualconfig <span class="literal">-class</span> CCM_Service_BITSConfiguration &gt; C:\result\actualconfig_2.txt</span><br><span class="line"><span class="built_in">gwmi</span> <span class="literal">-namespace</span> root\ccm\policy\machine\requestedconfig <span class="literal">-class</span> CCM_Service_BITSConfiguration &gt; C:\result\requestedconfig_2.txt</span><br></pre></td></tr></table></figure><h3 id="WMI-クラス対応表"><a href="#WMI-クラス対応表" class="headerlink" title="WMI クラス対応表"></a>WMI クラス対応表</h3><hr><table><thead><tr><th>名前</th><th>クラス</th></tr></thead><tbody><tr><td>バックグラウンド インテリジェント転送</td><td>CCM_Service_BITS2Configuration</td></tr><tr><td></td><td>CCM_Service_BITSConfiguration</td></tr><tr><td>クライアント キャッシュの設定</td><td>CCM_SuperPeerClientConfig</td></tr><tr><td>クライアント ポリシー</td><td>CCM_PolicyAgent_Configuration</td></tr><tr><td>クラウド サービス</td><td>CCM_CloudClientConfig</td></tr><tr><td>コンプライアンス設定</td><td>CCM_ConfigurationManagementClientConfig</td></tr><tr><td>コンピューター エージェント</td><td>CCM_ClientAgentConfig</td></tr><tr><td>コンピューターの再起動</td><td>CCM_RebootSettings</td></tr><tr><td>配信の最適化</td><td>CCM_WindowsDOClientConfig</td></tr><tr><td>Endpoint Protection</td><td>CCM_EndpointProtectionClientConfig</td></tr><tr><td>ハードウェア インベントリ</td><td>InventoryDataItem</td></tr><tr><td></td><td>CCM_HardwareInventoryClientConfig</td></tr><tr><td></td><td>CCM_Scheduler_ScheduledMessage</td></tr><tr><td>従量制インターネット接続</td><td>CCM_NetworkSettings</td></tr><tr><td>電源管理</td><td>CCM_Scheduler_ScheduledMessage</td></tr><tr><td>リモート ツール</td><td>CCM_RemoteToolsConfig</td></tr><tr><td>ソフトウェア センター</td><td>CCM_SoftwareCenterClientConfig</td></tr><tr><td>ソフトウェアの展開</td><td>CCM_Scheduler_ScheduledMessage</td></tr><tr><td>ソフトウェア インベントリ</td><td>CCM_SoftwareInventoryClientConfig</td></tr><tr><td>ソフトウェア使用状況の測定</td><td>CCM_SoftwareMeteringClientConfig</td></tr><tr><td>ソフトウェア更新プログラム</td><td>CCM_SoftwareUpdatesClientConfig</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。  &lt;/p&gt;
&lt;p&gt;今回はクライアント設定がクライアント上で適用されない時に確認すべき 3 つのポイントについて解説致します。  &lt;/p&gt;
&lt;h2 id=&quot;1-管理コンソールの設定を確認</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>WSUS サーバーを新しいハードへ移設したい</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-04-08_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-04-08_01/</id>
    <published>2022-04-07T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.885Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。 WSUS サポート チームです。</p><p>今回は、旧サーバーから新サーバーへ WSUS を移行する方法をご紹介します。<br>ハードウェアの老朽化や運用上の様々な理由から WSUS サーバー を移行する必要があるといったようなときに際にお役立ていただける情報です。  </p><ul><li><strong>A. 一時的にレプリカ構成にする</strong></li><li><strong>B. 更新プログラム情報をファイル ベースで移行する</strong></li><li><strong>C. データベースバックアップをリストアし移行する</strong>  </li></ul><h3 id="A-一時的にレプリカ構成にする"><a href="#A-一時的にレプリカ構成にする" class="headerlink" title="A. 一時的にレプリカ構成にする"></a><strong>A. 一時的にレプリカ構成にする</strong></h3><p>旧 WSUS サーバーを親とし、移設先の新しい WSUS サーバーを子として新規構築します<br>この時、新しい WSUS サーバーをレプリカとして設定し、旧 WSUS サーバーと同期を行う方法です。<br>＜手順＞    </p><ol><li><p>WSUS コンソールを開き、 [オプション] - [更新元およびプロキシ サーバー] にて以下の設定を行います。<br>・親となる旧 WSUS サーバーの指定<br>・[このサーバーはアップストリーム サーバーのレプリカです] へのチェック<br><img src="/blog/wsus/2022-04-08_01/2022-04-08_01_1.png">  </p></li><li><p>同期が完了した後で親子構成を解除すると、新しい WSUS サーバーへ、旧 WSUS サーバーの情報が複製された状態で、スタンドアロンの WSUS が出来上がります。<br>忘れずに新しい WSUS サーバー側でオプションを再設定すれば、移行は完了です。  </p></li></ol><p>※ 注意 ※<br>レプリカ構成の場合、WSUS サーバーのバージョンは、下位が上位と同じバージョン又は上位よりも下位が古いバージョンである必要があります。<br>下位が上位よりもバージョンが新しい場合はサポートされません。（ ※ WSUS バージョンは OS バージョンと紐づいています ）  </p><h3 id="B-更新プログラム情報をファイル-ベースで移行する"><a href="#B-更新プログラム情報をファイル-ベースで移行する" class="headerlink" title="B. 更新プログラム情報をファイル ベースで移行する"></a><strong>B. 更新プログラム情報をファイル ベースで移行する</strong></h3><p>オフライン環境に WSUS サーバーを構築するのと同じ要領で、旧 WSUS サーバーで保持している更新プログラムの情報を移行させる方法です。  </p><p>下記の 2 つを旧 WSUS サーバーより取得し、新しい WSUS サーバーへインポートし取り入れます。<br>– カタログのメタデータ ( 更新プログラムのリスト )<br>– WsusContent フォルダ ( 更新ファイル )  </p><p>＜手順＞  </p><ol><li>旧 WSUS サーバー上で下記のコマンドを実行し、データベース内の更新プログラム情報をファイルへエクスポートします。  </li></ol><p>C:\Program Files\Update Services\Tools に作成する場合  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">　cd &quot;C:\Program Files\Update Services\Tools&quot;  </span><br><span class="line">　wsusutil.exe export export.xml.gz export.log  </span><br></pre></td></tr></table></figure><ol start="2"><li>旧 WSUS サーバーの WsusContent フォルダ内にあるダウンロード済みファイルを、すべて新 WSUS サーバーへコピーします。<br>もし新 WSUS サーバーでファイルのダウンロードをやり直す場合には、コピー不要です。  </li></ol><ol start="3"><li>新 WSUS サーバー上で下記のコマンドを実行し、旧 WSUS サーバーの更新プログラム情報をインポートします。  </li></ol><p>C:\Program Files\Update Services\Tools にコピーした場合    </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &quot;C:\Program Files\Update Services\Tools&quot;  </span><br><span class="line">wsusutil.exe import import.xml.gz import.log  </span><br></pre></td></tr></table></figure><ol start="4"><li>新 WSUS サーバー上で下記のコマンドを実行し、データベース内の更新プログラム情報と、WsusContent フォルダ内のファイル情報の整合性をチェックします。<br>ドキュメントに記載のない手順なのですが、もしファイル コピーに抜けがあると配布に支障が出るため、念のために実行してください。  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsusutil.exe reset  </span><br></pre></td></tr></table></figure>もし 3. でファイルのコピーを実施しなかった場合や、コピーに抜けがありファイルが不足している場合には、ダウンロードが行われます。  </li></ol><p>※ 注意 ※<br>この方法では、データベース内の更新プログラムのカタログ情報 及び その更新プログラムの実体となるコンテンツファイルのコピーを新 WSUS サーバーへ取り入れる方法ですので、旧 WSUS サーバーのインストール承認や拒否済みの情報、コンピュータグループ情報などは移行されません。  </p><p>参考情報<br> <a href="https://docs.microsoft.com/ja-jp/security-updates/windowsupdateservices/18111626">コマンド ラインからの WSUS の管理</a></p><h3 id="C-データベースバックアップをリストアし移行する"><a href="#C-データベースバックアップをリストアし移行する" class="headerlink" title="C. データベースバックアップをリストアし移行する"></a><strong>C. データベースバックアップをリストアし移行する</strong></h3><p>旧 WSUS サーバーのバックアップを取得し、新 WSUS サーバーにリストアする方法です。  </p><p>＜手順＞<br>下記の公開記事にてデータベースを取得してリストアする方法での手順をご紹介しておりますのでご参照ください。<br>参考情報<br><a href="https://jpmem.github.io/blog/wsus/2021-10-19_01/#WSUS-%E7%A7%BB%E8%A1%8C%E6%89%8B%E9%A0%86%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6-WID-gt-WID">WSUS 移行手順について (WID -&gt; WID)</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。 WSUS サポート チームです。&lt;/p&gt;
&lt;p&gt;今回は、旧サーバーから新サーバーへ WSUS を移行する方法をご紹介します。&lt;br&gt;ハードウェアの老朽化や運用上の様々な理由から WSUS サーバー を移行する必要があるといったようなときに際にお役立て</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>Windows 365 のクラウド PC を以前の状態に復元する方法について</title>
    <link href="https://jpmem.github.io/blog/w365/2022-04-06_01/"/>
    <id>https://jpmem.github.io/blog/w365/2022-04-06_01/</id>
    <published>2022-04-05T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.849Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。<br>本日は、Windows 365 のクラウド PC を以前の状態に復元する方法についてご案内します。</p><p>2022 年 3 月より、Windows 365 Enterprise / Business ともに特定の時点に復元することができるようになりました。本機能はまだパブリック プレビュー段階ですが、その使用方法をご紹介いたします。</p><h2 id="免責事項"><a href="#免責事項" class="headerlink" title="免責事項"></a>免責事項</h2><p>下記内容は 2022/4/6 時点での内容についての記載となっております。<br>今後内容が更新されることもございますので、その点ご承知置きくださいますようお願い致します。</p><h2 id="Windows-365-Enterprise-環境のクラウド-PC-を以前の状態に復元"><a href="#Windows-365-Enterprise-環境のクラウド-PC-を以前の状態に復元" class="headerlink" title="Windows 365 Enterprise 環境のクラウド PC を以前の状態に復元"></a>Windows 365 Enterprise 環境のクラウド PC を以前の状態に復元</h2><ol><li><p>グローバル管理者などの権限を持つアカウントで Microsoft Endpoint Manager admin center (<a href="https://aka.ms/memac">https://aka.ms/memac</a>) にログインします。</p></li><li><p>[デバイス] - [Windows 365] - [すべてのクラウド PC] と辿り、特定の地点に復元したいクラウド PC を選択します。</p></li><li><p>画面上部の [復元（プレビュー）] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-29-32.png"></p></li><li><p>復元したい地点の日時を選択し、画面下部の [選択] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-30-55.png"></p></li><li><p>以下の画面が表示されるので、[復元] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-31-14.png"></p></li><li><p>[Restore 保留中…] と表示されるので、復元されるまで待ちます。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-31-37.png"></p></li><li><p>[Restore 完了] と表示されたら（弊社環境では約 15 分ほどで完了しました）、クラウド PC にサインインし、選択した日時の状態に復元していることを確認します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-32-21.png"></p></li></ol><p>■ 補足事項<br>Windows 365 Enterprise ではユーザーによる復元を許可するか否かと復元ポイントの更新頻度を設定することが可能です。設定箇所は以下です。</p><ol><li>グローバル管理者などの権限を持つアカウントで Microsoft Endpoint Manager admin center (<a href="https://aka.ms/memac">https://aka.ms/memac</a>) にログインします。</li><li>[デバイス] - [Windows 365] - [ユーザー設定] と辿り、[追加] を選択します。</li><li>[名前] を入力し、ユーザーによる復元を許可する場合は [ユーザーによる復元サービスの開始を許可する] にチェックを入れます。</li><li>[復元ポイント サービスの頻度] からプルダウンメニューで復元ポイントの更新頻度を選択し、[次へ] を選択します。</li><li>割り当てるグループを選択し、[次へ] を選択します。</li><li>[作成] を選択し、ユーザー設定を完了させます。</li></ol><p>参考公開情報<br>Title : 単一のクラウド PC を以前の状態に復元する<br>URL : <a href="https://docs.microsoft.com/ja-jp/windows-365/enterprise/restore-single-cloud-pc">https://docs.microsoft.com/ja-jp/windows-365/enterprise/restore-single-cloud-pc</a></p><h2 id="Windows-365-Business-環境のクラウド-PC-を以前の状態に復元"><a href="#Windows-365-Business-環境のクラウド-PC-を以前の状態に復元" class="headerlink" title="Windows 365 Business 環境のクラウド PC を以前の状態に復元"></a>Windows 365 Business 環境のクラウド PC を以前の状態に復元</h2><p>Business は Microsoft Endpoint Manager admin center からの復元はできませんが、以下の手順で復元することが可能です。</p><ol><li><p>Windows 365 Business のライセンスを持ったユーザーで以下の URL にサインインします。<br><a href="https://windows365.microsoft.com/">https://windows365.microsoft.com/</a></p></li><li><p>歯車アイコンから、[復元（プレビュー）] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-32-45.png"></p></li><li><p>[はい、この クラウド PC を復元します。] にチェックを入れ、復元したい日時を選択して [復元] を選択します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-33-07.png"></p></li><li><p>数十分待ち、[クラウド PC が復元されました] と表示されたら復元成功です（弊社環境では約 15 分ほどで完了しました）。クラウド PC にサインインし、選択した日時の状態に復元していることを確認します。<br><img src="/blog/w365/2022-04-06_01/2022-04-06-13-33-26.png"></p></li></ol><p>■ 補足事項<br>2022/4/6 時点では、Windows 365 Business は復元ポイントの更新頻度が 12 時間で固定されています。</p><p>参考公開情報<br>Title : Windows 365 Business (プレビュー) の特定の時点への復元<br>URL : <a href="https://docs.microsoft.com/ja-jp/windows-365/business/restore-overview">https://docs.microsoft.com/ja-jp/windows-365/business/restore-overview</a></p><p>以上、クラウド PC を以前の状態に復元する方法について参考になりましたら幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。&lt;br&gt;本日は、Windows 365 のクラウド PC を以前の状態に復元する方法についてご案内します。&lt;/p&gt;
&lt;p&gt;2022 年 3 月より、Windows 365 En</summary>
      
    
    
    
    
    <category term="Windows 365" scheme="https://jpmem.github.io/blog/tags/Windows-365/"/>
    
  </entry>
  
  <entry>
    <title>クラウド管理ゲートウェイ (CMG) の設計ポイントについて (2)</title>
    <link href="https://jpmem.github.io/blog/mecm/20220401_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220401_01/</id>
    <published>2022-03-31T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.805Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Microsoft Endpoint Configuration Manager (MECM) にて提供されるクラウド管理ゲートウェイ (CMG) の設計ポイントについてご案内します。  </p><p>本記事は以下の二部構成としております。</p><ol><li>CMG の概要とユースケース、及びリバース プロキシとして CMG を利用する際の設計ポイントについてご案内いたします。</li><li>(本記事) 配布ポイントとしての CMG についてとインターネット アクセス要件、セキュリティ、サイジング設計、コスト見積についてご案内致します。  </li></ol><p>なお、下記は MECM CB 2111 および仮想マシン スケール セット (VMSS) の CMG のご利用を前提としておりますのでご留意くださいませ。</p><h2 id="CMG-のクラウド上の配布ポイント機能"><a href="#CMG-のクラウド上の配布ポイント機能" class="headerlink" title="CMG のクラウド上の配布ポイント機能"></a>CMG のクラウド上の配布ポイント機能</h2><p>CMG を Azure 上の配布ポイントとして提供する機能です。本機能はリバース プロキシ機能とは異なり、イントラネット端末、インターネット端末両方で利用可能です。イントラネット端末が CMG を配布ポイントとして利用する場合は境界グループへの CMG の紐付けが必要です。インターネット端末はイントラネット端末と異なり、境界グループの影響無しにダウンロード元を決定します。コンテンツ別の、ダウンロード元については以下の図を参考ください。</p><p><img src="/blog/mecm/20220401_01/20220401_01_01.png">  </p><p>上記図で示している、イントラネット端末に対して、Windows Update や Office CDN をダウンロード元のリストに追加する「展開設定」とは以下のオプションを指します。  </p><p>[CM コンソール] - [ソフトウェア ライブラリ] - [概要] - [ソフトウェア更新プログラム] - [すべてのソフトウェア更新プログラム] - [展開] - [プロパティ] - [ダウンロードの設定]タブ</p><p><img src="/blog/mecm/20220401_01/20220401_01_02.png">  </p><p>また、イントラネット端末に対して、イントラネットの配布ポイントよりも、Windows Update や Office CDN, CMG からのダウンロードを優先させるためには以下のオプションを有効化します。  </p><p>[CM コンソール] - [管理] - [概要] - [階層の構成] - [境界グループ] - 対象の境界グループを選択 - [プロパティ] - [オプション]タブ - [オンプレミスのソースよりクラウド ベースのソースを優先します]  </p><p><img src="/blog/mecm/20220401_01/20220401_01_03.png">  </p><h3 id="CMG-での-Microsoft-365-Apps-更新プログラムの配布について"><a href="#CMG-での-Microsoft-365-Apps-更新プログラムの配布について" class="headerlink" title="CMG での Microsoft 365 Apps 更新プログラムの配布について"></a>CMG での Microsoft 365 Apps 更新プログラムの配布について</h3><p>以下でもご案内している通り、 Microsoft 365 Apps の更新プログラムは CMG からの配布をサポートしておりません。 インターネット端末に対しては、 Office CDN からのダウンロード、イントラネット端末に対しては、イントラネットの配布ポイントもしくは Office CDN からダウンロードするようにご対応ください。</p><p>クラウド管理ゲートウェイでサポートされる構成<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/supported-configurations">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/supported-configurations</a>  </p><h3 id="CMG-利用による-VPN-帯域使用料削減の条件"><a href="#CMG-利用による-VPN-帯域使用料削減の条件" class="headerlink" title="CMG 利用による VPN 帯域使用料削減の条件"></a>CMG 利用による VPN 帯域使用料削減の条件</h3><p>多くのお客様において、VPN 帯域の利用料削減を目的に CMG 導入をご検討されることが多くございます。この際の条件としては、URL 指定による VPN スプリット トンネリング機能が必要になって参ります。お客様によっては、IP アドレス指定による VPN スプリット トンネリング機能しかご利用できない場合がございますが、Windows Update や Office CDN, および CMG は URL 指定によるサービスを前提としております。URL 指定の VPN スプリット トンネリング機能のご利用をお勧め致します。</p><h2 id="CMG-のインターネットアクセス要件"><a href="#CMG-のインターネットアクセス要件" class="headerlink" title="CMG のインターネットアクセス要件"></a>CMG のインターネットアクセス要件</h2><p>以下ドキュメントにまとまっております。</p><p>CMG のデータ フロー<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/data-flow">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/data-flow</a></p><p>主な通信経路は以下の図の通りです。<br><img src="/blog/mecm/20220401_01/20220401_01_04.png"></p><p>なお、CMDB 内の AzureEnvironments テーブルの中身はそれぞれご確認くださいますようお願い致します。ご参考までに、弊社環境における MECM CB 2111 の場合、他との重複を除きますと、AzurePublicCloud レコードの値は以下の通りです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">https://management.core.windows.net/</span><br><span class="line">https://login.microsoftonline.com/</span><br><span class="line">https://gallery.azure.com/</span><br><span class="line">https://vault.azure.net/</span><br><span class="line">core.windows.net</span><br><span class="line">database.windows.net</span><br><span class="line">trafficmanager.net</span><br><span class="line">vault.azure.net</span><br><span class="line">servicebus.azure.com</span><br><span class="line">cloudapp.net</span><br><span class="line">https://graph.microsoft.com/</span><br><span class="line">https://gateway.configmgr.manage.microsoft.com/</span><br><span class="line">https://cmmicrosvc.manage.microsoft.com/</span><br><span class="line">https://portal.manage.microsoft.com/</span><br><span class="line">https://enrollment.manage.microsoft.com/</span><br><span class="line">https://login.windows.net/</span><br><span class="line">cloudapp.azure.com</span><br></pre></td></tr></table></figure><h2 id="CMG-のセキュリティ"><a href="#CMG-のセキュリティ" class="headerlink" title="CMG のセキュリティ"></a>CMG のセキュリティ</h2><p>CMG は PaaS レベルで提供されるクラウド サービスです。そのため、責任共有モデルも PaaS のものに準じます。</p><p>クラウドにおける共同責任<br><a href="https://docs.microsoft.com/ja-jp/azure/security/fundamentals/shared-responsibility">https://docs.microsoft.com/ja-jp/azure/security/fundamentals/shared-responsibility</a></p><p>CMG で考慮すべき(設定可能な)セキュリティについては以下にまとまっておりますのでこちらをご参照ください。</p><p>クラウド管理ゲートウェイのセキュリティとプライバシー<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/security-and-privacy-for-cloud-management-gateway">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/security-and-privacy-for-cloud-management-gateway</a></p><h2 id="CMG-のサイジング設計について"><a href="#CMG-のサイジング設計について" class="headerlink" title="CMG のサイジング設計について"></a>CMG のサイジング設計について</h2><p>CMG のサイジングについては下記ガイドをご参照ください。</p><p>CMG のパフォーマンスとスケール<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/perf-scale">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/perf-scale</a></p><p>上記 URL の注意点としましては、表記される数値はあくまで同時クライアント接続数であることです。1 台のクライアントから CMG に対して複数の接続がある場合もあり、その場合クライアント台数とは完全には一致しませんので、余裕を持って設計されることをお勧め致します。</p><h2 id="CMG-のコスト見積について"><a href="#CMG-のコスト見積について" class="headerlink" title="CMG のコスト見積について"></a>CMG のコスト見積について</h2><p>CMG のコスト見積については下記を参照ください。多くの場合、仮想マシンより Azure からクライアントに対するアウトバウンド ネットワークの費用が、総コストのうち、多くの割合を占めます。</p><p>CMG のコスト<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/cost">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/cost</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Microsoft Endpoint Configuration Manager (MECM) にて提供されるクラウド管理ゲートウェイ (CMG) の設計ポイントについてご案内し</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
    <category term="CMG" scheme="https://jpmem.github.io/blog/tags/CMG/"/>
    
  </entry>
  
  <entry>
    <title>WSUS アンインストール手順について (Windows Server 2022 対応版)</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-03-29_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-03-29_01/</id>
    <published>2022-03-28T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.885Z</updated>
    
    <content type="html"><![CDATA[<p>皆さま、こんにちは。WSUS サポート チームです。<br>今回は Windows Server 2022 に対応した WSUS を完全にアンインストールする手順をご紹介します。Windows Server 2022 にて WSUS の構築や、検証を行っていらっしゃる皆さまは、是非ご覧ください。</p><hr><h2 id="Windows-Server-2022-環境の-WSUS-をアンインストールする手順"><a href="#Windows-Server-2022-環境の-WSUS-をアンインストールする手順" class="headerlink" title="Windows Server 2022 環境の WSUS をアンインストールする手順"></a>Windows Server 2022 環境の WSUS をアンインストールする手順</h2><h3 id="a-役割と機能のアンインストール"><a href="#a-役割と機能のアンインストール" class="headerlink" title="a. 役割と機能のアンインストール"></a>a. 役割と機能のアンインストール</h3><p>サーバー マネージャーを使用して、WSUS サーバー、IIS、Windows Internal Database の役割と機能をアンインストールします。<br>なお、WSUS サーバーのデータベースに、SQL Server をご利用の場合は、本手順を実施後、別途 WSUS データベース (SUSDB) を手動で削除してください。</p><ol><li>[スタート] にて、[サーバー マネージャー] を起動します。</li><li>画面右上の [管理] メニューを選択し、[役割と機能の削除]を選択します。</li><li>[開始する前に] ページにて、[次へ] ボタンを選択します。</li><li>[サーバーの選択] ページにて、[次へ] ボタンを選択します。</li><li>[サーバーの役割] ページにて、[Windows Server Update Services] チェック ボックスをオフにします。</li><li>[役割と機能の削除ウィザード] ダイアログ ボックスが表示されます。<br>[管理ツールを削除する (存在する場合)] チェック ボックスがオンであることを確認し、 [機能の削除] ボタンを選択します。</li><li>IIS を他のアプリケーションで利用していない場合は、[Web Server (IIS)] のチェックをオフにします。</li><li>[役割と機能の削除ウィザード] ダイアログ ボックスが表示されます。<br>[管理ツールを削除する (存在する場合)] チェック ボックスがオンであることを確認し、 [機能の削除] ボタンを選択します。</li><li>[次へ] を選択します。</li><li>[機能] ページにて、[Windows Internal Database] チェック ボックスをオフにします。<br>※ WSUS サーバーのデータベースに、SQL Server をご利用されている場合は、本手順をスキップしてください。</li><li>[次へ] を選択します。</li><li>[確認] ページにて、[削除] ボタンを選択します。<br>※ 即時再起動して問題ない場合は、[必要に応じて対象サーバーを自動的に再起動する] チェック ボックスをオンにします。</li><li>アンインストール後に、[閉じる] を選択し、OS の再起動を行います。</li></ol><h3 id="b-削除されたサービスの確認"><a href="#b-削除されたサービスの確認" class="headerlink" title="b. 削除されたサービスの確認"></a>b. 削除されたサービスの確認</h3><p>a. の作業完了後、以下のサービスが削除されている事を確認します。</p><ul><li>WSUS Services</li><li>WSUS Certificate Server</li><li>Windows Internal Database</li><li>Windows Internal Database VSS Writer (Windows Internal Database VSS ライター)</li></ul><p>IIS も削除した場合は、以下のサービスも削除されます。</p><ul><li>IIS Admin Service (IIS 管理サービス)</li><li>World Wide Web Publishing Service</li><li>Web Management Service</li></ul><h3 id="c-残存するデータベースファイルの削除"><a href="#c-残存するデータベースファイルの削除" class="headerlink" title="c. 残存するデータベースファイルの削除"></a>c. 残存するデータベースファイルの削除</h3><ul><li>Windows Internal Database をご利用の場合<br>以下フォルダー内のファイルを、全て手動で削除します。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%windir%\WID\DATA</span><br></pre></td></tr></table></figure><ul><li>SQL Server をご利用の場合<br>これまで WSUS サーバーで利用していたインスタンスはアンインストールしてください。<br><a href="https://docs.microsoft.com/ja-jp/sql/sql-server/install/uninstall-an-existing-instance-of-sql-server-setup?view=sql-server-ver15&tabs=Windows10">SQL Server の既存のインスタンスのアンインストール (セットアップ)</a><br>(アンインストール後、WSUS の再インストールを実施する場合には、 SQL サーバーへ新たなインスタンスを追加してください。)<br><a href="https://docs.microsoft.com/ja-jp/sql/database-engine/install-windows/add-features-to-an-instance-of-sql-server-setup?view=sql-server-ver15">SQL Server のインスタンスへの機能の追加 (セットアップ)</a>  </li></ul><p>※ “SUSDB.mdf”、”SUSDB_log.ldf” ファイルが WSUS に関連するファイルとなります。 </p><h3 id="d-WSUS-コンテンツ-フォルダーの削除"><a href="#d-WSUS-コンテンツ-フォルダーの削除" class="headerlink" title="d. WSUS コンテンツ フォルダーの削除"></a>d. WSUS コンテンツ フォルダーの削除</h3><p>インストール時に指定した WSUS コンテンツ フォルダーを手動で削除します。</p><p>※ (インストールパスを C:\WSUS とした場合) “C:\WSUS\WSUSContent” になります。</p><h3 id="e-Microsoft-Report-Viewer-の削除方法"><a href="#e-Microsoft-Report-Viewer-の削除方法" class="headerlink" title="e. Microsoft Report Viewer の削除方法"></a>e. Microsoft Report Viewer の削除方法</h3><p>レポート参照用に Microsoft Report Viewer 2012 Runtime 再頒布可能パッケージをインストールした場合は、以下の手順でアンインストールします。</p><ol><li>[スタート] の [設定] にて [アプリ] を選択し、[アプリと機能] を開きます。</li><li>[Microsoft Report Viewer 2012 ランタイム] を選択し、[アンインストール] を選択します。</li><li>[アンインストール] を選択します。</li></ol><hr><h3 id="補足情報"><a href="#補足情報" class="headerlink" title="補足情報"></a>補足情報</h3><p>手順「a. 役割と機能のアンインストール」にて IIS を削除しない場合は、WSUS のアプリケーション プールと仮想ディレクトリは IIS に残存します。<br>WSUS のアプリケーション プールと仮想ディレクトリを IIS から手動で削除するには、以下の手順をご実施ください。</p><ol><li>[インターネット インフォメーション サービス (IIS) マネージャー] を起動します。</li><li>[接続] ペインにて、[サイト] を選択します。</li><li>[WSUS の管理] を選択し、[操作] ペインの [削除] を選択します。</li><li>[削除の確認] ダイアログ ボックスにて、[はい] を選択します。</li><li>[接続] ペインにて、[アプリケーション プール] を選択します。</li><li>[WsusPool] を選択し、[操作] ペインの [削除] を選択します。</li><li>[削除の確認] ダイアログ ボックスにて、[はい] を選択します。  </li></ol><p>以上、Windows Server 2022 WSUS のアンインストール手順のご案内でした。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;皆さま、こんにちは。WSUS サポート チームです。&lt;br&gt;今回は Windows Server 2022 に対応した WSUS を完全にアンインストールする手順をご紹介します。Windows Server 2022 にて WSUS の構築や、検証を行っていらっしゃる皆さま</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>クラウド管理ゲートウェイ (CMG) の設計ポイントについて (1)</title>
    <link href="https://jpmem.github.io/blog/mecm/20220328_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220328_01/</id>
    <published>2022-03-27T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.805Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Microsoft Endpoint Configuration Manager (MECM) にて提供されるクラウド管理ゲートウェイ (CMG) の設計ポイントについてご案内します。  </p><p>本記事は以下の二部構成としております。  </p><ol><li> (本記事) CMG の概要とユースケース、及びリバース プロキシとして CMG を利用する際の設計ポイントについてご案内いたします。</li><li>配布ポイントとしての CMG についてとインターネット アクセス要件、セキュリティ、サイジング設計、コスト見積についてご案内致します。</li></ol><p>なお、下記は MECM CB 2111 および仮想マシン スケール セット (VMSS) の CMG のご利用を前提としておりますのでご留意くださいませ。</p><p>CMG とは以下の機能を提供する Azure 上で提供されるクラウド サービスです。</p><ul><li>リバース プロキシ機能<ul><li>インターネット上の端末からの通信をイントラネット上の MECM の管理ポイントやソフトウェア更新ポイントに中継する機能。イントラネット上の配布ポイントには中継しませんのでご注意ください。</li></ul></li><li>クラウド上の配布ポイント機能<ul><li>イントラネット、インターネットのどちらの端末に対してもアプリケーションやパッケージを提供するための配布ポイント機能を提供する機能。</li></ul></li></ul><p>下記 URL でもドキュメントをご提供しておりますのでご参照くださいませ。</p><p>クラウド管理ゲートウェイの概要<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/overview">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/manage/cmg/overview</a></p><h2 id="CMG-のユースケース"><a href="#CMG-のユースケース" class="headerlink" title="CMG のユースケース"></a>CMG のユースケース</h2><p>CMG を使われるユースケースとしては以下のようなものがございます。</p><ol><li>リモート ワーク向けに貸し出した企業端末をMECMを使ってインターネット経由で管理したい。これを VPN を使わずに実現したい。</li><li>リモート ワーク向けに貸し出した企業端末の更新プログラム適用を実施する際、WSUS と同様レベルで管理したい。その際に、VPN 経由でイントラネットの配布ポイントからコンテンツをダウンロードさせるのでは無く、Microsoft の Windows Update や Office CDN からダウンロードさせることにより、限られた社内インターネット帯域の逼迫を回避したい。</li><li>社内にある端末だが、事業拠点とデータセンター間の帯域より、インターネット回線の方が早い、もしくは空いているのでそちらを使いたい。</li></ol><h2 id="CMG-のリバース-プロキシ機能"><a href="#CMG-のリバース-プロキシ機能" class="headerlink" title="CMG のリバース プロキシ機能"></a>CMG のリバース プロキシ機能</h2><p>CMG をリバース プロキシとして利用する場合、以下の要素をご理解くださいますようお願い致します。</p><ol><li>インターネット端末のみが CMG をリバース プロキシとして利用する<ul><li>イントラネットとして判定されている端末は CMG をリバース プロキシとして利用できません。後述するインターネット端末の判定フローで、イントラネット端末として判定された端末は例え御社外のネットワークにいる端末でも CMG をリバース プロキシとして利用しません。</li></ul></li><li>CMG を利用するためクライアント認証が発生する<ul><li>CMG はインターネット上に公開されているサービスなので、不特定多数の端末から管理対象のデバイスの通信のみを受け付けるため、認証行為が発生します。この認証方式は全 3 種類存在し、どの認証方式を採用しているかよく理解しておかないと、CMG に接続出来ないなどのトラブル シューティングの際に苦労することになります。</li></ul></li><li>サイト サーバー間の通信暗号化が必要<ul><li>過去の MECM サーバーの通信と異なり、通信の暗号化のために SSL 証明書が必要となります。各 サイト サーバーにどの証明書が必要かを理解しておかないと環境構築の際のトラブルの原因となります。</li></ul></li></ol><h3 id="MECM-におけるインターネット端末の判定"><a href="#MECM-におけるインターネット端末の判定" class="headerlink" title="MECM におけるインターネット端末の判定"></a>MECM におけるインターネット端末の判定</h3><p>上記でもご案内の通り、インターネット端末として判定されない場合、クライアントはイントラネット用の管理ポイントに対して通信を試みる形となります。<br>MECM において、端末がインターネット経由で接続しているのか、イントラネット経由で接続しているのかの判定条件は以下の図のとおりです。オンプレミス ADに参加している、リモート ワーク向け端末が VPN を介して、オンプレミス ADのドメイン コントローラーやイントラネットの管理ポイントに接続できてしまうと、たとえ利用している回線がインターネット回線でもイントラネット端末として判定されてしまいます。こちらを回避するためにはレジストリを使って「常にインターネット」の設定をする必要がございますのでご理解くださいますようお願い致します。</p><p><img src="/blog/mecm/20220328_01/20220328_01_01.png"></p><h3 id="CMG-におけるクライアント認証"><a href="#CMG-におけるクライアント認証" class="headerlink" title="CMG におけるクライアント認証"></a>CMG におけるクライアント認証</h3><p>CMG は不特定多数の端末からアクセスがあるため、クライアント認証を行い、成功した端末の通信のみをイントラネットの MECM サーバーに中継する仕組みを持ちます。認証の仕組みとしては以下の3つがございます。</p><ol><li>Azure AD 認証</li><li>PKI 証明書認証</li><li>サイト トークン認証</li></ol><p>CMG の認証は 1 -&gt; 2 -&gt; 3 の流れでフォールバックしていきます。　　</p><h4 id="Azure-AD-認証"><a href="#Azure-AD-認証" class="headerlink" title="Azure AD 認証"></a>Azure AD 認証</h4><p>Windows 10 / 11 端末のみが利用できる Azure AD を使った認証です。Azure AD connect を使ってオンプレミスの AD の情報を Azure AD に同期したり、直接端末を Azure AD に参加させて、その際の シングル サインオン情報を使って認証を行います。 インターネット上の Windows 8.1 や Windows Server 端末は本認証は利用できませんので、他の認証方式と併用する形となります。</p><p>なお、CMG では 他のクライアント認証方式を使う場合、Azure AD connectを使った AD - Azure AD 間同期は不要です。ただし、多くの場合、CMG 利用と共同管理の利用は同時に検討されることが多いので、その場合は Hybrid Azure AD 構成が必要になります。</p><h4 id="PKI-証明書認証"><a href="#PKI-証明書認証" class="headerlink" title="PKI 証明書認証"></a>PKI 証明書認証</h4><p>企業内のクライアント証明書配布基盤により配布されたクライアント証明書により認証を行う方式です。例えば、Active Directory 証明書サービスとグループ ポリシーを使って配布する、といった方法があるでしょう。よくありがちなトラブルとして、証明書失効リスト (CRL) の公開元がインターネット公開されていないために CRL チェックが出来ずに認証失敗と言ったものがあります。CRL をインターネット公開していない場合は、以下のように CMG のクライアント認証設定で CRL チェックを外すと解決します。  </p><p><img src="/blog/mecm/20220328_01/20220328_01_07.png">  </p><p>また、同様に CMG のサーバー証明書の CRL をインターネット公開していないために CMG と通信できない場合は、以下のようにサイトの設定で CRL チェックを外すと解決します。  </p><p>[CM コンソール] - [管理] - [概要] - [サイトの構成] - [サイト] - 対象のサイトを選択 - [プロパティ] - [通信セキュリティ]タブ</p><p><img src="/blog/mecm/20220328_01/20220328_01_08.png">  </p><h4 id="サイト-トークン認証"><a href="#サイト-トークン認証" class="headerlink" title="サイト トークン認証"></a>サイト トークン認証</h4><p>Azure AD 認証や PKI 証明書認証基盤が利用出来ない環境における認証手段となります。サイト トークン認証は以下の二つの場合に利用されますが、それぞれ利用するトークンが異なります。</p><ul><li><p>インターネット端末の MECM サーバーへの登録: 一括登録トークン</p><ul><li><p>インターネット端末が MECM サーバーと初めて通信を行う際、サーバー登録用の認証が必要となります。Azure AD や証明書の代替として、登録の際に利用されるトークンが一括登録トークンです。一括登録トークンは階層内の最上位サイト サーバー (中央管理サイト サーバーもしくはプライマリサイト サーバー) にある  BulkRegistrationTokenTool.exe ツールを使用して発行します。このトークンは既定では 3 日間、最大 7 日間有効であり、期間内にインターネット端末にて ccmsetup のオプションでこのトークンを指定すると、インターネット越しでの端末登録が成功します。  </p><p>一括登録トークン<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/deploy/deploy-clients-cmg-token#bulk-registration-token">https://docs.microsoft.com/ja-jp/mem/configmgr/core/clients/deploy/deploy-clients-cmg-token#bulk-registration-token</a></p></li></ul></li><li><p>MECM サーバーとの通信: 自己証明 (SelfProve) トークン</p><ul><li>一度でも MECM サーバーとの通信に成功したことのあるデバイスに自動的に割り当てられるトークンです。本トークンは 90 日間有効で、インターネット経由でも、イントラネット経由でも MECM サーバーに通信が行われると月に 1 回、自動で更新される仕組みとなっています。90 日間、1度も MECM サーバーに接続出来ないで居ると、本トークンは無効化されます。トークンが無効化された端末はイントラネット経由で MECM サーバーに接続して再度、本トークンを取得する必要があります。<br>なお、本トークンの発行は無効化できません。</li></ul></li></ul><h3 id="クライアント認証方式の選択方針"><a href="#クライアント認証方式の選択方針" class="headerlink" title="クライアント認証方式の選択方針"></a>クライアント認証方式の選択方針</h3><p>環境に依りますが、大凡以下の方針で選択されるのが良いかと存じます。各認証方式を組み合わせることも可能です。</p><ol><li>Windows 10 / 11 端末しか管理しない -&gt; Azure AD 認証</li><li>Windows 8.1 端末や Windows Server もインターネット越しに管理したい -&gt; PKI 証明書認証</li><li>認証基盤の都合上、Azure AD 認証が利用出来ない -&gt; PKI 証明書認証</li><li>Azure AD 認証や PKI 証明書認証が利用出来ない -&gt; サイト トークン認証</li><li>端末のキッティング/再キッティングは必ず企業ネットワークで行われ、かつリモート ワークを行う期間は数日なので3ヶ月以内に企業ネットワークに接続する機会がある -&gt; サイト トークン認証</li></ol><h3 id="サイト-サーバー間の通信暗号化"><a href="#サイト-サーバー間の通信暗号化" class="headerlink" title="サイト サーバー間の通信暗号化"></a>サイト サーバー間の通信暗号化</h3><p>最新の MECM ではサイト サーバー間通信で平文通信 (http) が非推奨となっているため、問題無いかと存じますが、CMG を利用する際、各サイト サーバー間の通信は SSL を使った暗号化通信が必須となっております。選択方式としては、以下の 2 方式がございます。</p><ul><li>拡張 HTTP</li><li>HTTPS</li></ul><p>また、CMG リバース プロキシ シナリオにおいて関係するサイト システムは以下の通りです。</p><ul><li>CMG</li><li>クラウド管理ゲートウェイ接続ポイント (CMG-CP)<ul><li>CMG に対して HTTPS 通信を行い、その通信を維持することでクライアント -&gt; CMG -&gt; CMG-CP -&gt; 管理ポイントもしくはソフトウェア更新ポイントへの通信を中継するサイト システムの役割です。</li></ul></li><li>管理ポイント</li></ul><h4 id="拡張-HTTP"><a href="#拡張-HTTP" class="headerlink" title="拡張 HTTP"></a>拡張 HTTP</h4><p>CM が独自に発行・管理する自己署名証明書を使って、秘匿性の高い、サイト システム間の通信を暗号化する方式です。本証明書は有効期限が自動更新されるため、証明書管理の負担が下がるメリットがあります。</p><h4 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h4><p>企業内のPKI 証明書基盤が発行する証明書を使って全てのサイト システム間の通信を暗号化する方式です。サイト システム間同士がお互いのサーバー証明書・クライアント証明書を認証する必要があるため、多くの証明書が必要となります。これらの証明書には有効期限があるため、期限が切れた証明書は更新する必要があります。</p><h4 id="認証方式、通信方式に伴う必要な-PKI-証明書の一覧"><a href="#認証方式、通信方式に伴う必要な-PKI-証明書の一覧" class="headerlink" title="認証方式、通信方式に伴う必要な PKI 証明書の一覧"></a>認証方式、通信方式に伴う必要な PKI 証明書の一覧</h4><p>拡張HTTP、HTTPS 方式それぞれに伴う各ポイントに必要な PKI 証明書は以下の図の通りです。</p><p><img src="/blog/mecm/20220328_01/20220328_01_02.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Microsoft Endpoint Configuration Manager (MECM) にて提供されるクラウド管理ゲートウェイ (CMG) の設計ポイントについてご案内し</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
    <category term="CMG" scheme="https://jpmem.github.io/blog/tags/CMG/"/>
    
  </entry>
  
  <entry>
    <title>Windows 365 Enterprise 環境の Azure AD 結合によるプロビジョニング ポリシーの作成方法</title>
    <link href="https://jpmem.github.io/blog/w365/2022-03-28_01/"/>
    <id>https://jpmem.github.io/blog/w365/2022-03-28_01/</id>
    <published>2022-03-27T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.845Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。<br>本日は、Azure AD 結合によるプロビジョニング ポリシーの作成方法についてご案内します。</p><p>Hybrid Azure AD 環境を構築せずに Windows 365 Enterprise を利用したいというご要望はこれまでも多くのフィードバックを頂いておりましたが、本機能によって Hybrid Azure AD 環境をご用意いただかなくても、Windows 365 Enterprise をご利用いただけるようになります。<br>本機能はまだパブリック プレビュー段階ですが、その使用方法をご紹介いたします。</p><h2 id="免責事項"><a href="#免責事項" class="headerlink" title="免責事項"></a>免責事項</h2><p>下記内容は 2022/3/28 時点での内容についての記載となっております。<br>今後内容が更新されることもございますので、その点ご承知置きくださいますようお願い致します。</p><h2 id="Azure-AD-結合について"><a href="#Azure-AD-結合について" class="headerlink" title="Azure AD 結合について"></a>Azure AD 結合について</h2><p>従来の Windows 365 Enterprise では、Hybrid Azure AD Join の環境が前提だったため、オンプレミスの環境が必要でした。<br>また、Azure 上に作成した仮想ネットワークとオンプレミスを接続しなければならないため、Windows 365 Enterprise を使用するまでに環境の構築が必要でしたが、Azure AD 結合の Microsoft のホステッド ネットワークを使用することで、オンプレミス環境や Azure の仮想ネットワークなしで Windows 365 Enterprise を使えるようになりました。</p><h2 id="設定手順"><a href="#設定手順" class="headerlink" title="設定手順"></a>設定手順</h2><p>以下の順番で設定を行うことで、Microsoft のホステッド ネットワークを使用してプロビジョニング ポリシーを作成し、クラウド PC を使用することができます。</p><ol><li>グローバル管理者などの権限を持つアカウントで Microsoft Endpoint Manager admin center (<a href="https://aka.ms/memac">https://aka.ms/memac</a>) にログインします。</li></ol><ol start="2"><li><p>[デバイス] - [Windows 365] - [プロビジョニング ポリシー] と辿り、[ポリシーの作成] を選択します。</p></li><li><p>[統合の種類] で [Azure AD 結合（プレビュー）] にチェックを入れます。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-06-23.png"></p></li><li><p>[ネットワーク] で [Microsoft のホステッド ネットワーク] を選択し、任意でリージョンを選択して次へ進みます。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-06-54.png"><br>※ 組み込みのネットワークと Azure network connection の違いについては後述いたします。</p></li><li><p>ギャラリー イメージかカスタム イメージを選択し、次へ進みます。</p></li></ol><p><img src="/blog/w365/2022-03-28_01/2022-03-28-18-07-43.png"> 6. 言語を選択し、次へ進みます。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-08-05.png"></p><ol start="7"><li><p>本プロビジョニング ポリシーを適用させたいグループを選択し、次へ進みます。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-08-25.png"></p></li><li><p>[作成] を選択し、プロビジョニング ポリシーを作成します。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-08-41.png"></p></li><li><p>プロビジョニングが開始されますので、クラウド PC が作成されるまで待ちます。</p></li></ol><h2 id="組み込みのネットワークと-Azure-network-connection（旧名：オンプレミスのネットワーク接続）-の違いについて"><a href="#組み込みのネットワークと-Azure-network-connection（旧名：オンプレミスのネットワーク接続）-の違いについて" class="headerlink" title="組み込みのネットワークと Azure network connection（旧名：オンプレミスのネットワーク接続） の違いについて"></a>組み込みのネットワークと Azure network connection（旧名：オンプレミスのネットワーク接続） の違いについて</h2><p>それぞれ以下の違いがあります。</p><h4 id="a-組み込みのネットワーク"><a href="#a-組み込みのネットワーク" class="headerlink" title="a. 組み込みのネットワーク"></a>a. 組み込みのネットワーク</h4><p>Windows 365 Business のように Microsoft でホストされる仮想ネットワークにクラウド PC がデプロイされます。そのため、事前に Azure 上に仮想ネットワークを用意する必要がありません。また、オンプレミス環境も必要ないため、すぐに使用可能です。<br>社内ネットワークに接続させたくない場合等にもおすすめです。</p><h4 id="b-Azure-network-connection（旧名：オンプレミスのネットワーク接続）"><a href="#b-Azure-network-connection（旧名：オンプレミスのネットワーク接続）" class="headerlink" title="b. Azure network connection（旧名：オンプレミスのネットワーク接続）"></a>b. Azure network connection（旧名：オンプレミスのネットワーク接続）</h4><p>Azure 上の仮想ネットワークを使用することができるため、カスタマイズされたネットワークを使用することが出来ます。<br>[Azure network connection] - [Azure AD 結合（プレビュー）] から新規作成します。<br><img src="/blog/w365/2022-03-28_01/2022-03-28-18-09-48.png"></p><p>以上、Azure AD 結合によるプロビジョニング ポリシーの作成方法について参考になりましたら幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Microsoft Endpoint Manager サポート チームです。&lt;br&gt;本日は、Azure AD 結合によるプロビジョニング ポリシーの作成方法についてご案内します。&lt;/p&gt;
&lt;p&gt;Hybrid Azure AD 環境を構築せずに Wind</summary>
      
    
    
    
    
    <category term="Windows 365" scheme="https://jpmem.github.io/blog/tags/Windows-365/"/>
    
  </entry>
  
  <entry>
    <title>クライアントの更新プログラムのダウンロードが 0 %で進まない場合のチェックポイント ( WSUS )</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-03-25_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-03-25_01/</id>
    <published>2022-03-24T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.877Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。 WSUS サポート チームです。</p><p>よくあるお問い合わせの中で、 WSUS から配信した更新プログラムのダウンロードがクライアント端末上で 0 % から進まず、更新プログラムの適用処理が完了できないといった事象があります。</p><p>クライアント側で WSUS から取得する更新プログラムのダウンロードに失敗する要因は様々ございますが、<br>今回は、そんなときにまずは一度ご確認いただきたいポイントについてお伝えしようと思います。<br>クライアントのダウンロードが進まない、失敗する といったご状況の際はぜひご一読ください。</p><ul><li><strong>WSUS サーバー上のコンテンツ ファイルの有無を確認</strong></li><li><strong>Windows Firewall サービス の無効化についての確認</strong></li></ul><p>上記項目の説明及び確認手順は以下の通りです。</p><h3 id="＜-確認手順-WSUS-サーバー上のコンテンツ-ファイルの有無を確認-＞"><a href="#＜-確認手順-WSUS-サーバー上のコンテンツ-ファイルの有無を確認-＞" class="headerlink" title="＜ 確認手順 : WSUS サーバー上のコンテンツ ファイルの有無を確認 ＞"></a><strong>＜ 確認手順 : WSUS サーバー上のコンテンツ ファイルの有無を確認 ＞</strong></h3><p>＜説明＞<br>WSUS サーバーに実体となる更新プログラムのファイルが存在していない場合、<br>クライアントは、更新プログラムのダウンロードを実行しても取るファイルが存在しないためダウンロードが進捗しない状況になります。<br>この場合、 WSUS サーバー上で、更新プログラムの承認後、実体ファイルのダウンロードが正常にできていない可能性などが疑われます。</p><p>＜手順＞<br>1． WSUS コンソールで対象の更新プログラムを右クリックし「 ファイル情報 」を参照します。<br><img src="/blog/wsus/2022-03-25_01/2022-03-25_01_1.png"><br>2．更新プログラムの URI が表示されています。これが更新プログラムの実体ファイルの格納先になります。<br><img src="/blog/wsus/2022-03-25_01/2022-03-25_01_2.png"><br>3． WSUS サーバーのエクスプローラーから「 WsusContent 」フォルダーを開きます。<br> 　 2 ケタの英数字で名づけられたフォルダーが複数存在しますので、手順2 で確認したファイルパス内に記載されているフォルダーをたどっていきます。<br> <img src="/blog/wsus/2022-03-25_01/2022-03-25_01_3.png"></p><p>4．フォルダー内に格納されているファイルが存在するかを確認します。<br> <img src="/blog/wsus/2022-03-25_01/2022-03-25_01_4.png"></p><h3 id="＜-確認手順-Windows-Firewall-サービス-の無効化についての確認＞"><a href="#＜-確認手順-Windows-Firewall-サービス-の無効化についての確認＞" class="headerlink" title="＜ 確認手順 : Windows Firewall サービス の無効化についての確認＞"></a><strong>＜ 確認手順 : Windows Firewall サービス の無効化についての確認＞</strong></h3><p>＜説明＞<br>OS の標準機能として Windows Firewall のサービス無効化はサポートされておらず、WSUS から更新プログラムをダウンロードする際に利用される Background Intelligent Transfer Service (BITS) と呼ばれるコンポーネントの動作に影響を与えてしまい、正常にダウンロードすることができなくなります。</p><p>参考情報 <a href="https://docs.microsoft.com/ja-jp/windows/win32/bits/">Background Intelligent Transfer Service</a></p><p>＜手順＞<br>1．サービス を開き　Windows Firewall もしくは Windows Defender Firewall の名称（サービス名： MpsSvc）を探します。<br><img src="/blog/wsus/2022-03-25_01/2022-03-25_01_5.png"></p><p>2．サービスの状態が [無効] となっているかをご確認いただき、無効とされていた場合はスタートアップの種類を [自動] にしてサービスを開始してください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。 WSUS サポート チームです。&lt;/p&gt;
&lt;p&gt;よくあるお問い合わせの中で、 WSUS から配信した更新プログラムのダウンロードがクライアント端末上で 0 % から進まず、更新プログラムの適用処理が完了できないといった事象があります。&lt;/p&gt;
&lt;p&gt;</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>Configuration Manager における共同管理機能について</title>
    <link href="https://jpmem.github.io/blog/mecm/20220321_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220321_01/</id>
    <published>2022-03-20T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.801Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Configuration Manager (CM) にて提供される共同管理機能についてご案内します。<br>なお、下記は MECM CB 2111 を前提に記載しておりますのでご留意くださいませ。また、MECM CB 2107 より共同管理機能は「クラウドの接続 (Cloud Attach)」と名前を変更しておりますが、本記事では従来通り「共同管理」の名前を継続利用しておりますのでご承知置きくださいませ。</p><p>共同管理機能は、同様の機能を持つ CM と Intune について、重複する機能は、どちらかの機能を使い、重複しない機能についてはそれぞれの機能を利用を可能にする機能のことです。本機能は、CM と Intune のみで利用でき、他社 EMM 製品等とは組み合わせられない機能です。また、クライアントがイントラネットに接続している時は CM を使い、 インターネットに接続している時は Intune を使うと言った、Location aware を実現する機能ではございませんので、ご注意ください。インターネット経由で CM の管理下に置く場合、通常、クラウド管理ゲートウェイが必要となります。(なお、ここで言うインターネット経由とは VPN で接続されている環境は通常省きます)  </p><p><img src="/blog/mecm/20220321_01/20220321_01_01.png"></p><h2 id="よくあるユースケース"><a href="#よくあるユースケース" class="headerlink" title="よくあるユースケース"></a>よくあるユースケース</h2><p>共同管理機能を使われるユースケースとしては以下のものが挙げられます。</p><ol><li>スマートフォン等と同一の製品でWindows端末を管理したい。多くの機能は Intune で十分だが、OS の更新プログラムは細やかに管理したいので CM の更新プログラム配布機能を継続利用したい。</li><li>Intune のインベントリ機能では必要な情報が収集できないので、CM のカスタマイズ可能なインベントリ機能を使ってより詳細な情報収集を行いたい。</li><li>CM の構成基準を使って Intune より細やかなポリシー制御を行いたい。</li><li>CM で十分に運用管理出来ているが、Intune の条件付き制御やリモート制御機能を使いたい。</li><li>企業ネットワークに接続した際のインターネット回線帯域が限られているので、更新プログラムやアプリケーションの配布は CM の企業ネットワーク配布ポイントを活用したい。</li></ol><h2 id="共同管理機能の前提条件"><a href="#共同管理機能の前提条件" class="headerlink" title="共同管理機能の前提条件"></a>共同管理機能の前提条件</h2><p>共同管理機能の利用前提は以下でご案内しております。<br>よくあるご質問として、Azure AD Registered の端末が利用できるかのご質問がありますが、共同管理において Azure AD Registered の端末はサポートされておりませんのでご承知おきください。</p><p>共同管理とは<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/comanage/overview#prerequisites">https://docs.microsoft.com/ja-jp/mem/configmgr/comanage/overview#prerequisites</a></p><h2 id="ワークロード"><a href="#ワークロード" class="headerlink" title="ワークロード"></a>ワークロード</h2><p>ワークロード とは、CM と Intune で重複する機能群のことです。共同管理構成ポリシーでは、重複する以下の機能を CM と Intune のどちらで担当するかを設定する必要がございます。なお、一部のワークロードでは 設定次第で CM と Intune どちらでも利用が出来る場合がございますので、ご留意くださいますようお願い致します。</p><ul><li>コンプライアンス ポリシー<ul><li> 本ワークロードを Intune 側に設定した場合でも、Intune 上で以下を設定することで、CM のコンプライアンス ポリシーを　Intune のコンプライアンス ポリシーの一部として利用できます。<br>[コンプライアンス ポリシー] - [コンプライアンス設定] - [Configuration Manager のコンプライアンス] - [Configuration Manager からのデバイス コンプライアンスが必要]<br><img src="/blog/mecm/20220321_01/20220321_01_02.png"></li></ul></li><li>デバイス構成<ul><li>本ワークロードを Intune 側に設定した場合でも、CM 上で以下を設定することで、構成基準を継続して利用出来ます。<br>[資産とコンプライアンス] - [概要] - [コンプライアンス設定] - [構成基準] - 該当の構成基準を選択 - [プロパティ] - [全般]タブ - [共同管理のクライアントに対しても常にこの基準を適用する]<br><img src="/blog/mecm/20220321_01/20220321_01_03.png"></li></ul></li><li>リソース アクセス ポリシー</li><li>Endpoint Protection</li><li>クライアント アプリ<ul><li>本ワークロードを Intune 側に設定すると、 CM と Intune 両方のアプリケーションをダウンロード、インストール出来ます。CM 側に設定した場合は CM のアプリケーションのみが配布される形となります。</li></ul></li><li>Office クイック実行アプリ</li><li>Windows Update のポリシー</li></ul><h2 id="ワークロード外の機能"><a href="#ワークロード外の機能" class="headerlink" title="ワークロード外の機能"></a>ワークロード外の機能</h2><p>CM と Intune 間で重複しない以下の機能は共同管理を有効にすることで並行利用が可能となります。</p><ul><li>CM <ul><li>インベントリ</li><li>ソフトウェア利用状況</li><li>電源管理</li></ul></li><li>Intune<ul><li>リモート管理(リタイヤ、ワイプ)</li><li>条件付きアクセス制御ポリシーの配布</li></ul></li></ul><h1 id="共同管理構成の設定方法"><a href="#共同管理構成の設定方法" class="headerlink" title="共同管理構成の設定方法"></a>共同管理構成の設定方法</h1><p>共同管理構成の設定方法を以下でご案内します。なお、共同管理構成は CM 側でのみ設定可能で、Intune 側からは設定できませんのでご留意ください。</p><h2 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h2><p>共同管理構成のウィザードではいくつかの設定を同時に行う形となっております。事前に下記についてご検討くださいますようお願い致します。</p><ol><li>Azure AD グローバル管理者権限を持ち、Intune ライセンスが割当たっているAzure AD ユーザーアカウントをご用意ください。</li><li>共同管理構成を有効にする対象をご検討ください。すべてのデバイスを共同管理にする場合は特に検討は必要ございませんが、 一部のデバイスのみを対象にしたい場合は、そのデバイスが所属するデバイス コレクションを事前に設定する必要がございます。なお、本デバイス コレクションは1つだけしか割り当てられないのでご理解くださいますようお願い致します。</li><li>Intune 画面から CM の管理デバイスを操作する「テナントアタッチ」機能を全ての CM 管理デバイスを対象にするか、一部のコレクションのみを対象にするかどうか事前にご検討ください。  <ul><li>Microsoft エンドポイント マネージャーのテナントのアタッチ: デバイスの同期とデバイスの操作<br><a href="https://docs.microsoft.com/ja-jp/mem/configmgr/tenant-attach/device-sync-actions">https://docs.microsoft.com/ja-jp/mem/configmgr/tenant-attach/device-sync-actions</a></li></ul></li><li>デスクトップの利用情報等を分析できる「Endpoint Analytics」機能をご利用されるかどうか事前にご検討ください。後から設定変更も可能です。  <ul><li>エンドポイント分析とは?<br><a href="https://docs.microsoft.com/ja-jp/mem/analytics/overview">https://docs.microsoft.com/ja-jp/mem/analytics/overview</a></li></ul></li><li>共同管理構成を有効にしたタイミングで端末を Intune に自動登録させるか事前にご検討ください。一部デバイスのみを自動登録させる場合は該当のデバイスが所属するコレクションを作成ください。</li><li>事前にワークロードの設定内容をご検討ください。「ワークロード」ステップで設定することになります。</li></ol><h2 id="クライアントのネットワーク要件"><a href="#クライアントのネットワーク要件" class="headerlink" title="クライアントのネットワーク要件"></a>クライアントのネットワーク要件</h2><ul><li>CM のポリシーとして共同管理構成は配布されるため、クライアントが CM の管理ポイントと接続出来る必要があります。</li><li>Intune の自動登録を有効にする場合、Intune を提供する各サイトに接続できる必要がございます。下記 URL をご参考ください。<br>Microsoft Intune のネットワーク エンドポイント<br><a href="https://docs.microsoft.com/ja-jp/mem/intune/fundamentals/intune-endpoints">https://docs.microsoft.com/ja-jp/mem/intune/fundamentals/intune-endpoints</a></li></ul><h2 id="実際の設定手順"><a href="#実際の設定手順" class="headerlink" title="実際の設定手順"></a>実際の設定手順</h2><ol><li>CM サーバーに接続し、CM コンソールを起動します。</li><li>[CM コンソール] - [管理] - [概要] - [クラウド サービス] - [クラウドの接続] を選択します。<br><img src="/blog/mecm/20220321_01/20220321_01_04.png"></li><li>[クラウド接続の構成] を選択します。<br><img src="/blog/mecm/20220321_01/20220321_01_05.png"></li><li>「クラウド接続の構成」のウィザードが起動します。<br><img src="/blog/mecm/20220321_01/20220321_01_06.png">  </li><li>Azure 環境として「AzurePublicCloud」が選択されていることを確認し、「サインイン」ボタンをクリックします。</li><li>Azure AD の認証が始まりますので事前準備したグローバル管理者権限でサインインします。<br><img src="/blog/mecm/20220321_01/20220321_01_07.png">  </li><li>事前検討で全てのデバイスを Intune に自動登録できるようにする、Endpoint Analyticsを利用できるようにする、全てのデバイスをテナントアタッチを利用出来るようにする、ことを決定されている場合は「既定の設定を使用する(推奨)」を選択ください。以下では「設定をカスタマイズする」の選択を前提にウィザードを進めていきます。選択後、「次へ」をクリックください。<br><img src="/blog/mecm/20220321_01/20220321_01_08.png">  </li><li>事前に検討された内容に従って、「テナントアタッチ」の対象を「Microsoft エンドポイント マネージャーにアップロードするデバイスを選択する」の項目を設定ください。</li><li>事前に検討された内容に従って、「エンドポイント分析」の項目を設定ください。選択後、「次へ」をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_09.png">  </li><li> 対象のデバイスを Intune に自動登録させる場合は、「Intune で自動登録」にて「すべて」か「パイロット」を選択して「次へ」を選択します。一部のコレクションのみを自動登録する場合は「パイロット」を選択し、事前に作成しておいたコレクションを指定します。自動登録させない場合は「なし」を選択します。選択後、「次へ」をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_10.png">  </li><li>設定内容を確認し、「次へ」をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_11.png">  </li><li>設定完了したら、「閉じる」をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_12.png">  </li><li>[クラウドの接続] 画面に戻り、作成された “CoMgmtSettingsProd” を選択して [プロパティ] をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_13.png">  </li><li>[ワークロード] タブに遷移し、事前に検討したワークロードを設定します。<br><img src="/blog/mecm/20220321_01/20220321_01_14.png">  </li><li>ワークロードにて「パイロット Intune」を選択した場合、「ステージング」タブに遷移して、該当のワークロードを配布するパイロット コレクションを指定して「OK」をクリックします。<br><img src="/blog/mecm/20220321_01/20220321_01_15.png">  </li></ol><h2 id="設定がクライアントに適用されたかの確認"><a href="#設定がクライアントに適用されたかの確認" class="headerlink" title="設定がクライアントに適用されたかの確認"></a>設定がクライアントに適用されたかの確認</h2><h3 id="クライアントからの確認方法"><a href="#クライアントからの確認方法" class="headerlink" title="クライアントからの確認方法"></a>クライアントからの確認方法</h3><p>共同管理構成ポリシーがクライアントに適用されると、Configuration Manager のコントロール パネル アプレットの「構成タブ」に以下のように “CoMgmtSettings” で始まる項目が表示されます。各項目の意味は以下の通りです。  </p><p><img src="/blog/mecm/20220321_01/20220321_01_16.png">  </p><ul><li>CoMgmtSettingsProd<ul><li>共同管理構成ポリシーが設定された全てのデバイスに設定される項目です。</li></ul></li><li>CoMgmtSettingsPilotAutoEnroll<ul><li>Intune への自動登録の設定にパイロットコレクションとして指定されたデバイスに設定される項目です。</li></ul></li><li>CoMgmtSettingsPilotCP<ul><li>ワークロード「コンプライアンスポリシー」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotDC<ul><li>ワークロード「デバイスの構成」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotEP<ul><li>ワークロード「Endpoint Protection」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotRAP<ul><li>ワークロード「リソース アクセス」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotCApp<ul><li>ワークロード「クライアントアプリ」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotO365<ul><li>ワークロード「Office クイック実行アプリ」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li><li>CoMgmtSettingsPilotWUP<ul><li>ワークロード「Windows Update のポリシー」のパイロットコレクションとして指定されたデバイスに設定された項目です。</li></ul></li></ul><h3 id="CM-コンソールからの確認方法"><a href="#CM-コンソールからの確認方法" class="headerlink" title="CM コンソールからの確認方法"></a>CM コンソールからの確認方法</h3><p>下記ダッシュボードを利用して共同管理の登録状況を確認できます。  </p><p>[CM コンソール] - [監視] - [共同管理]  </p><p><img src="/blog/mecm/20220321_01/20220321_01_17.png"></p><h3 id="MEM-管理センターからの確認方法"><a href="#MEM-管理センターからの確認方法" class="headerlink" title="MEM 管理センターからの確認方法"></a>MEM 管理センターからの確認方法</h3><p>通常、デバイス一覧で「管理者」が「共同管理」となっているデバイスが共同管理状態となっているデバイスとなります。なお、ここで「管理者」が「ConfigMgr」となっているデバイスはテナントアタッチのみされているデバイスであり、共同管理状態にはなっていないのでご注意ください。  </p><p><img src="/blog/mecm/20220321_01/20220321_01_18.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。本日は、Configuration Manager (CM) にて提供される共同管理機能についてご案内します。&lt;br&gt;なお、下記は MECM CB 2111 を前提に記載しておりますので</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>Windows Server 2022 に更新プログラムを配布するためのポイント</title>
    <link href="https://jpmem.github.io/blog/wsus/2022-03-11_01/"/>
    <id>https://jpmem.github.io/blog/wsus/2022-03-11_01/</id>
    <published>2022-03-10T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.877Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。WSUS サポート チームです。</p><p>近頃のお問い合わせで、「 WSUS から Windows Server 2022 へ更新プログラムを配信することはできますか 」との声をよくいただくようになりました。<br>そこで、今回は 2021年9月1日（米国時間）リリースされた Windows Server 2022 に WSUS を利用して更新プログラムを配布する為のポイントをご紹介します。  </p><p>Windows Server 2022 向けの更新プログラムを WSUSへ 同期するためには、同期対象に以下の “製品” を追加する必要があります。</p><p><strong>製品「Microsoft Server operating system-21H2」</strong></p><p>ー同期対象追加手順ー  </p><p>１．WSUSコンソールを開きます。  </p><p>２．[オプション]&gt;[製品と分類]&gt;”製品” を開きます。<br> Windows配下の製品項目「Microsoft Server operating system-21H2」にチェックを入れてOKを押します。<br> （※取得したい更新プログラムに応じて “分類” 項目の追加も実施ください）<br><img src="/blog/wsus/2022-03-11_01/2022-03-11_01_1.PNG"></p><p>３．その後、WSUSで同期を実施いただくことで、Windows Server 2022 向けの更新プログラムを取得することができます。<br><img src="/blog/wsus/2022-03-11_01/2022-03-11_01_2.PNG"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。WSUS サポート チームです。&lt;/p&gt;
&lt;p&gt;近頃のお問い合わせで、「 WSUS から Windows Server 2022 へ更新プログラムを配信することはできますか 」との声をよくいただくようになりました。&lt;br&gt;そこで、今回は 2021年9月</summary>
      
    
    
    
    
    <category term="WSUS" scheme="https://jpmem.github.io/blog/tags/WSUS/"/>
    
  </entry>
  
  <entry>
    <title>Configuration Manager の便利な機能</title>
    <link href="https://jpmem.github.io/blog/mecm/20220307_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220307_01/</id>
    <published>2022-03-06T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.793Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。</p><p>本日は Configuration Manager の便利な機能について、以下 2 点についてご紹介させていただきます。</p><p>a. クライアントのログを Configuration Manager コンソールから収集する機能<br>b. CSV へのエクスポート機能</p><p>a は何らかの状況でクライアントの操作が出来ない際に、MECM コンソール上からクライアントのログを確認したい、もしくは採取したい時に有効な機能です。<br>b は Configuration Manager 2111 から追加された機能で、デバイスやユーザーの一覧を CSV にエクスポートすることが可能です。<br>それぞれの手順について以下に記載させていただきますので、ぜひご活用ください。</p><ol><li>Configuration Manager コンソールを開き、[資産とコンプライアンス] &gt; [概要] &gt; [デバイス] を開き、クライアント ログを収集したいデバイスを選択します。</li></ol><ol start="2"><li><p>選択したデバイスを右クリックし、[クライアント診断] &gt; [クライアント ログの収集] を選択します。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-05-00.png"></p></li><li><p>下記の警告が表示されますので、[OK] を選択します。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-05-40.png"></p></li><li><p>[資産とコンプライアンス] &gt; [概要] &gt; [デバイス] に戻り、手順 2 のデバイスを選択し、右クリックから [開始] &gt; [リソース エクスプローラー] を選択します。</p></li></ol><p><img src="/blog/mecm/20220307_01/2022-03-08-13-06-59.png">  </p><ol start="5"><li><p>[リソース エクスプローラー] が開きますので、左側ペインから [診断ファイル] を選択します。右側ペインに収集した診断ファイルが表示されます。表示されない場合は少し待ち、再度表示されるまで待ちます。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-08-24.png"></p></li><li><p>診断ファイルを選択し、右クリックから [サポート センターを開く] を選択します。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-12-35.png"></p></li><li><p>Configuration Manager Support Center Viewer が起動しますので、確認したいログをダブルクリックすると以下のようにログが表示されます。<br>下図は PolicyAgent.log を表示した画面です。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-14-38.png"></p></li><li><p>採取したログを保存したい場合は手順 6 で [保存] を選択します。<br><img src="/blog/mecm/20220307_01/2022-03-08-13-15-54.png"></p></li></ol><h1 id="b-CSV-へのエクスポート機能"><a href="#b-CSV-へのエクスポート機能" class="headerlink" title="b. CSV へのエクスポート機能"></a>b. CSV へのエクスポート機能</h1><ol><li>デバイスやユーザーなど、CSV にエクスポートしたい対象の一覧を表示します。</li><li>画面上部にある [CSV ファイルにエクスポート] から [すべてのアイテムをエクスポート] もしくは [選択したアイテムをエクスポート] を選択します。<br><img src="/blog/mecm/20220307_01/2022-03-10-10-52-11.png"></li><li>[名前を付けて保存] 画面が表示されますので、任意の場所を選択し、[保存] を選択します。 </li><li>CSV ファイルを開くと、Configuration Manager コンソール上で閲覧できている状態の情報が表示されています。<br><img src="/blog/mecm/20220307_01/2022-03-10-10-56-24.png"></li></ol><p>■注意事項<br>エクスポートした CSV ファイルを開くと文字化けしている場合がございます。<br>その場合は、以下の手順で直すことが可能です。  </p><p>a. CSV ファイルを右クリックし、[プログラムから開く] - [メモ帳] を選択します。<br>b. メモ帳が開かれたら、[ファイル] - [名前を付けて保存] を選択します。<br>c. 画面右下の [エンコード] を [ANSI] に変更し、上書き保存します。<br>d. 再度 CSV ファイルを開き、文字化けが改善され、正常に表示されていることを確認します。</p><p>◆  文字化けしている CSV ファイルの例<br><img src="/blog/mecm/20220307_01/2022-03-10-10-59-03.png"></p><p>参考公開情報<br>Title : CSV へのエクスポート<br>URL : <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/admin-console-tips#export-to-csv">https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/admin-console-tips#export-to-csv</a></p><p>※本情報の内容（添付画像を含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;/p&gt;
&lt;p&gt;本日は Configuration Manager の便利な機能について、以下 2 点についてご紹介させていただきます。&lt;/p&gt;
&lt;p&gt;a. クライアントのログを Con</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>CMPivot 機能について</title>
    <link href="https://jpmem.github.io/blog/mecm/20220208_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220208_01/</id>
    <published>2022-02-07T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.793Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。</p><p>本日は CMPivot についてご紹介させていただきます。</p><p>CMPivot とは・・・Configuration Manager コンソールからクエリを実行し、リアルタイムでクライアントの情報を取得できる、とても優れた機能です！</p><p>参考公開情報<br>Title : CMPivot の概要<br>URL   : <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/cmpivot-overview">https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/cmpivot-overview</a></p><p>今回は例として、特定のイベントログを抽出する方法について記載させていただきますので、ぜひお試しください。  </p><ol><li>デバイス一覧より対象デバイス（またはデバイスコレクション）を右クリックして [CMPivot の開始]  をクリックします。<br><img src="/blog/mecm/20220208_01/2022-02-08-20-02-16.png"></li></ol><ol start="2"><li><p>以下の画面が表示されますので、[クエリ] タブに移動します。<br><img src="/blog/mecm/20220208_01/2022-02-08-20-03-31.png"></p></li><li><p>クエリを記載します。以下はシステムイベントログの ID 1500 を抽出するクエリです。</p><p>EventLog(‘System’)<br>| where EventID == 1500<br>※イベントログは既定で 24 時間以内のログを抽出しますので、3 日以内など日数をしたい場合は以下のようにクエリを作成します。  </p><p> EventLog(‘System’,3d)<br>| where EventID == 1500  </p></li></ol><ol start="4"><li>[クエリの実行] をクリックし、結果が得られたら成功です。<br><img src="/blog/mecm/20220208_01/2022-02-08-20-09-56.png"></li></ol><h1 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h1><p>CMPivot を使用いただくにあたり、前提条件やアクセス許可などが必要がございますので、あらかじめご承知おきいただきますようお願いいたします。</p><p>参考公開情報<br>Title : 前提条件<br>URL   : <a href="https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/cmpivot#prerequisites">https://docs.microsoft.com/ja-jp/mem/configmgr/core/servers/manage/cmpivot#prerequisites</a></p><p>※本情報の内容（添付画像を含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;/p&gt;
&lt;p&gt;本日は CMPivot についてご紹介させていただきます。&lt;/p&gt;
&lt;p&gt;CMPivot とは・・・Configuration Manager コンソールからクエリを実行</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
  <entry>
    <title>パッケージの展開が失敗した時に確認したいポイント ~ sysnative 編 ~</title>
    <link href="https://jpmem.github.io/blog/mecm/20220125_01/"/>
    <id>https://jpmem.github.io/blog/mecm/20220125_01/</id>
    <published>2022-01-24T15:00:00.000Z</published>
    <updated>2022-04-28T06:54:42.793Z</updated>
    
    <content type="html"><![CDATA[<p>みなさま、こんにちは。Configuration Manager サポート チームです。</p><p>今回は Configuration Manager からのパッケージ展開が失敗した際ご確認いただきたい sysnative について解説させていただきます。</p><hr><h2 id="パッケージ展開対象のアプリケーションが-64-bit-の場合には-sysnative-の指定が必要になることがあります"><a href="#パッケージ展開対象のアプリケーションが-64-bit-の場合には-sysnative-の指定が必要になることがあります" class="headerlink" title="パッケージ展開対象のアプリケーションが 64 bit の場合には sysnative の指定が必要になることがあります"></a>パッケージ展開対象のアプリケーションが 64 bit の場合には sysnative の指定が必要になることがあります</h2><p>現在展開対象としているアプリケーション、クライアント端末は 64 bit ではありませんか ?<br>その場合、パッケージの展開が失敗してしまう可能性があります。</p><h2 id="ファイル-リダイレクトについて"><a href="#ファイル-リダイレクトについて" class="headerlink" title="ファイル リダイレクトについて"></a>ファイル リダイレクトについて</h2><p>ファイルリ ダイレクトという機能をご存知でしょうか ? これは 64 bit 端末上で 32 bit のアプリケーションを実行するために使用されております。通常 64 bit のアプリケーションの dll は %windir%\System32\ から呼び出されます。しかし、64 bit の端末上の 32 bit アプリケーションの dll は、異なるディレクトリに格納されており、各 bit によって、パスを使い分ける必要があります。</p><p>その際を埋めるのが WOW64 です。<br>WOW64 は上記のディレクトリ パスの差異をファイル リダイレクトによりあたかも同じ場所にあるように扱うことを可能にしています。</p><p>32 bit アプリケーションから %windir%\System32 が指定された場合には、WOW64 は %windir%\SysWOW64（32 bit プログラム用のファイルがおいてあるフォルダー） にリダイレクトします。</p><h2 id="ファイルリダイレクトによる弊害"><a href="#ファイルリダイレクトによる弊害" class="headerlink" title="ファイルリダイレクトによる弊害"></a>ファイルリダイレクトによる弊害</h2><p>しかし、パッケージ展開の際には注意が必要となります。<br>パッケージ展開処理は 32 bit で動作します。そのため、64 bit の OS の端末上でパッケージ展開を実行する際には WOW64 を介して 32 bit 用の dll が存在するパスにリダイレクトされます。</p><p>例えば、64 bit の exe を実行する場合に、パッケージのコマンド ラインに「cmd /c test.exe」と指定した場合には、C:\Windows\SysWOW64 配下の cmd が呼び出され、32 bit の cmd から 64 bit のアプリケーション（exe）を実行する事となり、正常に動作しないことがあります。</p><h3 id="パッケージのコマンドラインの確認方法"><a href="#パッケージのコマンドラインの確認方法" class="headerlink" title="パッケージのコマンドラインの確認方法"></a>パッケージのコマンドラインの確認方法</h3><p>1.MECM 管理コンソール &gt; [ソフトウェア ライブラリ] &gt; [概要] &gt; [アプリケーション管理] &gt; [パッケージ] にて、[プログラム] タブを開き、該当のプログラムを右クリック &gt; [プロパティ] を開きます。</p><p><img src="/blog/mecm/20220125_01/20220125_01_01.png"></p><p>2.[全般] タブにて「コマンド ライン」を確認することができます。</p><p><img src="/blog/mecm/20220125_01/20220125_01_02.png"></p><h2 id="回避策"><a href="#回避策" class="headerlink" title="回避策"></a>回避策</h2><p>以下のように sysnative をコマンドラインに指定することにより、回避することが可能となります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%windir%\sysnative\cmd /c test.exe</span><br></pre></td></tr></table></figure><p>※ 適宜ファイル名を変更してお試し下さい。</p><h3 id="ps1-の場合"><a href="#ps1-の場合" class="headerlink" title="ps1 の場合"></a>ps1 の場合</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;%Windir%\sysnative\WindowsPowerShell\v1.0\powershell.exe&quot;</span> <span class="literal">-ExecutionPolicy</span> Bypass <span class="literal">-Command</span> .\xxx.ps1</span><br></pre></td></tr></table></figure><h3 id="bat-の場合"><a href="#bat-の場合" class="headerlink" title="bat の場合"></a>bat の場合</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%windir%\sysnative\cmd.exe /c xxx.bat</span><br></pre></td></tr></table></figure><h3 id="vbs-の場合"><a href="#vbs-の場合" class="headerlink" title="vbs の場合"></a>vbs の場合</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">％windir％\sysnative\cscript.exe xxx.vbs</span><br></pre></td></tr></table></figure><h3 id="msi-の場合"><a href="#msi-の場合" class="headerlink" title="msi の場合"></a>msi の場合</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">％windir％\sysnative\msiexec.exe xxx.msi</span><br></pre></td></tr></table></figure><h2 id="パッケージのコマンドラインの変更箇所"><a href="#パッケージのコマンドラインの変更箇所" class="headerlink" title="パッケージのコマンドラインの変更箇所"></a>パッケージのコマンドラインの変更箇所</h2><p>1.MECM 管理コンソール &gt; [ソフトウェア ライブラリ] &gt; [概要] &gt; [アプリケーション管理] &gt; [パッケージ] にて、[プログラム] タブを開き、該当のプログラムを右クリック &gt; [プロパティ] を開きます。</p><p><img src="/blog/mecm/20220125_01/20220125_01_01.png"></p><p>2.[全般] タブにて「コマンド ライン」の修正を行います。</p><p><img src="/blog/mecm/20220125_01/20220125_01_03.png"></p><p>3.[OK] ボタンをクリックし、変更を完了します。</p><p>4.パッケージの再展開を行い、改善が見られるかご確認くださいませ。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;みなさま、こんにちは。Configuration Manager サポート チームです。&lt;/p&gt;
&lt;p&gt;今回は Configuration Manager からのパッケージ展開が失敗した際ご確認いただきたい sysnative について解説させていただきます。&lt;/p&gt;
&lt;h</summary>
      
    
    
    
    
    <category term="MECM" scheme="https://jpmem.github.io/blog/tags/MECM/"/>
    
  </entry>
  
</feed>
